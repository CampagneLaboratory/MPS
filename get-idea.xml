<?xml version="1.0" encoding="UTF-8"?>
<project name="get-idea" default="default">
  <property name="main.url" value="http://buildserver/guestAuth/repository/download/bt24/.lastSuccessful" />
  <property name="idea.platform.dir" value="lib/jetbrains-ideframework" />
  <property name="idea.platform.internal.dir" value="lib/idea-platform-internal" />
  <property name="tmp" value="idea.new" />
  <property name="idea.platform.build.property" value="idea.platform.build.number" />
  <property name="platfrom.src.zip" value="idea-platform-src.zip" />
  <target name="default" depends="prepare,download,replace.libraries,unpack.sources,upgrade.plugins,clean" />
  <target name="prepare">
    <mkdir dir="${tmp}" />
  </target>
  <target name="download" depends="prepare">
    <get src="${main.url}/platform15/platform-api.jar" dest="${idea.platform.dir}/platform-api.jar" />
    <get src="${main.url}/platform15/platform.jar" dest="${idea.platform.dir}/platform.jar" />
    <get src="${main.url}/platform15/resources.jar" dest="${idea.platform.dir}/resources.jar" />
    <get src="${main.url}/platform15/resources_en.jar" dest="${idea.platform.dir}/resources_en.jar" />
    <get src="${main.url}/sources.zip" dest="${idea.platform.dir}/sources.zip" />
    <get src="${main.url}/idea{build.number}-jdk15.zip" dest="${tmp}/idea-jdk15.zip" />
  </target>
  <target name="clean.license.classes" depends="download">
    <property name="platform.jar" value="${idea.platform.dir}/platform.jar" />
    <property name="tmpdir" value="${idea.platform.dir}/tmp" />
    <mkdir dir="${tmpdir}" />
    <unzip src="${platform.jar}" dest="${tmpdir}" />
    <delete dir="${tmpdir}" includes="**com/intellij/ide/license/impl/**" />
    <jar basedir="${tmpdir}" destfile="${platform.jar}" update="false" />
    <delete dir="${tmpdir}" />
  </target>
  <target name="replace.libraries" depends="download">
    <unzip src="${tmp}/idea-jdk15.zip" dest="${tmp}/idea" />
    <copy todir="${idea.platform.dir}" overwrite="true">
      <fileset dir="${tmp}/idea/lib" includes="alloy.jar, annotations.jar, boot.jar, bootstrap.jar, commons-codec-1.3.jar, commons-collections.jar, extensions.jar, forms_rt.jar, icons.jar, jh.jar, jdom.jar, jgoodies-forms.jar, jna-utils.jar, jna.jar, log4j.jar, microba.jar, nanoxml-2.2.3.jar, oromatcher.jar, picocontainer.jar, trove4j.jar, trove4j_src.jar, util.jar, xmlrpc-2.0.jar, xstream.jar, yjp-controller-api-redist.jar" />
    </copy>
    <copy todir="${idea.platform.internal.dir}" overwrite="true">
      <fileset dir="${tmp}/idea/lib" includes="cocoa.jar, exe4jlib.jar, growl.jar, jLmgr.jar, ui.jar, velocity.jar" />
    </copy>
    <replaceregexp match="${idea.platform.build.property}=(.*)" file="build.number" replace="${idea.platform.build.property}=" byline="true" />
    <concat append="true" destfile="build.number">
      <filelist files="${tmp}/idea/build.txt" />
    </concat>
  </target>
  <target name="unpack.sources" depends="download">
    <copy file="${idea.platform.dir}/${platfrom.src.zip}" tofile="${idea.platform.dir}/${platfrom.src.zip}.old" />
    <unzip src="${idea.platform.dir}/sources.zip" dest="${tmp}/idea-src" />
    <zip destfile="${idea.platform.dir}/${platfrom.src.zip}" update="false">
      <fileset dir="${tmp}/idea-src/Annotations/src/" />
      <fileset dir="${tmp}/idea-src/boot/src/" />
      <fileset dir="${tmp}/idea-src/bootstrap/src/" />
      <fileset dir="${tmp}/idea-src/extensions/source/" />
      <fileset dir="${tmp}/idea-src/lang-api/src/" />
      <fileset dir="${tmp}/idea-src/lang-impl/src/" />
      <fileset dir="${tmp}/idea-src/lvcs/impl/src/" />
      <fileset dir="${tmp}/idea-src/lvcs/openapi/src/" />
      <fileset dir="${tmp}/idea-src/platform-api/src/" />
      <fileset dir="${tmp}/idea-src/platform-impl/src/" />
      <fileset dir="${tmp}/idea-src/platform-resources/src/" />
      <fileset dir="${tmp}/idea-src/platform-resources_eng/src/" />
      <fileset dir="${tmp}/idea-src/plugins-management/src/" />
      <fileset dir="${tmp}/idea-src/psi-extapi/src/" />
      <fileset dir="${tmp}/idea-src/testRunner/src/" />
      <fileset dir="${tmp}/idea-src/UsageView/src/" />
      <fileset dir="${tmp}/idea-src/util/src/" />
      <fileset dir="${tmp}/idea-src/vcs-api/src/" />
      <fileset dir="${tmp}/idea-src/vcs-impl/src/" />
    </zip>
    <delete file="${idea.platform.dir}/${platfrom.src.zip}.old" />
  </target>
  <target name="upgrade.plugins" depends="replace.libraries">
    <copy todir="plugins" overwrite="true">
      <fileset dir="${tmp}/idea/plugins/" includes="ClearCaseIntegration/**, cvsIntegration/**, git4idea/**, PerforceIntegration/**, starteamIntegration/**, svn4idea/**, vssIntegration/**" />
    </copy>
  </target>
  <target name="clean" depends="upgrade.plugins,download,replace.libraries,unpack.sources,prepare,clean.license.classes">
    <delete dir="${tmp}" />
  </target>
</project>

