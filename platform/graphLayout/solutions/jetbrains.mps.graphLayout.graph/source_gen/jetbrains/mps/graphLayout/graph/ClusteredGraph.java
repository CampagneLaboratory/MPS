package jetbrains.mps.graphLayout.graph;

/*Generated by MPS */

import java.util.Map;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.internal.collections.runtime.Sequence;

public class ClusteredGraph extends Graph implements IClusteredGraph {
  private Graph myInclusionTree;
  private Map<Node, Node> myLeafClusters;
  private Node myRoot;

  public ClusteredGraph() {
    super();
    myInclusionTree = new Graph();
    myLeafClusters = MapSequence.fromMap(new HashMap<Node, Node>());
    myRoot = myInclusionTree.createNode();
  }

  public Iterable<Node> getNodesInCluster(INode cluster) {
    Set<Node> nodes = SetSequence.fromSet(new HashSet<Node>());
    getNodesInCluster(((Node) cluster), nodes);
    return nodes;
  }

  @Override
  public Node addNode() {
    Node node = super.addNode();
    Node cluster = myInclusionTree.addNode();
    myRoot.addEdgeTo(cluster);
    MapSequence.fromMap(myLeafClusters).put(cluster, node);
    return node;
  }

  private void getNodesInCluster(Node cluster, Set<Node> nodes) {
    Iterable<Node> subclusters = ListSequence.fromList(cluster.getOutEdges()).select(new ISelector<Edge, Node>() {
      public Node select(Edge it) {
        return it.getTarget();
      }
    });
    for (Node subcluster : Sequence.fromIterable(subclusters)) {
      getNodesInCluster(subcluster, nodes);
    }
    Node node = MapSequence.fromMap(myLeafClusters).get(cluster);
    if (node != null) {
      SetSequence.fromSet(nodes).addElement(node);
    }
  }

  public INode getRoot() {
    return myRoot;
  }

  public IGraph getUnderlyingGraph() {
    return this;
  }

  public IGraph getInclusionTree() {
    return myInclusionTree;
  }
}
