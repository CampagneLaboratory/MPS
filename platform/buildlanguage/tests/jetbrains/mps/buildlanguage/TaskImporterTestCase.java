package jetbrains.mps.buildlanguage;

/*Generated by MPS */

import jetbrains.mps.buildlanguage.SmartItemsInfoExtractor.IWalker;
import jetbrains.mps.buildlanguage.resource.Child;
import jetbrains.mps.buildlanguage.resource.Parent;
import junit.framework.Assert;
import junit.framework.TestCase;
import org.apache.tools.ant.Task;

import java.io.IOException;
import java.io.PrintWriter;
import java.io.StringWriter;
import java.util.*;
import java.util.jar.JarFile;

public class TaskImporterTestCase extends TestCase {
  private static final String ANT_PATH = System.getProperty("user.dir")+"/lib/ant-1.7.0";
  private static final String TEST_FOLDER = "platform/buildlanguage/tests";

  public void testTestTask1(){
    try {
      Map<String, Class<?>> attrs = SmartItemsInfoExtractor.getInstance().getAttributesFromTask(ANT_PATH, TEST_FOLDER,"jetbrains.mps.buildlanguage.resource.TestTask", Task.class);
      assertTrue(attrs.get("booleanattribute").equals(boolean.class));
      assertTrue(attrs.get("intattribute").equals(int.class));
      assertTrue(attrs.get("stringattribute").equals(String.class));
      assertEquals(3, attrs.size());
    } catch (IOException e) {
      throw new RuntimeException(e);
    } catch (ClassNotFoundException e) {
      throw new RuntimeException(e);
    }
  }

  public void testGetTaskClasses(){
    try {
      ClassLoader cl = SmartItemsInfoExtractor.getInstance().createClassLoader(ANT_PATH, "platform/buildlanguage/tests/testTasks.jar");
      Set<Class<? extends Task>> taskClasses = SmartItemsInfoExtractor.getInstance().getTaskClasses(new JarFile("platform/buildlanguage/tests/testTasks.jar"), cl, Task.class);
      assertTrue(taskClasses.contains(cl.loadClass(Parent.class.getName())));
      assertTrue(taskClasses.contains(cl.loadClass(Child.class.getName())));
      assertEquals(2, taskClasses.size());
    } catch (IOException e) {
      throw new RuntimeException(e);
    } catch (ClassNotFoundException e) {
      throw new RuntimeException(e);
    }
  }

  public void testGenerateTasks1(){
    try {
      TaskImporterTestCase.TestWalker testWalker = new TestWalker();
      SmartItemsInfoExtractor.getInstance().generateHierarchy(ANT_PATH, "platform/buildlanguage/tests/testTasks.jar", testWalker);
      assertEquals("declarations {child=false, datatype=true, parent=false, task=true}\n" +
                   "interfaces {}\n" +
                   "nesteds {}\n" +
                   "parents {child=parent, parent=task}\n" +
                   "attributes {intattribute=int, stringattribute=class java.lang.String}", testWalker.toString());
    } catch (IOException e) {
      fail(e);
    } catch (ClassNotFoundException e) {
      fail(e);
    }
  }

  public void testGenerateTasks2NestedElements(){
    try {
      TaskImporterTestCase.TestWalker testWalker = new TestWalker();
      SmartItemsInfoExtractor.getInstance().generateHierarchy(ANT_PATH, "platform/buildlanguage/tests/testNested.jar", testWalker);
      assertEquals("declarations {bigtask=false, datatype=true, inner1=false, inner2=false, inner3=false, task=true}\n" +
                   "interfaces {}\n" +
                   "nesteds {bigtask=[inner3, inner1, inner2]}\n" +
                   "parents {bigtask=task, inner1=datatype, inner2=datatype, inner3=datatype}\n" +
                   "attributes {}", testWalker.toString());
    } catch (IOException e) {
      fail(e);
    } catch (ClassNotFoundException e) {
      fail(e);
    }
  }

  private static void fail(Exception e) {
    StringWriter writer = new StringWriter();
    e.printStackTrace(new PrintWriter(writer));
    Assert.fail(writer.toString());
  }

  private class TestWalker implements IWalker {

    private Map<String, Boolean> myDecls = new TreeMap<String, Boolean>();
    private Map<String, Boolean> myInterfaces = new TreeMap<String, Boolean>();
    private Map<String, LinkedList<String>> myNesteds = new TreeMap<String, LinkedList<String>>();
    private Map<String, String> myParents = new TreeMap<String, String>();
    private Map<String, Class<?>> myAttributes = new TreeMap<String, Class<?>>();

    @Override
    public String toString(){
      StringBuffer sb = new StringBuffer();
      sb.append("declarations ");
      sb.append(myDecls);
      sb.append("\n");
      sb.append("interfaces ");
      sb.append(myInterfaces);
      sb.append("\n");
      sb.append("nesteds ");
      sb.append(myNesteds);
      sb.append("\n");
      sb.append("parents ");
      sb.append(myParents);
      sb.append("\n");
      sb.append("attributes ");
      sb.append(myAttributes);
      return sb.toString();
    }

    public void createDeclaration(String declName, boolean isAbstract) {
      myDecls.put(declName, isAbstract);
    }

    public void createInterfaceDeclaration(String declName) {
      //To change body of implemented methods use File | Settings | File Templates.
    }

    public void addParent(String declName, String parentName) {
      assertTrue(declName, myDecls.containsKey(declName));
      assertTrue(parentName, myDecls.containsKey(parentName));
      myParents.put(declName, parentName);
    }

    public void addNested(String declName, String nestedName) {
      assertTrue(declName, myDecls.containsKey(declName));
      assertTrue(nestedName, myDecls.containsKey(nestedName));
      LinkedList<String> nesteds = myNesteds.get(declName);
      if (nesteds == null){
        nesteds = new LinkedList<String>();
        myNesteds.put(declName, nesteds);
      }
      nesteds.add(nestedName);
    }

    public void addAttribute(String declName, String attrName, Class<?> type) {
      assertTrue(declName, myDecls.containsKey(declName));
      myAttributes.put(attrName, type);
    }

    public void addImplemented(String declName, String intName) {
      //To change body of implemented methods use File | Settings | File Templates.
    }

    public Collection<String> getExisting() {
      return Collections.EMPTY_SET;  //To change body of implemented methods use File | Settings | File Templates.
    }
  }
}
