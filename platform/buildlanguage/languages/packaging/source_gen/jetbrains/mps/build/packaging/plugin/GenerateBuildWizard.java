package jetbrains.mps.build.packaging.plugin;

/*Generated by MPS */

import com.intellij.ide.wizard.AbstractWizard;
import com.intellij.openapi.project.Project;
import javax.swing.JComponent;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import com.intellij.openapi.progress.ProgressManager;
import com.intellij.openapi.progress.Task;
import com.intellij.openapi.progress.ProgressIndicator;
import jetbrains.mps.reloading.ClassLoaderManager;
import com.intellij.openapi.progress.EmptyProgressIndicator;
import com.intellij.ide.wizard.Step;

public class GenerateBuildWizard extends AbstractWizard {

  private final String myTitle;
  private final Project myProject;
  protected final AbstractBuildGenerator myGenerator;
  protected IErrorHandler myErrorHandler = new IErrorHandler() {

    public void setErrorText(String text) {
      GenerateBuildWizard.this.setErrorText(text);
    }
  };

  public GenerateBuildWizard(String title, Project project, AbstractBuildGenerator generator) {
    super(title, project);
    this.myTitle = title;
    this.myProject = project;
    this.myGenerator = generator;
  }

  public String getHelpID() {
    return null;
  }

  protected JComponent createCenterPanel() {
    JComponent panel = super.createCenterPanel();
    assert panel != null;
    panel.doLayout();
    return panel;
  }

  protected void updateStep() {
    super.updateStep();
    this.getFinishButton().setEnabled((this.getCurrentStep() == this.mySteps.size() - 1) && this.myGenerator.isValid());
  }

  protected void doOKAction() {
    super.doOKAction();
    final List<Runnable> toRunAfter = ListSequence.fromList(new ArrayList<Runnable>());
    ProgressManager.getInstance().run(new Task.Modal(null, "Generating build script", false) {

      public void run(ProgressIndicator progressIndicator) {
        progressIndicator.setIndeterminate(true);
        ListSequence.fromList(toRunAfter).addElement(GenerateBuildWizard.this.myGenerator.generate(progressIndicator));
        ClassLoaderManager.getInstance().reloadAll(new EmptyProgressIndicator());
      }
    });
    for(Runnable runnable : ListSequence.fromList(toRunAfter)) {
      runnable.run();
    }
  }

  public void initWizard() {
    Step moduleStep = new SolutionStep(this.myProject, this.myGenerator, this.myErrorHandler);
    Step modelStep = new ModelStep(this.myProject, this.myGenerator, this.myErrorHandler);
    Step languagesStep = new LanguagesStep(this.myProject, this.myGenerator, this.myErrorHandler);
    this.addStep(moduleStep);
    this.addStep(modelStep);
    this.addStep(languagesStep);
    this.init();
  }

}
