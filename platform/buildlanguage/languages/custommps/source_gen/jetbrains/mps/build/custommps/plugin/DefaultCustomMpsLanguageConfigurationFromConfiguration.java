package jetbrains.mps.build.custommps.plugin;

/*Generated by MPS */

import jetbrains.mps.plugins.pluginparts.runconfigs.BaseConfigCreator;
import jetbrains.mps.smodel.SNode;
import com.intellij.execution.configurations.RunConfiguration;
import com.intellij.util.containers.ContainerUtil;
import com.intellij.openapi.extensions.Extensions;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.plugins.pluginparts.runconfigs.MPSPsiElement;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;

public class DefaultCustomMpsLanguageConfigurationFromConfiguration extends BaseConfigCreator<SNode> implements Cloneable {
  private RunConfiguration myConfig;

  public DefaultCustomMpsLanguageConfigurationFromConfiguration() {
    super(ContainerUtil.findInstance(Extensions.getExtensions(CustomMPSConfigurationType_ConfigurationType.CONFIGURATION_TYPE_EP), CustomMPSConfigurationType_ConfigurationType.class));
  }

  protected RunConfiguration doCreateConfiguration(SNode node) {
    this.createConfig(node);
    return this.myConfig;
  }

  private void createConfig(final SNode parameter) {
    final Wrappers._T<SNode> layout = new Wrappers._T<SNode>();
    final Wrappers._boolean isApplicable = new Wrappers._boolean();
    final Wrappers._T<String> configurationId = new Wrappers._T<String>();
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        layout.value = SNodeOperations.getAncestor(parameter, "jetbrains.mps.build.packaging.structure.MPSLayout", false, true);
        isApplicable.value = (layout.value != null) && ListSequence.fromList(SNodeOperations.getDescendants(layout.value, "jetbrains.mps.build.custommps.structure.MPSBuild", false, new String[]{})).isNotEmpty();
        configurationId.value = parameter.getId();
      }
    });
    if (!(isApplicable.value)) {
      return;
    }

    DefaultCustomMpsLanguageConfigurationFromConfiguration.this.setSourceElement(new MPSPsiElement(parameter));
    {
      CustomMPSConfigurationType_ConfigurationType configType = ContainerUtil.findInstance(Extensions.getExtensions(CustomMPSConfigurationType_ConfigurationType.CONFIGURATION_TYPE_EP), CustomMPSConfigurationType_ConfigurationType.class);
      DefaultCustomMpsApplication_Configuration _config = new DefaultCustomMpsApplication_Configuration(DefaultCustomMpsLanguageConfigurationFromConfiguration.this.getContext().getProject(), configType.getConfigurationFactories()[0], "NewConfig");
      _config.setName(SPropertyOperations.getString(layout.value, "name") + "." + SPropertyOperations.getString(parameter, "name"));
      _config.getStateObject().nodeId = layout.value.getId();
      _config.getStateObject().modelId = layout.value.getModel().getModelDescriptor().getSModelReference().toString();
      _config.getStateObject().configurationId = configurationId.value;
      DefaultCustomMpsLanguageConfigurationFromConfiguration.this.myConfig = _config;
    }
  }

  @Override
  public DefaultCustomMpsLanguageConfigurationFromConfiguration clone() {
    return ((DefaultCustomMpsLanguageConfigurationFromConfiguration) super.clone());
  }

  protected boolean isApplicable(final Object element) {
    return element instanceof SNode && SNodeOperations.isInstanceOf(((SNode) element), "jetbrains.mps.build.packaging.structure.Configuration");
  }
}
