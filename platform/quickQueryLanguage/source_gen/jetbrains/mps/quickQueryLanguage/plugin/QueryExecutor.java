package jetbrains.mps.quickQueryLanguage.plugin;

/*Generated by MPS */

import jetbrains.mps.smodel.SNode;
import jetbrains.mps.quickQueryLanguage.runtime.Query;
import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.ide.findusages.model.SearchQuery;
import jetbrains.mps.ide.findusages.model.SearchResults;
import jetbrains.mps.ide.embeddableEditor.GenerateResult;
import jetbrains.mps.smodel.ModelAccess;
import java.util.List;
import java.util.ArrayList;
import jetbrains.mps.ide.findusages.model.SearchResult;
import jetbrains.mps.ide.findusages.view.UsagesViewTool;
import org.jetbrains.annotations.NotNull;
import com.intellij.openapi.progress.ProgressIndicator;
import jetbrains.mps.smodel.IScope;
import jetbrains.mps.smodel.SModelUtil_new;
import jetbrains.mps.project.GlobalScope;
import jetbrains.mps.ide.findusages.model.holders.NodeHolder;
import jetbrains.mps.bootstrap.smodelLanguage.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.ide.findusages.findalgorithm.finders.BaseFinder;
import jetbrains.mps.ide.findusages.view.FindUtils;

public class QueryExecutor {

  private final String myClassType = ".Query";
  private String myClassName;
  private ClassLoader myLoader;
  private SNode myModelQuery;
  private Query myQuery;
  private IOperationContext myContext;
  private SearchQuery mySearchQuery;
  private SearchResults myResult;

  public QueryExecutor(final GenerateResult generateResult) {
    this.setFields(generateResult);
    if (generateResult.getModelDescriptor() != null) {
      this.myClassName = generateResult.getModelDescriptor().getLongName() + this.myClassType;
      ModelAccess.instance().runReadAction(new Runnable() {

        public void run() {
          QueryExecutor.this.myLoader = generateResult.getLoader(QueryExecutor.this.getClass().getClassLoader());
        }

      });
    }
  }
  public QueryExecutor(IOperationContext context, Query query) {
    this.myContext = context;
    this.myQuery = query;
  }

  private void setFields(GenerateResult result) {
    this.myModelQuery = result.getSNode();
    this.myContext = result.getOperationContext();
  }

  public void setSNode(SNode node) {
    this.myModelQuery = node;
  }

  private List<SNode> getExecuteResult() {
    List<SNode> results = new ArrayList<SNode>();
    List<SearchResult<SNode>> resultsList = this.myResult.getSearchResults();
    for(SearchResult<SNode> nodeResult : resultsList) {
      results.add(nodeResult.getObject());
    }
    return results;
  }

  public void replace() {
    final List<SNode> replaceNodes = this.getExecuteResult();
    ModelAccess.instance().runWriteActionInCommand(new Runnable() {

      public void run() {
        for(SNode node : replaceNodes) {
          QueryExecutor.this.myQuery.doReplace(node);
        }
      }

    });
  }

  public void showResults() {
    this.myContext.getProject().getComponent(UsagesViewTool.class).showResults(this.mySearchQuery, this.myResult);
  }

  public void run(@NotNull() final ProgressIndicator indicator, final IScope scope) {
    ModelAccess.instance().runReadAction(new Runnable() {

      public void run() {
        try {
          QueryExecutor.this.myQuery = (Query)Class.forName(QueryExecutor.this.myClassName, true, QueryExecutor.this.myLoader).newInstance();
          /*
            String conceptFqName = QueryExecutor.this.myQuery.getConcept();
            SNode c = SModelUtil_new.findConceptDeclaration(conceptFqName, GlobalScope.getInstance());
          */
          QueryExecutor.this.mySearchQuery = new SearchQuery(new NodeHolder(SLinkOperations.getTarget(QueryExecutor.this.myModelQuery, "conceptDeclaration", false)), scope);
          BaseFinder[] finders = new BaseFinder[1];
          finders[0] = new QueryFinder(QueryExecutor.this.myQuery);
          QueryExecutor.this.myResult = FindUtils.getSearchResults(indicator, QueryExecutor.this.mySearchQuery, finders);
        } catch (Throwable t) {
          t.printStackTrace();
        }
      }

    });
  }

  public void execute(@NotNull() final ProgressIndicator indicator, final IScope scope) {
    ModelAccess.instance().runReadAction(new Runnable() {

      public void run() {
        try {
          QueryExecutor.this.mySearchQuery = new SearchQuery(new NodeHolder(SLinkOperations.getTarget(QueryExecutor.this.myModelQuery, "conceptDeclaration", false)), scope);
          BaseFinder[] finders = new BaseFinder[1];
          finders[0] = new QueryFinder(QueryExecutor.this.myQuery);
          QueryExecutor.this.myResult = FindUtils.getSearchResults(indicator, QueryExecutor.this.mySearchQuery, finders);
        } catch (Throwable t) {
          t.printStackTrace();
        }
      }

    });
  }

}
