package jetbrains.mps.quickQueryLanguage.plugin;

/*Generated by MPS */

import jetbrains.mps.smodel.SNode;
import com.intellij.openapi.project.Project;
import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.closures.runtime.Wrappers;
import jetbrains.mps.smodel.SModelDescriptor;
import jetbrains.mps.smodel.ModelOwner;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.smodel.ProjectModels;
import jetbrains.mps.bootstrap.smodelLanguage.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.ide.embeddableEditor.EditorGenerationType;
import jetbrains.mps.generator.GeneratorManager;
import java.util.Arrays;
import jetbrains.mps.smodel.SModelRepository;
import jetbrains.mps.project.IModule;
import jetbrains.mps.project.GlobalScope;
import jetbrains.mps.reloading.ClassLoaderManager;
import jetbrains.mps.ide.embeddableEditor.GenerateResult;
import org.jetbrains.annotations.NotNull;
import com.intellij.openapi.progress.ProgressIndicator;
import jetbrains.mps.smodel.IScope;
import jetbrains.mps.ide.findusages.model.SearchQuery;
import jetbrains.mps.ide.findusages.model.holders.NodeHolder;
import jetbrains.mps.bootstrap.smodelLanguage.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.ide.findusages.findalgorithm.finders.BaseFinder;
import jetbrains.mps.bootstrap.structureLanguage.findUsages.ConceptInstances_Finder;
import jetbrains.mps.ide.findusages.model.SearchResults;
import jetbrains.mps.ide.findusages.view.FindUtils;
import jetbrains.mps.quickQueryLanguage.runtime.Query;
import java.util.List;
import jetbrains.mps.ide.findusages.model.SearchResult;
import java.util.Iterator;
import jetbrains.mps.ide.findusages.view.UsagesViewTool;

public class QueryExecutor {

  private final String myClassType = ".Query";
  private final String myLanguageFqName = "jetbrains.mps.quickQueryLanguage";
  private String myClassName;
  private ClassLoader myLoader;
  private SNode myModelQuery;
  private Project myProject;

  public QueryExecutor(IOperationContext context, SNode modelQuery) {
    this.myModelQuery = modelQuery;
    this.myProject = context.getProject();
    final Wrappers._T<SModelDescriptor> model = new Wrappers._T<SModelDescriptor>();
    final ModelOwner owner = new ModelOwner() {
    };
    ModelAccess.instance().runWriteActionInCommand(new Runnable() {

      public void run() {
        model.value = ProjectModels.createDescriptorFor(owner);
        model.value.getSModel().addRoot(SNodeOperations.copyNode(QueryExecutor.this.myModelQuery));
      }

    });
    final EditorGenerationType type = new EditorGenerationType();
    this.myClassName = model.value.getLongName() + this.myClassType;
    GeneratorManager manager = context.getComponent(GeneratorManager.class);
    manager.generateModelsWithProgressWindow(Arrays.asList(model.value), context, type, false);
    SModelRepository.getInstance().unRegisterModelDescriptors(owner);
    ModelAccess.instance().runReadAction(new Runnable() {

      public void run() {
        IModule lang = GlobalScope.getInstance().getLanguage(QueryExecutor.this.myLanguageFqName);
        ClassLoader parentClassLoader = ClassLoaderManager.getInstance().getClassLoaderFor(lang);
        QueryExecutor.this.myLoader = type.getClassLoader(parentClassLoader);
      }

    });
  }
  public QueryExecutor(GenerateResult genResult, EditorGenerationType type) {
    this.myProject = genResult.getOperationContext().getProject();
    this.myLoader = genResult.getClassLoader();
    SModelDescriptor model = genResult.getModelDescriptor();
    this.myClassName = model.getLongName() + this.myClassType;
    GeneratorManager manager = genResult.getOperationContext().getComponent(GeneratorManager.class);
    manager.generateModelsWithProgressWindow(Arrays.asList(model), genResult.getOperationContext(), type, false);
    this.myModelQuery = model.getSModel().getRoots().get(0);
  }

  public void run(@NotNull() final ProgressIndicator indicator, final IScope scope) {
    ModelAccess.instance().runReadAction(new Runnable() {

      public void run() {
        try {
          SearchQuery searchQuery = new SearchQuery(new NodeHolder(SLinkOperations.getTarget(QueryExecutor.this.myModelQuery, "conceptDeclaration", false)), scope);
          BaseFinder[] finders = new BaseFinder[1];
          finders[0] = new ConceptInstances_Finder();
          SearchResults instances = FindUtils.getSearchResults(indicator, searchQuery, finders);
          Query queryInstance = (Query)Class.forName(QueryExecutor.this.myClassName, true, QueryExecutor.this.myLoader).newInstance();
          List<SearchResult<SNode>> instancesList = instances.getSearchResults();
          Iterator<SearchResult<SNode>> it = instancesList.iterator();
          while (it.hasNext()) {
            SearchResult<SNode> current = it.next();
            if (!(queryInstance.isSatisfies(current.getObject()))) {
              it.remove();
            }
          }
          QueryExecutor.this.myProject.getComponent(UsagesViewTool.class).showResults(searchQuery, new SearchResults(instances.getSearchedNodes(), instancesList));
        } catch (Throwable t) {
          t.printStackTrace();
        }
      }

    });
  }

}
