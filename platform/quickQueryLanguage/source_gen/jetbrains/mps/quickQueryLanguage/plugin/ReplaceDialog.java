package jetbrains.mps.quickQueryLanguage.plugin;

/*Generated by MPS */

import jetbrains.mps.ide.dialogs.BaseDialog;
import jetbrains.mps.ide.embeddableEditor.EmbeddableEditor;
import jetbrains.mps.ide.findusages.view.optionseditor.components.ScopeEditor;
import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.smodel.SNode;
import javax.swing.JPanel;
import java.awt.BorderLayout;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.bootstrap.smodelLanguage.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.ide.findusages.view.optionseditor.options.ScopeOptions;
import jetbrains.mps.smodel.ModelOwner;
import java.awt.Dimension;
import javax.swing.JComponent;
import jetbrains.mps.bootstrap.smodelLanguage.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.ide.embeddableEditor.GenerateResult;
import jetbrains.mps.smodel.IScope;
import com.intellij.openapi.progress.ProgressManager;
import com.intellij.openapi.progress.Task;
import org.jetbrains.annotations.NotNull;
import com.intellij.openapi.progress.ProgressIndicator;
import jetbrains.mps.quickQueryLanguage.runtime.Query;
import java.util.List;

public class ReplaceDialog extends BaseDialog {

  private EmbeddableEditor myEditor;
  private ScopeEditor myScope;
  private IOperationContext myContext;
  private SNode myNode;
  private JPanel myPanel = new JPanel(new BorderLayout());

  public ReplaceDialog(IOperationContext context, Language language) {
    super(context.getMainFrame(), "Replace");
    this.myContext = context;
    ModelAccess.instance().runReadAction(new Runnable() {

      public void run() {
        ReplaceDialog.this.myNode = SConceptOperations.createNewNode("jetbrains.mps.quickQueryLanguage.structure.ReplaceModelQuery", null);
        ReplaceDialog.this.myScope = new ScopeEditor(new ScopeOptions());
        ReplaceDialog.this.myPanel.add(ReplaceDialog.this.myScope.getComponent(), BorderLayout.SOUTH);
      }

    });
    this.myEditor = new EmbeddableEditor(context, new ModelOwner() {
    });
    this.myEditor.setNode(this.myNode);
    this.myEditor.addLanguage(language);
    this.myPanel.add(this.myEditor.getComponent(), BorderLayout.CENTER);
    this.setSize(new Dimension(500, 500));
    this.setModal(false);
  }

  protected JComponent getMainComponent() {
    return this.myPanel;
  }

  public void setConceptDeclaration(final SNode declaration) {
    ModelAccess.instance().runWriteActionInCommand(new Runnable() {

      public void run() {
        SLinkOperations.setTarget(ReplaceDialog.this.myNode, "conceptDeclaration", declaration, false);
      }

    });
  }

  @BaseDialog.Button(position = 0, name = "Replace", defaultButton = true)
  public void buttonReplace() {
    GenerateResult result = this.myEditor.generate();
    final QueryExecutor executor = new QueryExecutor(result);
    final IScope scope = this.myScope.getOptions().getScope(this.myContext, result.getModelDescriptor());
    ProgressManager.getInstance().run(new Task.Modal(ReplaceDialog.this.myContext.getProject(), "Executing query", false) {

      public void run(@NotNull() ProgressIndicator indicator) {
        executor.run(indicator, scope);
      }

    });
    final Query query = executor.getQuery();
    final List<SNode> replaceNodes = executor.getSearchResult();
    ModelAccess.instance().runWriteActionInCommand(new Runnable() {

      public void run() {
        for(SNode node : replaceNodes) {
          query.doReplace(node);
        }
      }

    });
  }

  @BaseDialog.Button(position = 1, name = "Cancel", defaultButton = false)
  public void buttonCancel() {
    this.myEditor.disposeEditor();
    this.dispose();
  }

}
