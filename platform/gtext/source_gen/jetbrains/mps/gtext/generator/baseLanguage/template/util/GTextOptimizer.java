package jetbrains.mps.gtext.generator.baseLanguage.template.util;

/*Generated by MPS */

import jetbrains.mps.smodel.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.List;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;

public class GTextOptimizer {

  public static SNode optimize(SNode item, boolean mayReplace) {
    if (SNodeOperations.isInstanceOf(item, "webr.gtext.structure.GItemList") || SNodeOperations.isInstanceOf(item, "webr.gtext.structure.GConditionalLine") || SNodeOperations.isInstanceOf(item, "webr.gtext.structure.GLine")) {
      if (optimizeItems(item) == 1 && mayReplace && SNodeOperations.isInstanceOf(item, "webr.gtext.structure.GItemList")) {
        SNode child = item.getChildren("item").get(0);
        SNodeOperations.replaceWithAnother(item, child);
        item = child;
      }
      return item;
    }
    return item;
  }

  public static SNode optimize(SNode item) {
    return optimize(item, true);
  }

  public static int optimizeItems(SNode item) {
    // inline item lists
    SNode n = item;
    for(SNode child : (List<SNode>)n.getChildren("item")) {
      SNode optChild = optimize(child);
      if (SNodeOperations.isInstanceOf(optChild, "webr.gtext.structure.GItemList")) {
        inlineChildren(optChild, optChild);
        SNodeOperations.deleteNode(optChild);
      } else
      if (SNodeOperations.isInstanceOf(optChild, "webr.gtext.structure.GConditionalLine")) {
        SNode nextChild = optChild;
        if (SPropertyOperations.getBoolean(optChild, "isSeparate")) {
          SNodeOperations.insertNextSiblingChild(nextChild, SModelOperations.createNewNode(SNodeOperations.getModel(item), "webr.gtext.structure.GIndent", null));
          nextChild = (SNode)SNodeOperations.getNextSibling(nextChild);
        }
        nextChild = inlineChildren(optChild, nextChild);
        if (SPropertyOperations.getBoolean(optChild, "isSeparate")) {
          SNodeOperations.insertNextSiblingChild(nextChild, SModelOperations.createNewNode(SNodeOperations.getModel(item), "webr.gtext.structure.GNewLine", null));
        }
        SNodeOperations.deleteNode(optChild);
      } else
      if (SNodeOperations.isInstanceOf(optChild, "webr.gtext.structure.GLine")) {
        SNode nextChild = optChild;
        SNodeOperations.insertNextSiblingChild(nextChild, SModelOperations.createNewNode(SNodeOperations.getModel(item), "webr.gtext.structure.GIndent", null));
        nextChild = (SNode)SNodeOperations.getNextSibling(nextChild);
        nextChild = inlineChildren(optChild, nextChild);
        SNodeOperations.insertNextSiblingChild(nextChild, SModelOperations.createNewNode(SNodeOperations.getModel(item), "webr.gtext.structure.GNewLine", null));
        SNodeOperations.deleteNode(optChild);
      }
    }
    // concat text
    SNode t = null;
    for(SNode child : (List<SNode>)n.getChildren("item")) {
      if (SNodeOperations.isInstanceOf(child, "webr.gtext.structure.GText")) {
        if (t == null) {
          t = child;
        } else
        {
          String text = SPropertyOperations.getString(child, "text");
          if (text != null) {
            SPropertyOperations.set(t, "text", SPropertyOperations.getString(t, "text") + text);
          }
          SNodeOperations.deleteNode(child);
        }
      } else
      {
        t = null;
      }
    }
    return n.getChildren("item").size();
  }

  public static SNode inlineChildren(SNode optChild, SNode nextChild) {
    SNode nc = nextChild;
    // cast to GItemList, because all item list containers have the same name for children items - "item"
    while (ListSequence.fromList(SLinkOperations.getTargets(optChild, "item", true)).isNotEmpty()) {
      SNode childOfChild = ListSequence.fromList(SLinkOperations.getTargets(optChild, "item", true)).first();
      SNodeOperations.insertNextSiblingChild(nc, childOfChild);
      nc = childOfChild;
    }
    return nc;
  }

}
