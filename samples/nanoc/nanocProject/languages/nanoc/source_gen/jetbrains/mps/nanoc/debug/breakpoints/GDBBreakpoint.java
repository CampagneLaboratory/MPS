package jetbrains.mps.nanoc.debug.breakpoints;

/*Generated by MPS */

import jetbrains.mps.debug.api.AbstractMPSBreakpoint;
import jetbrains.mps.nanoc.debug.requests.BreakpointRequestor;
import jetbrains.mps.smodel.SNodePointer;
import com.intellij.openapi.project.Project;
import jetbrains.mps.nanoc.debug.CppDebugSession;
import jetbrains.mps.nanoc.debug.requests.GDBRequestManager;
import jetbrains.mps.nanoc.debug.answer.ResultAnswer;
import java.util.List;
import jetbrains.mps.nanoc.debug.answer.StreamAnswer;
import jetbrains.mps.nanoc.debug.answer.RecordValue;
import jetbrains.mps.nanoc.debug.answer.StringValue;
import jetbrains.mps.nanoc.debug.requests.RemoveBreakpointRequestor;

public class GDBBreakpoint extends AbstractMPSBreakpoint {
  private static final String BKPT = "bkpt";
  private static final String NUMBER = "number";

  /*package*/ BreakpointRequestor myBreakpointRequestor;
  /*package*/ boolean myAdded = false;
  /*package*/ int myInternalGDBNumber = -1;

  public GDBBreakpoint(SNodePointer nodePointer, Project project) {
    super(nodePointer, project);
  }

  @Override
  public void removeFromRunningSessions() {
    CppDebugSession.performAllSessionsAction(myProject, new CppDebugSession.DebugSessionAction() {
      @Override
      public void run(CppDebugSession debugSession) {
        createRemoveBreakpointRequest(debugSession.getGDBRequestManager());
      }
    });
  }

  @Override
  public void addToRunningSessions() {
    CppDebugSession.performAllSessionsAction(myProject, new CppDebugSession.DebugSessionAction() {
      @Override
      public void run(CppDebugSession debugSession) {
        createBreakpointRequest(debugSession.getGDBRequestManager());
      }
    });
  }

  public void createBreakpointRequest(GDBRequestManager requestManager) {
    requestManager.createRequest(new BreakpointRequestor(getFileName(), getLineIndexInFile()) {
      @Override
      public void onRequestFulfilled(ResultAnswer answer, List<StreamAnswer> receivedStreamAnswers) {
        myAdded = true;
        RecordValue bkptInfo = (RecordValue) answer.getResults().getPropertyValue(GDBBreakpoint.BKPT);
        StringValue numberValue = (StringValue) bkptInfo.getPropertyValue(GDBBreakpoint.NUMBER);
        int number = Integer.parseInt(numberValue.getString());
        myInternalGDBNumber = number;
      }
    });
  }

  public void createRemoveBreakpointRequest(GDBRequestManager requestManager) {
    requestManager.createRequest(new RemoveBreakpointRequestor(myInternalGDBNumber) {
      @Override
      public void onRequestFulfilled(ResultAnswer answer, List<StreamAnswer> receivedStreamAnswers) {
        myAdded = false;
        myInternalGDBNumber = -1;
      }
    });
  }
}
