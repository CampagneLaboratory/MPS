package jetbrains.mps.lang.core.plugin;

/*Generated by MPS */

import jetbrains.mps.generator.IncrementalGenerationStrategy;
import jetbrains.mps.generator.GenerationCacheContainer;
import jetbrains.mps.generator.impl.dependencies.GenerationDependencies;
import jetbrains.mps.smodel.SModelDescriptor;
import jetbrains.mps.generator.impl.dependencies.GenerationDependenciesCache;
import java.util.Map;
import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.smodel.descriptor.GeneratableSModelDescriptor;
import jetbrains.mps.generator.ModelDigestHelper;
import java.util.Collections;

public class MakeGenerationStrategy implements IncrementalGenerationStrategy {
  private final GenerationCacheContainer cache;
  private final boolean isIncremental;

  public MakeGenerationStrategy(GenerationCacheContainer cache, boolean isIncremental) {
    this.cache = cache;
    this.isIncremental = isIncremental;
  }

  @Override
  public GenerationDependencies getDependencies(SModelDescriptor descriptor) {
    return (isIncremental ?
      GenerationDependenciesCache.getInstance().get(descriptor) :
      null
    );
  }

  @Override
  public GenerationCacheContainer getContainer() {
    return cache;
  }

  @Override
  public Map<String, String> getModelHashes(SModelDescriptor md, IOperationContext context) {
    if (!(md instanceof GeneratableSModelDescriptor)) {
      return null;
    }
    GeneratableSModelDescriptor sm = (GeneratableSModelDescriptor) md;
    if (!(sm.isGeneratable())) {
      return null;
    }

    Map<String, String> generationHashes = ModelDigestHelper.getInstance().getGenerationHashes(sm, context);
    if (generationHashes != null) {
      return generationHashes;
    }

    String hash = sm.getModelHash();
    return (hash != null ?
      Collections.singletonMap(ModelDigestHelper.FILE, hash) :
      null
    );
  }

  @Override
  public boolean isIncrementalEnabled() {
    return isIncremental;
  }
}
