package jetbrains.mps.graphLayout.flowOrthogonalLayout;

/*Generated by MPS */

import java.util.Set;
import jetbrains.mps.graphLayout.graph.Edge;
import jetbrains.mps.graphLayout.graph.Node;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import java.util.Map;
import jetbrains.mps.graphLayout.planarGraph.Dart;
import jetbrains.mps.graphLayout.planarGraph.EmbeddedGraph;
import jetbrains.mps.graphLayout.graph.Graph;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.graphLayout.planarGraph.Face;
import java.util.List;
import jetbrains.mps.graphLayout.algorithms.MinCostMaxFlowWithPotentials;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;
import java.util.HashSet;

public class QuasiOrthogonalRepresentation {
  private static int INF = 1000000;
  private static int SHOW_INFO = 0;

  private Set<Edge> myStraightEdges;
  private Set<Edge> myRealEdges;
  private Set<Node> myRealNodes;

  public QuasiOrthogonalRepresentation() {
    myStraightEdges = null;
    myRealEdges = null;
    myRealNodes = null;
  }

  public void setStraightEdges(Set<Edge> straightEdges) {
    myStraightEdges = straightEdges;
  }

  public void setRealEdges(Set<Edge> realEdges) {
    myRealEdges = realEdges;
  }

  public void setRealNodes(Set<Node> realNodes) {
    myRealNodes = realNodes;
  }

  public Tuples._2<Map<Dart, Integer>, Map<Dart, Integer>> getRepresentation(EmbeddedGraph embeddedGraph) {
    Graph graph = embeddedGraph.getGraph();
    int c = 100 * graph.getNumNodes();
    Graph network = new Graph();
    Node networkSource = network.createNode();
    Node networkTarget = network.createNode();
    Map<Edge, Integer> capacity = MapSequence.<Edge,Integer>fromMap(new HashMap<Edge, Integer>());
    Map<Edge, Integer> cost = MapSequence.<Edge,Integer>fromMap(new HashMap<Edge, Integer>());
    Map<Node, Node> nodeMap = MapSequence.<Node,Node>fromMap(new HashMap<Node, Node>());
    for (Node node : ListSequence.<Node>fromList(graph.getNodes())) {
      Node networkNode = network.createNode();
      MapSequence.<Node,Node>fromMap(nodeMap).put(node, networkNode);
      int deg = ListSequence.<Edge>fromList(node.getEdges()).count();
      Edge edge = null;
      if (deg < 4) {
        edge = network.connect(networkSource, networkNode);
      }
      if (deg > 4) {
        edge = network.connect(networkNode, networkTarget);
      }
      if (edge != null) {
        MapSequence.<Edge,Integer>fromMap(cost).put(edge, 0);
        MapSequence.<Edge,Integer>fromMap(capacity).put(edge, Math.abs(deg - 4));
      }
    }
    Map<Face, Node> faceMap = MapSequence.<Face,Node>fromMap(new HashMap<Face, Node>());
    for (Face face : ListSequence.<Face>fromList(embeddedGraph.getFaces())) {
      Node networkNode = network.createNode();
      MapSequence.<Face,Node>fromMap(faceMap).put(face, networkNode);
      int deg = ListSequence.<Dart>fromList(face.getDarts()).count();
      if (embeddedGraph.isOuterFace(face)) {
        Edge edge = network.connect(networkNode, networkTarget);
        MapSequence.<Edge,Integer>fromMap(cost).put(edge, 0);
        MapSequence.<Edge,Integer>fromMap(capacity).put(edge, deg + 4);
      } else {
        Edge edge = null;
        if (deg < 4) {
          edge = network.connect(networkSource, networkNode);
        }
        if (deg > 4) {
          edge = network.connect(networkNode, networkTarget);
        }
        if (edge != null) {
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, 0);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, Math.abs(deg - 4));
        }
      }
    }
    Map<Dart, Edge> dartBendMap = MapSequence.<Dart,Edge>fromMap(new HashMap<Dart, Edge>());
    Map<Dart, Edge> dartAngleMap = MapSequence.<Dart,Edge>fromMap(new HashMap<Dart, Edge>());
    for (Face face : ListSequence.<Face>fromList(embeddedGraph.getFaces())) {
      Node faceNode = MapSequence.<Face,Node>fromMap(faceMap).get(face);
      for (Dart dart : ListSequence.<Dart>fromList(face.getDarts())) {
        Edge graphEdge = dart.getEdge();
        Edge edge;
        edge = network.connect(MapSequence.<Node,Node>fromMap(nodeMap).get(dart.getSource()), faceNode);
        MapSequence.<Dart,Edge>fromMap(dartAngleMap).put(dart, edge);
        MapSequence.<Edge,Integer>fromMap(capacity).put(edge, INF);
        MapSequence.<Edge,Integer>fromMap(cost).put(edge, 0);
        Dart oppositeDart = embeddedGraph.getOpposite(dart);
        Node oppositeFaceNode = MapSequence.<Face,Node>fromMap(faceMap).get(embeddedGraph.getFace(oppositeDart));
        edge = network.connect(faceNode, oppositeFaceNode);
        MapSequence.<Dart,Edge>fromMap(dartBendMap).put(dart, edge);
        MapSequence.<Edge,Integer>fromMap(capacity).put(edge, getCapacity(graphEdge));
        MapSequence.<Edge,Integer>fromMap(cost).put(edge, getCost(graphEdge));
      }
    }
    Map<Node, Map<Face, Edge>> faceToNodeEdges = MapSequence.<Node,Map<Face, Edge>>fromMap(new HashMap<Node, Map<Face, Edge>>());
    Map<Edge, Dart> tempEdgesToDart = MapSequence.<Edge,Dart>fromMap(new HashMap<Edge, Dart>());
    for (Node node : ListSequence.<Node>fromList(graph.getNodes())) {
      if (this.isParallelEdgeNode(node)) {
        List<Dart> darts = embeddedGraph.getDartWithSource(node);
        Map<Face, Node> faceNodes = MapSequence.<Face,Node>fromMap(new HashMap<Face, Node>());
        Map<Face, Edge> faceEdges = MapSequence.<Face,Edge>fromMap(new HashMap<Face, Edge>());
        for (Dart dart : ListSequence.<Dart>fromList(darts)) {
          Node faceNode = network.createNode();
          Face face = embeddedGraph.getFace(dart);
          MapSequence.<Face,Node>fromMap(faceNodes).put(face, faceNode);
          Edge edge;
          edge = network.connect(faceNode, MapSequence.<Node,Node>fromMap(nodeMap).get(node));
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, 0);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 1);
          MapSequence.<Face,Edge>fromMap(faceEdges).put(face, edge);
        }
        for (Dart dart : ListSequence.<Dart>fromList(darts)) {
          Face face = embeddedGraph.getFace(dart);
          Face leftFace = embeddedGraph.getFace(embeddedGraph.getOpposite(dart));
          Edge edge;
          edge = network.connect(MapSequence.<Face,Node>fromMap(faceMap).get(leftFace), MapSequence.<Face,Node>fromMap(faceNodes).get(face));
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, 1);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 1);
          MapSequence.<Edge,Dart>fromMap(tempEdgesToDart).put(edge, dart);
        }
        MapSequence.<Node,Map<Face, Edge>>fromMap(faceToNodeEdges).put(node, faceEdges);
      }
    }
    /*
      for (Node node : ListSequence.<Node>fromList(graph.getNodes())) {
        List<Dart> darts = embeddedGraph.getDartWithSource(node);
        Map<Face, Node> faceNodes = MapSequence.<Face,Node>fromMap(new HashMap<Face, Node>());
        Map<Face, Edge> faceEdges = MapSequence.<Face,Edge>fromMap(new HashMap<Face, Edge>());
        for (Dart dart : ListSequence.<Dart>fromList(darts)) {
          Node faceNode = network.createNode();
          Face face = embeddedGraph.getFace(dart);
          MapSequence.<Face,Node>fromMap(faceNodes).put(face, faceNode);
          Edge edge = faceNode.addEdgeTo(MapSequence.<Node,Node>fromMap(nodeMap).get(node));
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, 0);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 1);
          MapSequence.<Face,Edge>fromMap(faceEdges).put(face, edge);
        }
        for (Dart dart : ListSequence.<Dart>fromList(darts)) {
          Node left = network.createNode();
          Node right = network.createNode();
          Edge edge = left.addEdgeTo(right);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 1);
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, -c);
          edge = right.addEdgeTo(left);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 1);
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, -c);
          Face rightFace = embeddedGraph.getFace(dart);
          Face leftFace = embeddedGraph.getFace(embeddedGraph.getOpposite(dart));
          edge = MapSequence.<Face,Node>fromMap(faceMap).get(rightFace).addEdgeTo(right);
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, 2 * c + 1);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 1);
          edge = MapSequence.<Face,Node>fromMap(faceMap).get(leftFace).addEdgeTo(left);
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, 2 * c + 1);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 1);
          edge = right.addEdgeTo(MapSequence.<Face,Node>fromMap(faceNodes).get(leftFace));
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, 0);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 1);
          MapSequence.<Edge,Dart>fromMap(tempEdgesToDart).put(edge, dart);
          edge = left.addEdgeTo(MapSequence.<Face,Node>fromMap(faceNodes).get(rightFace));
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, 0);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 1);
          MapSequence.<Edge,Dart>fromMap(tempEdgesToDart).put(edge, dart);
        }
        MapSequence.<Node,Map<Face, Edge>>fromMap(faceToNodeEdges).put(node, faceEdges);
      }
    */
    Map<Edge, Integer> flow = MinCostMaxFlowWithPotentials.getFlow(network, networkSource, networkTarget, capacity, cost);
    Map<Dart, Integer> bends = MapSequence.<Dart,Integer>fromMap(new HashMap<Dart, Integer>());
    Map<Dart, Integer> angles = MapSequence.<Dart,Integer>fromMap(new HashMap<Dart, Integer>());
    for (Face face : ListSequence.<Face>fromList(embeddedGraph.getFaces())) {
      for (Dart dart : ListSequence.<Dart>fromList(face.getDarts())) {
        Node source = dart.getSource();
        int angle = MapSequence.<Edge,Integer>fromMap(flow).get(MapSequence.<Dart,Edge>fromMap(dartAngleMap).get(dart)) + 1;
        if (MapSequence.<Face,Edge>fromMap(MapSequence.<Node,Map<Face, Edge>>fromMap(faceToNodeEdges).get(source)).get(face) != null && MapSequence.<Edge,Integer>fromMap(flow).get(MapSequence.<Face,Edge>fromMap(MapSequence.<Node,Map<Face, Edge>>fromMap(faceToNodeEdges).get(source)).get(face)) > 0) {
          angle -= 1;
        }
        MapSequence.<Dart,Integer>fromMap(angles).put(dart, angle);
      }
    }
    for (Dart dart : SetSequence.<Dart>fromSet(MapSequence.fromMap(dartBendMap).keySet())) {
      MapSequence.<Dart,Integer>fromMap(bends).put(dart, MapSequence.<Edge,Integer>fromMap(flow).get(MapSequence.<Dart,Edge>fromMap(dartBendMap).get(dart)));
    }
    for (Face face : ListSequence.<Face>fromList(embeddedGraph.getFaces())) {
      List<Dart> darts = face.getDarts();
      for (Dart dart : ListSequence.<Dart>fromList(darts)) {
        Node node = dart.getSource();
        Edge edgeToNode = MapSequence.<Face,Edge>fromMap(MapSequence.<Node,Map<Face, Edge>>fromMap(faceToNodeEdges).get(node)).get(face);
        if (edgeToNode != null && MapSequence.<Edge,Integer>fromMap(flow).get(edgeToNode) > 0) {
          Dart dartWithBend = embeddedGraph.getOpposite(dart);
          MapSequence.<Dart,Integer>fromMap(bends).put(dartWithBend, MapSequence.<Dart,Integer>fromMap(bends).get(dartWithBend) + 1);
        }
      }
    }
    /*
      for (Face face : ListSequence.<Face>fromList(embeddedGraph.getFaces())) {
        List<Dart> darts = face.getDarts();
        Dart prev = ListSequence.<Dart>fromList(darts).last();
        for (Dart dart : ListSequence.<Dart>fromList(darts)) {
          Node node = dart.getSource();
          Edge edgeToNode = MapSequence.<Face,Edge>fromMap(MapSequence.<Node,Map<Face, Edge>>fromMap(faceToNodeEdges).get(node)).get(face);
          if (MapSequence.<Edge,Integer>fromMap(flow).get(edgeToNode) > 0) {
            Node faceNode = edgeToNode.getSource();
            List<Edge> prevEdges = faceNode.getInEdges();
            for (Edge prevEdge : ListSequence.<Edge>fromList(prevEdges)) {
              if (MapSequence.<Edge,Integer>fromMap(flow).get(prevEdge) > 0) {
                Dart flowDart = MapSequence.<Edge,Dart>fromMap(tempEdgesToDart).get(prevEdge);
                Dart dartWithBend = null;
                if (flowDart == dart) {
                  dartWithBend = embeddedGraph.getOpposite(dart);
                }
                if (flowDart == embeddedGraph.getOpposite(prev)) {
                  dartWithBend = embeddedGraph.getOpposite(prev);
                }
                if (dartWithBend == null) {
                  throw new RuntimeException("bad bend dart!");
                }
                MapSequence.<Dart,Integer>fromMap(bends).put(dartWithBend, MapSequence.<Dart,Integer>fromMap(bends).get(dartWithBend) + 1);
              }
            }
          }
          prev = dart;
        }
      }
    */
    if (SHOW_INFO > 0) {
      for (Node node : ListSequence.<Node>fromList(graph.getNodes())) {
        System.out.println("node " + node);
        for (Dart dart : ListSequence.<Dart>fromList(embeddedGraph.getDartWithSource(node))) {
          System.out.println(dart + " angle = " + MapSequence.<Dart,Integer>fromMap(angles).get(dart) + ", bends = " + MapSequence.<Dart,Integer>fromMap(bends).get(dart) + ", opposite bends = " + MapSequence.<Dart,Integer>fromMap(bends).get(embeddedGraph.getOpposite(dart)));
        }
      }
      int totalCost = 0;
      for (Edge edge : ListSequence.<Edge>fromList(network.getEdges())) {
        totalCost += MapSequence.<Edge,Integer>fromMap(flow).get(edge) * MapSequence.<Edge,Integer>fromMap(cost).get(edge);
      }
      System.out.println("!!! total cost = " + totalCost);
      int totalBendsNumber = 0;
      for (Integer value : Sequence.<Integer>fromIterable(MapSequence.fromMap(bends).values())) {
        totalBendsNumber += value;
      }
      System.out.println("!!! total bends number = " + totalBendsNumber);
      if (totalBendsNumber != totalCost) {
        throw new RuntimeException("total cost is not equal to bends number");
      }
    }
    return MultiTuple.<Map<Dart, Integer>,Map<Dart, Integer>>from(bends, angles);
  }

  private boolean isParallelEdgeNode(Node node) {
    return SetSequence.<Node>fromSet(myRealNodes).contains(node) || ListSequence.<Edge>fromList(node.getEdges()).count() > 4;
  }

  private int getCapacity(Edge edge) {
    if (SetSequence.<Edge>fromSet(myStraightEdges).contains(edge)) {
      System.out.println("edge " + edge + " is straight");
      return 0;
    } else {
      return INF;
    }
  }

  private int getCost(Edge edge) {
    int cost;
    if (SetSequence.<Edge>fromSet(myRealEdges).contains(edge)) {
      cost = 50;
    } else {
      cost = 1;
    }
    return cost;
  }

  public static void getRepresentation(EmbeddedGraph embeddedGraph, Map<Dart, Integer> bends, Map<Dart, Integer> angles) {
    getRepresentation(embeddedGraph, bends, angles, SetSequence.<Edge>fromSet(new HashSet<Edge>()));
  }

  public static void getRepresentation(EmbeddedGraph embeddedGraph, Map<Dart, Integer> bends, Map<Dart, Integer> angles, Set<Edge> straightEdges) {
    Graph graph = embeddedGraph.getGraph();
    int c = 100 * graph.getNumNodes();
    Graph network = new Graph();
    Node networkSource = network.createNode();
    Node networkTarget = network.createNode();
    Map<Edge, Integer> capacity = MapSequence.<Edge,Integer>fromMap(new HashMap<Edge, Integer>());
    Map<Edge, Integer> cost = MapSequence.<Edge,Integer>fromMap(new HashMap<Edge, Integer>());
    Map<Node, Node> nodeMap = MapSequence.<Node,Node>fromMap(new HashMap<Node, Node>());
    for (Node node : ListSequence.<Node>fromList(graph.getNodes())) {
      Node networkNode = network.createNode();
      MapSequence.<Node,Node>fromMap(nodeMap).put(node, networkNode);
      int deg = ListSequence.<Edge>fromList(node.getEdges()).count();
      Edge edge = null;
      if (deg < 4) {
        edge = network.connect(networkSource, networkNode);
      }
      if (deg > 4) {
        edge = network.connect(networkNode, networkTarget);
      }
      if (edge != null) {
        MapSequence.<Edge,Integer>fromMap(cost).put(edge, 0);
        MapSequence.<Edge,Integer>fromMap(capacity).put(edge, Math.abs(deg - 4));
      }
    }
    Map<Face, Node> faceMap = MapSequence.<Face,Node>fromMap(new HashMap<Face, Node>());
    for (Face face : ListSequence.<Face>fromList(embeddedGraph.getFaces())) {
      Node networkNode = network.createNode();
      MapSequence.<Face,Node>fromMap(faceMap).put(face, networkNode);
      int deg = ListSequence.<Dart>fromList(face.getDarts()).count();
      if (embeddedGraph.isOuterFace(face)) {
        Edge edge = network.connect(networkNode, networkTarget);
        MapSequence.<Edge,Integer>fromMap(cost).put(edge, 0);
        MapSequence.<Edge,Integer>fromMap(capacity).put(edge, deg + 4);
      } else {
        Edge edge = null;
        if (deg < 4) {
          edge = network.connect(networkSource, networkNode);
        }
        if (deg > 4) {
          edge = network.connect(networkNode, networkTarget);
        }
        if (edge != null) {
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, 0);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, Math.abs(deg - 4));
        }
      }
    }
    Map<Dart, Edge> dartBendMap = MapSequence.<Dart,Edge>fromMap(new HashMap<Dart, Edge>());
    Map<Dart, Edge> dartAngleMap = MapSequence.<Dart,Edge>fromMap(new HashMap<Dart, Edge>());
    for (Face face : ListSequence.<Face>fromList(embeddedGraph.getFaces())) {
      Node faceNode = MapSequence.<Face,Node>fromMap(faceMap).get(face);
      for (Dart dart : ListSequence.<Dart>fromList(face.getDarts())) {
        Edge edge;
        edge = network.connect(MapSequence.<Node,Node>fromMap(nodeMap).get(dart.getSource()), faceNode);
        MapSequence.<Dart,Edge>fromMap(dartAngleMap).put(dart, edge);
        MapSequence.<Edge,Integer>fromMap(capacity).put(edge, INF);
        MapSequence.<Edge,Integer>fromMap(cost).put(edge, 0);
        Dart oppositeDart = embeddedGraph.getOpposite(dart);
        Node oppositeFaceNode = MapSequence.<Face,Node>fromMap(faceMap).get(embeddedGraph.getFace(oppositeDart));
        edge = network.connect(faceNode, oppositeFaceNode);
        MapSequence.<Dart,Edge>fromMap(dartBendMap).put(dart, edge);
        if (SetSequence.<Edge>fromSet(straightEdges).contains(edge)) {
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 0);
        } else {
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, INF);
        }
        MapSequence.<Edge,Integer>fromMap(cost).put(edge, 1);
      }
    }
    Map<Node, Map<Face, Edge>> faceToNodeEdges = MapSequence.<Node,Map<Face, Edge>>fromMap(new HashMap<Node, Map<Face, Edge>>());
    Map<Edge, Dart> tempEdgesToDart = MapSequence.<Edge,Dart>fromMap(new HashMap<Edge, Dart>());
    for (Node node : ListSequence.<Node>fromList(graph.getNodes())) {
      if (ListSequence.<Edge>fromList(node.getEdges()).count() > 4) {
        List<Dart> darts = embeddedGraph.getDartWithSource(node);
        Map<Face, Node> faceNodes = MapSequence.<Face,Node>fromMap(new HashMap<Face, Node>());
        Map<Face, Edge> faceEdges = MapSequence.<Face,Edge>fromMap(new HashMap<Face, Edge>());
        for (Dart dart : ListSequence.<Dart>fromList(darts)) {
          Node faceNode = network.createNode();
          Face face = embeddedGraph.getFace(dart);
          MapSequence.<Face,Node>fromMap(faceNodes).put(face, faceNode);
          Edge edge;
          edge = network.connect(faceNode, MapSequence.<Node,Node>fromMap(nodeMap).get(node));
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, 0);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 1);
          MapSequence.<Face,Edge>fromMap(faceEdges).put(face, edge);
        }
        for (Dart dart : ListSequence.<Dart>fromList(darts)) {
          Face face = embeddedGraph.getFace(dart);
          Face leftFace = embeddedGraph.getFace(embeddedGraph.getOpposite(dart));
          Edge edge;
          edge = network.connect(MapSequence.<Face,Node>fromMap(faceMap).get(leftFace), MapSequence.<Face,Node>fromMap(faceNodes).get(face));
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, 1);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 1);
          MapSequence.<Edge,Dart>fromMap(tempEdgesToDart).put(edge, dart);
        }
        MapSequence.<Node,Map<Face, Edge>>fromMap(faceToNodeEdges).put(node, faceEdges);
      }
    }
    /*
      for (Node node : ListSequence.<Node>fromList(graph.getNodes())) {
        List<Dart> darts = embeddedGraph.getDartWithSource(node);
        Map<Face, Node> faceNodes = MapSequence.<Face,Node>fromMap(new HashMap<Face, Node>());
        Map<Face, Edge> faceEdges = MapSequence.<Face,Edge>fromMap(new HashMap<Face, Edge>());
        for (Dart dart : ListSequence.<Dart>fromList(darts)) {
          Node faceNode = network.createNode();
          Face face = embeddedGraph.getFace(dart);
          MapSequence.<Face,Node>fromMap(faceNodes).put(face, faceNode);
          Edge edge = faceNode.addEdgeTo(MapSequence.<Node,Node>fromMap(nodeMap).get(node));
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, 0);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 1);
          MapSequence.<Face,Edge>fromMap(faceEdges).put(face, edge);
        }
        for (Dart dart : ListSequence.<Dart>fromList(darts)) {
          Node left = network.createNode();
          Node right = network.createNode();
          Edge edge = left.addEdgeTo(right);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 1);
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, -c);
          edge = right.addEdgeTo(left);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 1);
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, -c);
          Face rightFace = embeddedGraph.getFace(dart);
          Face leftFace = embeddedGraph.getFace(embeddedGraph.getOpposite(dart));
          edge = MapSequence.<Face,Node>fromMap(faceMap).get(rightFace).addEdgeTo(right);
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, 2 * c + 1);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 1);
          edge = MapSequence.<Face,Node>fromMap(faceMap).get(leftFace).addEdgeTo(left);
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, 2 * c + 1);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 1);
          edge = right.addEdgeTo(MapSequence.<Face,Node>fromMap(faceNodes).get(leftFace));
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, 0);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 1);
          MapSequence.<Edge,Dart>fromMap(tempEdgesToDart).put(edge, dart);
          edge = left.addEdgeTo(MapSequence.<Face,Node>fromMap(faceNodes).get(rightFace));
          MapSequence.<Edge,Integer>fromMap(cost).put(edge, 0);
          MapSequence.<Edge,Integer>fromMap(capacity).put(edge, 1);
          MapSequence.<Edge,Dart>fromMap(tempEdgesToDart).put(edge, dart);
        }
        MapSequence.<Node,Map<Face, Edge>>fromMap(faceToNodeEdges).put(node, faceEdges);
      }
    */
    Map<Edge, Integer> flow = MinCostMaxFlowWithPotentials.getFlow(network, networkSource, networkTarget, capacity, cost);
    for (Face face : ListSequence.<Face>fromList(embeddedGraph.getFaces())) {
      for (Dart dart : ListSequence.<Dart>fromList(face.getDarts())) {
        Node source = dart.getSource();
        int angle = MapSequence.<Edge,Integer>fromMap(flow).get(MapSequence.<Dart,Edge>fromMap(dartAngleMap).get(dart)) + 1;
        if (MapSequence.<Face,Edge>fromMap(MapSequence.<Node,Map<Face, Edge>>fromMap(faceToNodeEdges).get(source)).get(face) != null && MapSequence.<Edge,Integer>fromMap(flow).get(MapSequence.<Face,Edge>fromMap(MapSequence.<Node,Map<Face, Edge>>fromMap(faceToNodeEdges).get(source)).get(face)) > 0) {
          angle -= 1;
        }
        MapSequence.<Dart,Integer>fromMap(angles).put(dart, angle);
      }
    }
    for (Dart dart : SetSequence.<Dart>fromSet(MapSequence.fromMap(dartBendMap).keySet())) {
      MapSequence.<Dart,Integer>fromMap(bends).put(dart, MapSequence.<Edge,Integer>fromMap(flow).get(MapSequence.<Dart,Edge>fromMap(dartBendMap).get(dart)));
    }
    for (Face face : ListSequence.<Face>fromList(embeddedGraph.getFaces())) {
      List<Dart> darts = face.getDarts();
      for (Dart dart : ListSequence.<Dart>fromList(darts)) {
        Node node = dart.getSource();
        Edge edgeToNode = MapSequence.<Face,Edge>fromMap(MapSequence.<Node,Map<Face, Edge>>fromMap(faceToNodeEdges).get(node)).get(face);
        if (edgeToNode != null && MapSequence.<Edge,Integer>fromMap(flow).get(edgeToNode) > 0) {
          Dart dartWithBend = embeddedGraph.getOpposite(dart);
          MapSequence.<Dart,Integer>fromMap(bends).put(dartWithBend, MapSequence.<Dart,Integer>fromMap(bends).get(dartWithBend) + 1);
        }
      }
    }
    /*
      for (Face face : ListSequence.<Face>fromList(embeddedGraph.getFaces())) {
        List<Dart> darts = face.getDarts();
        Dart prev = ListSequence.<Dart>fromList(darts).last();
        for (Dart dart : ListSequence.<Dart>fromList(darts)) {
          Node node = dart.getSource();
          Edge edgeToNode = MapSequence.<Face,Edge>fromMap(MapSequence.<Node,Map<Face, Edge>>fromMap(faceToNodeEdges).get(node)).get(face);
          if (MapSequence.<Edge,Integer>fromMap(flow).get(edgeToNode) > 0) {
            Node faceNode = edgeToNode.getSource();
            List<Edge> prevEdges = faceNode.getInEdges();
            for (Edge prevEdge : ListSequence.<Edge>fromList(prevEdges)) {
              if (MapSequence.<Edge,Integer>fromMap(flow).get(prevEdge) > 0) {
                Dart flowDart = MapSequence.<Edge,Dart>fromMap(tempEdgesToDart).get(prevEdge);
                Dart dartWithBend = null;
                if (flowDart == dart) {
                  dartWithBend = embeddedGraph.getOpposite(dart);
                }
                if (flowDart == embeddedGraph.getOpposite(prev)) {
                  dartWithBend = embeddedGraph.getOpposite(prev);
                }
                if (dartWithBend == null) {
                  throw new RuntimeException("bad bend dart!");
                }
                MapSequence.<Dart,Integer>fromMap(bends).put(dartWithBend, MapSequence.<Dart,Integer>fromMap(bends).get(dartWithBend) + 1);
              }
            }
          }
          prev = dart;
        }
      }
    */
    if (SHOW_INFO > 0) {
      for (Node node : ListSequence.<Node>fromList(graph.getNodes())) {
        System.out.println("node " + node);
        for (Dart dart : ListSequence.<Dart>fromList(embeddedGraph.getDartWithSource(node))) {
          System.out.println(dart + " angle = " + MapSequence.<Dart,Integer>fromMap(angles).get(dart) + ", bends = " + MapSequence.<Dart,Integer>fromMap(bends).get(dart) + ", opposite bends = " + MapSequence.<Dart,Integer>fromMap(bends).get(embeddedGraph.getOpposite(dart)));
        }
      }
      int totalCost = 0;
      for (Edge edge : ListSequence.<Edge>fromList(network.getEdges())) {
        totalCost += MapSequence.<Edge,Integer>fromMap(flow).get(edge) * MapSequence.<Edge,Integer>fromMap(cost).get(edge);
      }
      System.out.println("!!! total cost = " + totalCost);
      int totalBendsNumber = 0;
      for (Integer value : Sequence.<Integer>fromIterable(MapSequence.fromMap(bends).values())) {
        totalBendsNumber += value;
      }
      System.out.println("!!! total bends number = " + totalBendsNumber);
      if (totalBendsNumber != totalCost) {
        throw new RuntimeException("total cost is not equal to bends number");
      }
    }
  }
}
