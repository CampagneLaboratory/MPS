package jetbrains.mps.build.custommps.plugin;

/*Generated by MPS */

import jetbrains.mps.plugins.pluginparts.runconfigs.BaseConfigCreator;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.logging.Logger;
import com.intellij.execution.configurations.RunConfiguration;
import com.intellij.util.containers.ContainerUtil;
import com.intellij.openapi.extensions.Extensions;
import com.intellij.execution.configurations.ConfigurationType;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.plugins.pluginparts.runconfigs.MPSPsiElement;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import org.jetbrains.annotations.NotNull;
import com.intellij.execution.configurations.ConfigurationFactory;
import jetbrains.mps.internal.collections.runtime.Sequence;

public class DefaultCustomMpsLanguageConfigurationFromMPSLayout extends BaseConfigCreator<SNode> implements Cloneable {
  private static final Logger LOG = Logger.getLogger(DefaultCustomMpsLanguageConfigurationFromMPSLayout.class);

  private RunConfiguration myConfig;

  public DefaultCustomMpsLanguageConfigurationFromMPSLayout() {
    super(findFactoryImpl(ContainerUtil.findInstance(Extensions.getExtensions(ConfigurationType.CONFIGURATION_TYPE_EP), new _FunctionTypes._return_P0_E0<Class<ConfigurationType>>() {
      public Class<ConfigurationType> invoke() {
        try {
          return (Class<ConfigurationType>) getClass().getClassLoader().loadClass("jetbrains.mps.buildlanguage.plugin.BuildLanguage_ConfigurationType");
        } catch (ClassNotFoundException cl) {
          return (Class<ConfigurationType>) null;
        }
      }
    }.invoke()), "DefaultCustomMpsApplication"));
  }

  protected RunConfiguration doCreateConfiguration(SNode node) {
    this.createConfig(node);
    return this.myConfig;
  }

  private void createConfig(final SNode parameter) {
    final Wrappers._boolean isApplicable = new Wrappers._boolean();
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        isApplicable.value = ListSequence.fromList(SNodeOperations.getDescendants(parameter, "jetbrains.mps.build.custommps.structure.MPSBuild", false, new String[]{})).isNotEmpty() || ListSequence.fromList(SNodeOperations.getDescendants(parameter, "jetbrains.mps.build.custommps.structure.MPSDistribution", false, new String[]{})).isNotEmpty();
      }
    });
    if (!(isApplicable.value)) {
      return;
    }

    final Wrappers._T<String> id = new Wrappers._T<String>();
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        id.value = ListSequence.fromList(SLinkOperations.getTargets(parameter, "configuration", true)).first().getId();
      }
    });

    DefaultCustomMpsLanguageConfigurationFromMPSLayout.this.setSourceElement(new MPSPsiElement(parameter));
    {
      ConfigurationType configType = ContainerUtil.findInstance(Extensions.getExtensions(ConfigurationType.CONFIGURATION_TYPE_EP), new _FunctionTypes._return_P0_E0<Class<ConfigurationType>>() {
        public Class<ConfigurationType> invoke() {
          try {
            return (Class<ConfigurationType>) getClass().getClassLoader().loadClass("jetbrains.mps.buildlanguage.plugin.BuildLanguage_ConfigurationType");
          } catch (ClassNotFoundException cl) {
            return (Class<ConfigurationType>) null;
          }
        }
      }.invoke());
      DefaultCustomMpsApplication_Configuration _config = new DefaultCustomMpsApplication_Configuration(DefaultCustomMpsLanguageConfigurationFromMPSLayout.this.getContext().getProject(), findFactory(configType, "DefaultCustomMpsApplication"), "NewConfig");
      _config.setName(SPropertyOperations.getString(parameter, "name"));
      _config.getStateObject().nodeId = parameter.getId();
      _config.getStateObject().modelId = parameter.getModel().getModelDescriptor().getSModelReference().toString();
      _config.getStateObject().configurationId = id.value;
      DefaultCustomMpsLanguageConfigurationFromMPSLayout.this.myConfig = _config;
    }
  }

  @Override
  public DefaultCustomMpsLanguageConfigurationFromMPSLayout clone() {
    return ((DefaultCustomMpsLanguageConfigurationFromMPSLayout) super.clone());
  }

  protected boolean isApplicable(final Object element) {
    return element instanceof SNode && SNodeOperations.isInstanceOf(((SNode) element), "jetbrains.mps.build.packaging.structure.Layout");
  }

  @NotNull
  private ConfigurationFactory findFactory(ConfigurationType configurationType, String configurationName) {
    return findFactoryImpl(configurationType, configurationName);
  }

  @NotNull
  private static ConfigurationFactory findFactoryImpl(ConfigurationType configurationType, String configurationName) {
    for (ConfigurationFactory factory : Sequence.fromIterable(Sequence.fromArray(configurationType.getConfigurationFactories()))) {
      if (factory.getClass().getName().contains(configurationName)) {
        return factory;
      }
    }
    LOG.warning("Cound not find configuration factory for " + configurationName + " in type " + configurationType.getDisplayName() + ".");
    return configurationType.getConfigurationFactories()[0];
  }
}
