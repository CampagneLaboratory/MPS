package jetbrains.mps.lang.extension.tests.testExtension;

/*Generated by MPS */

import junit.framework.TestCase;
import jetbrains.mps.lang.extension.tests.plugin.TestObject;
import jetbrains.mps.MPSLaunch;
import jetbrains.mps.smodel.structure.Extension;
import jetbrains.mps.smodel.structure.ExtensionPoint;
import junit.framework.Assert;
import java.util.Iterator;
import java.util.NoSuchElementException;
import jetbrains.mps.lang.extension.tests.plugin.LazyTestObject;
import jetbrains.mps.internal.collections.runtime.IterableUtils;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.ISelector;
import com.intellij.openapi.application.ex.ApplicationManagerEx;
import com.intellij.openapi.application.ApplicationAdapter;

public class Extension_Test extends TestCase {
  private static TestObject TEST_OBJECT;

  @MPSLaunch
  public void test_testObject() throws Exception {
    Iterable<Extension<TestObject>> extensions = ((ExtensionPoint<TestObject>) ExtensionPoint.<TestObject>generify(new ExtensionPoint("jetbrains.mps.lang.extension.tests.testExtensionPoint", TestObject.class))).getExtensions();
    Assert.assertNotNull(extensions);
    Iterator<Extension<TestObject>> it = extensions.iterator();
    Assert.assertTrue(it.hasNext());
    Extension<TestObject> ext = it.next();
    try {
      it.next();
      Assert.fail("unexpected value");
    } catch (NoSuchElementException e) {
      // expected exception 
    }
    TestObject to = ext.get();
    TEST_OBJECT = to;
    Assert.assertEquals("foobar", to.getValue());
    Assert.assertFalse(to.getShutDown());
  }

  @MPSLaunch
  public void test_testLazyObject() throws Exception {
    Assert.assertNull(LazyTestObject.INSTANCE);
    Iterable<Extension<LazyTestObject>> extensions = ((ExtensionPoint<LazyTestObject>) ExtensionPoint.<LazyTestObject>generify(new ExtensionPoint("jetbrains.mps.lang.extension.tests.lazyTestExtensionPoint", LazyTestObject.class))).getExtensions();
    LazyTestObject lzo = extensions.iterator().next().get();
    Assert.assertNotNull(lzo);
    Assert.assertSame(LazyTestObject.INSTANCE, lzo);
  }

  @MPSLaunch
  public void test_extensionPointExpression() throws Exception {
    String string = IterableUtils.join(Sequence.fromIterable(ExtensionPoint.<String>generify(new ExtensionPoint("jetbrains.mps.lang.extension.tests.multiExtensionPoint", String.class)).getObjects()).sort(new ISelector<String, String>() {
      public String select(String it) {
        return it;
      }
    }, false), ", ");
    Assert.assertEquals("salam, dunya", string);
  }

  public void tearDown() {
    Assert.assertFalse(TEST_OBJECT.getShutDown());
    ApplicationManagerEx.getApplicationEx().addApplicationListener(new ApplicationAdapter() {
      @Override
      public void applicationExiting() {
        if (!(Extension_Test.TEST_OBJECT.getShutDown())) {
          throw new RuntimeException("!TestObject.shutDown");
        }
      }
    });
  }
}
