package jetbrains.mps.buildScript.util;

/*Generated by MPS */

import java.util.Set;
import java.util.HashSet;
import java.util.Arrays;
import java.util.concurrent.ConcurrentMap;
import jetbrains.mps.generator.template.TemplateQueryContext;
import jetbrains.mps.smodel.SNode;
import org.apache.commons.lang.StringUtils;

public class PathProvider {
  private static Set<String> reservedNames = new HashSet<String>(Arrays.asList("con", "prn", "aux", "clock$", "nul", "com0", "com1", "com2", "com3", "com4", "com5", "com6", "com7", "com8", "com9", "lpt0", "lpt1", "lpt2", "lpt3", "lpt4", "lpt5", "lpt6", "lpt7", "lpt8", "lpt9"));

  private ConcurrentMap<String, String> usedNames;

  public PathProvider(TemplateQueryContext genContext, SNode project) {
    this.usedNames = GenerationUtil.<String,String>getSessionMap(project, genContext, "location");
  }

  public String createTempPath(String name, String... categories) {
    StringBuilder sb = new StringBuilder("${build.tmp}/");
    int before;
    for (String s : categories) {
      if (StringUtils.isEmpty(s)) {
        continue;
      }
      before = sb.length();
      appendFileName(sb, s);
      if (before < sb.length()) {
        sb.append("/");
      }
    }
    before = sb.length();
    appendFileName(sb, name);
    if (before == sb.length()) {
      sb.append("noname");
    }
    before = sb.length();
    String result = sb.toString();
    int i = 1;
    while (usedNames.putIfAbsent(result, result) != null) {
      sb.setLength(before);
      sb.append(i++);
      result = sb.toString();
    }
    return result;
  }

  private static void appendFileName(StringBuilder sb, String name) {
    int before = sb.length();
    for (int i = 0; i < name.length(); i++) {
      char c = name.charAt(i);
      if (c < 0x20 || c == 0x7f) {
        continue;
      }
      switch (c) {
        case '/':
          sb.append("{slash}");
          break;
        case '\\':
          sb.append("{bslash}");
          break;
        case '>':
          sb.append("{gt}");
          break;
        case '<':
          sb.append("{lt}");
          break;
        case '"':
          sb.append("{quot}");
          break;
        case '|':
          sb.append("{bar}");
          break;
        case ':':
          sb.append("{colon}");
          break;
        case '*':
          sb.append("{star}");
          break;
        case '?':
          sb.append("{qmark}");
          break;
        case '%':
          sb.append("{percent}");
          break;
        default:
          sb.append(c);
      }
    }
    String escaped = sb.substring(before);
    if (reservedNames.contains(escaped) || escaped.startsWith("$")) {
      sb.insert(before, "_");
    }
  }
}
