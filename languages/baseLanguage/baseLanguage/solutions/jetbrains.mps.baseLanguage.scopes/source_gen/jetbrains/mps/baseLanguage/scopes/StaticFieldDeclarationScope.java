package jetbrains.mps.baseLanguage.scopes;

/*Generated by MPS */

import jetbrains.mps.scope.Scope;
import java.util.Map;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import java.util.List;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.ITranslator2;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.IMapping;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.lang.scopes.runtime.LazyScope;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.smodel.behaviour.BehaviorManager;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;

public class StaticFieldDeclarationScope extends Scope {
  private final Map<String, SNode> nameToField;
  private final Iterable<Scope> extendsScopes;

  public StaticFieldDeclarationScope(Iterable<SNode> fields, Iterable<Scope> extendsScopes) {
    nameToField = MapSequence.fromMap(new HashMap<String, SNode>(Sequence.fromIterable(fields).count()));
    for (SNode node : Sequence.fromIterable(fields)) {
      MapSequence.fromMap(nameToField).put(SPropertyOperations.getString(node, "name"), node);
    }
    this.extendsScopes = extendsScopes;
  }

  public List<SNode> getAvailableElements(@Nullable final String prefix) {
    List<SNode> result = ListSequence.fromList(new ArrayList<SNode>());

    ListSequence.fromList(result).addSequence(Sequence.fromIterable(MapSequence.fromMap(nameToField).values()));

    Map<String, List<SNode>> groups = MapSequence.fromMap(new HashMap<String, List<SNode>>());
    for (SNode field : Sequence.fromIterable(extendsScopes).translate(new ITranslator2<Scope, SNode>() {
      public Iterable<SNode> translate(Scope it) {
        return ListSequence.fromList(it.getAvailableElements(prefix)).select(new ISelector<SNode, SNode>() {
          public SNode select(SNode it) {
            return SNodeOperations.cast(it, "jetbrains.mps.baseLanguage.structure.StaticFieldDeclaration");
          }
        });
      }
    })) {
      if (!(MapSequence.fromMap(nameToField).containsKey(SPropertyOperations.getString(field, "name")))) {
        if (MapSequence.fromMap(groups).containsKey(SPropertyOperations.getString(field, "name"))) {
          ListSequence.fromList(MapSequence.fromMap(groups).get(SPropertyOperations.getString(field, "name"))).addElement(field);
        } else {
          MapSequence.fromMap(groups).put(SPropertyOperations.getString(field, "name"), ListSequence.fromListAndArray(new ArrayList<SNode>(), field));
        }
      }
    }

    for (IMapping<String, List<SNode>> group : MapSequence.fromMap(groups)) {
      if ((int) ListSequence.fromList(group.value()).count() == 1) {
        ListSequence.fromList(result).addSequence(ListSequence.fromList(group.value()));
      }
    }

    return result;
  }

  @Nullable
  public SNode resolve(SNode contextNode, @NotNull String refText) {
    if (MapSequence.fromMap(nameToField).containsKey(refText)) {
      return MapSequence.fromMap(nameToField).get(refText);
    } else {
      SNode result = null;
      for (Scope scope : extendsScopes) {
        SNode r = scope.resolve(contextNode, refText);
        if (r != null) {
          if (result == null) {
            result = r;
          } else {
            // ambiguity 
            return null;
          }
        }
      }
      return result;
    }
  }

  @Nullable
  public String getReferenceText(SNode contextNode, @NotNull SNode node) {
    // todo: look! mixin "INamedConcept" 
    return SPropertyOperations.getString(SNodeOperations.cast(node, "jetbrains.mps.baseLanguage.structure.StaticFieldDeclaration"), "name");
  }

  @Override
  public boolean contains(SNode node) {
    if (!(SNodeOperations.isInstanceOf(node, "jetbrains.mps.baseLanguage.structure.StaticFieldDeclaration"))) {
      return false;
    }
    if (MapSequence.fromMap(nameToField).containsKey(SPropertyOperations.getString(SNodeOperations.cast(node, "jetbrains.mps.baseLanguage.structure.StaticFieldDeclaration"), "name"))) {
      return true;
    }
    return ListSequence.fromList(getAvailableElements(SPropertyOperations.getString(SNodeOperations.cast(node, "jetbrains.mps.baseLanguage.structure.StaticFieldDeclaration"), "name"))).contains(node);
  }

  public static Scope forClass(final SNode classNode, @Nullable final SNode extendsClass, SNode... implementsInterfaces) {
    List<Scope> extendsScopes = ListSequence.fromList(new ArrayList<Scope>());
    if ((extendsClass != null)) {
      ListSequence.fromList(extendsScopes).addElement(new LazyScope(new _FunctionTypes._return_P0_E0<Scope>() {
        public Scope invoke() {
          return ((Scope) BehaviorManager.getInstance().invoke(Object.class, extendsClass, "virtual_getVisibleMembers_8083692786967356611", new Class[]{SNode.class, SNode.class, SNode.class}, classNode, SConceptOperations.findConceptDeclaration("jetbrains.mps.baseLanguage.structure.StaticFieldDeclaration")));
        }
      }));
    }
    for (final SNode extendsClassifier : implementsInterfaces) {
      if ((extendsClassifier != null)) {
        ListSequence.fromList(extendsScopes).addElement(new LazyScope(new _FunctionTypes._return_P0_E0<Scope>() {
          public Scope invoke() {
            return ((Scope) BehaviorManager.getInstance().invoke(Object.class, extendsClassifier, "virtual_getVisibleMembers_8083692786967356611", new Class[]{SNode.class, SNode.class, SNode.class}, classNode, SConceptOperations.findConceptDeclaration("jetbrains.mps.baseLanguage.structure.StaticFieldDeclaration")));
          }
        }));
      }
    }
    // todo: staticField??? 
    return new StaticFieldDeclarationScope(SLinkOperations.getTargets(classNode, "staticField", true), extendsScopes);
  }

  public static Scope forInterface(final SNode interfaceNode, SNode... extendsInterfaces) {
    List<Scope> extendsScopes = ListSequence.fromList(new ArrayList<Scope>());
    for (final SNode extendsClassifier : extendsInterfaces) {
      if ((extendsClassifier != null)) {
        ListSequence.fromList(extendsScopes).addElement(new LazyScope(new _FunctionTypes._return_P0_E0<Scope>() {
          public Scope invoke() {
            return ((Scope) BehaviorManager.getInstance().invoke(Object.class, extendsClassifier, "virtual_getVisibleMembers_8083692786967356611", new Class[]{SNode.class, SNode.class, SNode.class}, interfaceNode, SConceptOperations.findConceptDeclaration("jetbrains.mps.baseLanguage.structure.StaticFieldDeclaration")));
          }
        }));
      }
    }
    // todo: staticField??? 
    return new StaticFieldDeclarationScope(SLinkOperations.getTargets(interfaceNode, "staticField", true), extendsScopes);
  }
}
