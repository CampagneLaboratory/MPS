package jetbrains.mps.idea.java.psiStubs;

/*Generated by MPS */

import org.jetbrains.annotations.Nullable;
import jetbrains.mps.smodel.SNodeId;
import com.intellij.psi.PsiElement;
import com.intellij.psi.PsiFile;
import org.jetbrains.mps.openapi.model.SModelReference;
import com.intellij.psi.PsiJavaFile;
import jetbrains.mps.smodel.SModelFqName;
import jetbrains.mps.smodel.SModelId;
import com.intellij.psi.PsiNamedElement;
import com.intellij.psi.PsiClass;
import com.intellij.psi.PsiField;
import com.intellij.psi.PsiMethod;
import com.intellij.psi.PsiParameter;
import com.intellij.psi.PsiTypeElement;
import com.intellij.psi.PsiType;

public class JavaForeignIdBuilder {


  @Nullable
  public static SNodeId.Foreign computeNodeId(PsiElement element) {
    PsiElement parent = element.getParent();
    String prefix;
    if (parent instanceof PsiFile) {
      // element is root 
      prefix = SNodeId.Foreign.ID_PREFIX;
    } else {
      org.jetbrains.mps.openapi.model.SNodeId parentId = computeNodeId(parent);
      if (parentId == null) {
        return null;
      }
      prefix = parentId.toString() + ".";
    }

    // e.g. this was an anonymous class and we don't compute nodeId for parent 
    if (prefix == null) {
      return null;
    }
    return computeNodeId(prefix, element);
  }



  @Nullable
  public static SModelReference computeModelReference(PsiElement element) {
    PsiFile file = element.getContainingFile();
    if (!(file instanceof PsiJavaFile)) {
      return null;
    }
    String packageName = ((PsiJavaFile) file).getPackageName();

    return computeModelReference(packageName);
  }



  /*package*/ static jetbrains.mps.smodel.SModelReference computeModelReference(String packageName) {
    String stereotype = "java_stub";
    if (packageName.length() == 0) {
      packageName = "<default package>";
    }

    SModelFqName fqName = new SModelFqName(packageName, stereotype);
    SModelId modelId = SModelId.foreign(fqName.getStereotype(), fqName.getLongName());

    return new jetbrains.mps.smodel.SModelReference(fqName, modelId);
  }



  public static SNodeId.Foreign computeNodeId(PsiElement element, String newName) {
    SNodeId.Foreign nodeId = computeNodeId(element);
    if (nodeId == null) {
      return null;
    }
    // FIXME it's dumb 
    String nodeIdStr = nodeId.toString();
    nodeIdStr = nodeIdStr.replace(((PsiNamedElement) element).getName(), newName);
    nodeId = new SNodeId.Foreign(nodeIdStr);
    return nodeId;
  }



  /*package*/ static SNodeId.Foreign computeNodeId(String prefix, PsiElement element) {
    StringBuilder sb = new StringBuilder(prefix);

    if (element instanceof PsiClass || element instanceof PsiField) {
      // simply take the name 
      String name = ((PsiNamedElement) element).getName();
      if (name == null) {
        return null;
      }
      sb.append(name);

    } else if (element instanceof PsiMethod) {
      PsiMethod method = (PsiMethod) element;
      String name = method.getName();
      if (name == null) {
        return null;
      }
      sb.append(name);
      sb.append('(');

      for (PsiParameter param : method.getParameterList().getParameters()) {
        // for classess we want their name exactly how it is written in the source file 
        // (either short name, partially qualified or fully qualified) 
        // to make it equal to what we have in eclipse stubs 

        PsiTypeElement psiTypeElem = param.getTypeElement();
        PsiType psiType = param.getType();

        if (psiType != null && psiTypeElem != null) {
          sb.append(ASTConverter.typeReferenceId(psiTypeElem));
          sb.append(',');
        }
      }
      int last = sb.length() - 1;
      if (sb.charAt(last) == ',') {
        sb.deleteCharAt(last);
      }

      sb.append(')');
    }

    return new SNodeId.Foreign(sb.toString());
  }
}
