package jetbrains.mps.idea.java.psiStubs;

/*Generated by MPS */

import jetbrains.mps.ide.java.sourceStubs.MPSJavaSrcDataSource;
import java.util.Set;
import org.jetbrains.mps.openapi.persistence.MultiStreamDataSourceListener;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import org.jetbrains.annotations.Nullable;
import com.intellij.openapi.module.Module;
import com.intellij.openapi.vfs.VirtualFileManager;
import com.intellij.openapi.fileEditor.FileDocumentManager;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.vfs.IFile;
import org.jetbrains.mps.openapi.persistence.ModelRoot;
import jetbrains.mps.idea.core.project.PluginModelRootUtil;
import org.jetbrains.mps.openapi.persistence.DataSourceListener;
import java.io.InputStream;
import java.io.IOException;
import com.intellij.openapi.vfs.VirtualFile;
import jetbrains.mps.ide.vfs.VirtualFileUtils;
import com.intellij.openapi.editor.Document;
import java.io.ByteArrayInputStream;
import jetbrains.mps.idea.core.psi.PsiListener;
import com.intellij.psi.PsiFileSystemItem;
import com.intellij.psi.PsiFile;
import jetbrains.mps.internal.collections.runtime.Sequence;

public class EclipseJavaStubDataSource extends MPSJavaSrcDataSource {

  private final Object LOCK = new Object();
  private Set<MultiStreamDataSourceListener> myListeners = SetSequence.fromSet(new HashSet<MultiStreamDataSourceListener>());
  @Nullable
  private Module myIdeaModule;
  private VirtualFileManager myVirtFileMgr;
  private FileDocumentManager myFileDocMgr;


  public EclipseJavaStubDataSource(@NotNull IFile dir, ModelRoot modelRoot) {
    super(dir, modelRoot);
    myIdeaModule = PluginModelRootUtil.getIdeaModule(modelRoot);
    myVirtFileMgr = VirtualFileManager.getInstance();
    myFileDocMgr = FileDocumentManager.getInstance();

  }

  @Override
  public void addListener(DataSourceListener listener) {
    if (!(listener instanceof MultiStreamDataSourceListener)) {
      throw new IllegalArgumentException("Only MultiStreamDataSourceListener expected");
    }
    synchronized (LOCK) {
      SetSequence.fromSet(myListeners).addElement((MultiStreamDataSourceListener) listener);
      if ((int) SetSequence.fromSet(myListeners).count() == 1) {
        // ... 
      }
    }
  }

  @Override
  public void removeListener(DataSourceListener listener) {
    if (!(listener instanceof MultiStreamDataSourceListener)) {
      return;
    }

    synchronized (LOCK) {
      Object removed = SetSequence.fromSet(myListeners).removeElement((MultiStreamDataSourceListener) listener);
      if (removed != null && SetSequence.fromSet(myListeners).isEmpty()) {
        // ... 
      }
    }
  }

  @Override
  public InputStream openInputStream(String name) throws IOException {
    IFile ifile = getFile(name);
    VirtualFile vfile = VirtualFileUtils.getVirtualFile(ifile);
    if (vfile == null) {
      throw new IOException("Could not open stream by name: " + name);
    }
    Document doc = myFileDocMgr.getDocument(vfile);
    if (doc == null) {
      return vfile.getInputStream();
    } else {
      byte[] textBytes = doc.getText().getBytes();
      return new ByteArrayInputStream(textBytes);
    }
  }

  private class MyPsiListener implements PsiListener {
    public MyPsiListener() {
    }

    @Override
    public void psiChanged(PsiListener.PsiEvent event) {
      String path = getFolder().getPath();
      Set<String> changedItems = SetSequence.fromSet(new HashSet<String>());
      SetSequence.fromSet(changedItems).addSequence(SetSequence.fromSet(handleFsItems(path, event.getCreated())));
      SetSequence.fromSet(changedItems).addSequence(SetSequence.fromSet(handleFsItems(path, event.getRemoved())));
      // not pretty 
      Set<PsiFileSystemItem> files = SetSequence.fromSet(new HashSet<PsiFileSystemItem>());
      for (PsiFile f : SetSequence.fromSet(event.getChanged().keySet())) {
        SetSequence.fromSet(files).addElement(f);
      }
      SetSequence.fromSet(changedItems).addSequence(SetSequence.fromSet(handleFsItems(path, files)));
    }

    private Set<String> handleFsItems(String path, Iterable<PsiFileSystemItem> items) {
      Set<String> changedItems = SetSequence.fromSet(new HashSet<String>());

      for (PsiFileSystemItem fsItem : Sequence.fromIterable(items)) {
        String itemPath = fsItem.getVirtualFile().getPath();
        if (!(itemPath.startsWith(path))) {
          continue;
        }
        SetSequence.fromSet(changedItems).addElement(itemPath);
      }

      return changedItems;
    }
  }
}
