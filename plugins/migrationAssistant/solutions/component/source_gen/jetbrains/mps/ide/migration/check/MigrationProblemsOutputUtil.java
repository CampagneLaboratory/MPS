package jetbrains.mps.ide.migration.check;

/*Generated by MPS */

import com.intellij.openapi.project.Project;
import jetbrains.mps.lang.migration.runtime.base.Problem;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.ide.findusages.model.SearchResult;
import jetbrains.mps.ide.modelchecker.platform.actions.ModelCheckerIssue;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.mps.openapi.module.SModule;
import org.apache.log4j.Level;
import jetbrains.mps.ide.modelchecker.platform.actions.ModelCheckerViewer;
import jetbrains.mps.ide.modelchecker.platform.actions.ModelCheckerTool;
import jetbrains.mps.ide.findusages.model.SearchResults;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.internal.collections.runtime.IVisitor;
import jetbrains.mps.ide.icons.IdeIcons;
import org.apache.log4j.Logger;
import org.apache.log4j.LogManager;

public class MigrationProblemsOutputUtil {
  public static void showProblems(final Project project, Iterable<Problem> problems) {
    show(project, problems, new _FunctionTypes._return_P1_E0<SearchResult<ModelCheckerIssue>, Problem>() {
      public SearchResult<ModelCheckerIssue> invoke(Problem p) {
        return new SearchResult<ModelCheckerIssue>(issueByProblem(p), p.getReason(), p.getCategory());
      }
    });
  }

  public static void showNodes(final Project project, final String category, Iterable<SNode> nodes) {
    show(project, nodes, new _FunctionTypes._return_P1_E0<SearchResult<ModelCheckerIssue>, SNode>() {
      public SearchResult<ModelCheckerIssue> invoke(SNode n) {
        return new SearchResult<ModelCheckerIssue>(new ModelCheckerIssue.NodeIssue(n, "", null), n, category);
      }
    });
  }

  private static ModelCheckerIssue issueByProblem(Problem p) {
    Object r = p.getReason();
    if (r instanceof jetbrains.mps.smodel.SNode) {
      return new ModelCheckerIssue.NodeIssue(((SNode) r), p.getMessage(), null);
    }
    if (r instanceof jetbrains.mps.smodel.SNode) {
      return new ModelCheckerIssue.ModelIssue(((SModel) r), p.getMessage(), null);
    }
    if (r instanceof SModule) {
      return new ModelCheckerIssue.ModuleIssue(p.getMessage(), null);
    }

    if (LOG.isEnabledFor(Level.ERROR)) {
      LOG.error("Unknown issue type: " + r.getClass().getName());
    }
    return null;
  }

  private static <T> void show(final Project project, Iterable<T> problems, final _FunctionTypes._return_P1_E0<? extends SearchResult, ? super T> trans) {
    ModelCheckerViewer v = new ModelCheckerViewer(project) {
      @Override
      protected void close() {
        ModelCheckerTool.getInstance(project).closeTab(this);
        super.close();
      }
    };
    final SearchResults<ModelCheckerIssue> result = new SearchResults<ModelCheckerIssue>();
    Sequence.fromIterable(problems).select(new ISelector<T, SearchResult>() {
      public SearchResult select(T it) {
        return trans.invoke(it);
      }
    }).where(new IWhereFilter<SearchResult>() {
      public boolean accept(SearchResult it) {
        return it != null;
      }
    }).visitAll(new IVisitor<SearchResult>() {
      public void visit(SearchResult it) {
        result.add(it);
      }
    });
    v.setSearchResults(result);
    ModelCheckerTool.getInstance(project).showTabWithResults(v, "Migration issues", IdeIcons.MODULE_GROUP_CLOSED);
  }
  protected static Logger LOG = LogManager.getLogger(MigrationProblemsOutputUtil.class);
}
