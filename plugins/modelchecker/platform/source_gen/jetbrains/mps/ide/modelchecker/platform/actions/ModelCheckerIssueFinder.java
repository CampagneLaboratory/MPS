package jetbrains.mps.ide.modelchecker.platform.actions;

/*Generated by MPS */

import jetbrains.mps.ide.findusages.findalgorithm.finders.IFinder;
import java.util.List;
import java.util.Arrays;
import jetbrains.mps.ide.findusages.model.SearchResults;
import jetbrains.mps.ide.findusages.model.SearchQuery;
import org.jetbrains.mps.openapi.util.ProgressMonitor;
import jetbrains.mps.ide.findusages.model.holders.IHolder;
import org.jetbrains.mps.openapi.module.SearchScope;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.ide.findusages.model.holders.ModelsHolder;
import org.jetbrains.mps.openapi.model.SModelReference;
import jetbrains.mps.ide.findusages.model.holders.ModulesHolder;
import java.util.Set;
import jetbrains.mps.util.IterableUtil;
import org.jetbrains.mps.openapi.util.SubProgressKind;

public class ModelCheckerIssueFinder implements IFinder {
  private final List<SpecificChecker> myExtraCheckers;

  public ModelCheckerIssueFinder() {
    myExtraCheckers = null;
  }
  public ModelCheckerIssueFinder(List<SpecificChecker> extraCheckers) {
    myExtraCheckers = extraCheckers;
  }
  public ModelCheckerIssueFinder(SpecificChecker... extraCheckers) {
    this(Arrays.asList(extraCheckers));
  }
  protected List<SpecificChecker> getSpecificCheckers() {
    return myExtraCheckers;
  }
  @Override
  public SearchResults find(SearchQuery searchQuery, ProgressMonitor monitor) {
    IHolder objectHolder = searchQuery.getObjectHolder();
    final SearchScope scope = searchQuery.getScope();
    List<SModel> models = ListSequence.fromList(new ArrayList<SModel>());
    List<SModule> modules = ListSequence.fromList(new ArrayList<SModule>());
    if (objectHolder instanceof ModelsHolder) {
      ModelsHolder modelsHolder = (ModelsHolder) objectHolder;
      for (SModelReference ref : modelsHolder.getObject()) {
        SModel resolved = scope.resolve(ref);
        if (resolved != null) {
          ListSequence.fromList(models).addElement(resolved);
        }
      }
    } else if (objectHolder instanceof ModulesHolder) {
      ModulesHolder modulesHolder = (ModulesHolder) objectHolder;
      Set<SModule> visibleModules = IterableUtil.asSet(scope.getModules());
      visibleModules.retainAll(modulesHolder.getObject());
      ListSequence.fromList(models).addSequence(ListSequence.fromList(ModelCheckerUtils.getModelDescriptors(visibleModules)));
      ListSequence.fromList(modules).addSequence(ListSequence.fromList(modulesHolder.getObject()));
    } else {
      throw new IllegalArgumentException();
    }

    int work = ListSequence.fromList(modules).count() + ListSequence.fromList(models).count() + 1;
    monitor.start("Checking", work);

    try {
      SearchResults<ModelCheckerIssue> rv = new SearchResults<ModelCheckerIssue>();
      if (!(ListSequence.fromList(modules).isEmpty())) {
        ModuleChecker moduleChecker = new ModuleChecker();
        for (SModule module : ListSequence.fromList(modules)) {
          moduleChecker.checkModule(module, monitor.subTask(1, SubProgressKind.REPLACING));
          if (monitor.isCanceled()) {
            break;
          }
        }
        rv.addAll(moduleChecker.getSearchResults());
      }
      monitor.advance(0);

      ModelChecker modelChecker = new ModelChecker();
      modelChecker.setSpecificCheckers(getSpecificCheckers());
      monitor.advance(1);
      for (SModel modelDescriptor : ListSequence.fromList(models)) {
        modelChecker.checkModel(modelDescriptor, monitor.subTask(1, SubProgressKind.REPLACING));
        if (monitor.isCanceled()) {
          break;
        }
      }
      rv.addAll(modelChecker.getSearchResults());
      return rv;
    } finally {
      monitor.done();
    }
  }
}
