package jetbrains.mps.ide.modelchecker.platform.actions;

/*Generated by MPS */

import jetbrains.mps.ide.findusages.model.SearchResults;
import jetbrains.mps.project.Project;
import java.util.List;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.mps.openapi.util.ProgressMonitor;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.jetbrains.mps.openapi.module.SModule;
import org.apache.log4j.Level;
import jetbrains.mps.ide.findusages.model.SearchResult;
import org.jetbrains.mps.openapi.util.SubProgressKind;
import org.apache.log4j.Logger;
import org.apache.log4j.LogManager;

public class ModelChecker {
  public static final String SEVERITY_ERROR = "Errors";
  public static final String SEVERITY_WARNING = "Warnings";
  public static final String SEVERITY_INFO = "Infos";
  private final SearchResults<ModelCheckerIssue> myResults;
  private final Project myProject;
  private List<SpecificChecker> mySpecificCheckers;
  public ModelChecker(@NotNull Project mpsProject) {
    myProject = mpsProject;
    myResults = new SearchResults<ModelCheckerIssue>();
  }
  public void checkModel(final SModel model, final ProgressMonitor monitor) {
    final Wrappers._T<List<SpecificChecker>> specificCheckers = new Wrappers._T<List<SpecificChecker>>(mySpecificCheckers);
    if (specificCheckers.value == null) {
      specificCheckers.value = ModelCheckerSettings.getInstance().getSpecificCheckers();
    }

    monitor.start("Checking " + model.getModelName(), ListSequence.fromList(specificCheckers.value).count());
    try {

      myProject.getModelAccess().runReadAction(new Runnable() {
        public void run() {
          SModule module = model.getModule();

          if (module == null) {
            if (LOG.isEnabledFor(Level.WARN)) {
              LOG.warn("Module is null for " + model.getModelName() + " model");
            }
          }

          if (module != null) {
            for (SpecificChecker specificChecker : ListSequence.fromList(specificCheckers.value)) {
              try {
                List<SearchResult<ModelCheckerIssue>> specificCheckerResults = specificChecker.checkModel(model, monitor.subTask(1, SubProgressKind.AS_COMMENT), myProject.getRepository());
                myResults.getSearchResults().addAll(specificCheckerResults);
              } catch (Throwable t) {
                if (LOG.isEnabledFor(Level.ERROR)) {
                  LOG.error("Error while " + model.getModelName() + " model checking", t);
                }
              }
              if (monitor.isCanceled()) {
                break;
              }
            }
          }
        }
      });
    } finally {
      monitor.done();
    }
  }
  public SearchResults<ModelCheckerIssue> getSearchResults() {
    return myResults;
  }
  public void setSpecificCheckers(List<SpecificChecker> specificCheckers) {
    mySpecificCheckers = specificCheckers;
  }
  protected static Logger LOG = LogManager.getLogger(ModelChecker.class);
}
