package jetbrains.mps.plugin;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import org.apache.log4j.LogManager;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.components.impl.stores.IProjectStore;
import com.intellij.openapi.project.ex.ProjectEx;
import java.io.File;
import jetbrains.mps.project.MPSProject;
import com.intellij.openapi.components.StorageScheme;
import java.rmi.RemoteException;
import java.rmi.Naming;
import jetbrains.mps.ide.ThreadUtils;

public class MPSPlugin {
  private static final Logger LOG = Logger.getLogger(LogManager.getLogger(MPSPlugin.class));
  private static MPSPlugin ourInstance;
  private IMPSPlugin myPlugin = null;
  private boolean myMessageShown = false;

  private MPSPlugin() {
  }

  @Deprecated
  public IProjectHandler getProjectHandler(Project project) {
    MPSPlugin.assertNotInEDT();
    IProjectStore projectStore = ((ProjectEx) project).getStateStore();
    File mpsProject = project.getComponent(MPSProject.class).getProjectFile();
    File projectFile = (projectStore.getStorageScheme() == StorageScheme.DEFAULT ?
      mpsProject.getParentFile() :
      mpsProject
    );
    String projectPath = projectFile.getAbsolutePath();
    return getProjectHandler(projectPath);
  }

  public IProjectHandler getProjectHandler(String projectPath) {
    try {
      IMPSPlugin plugin = getPlugin();
      if (plugin == null) {
        return null;
      }
      return plugin.getProjectHandlerFor(projectPath);
    } catch (RemoteException e) {
      return null;
    }
  }

  public boolean isIDEAPresent() {
    MPSPlugin.assertNotInEDT();
    try {
      IMPSPlugin plugin = getPlugin();
      if (plugin == null) {
        return false;
      }
      IIDEAHandler handler = plugin.getProjectCreator();
      if (handler == null) {
        return false;
      }
      handler.ping();
      return true;
    } catch (RemoteException e) {
      return false;
    }
  }

  public boolean openConnectionPresent() {
    MPSPlugin.assertNotInEDT();
    if (myPlugin == null) {
      return false;
    }
    try {
      IIDEAHandler handler = myPlugin.getProjectCreator();
      if (handler != null) {
        handler.ping();
      }
    } catch (RemoteException e) {
      myPlugin = null;
    }
    return myPlugin != null;
  }

  private IMPSPlugin getPlugin() {
    try {
      myPlugin = (IMPSPlugin) Naming.lookup("//localhost:2391/MPSPlugin");
    } catch (Exception e) {
      if (!(myMessageShown)) {
        myMessageShown = true;
        LOG.info("Wasn't able to connect to IDEA");
      }
    }
    return myPlugin;
  }

  public static MPSPlugin getInstance() {
    if (ourInstance == null) {
      ourInstance = new MPSPlugin();
    }
    return ourInstance;
  }

  private static void assertNotInEDT() {
    LOG.assertLog(!(ThreadUtils.isEventDispatchThread()), "You should not do this in EDT");
  }
}
