package jetbrains.mps.plugin;

/*Generated by MPS */

import java.rmi.server.UnicastRemoteObject;
import com.intellij.openapi.components.ProjectComponent;
import jetbrains.mps.logging.Logger;
import com.intellij.openapi.project.Project;
import java.rmi.RemoteException;
import jetbrains.mps.MPSCore;
import java.rmi.NoSuchObjectException;
import org.jetbrains.annotations.NonNls;
import org.jetbrains.annotations.NotNull;
import java.awt.Frame;
import com.intellij.openapi.wm.WindowManager;
import jetbrains.mps.smodel.ModelAccess;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.smodel.SModelRepository;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.smodel.SModelInternal;
import jetbrains.mps.smodel.SNodeId;
import jetbrains.mps.project.ProjectOperationContext;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.openapi.navigation.NavigationSupport;
import jetbrains.mps.util.SNodeOperations;
import jetbrains.mps.util.FrameUtil;
import jetbrains.mps.ide.findusages.model.SearchQuery;
import jetbrains.mps.ide.findusages.findalgorithm.finders.specific.AspectMethodsFinder;
import jetbrains.mps.project.GlobalScope;
import jetbrains.mps.ide.findusages.findalgorithm.finders.IFinder;
import jetbrains.mps.ide.findusages.view.UsagesViewTool;
import jetbrains.mps.ide.findusages.view.FindUtils;
import jetbrains.mps.kernel.model.SModelUtil;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.ide.findusages.model.IResultProvider;
import jetbrains.mps.smodel.IScope;
import jetbrains.mps.util.Computable;

public class MPSProjectIDEHandler extends UnicastRemoteObject implements IMPSIDEHandler, ProjectComponent {
  private static final Logger LOG = Logger.getLogger(MPSProjectIDEHandler.class);
  private Project myProject;

  public MPSProjectIDEHandler(Project project) throws RemoteException {
    myProject = project;
  }

  @Override
  public void projectOpened() {
    if (MPSCore.getInstance().isTestMode()) {
      return;
    }
    new Thread() {
      @Override
      public void run() {
        try {
          IProjectHandler handler = MPSPlugin.getInstance().getProjectHandler(myProject);
          if (handler == null) {
            return;
          }
          handler.addIdeHandler(MPSProjectIDEHandler.this);
        } catch (RemoteException e) {
          e.printStackTrace();
        }
      }
    }.start();
  }

  @Override
  public void projectClosed() {
    if (MPSCore.getInstance().isTestMode()) {
      return;
    }
    new Thread() {
      @Override
      public void run() {
        IProjectHandler handler = MPSPlugin.getInstance().getProjectHandler(myProject);
        if (handler != null) {
          try {
            handler.removeIdeHandler(MPSProjectIDEHandler.this);
          } catch (RemoteException e) {
            MPSProjectIDEHandler.LOG.error(e);
          }
        }
        try {
          UnicastRemoteObject.unexportObject(MPSProjectIDEHandler.this, true);
        } catch (NoSuchObjectException e) {
          throw new RuntimeException(e);
        }
      }
    }.start();
  }

  @NonNls
  @NotNull
  @Override
  public String getComponentName() {
    return "MPS Project IDE Handler";
  }

  @Override
  public void initComponent() {
  }

  @Override
  public void disposeComponent() {
  }

  private Frame getMainFrame() {
    return WindowManager.getInstance().getFrame(myProject);
  }

  @Override
  public void showNode(final String namespace, final String id) throws RemoteException {
    ModelAccess.instance().runWriteInEDT(new Runnable() {
      public void run() {
        for (SModel descriptor : SModelRepository.getInstance().getModelDescriptors()) {
          if (!(namespace.equals(descriptor.getModelName()))) {
            continue;
          }
          SNode node = ((SModelInternal) descriptor).getNode(SNodeId.fromString(id));
          if (node != null) {
            ProjectOperationContext context = new ProjectOperationContext(ProjectHelper.toMPSProject(myProject));
            NavigationSupport.getInstance().openNode(context, node, true, !(SNodeOperations.isRoot(node)));
          }
        }
        FrameUtil.activateFrame(getMainFrame());
      }
    });
  }

  @Override
  public void showAspectMethodUsages(final String namespace, final String name) throws RemoteException {
    SearchQuery searchQuery = new SearchQuery(new AspectMethodsFinder.AspectMethodsHolder(namespace, name), GlobalScope.getInstance());
    IFinder[] finders = new IFinder[]{new AspectMethodsFinder()};
    myProject.getComponent(UsagesViewTool.class).findUsages(FindUtils.makeProvider(finders), searchQuery, false, true, false, "No usages for that method");
  }

  @Override
  public void showConceptNode(final String fqName) throws RemoteException {
    ModelAccess.instance().runWriteInEDT(new Runnable() {
      @Override
      public void run() {
        SNode concept = SModelUtil.findConceptDeclaration(fqName, GlobalScope.getInstance());
        NavigationSupport.getInstance().openNode(new ProjectOperationContext(ProjectHelper.toMPSProject(myProject)), concept, true, false);
        FrameUtil.activateFrame(getMainFrame());
      }
    });
  }

  @Override
  public void showClassUsages(final String fqName) throws RemoteException {
    ModelAccess.instance().runReadAction(new Runnable() {
      @Override
      public void run() {
        SNode cls = SModelUtil.findNodeByFQName(fqName, SConceptOperations.findConceptDeclaration("jetbrains.mps.baseLanguage.structure.Classifier"), GlobalScope.getInstance());
        if (cls == null) {
          MPSProjectIDEHandler.LOG.error("Can't find a class " + fqName);
          return;
        }
        FrameUtil.activateFrame(getMainFrame());
        findUsages(cls, GlobalScope.getInstance(), FindUtils.makeProvider(FindUtils.getFinderByClassName("jetbrains.mps.baseLanguage.findUsages.ClassUsages_Finder")));
      }
    });
  }

  @Override
  public void showMethodUsages(final String classFqName, final String methodName, final int parameterCount) throws RemoteException {
    ModelAccess.instance().runReadAction(new Runnable() {
      @Override
      public void run() {
        if (classFqName == null || methodName == null) {
          MPSProjectIDEHandler.LOG.error("Can't find a method " + classFqName + "." + methodName);
          return;

        }
        SNode cls = jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.as(SModelUtil.findNodeByFQName(classFqName, SConceptOperations.findConceptDeclaration("jetbrains.mps.baseLanguage.structure.Classifier"), GlobalScope.getInstance()), "jetbrains.mps.baseLanguage.structure.Classifier");
        if (cls == null) {
          MPSProjectIDEHandler.LOG.error("Can't find a class " + classFqName);
          return;
        }
        Iterable<SNode> allMethods = (Iterable<SNode>) ListSequence.fromList(jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.getChildren(cls)).where(new IWhereFilter<SNode>() {
          public boolean accept(SNode it) {
            return jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.isInstanceOf(it, "jetbrains.mps.baseLanguage.structure.BaseMethodDeclaration");
          }
        });
        SNode method = Sequence.fromIterable(allMethods).findFirst(new IWhereFilter<SNode>() {
          public boolean accept(SNode it) {
            return methodName.equals(SPropertyOperations.getString(it, "name")) && (int) ListSequence.fromList(SLinkOperations.getTargets(it, "parameter", true)).count() == parameterCount;
          }
        });
        if (method == null) {
          MPSProjectIDEHandler.LOG.error("Can't find a method " + classFqName + "." + methodName);
          return;
        }
        FrameUtil.activateFrame(getMainFrame());
        IResultProvider provider = FindUtils.makeProvider(FindUtils.getFinderByClassName("jetbrains.mps.baseLanguage.findUsages.ConstructorUsages_Finder"), FindUtils.getFinderByClassName("jetbrains.mps.baseLanguage.findUsages.BaseMethodUsages_Finder"));
        findUsages(method, GlobalScope.getInstance(), provider);
      }
    });
  }

  private void findUsages(@NotNull final SNode node, final IScope scope, final IResultProvider provider) {
    new Thread() {
      @Override
      public void run() {
        SearchQuery query = ModelAccess.instance().runReadAction(new Computable<SearchQuery>() {
          @Override
          public SearchQuery compute() {
            return new SearchQuery(node, scope);
          }
        });
        myProject.getComponent(UsagesViewTool.class).findUsages(provider, query, true, true, false, "No usages for that node");
      }
    }.start();
  }
}
