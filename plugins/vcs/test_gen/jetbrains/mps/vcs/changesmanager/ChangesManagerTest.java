package jetbrains.mps.vcs.changesmanager;

/*Generated by MPS */

import java.io.File;
import jetbrains.mps.util.FileUtil;
import jetbrains.mps.project.Project;
import com.intellij.openapi.vcs.changes.ChangeListManagerImpl;
import com.intellij.openapi.vcs.AbstractVcs;
import com.intellij.openapi.vfs.VirtualFile;
import java.util.Map;
import com.intellij.openapi.vcs.FileStatus;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import com.intellij.openapi.vcs.FileStatusManager;
import org.junit.Before;
import jetbrains.mps.ide.project.ProjectHelper;
import com.intellij.openapi.vcs.impl.projectlevelman.AllVcses;
import com.intellij.openapi.vcs.VcsShowConfirmationOption;
import jetbrains.mps.ide.vfs.VirtualFileUtils;
import jetbrains.mps.smodel.DefaultSModelDescriptor;
import jetbrains.mps.ide.platform.watching.FSChangesWatcher;
import javax.swing.SwingUtilities;
import java.lang.reflect.InvocationTargetException;
import com.intellij.openapi.vcs.ProjectLevelVcsManager;
import com.intellij.openapi.vcs.VcsConfiguration;
import org.junit.After;
import jetbrains.mps.nodeEditor.InspectorTool;
import org.junit.Assert;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import com.intellij.openapi.vcs.FileStatusListener;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import com.intellij.openapi.vcs.changes.VcsDirtyScopeManager;
import jetbrains.mps.smodel.SModelRepository;
import jetbrains.mps.smodel.SModelFqName;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.List;
import java.util.Arrays;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.internal.collections.runtime.ITranslator2;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.IVisitor;
import jetbrains.mps.util.NameUtil;
import jetbrains.mps.util.SNodeOperations;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.smodel.behaviour.BehaviorReflection;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import com.intellij.openapi.vcs.changes.Change;
import jetbrains.mps.vcs.concrete.GitUtils;
import com.intellij.openapi.vcs.VcsException;
import jetbrains.mps.util.InternUtil;
import jetbrains.mps.smodel.persistence.def.ModelReadException;
import jetbrains.mps.smodel.persistence.def.ModelPersistence;
import jetbrains.mps.smodel.descriptor.EditableSModelDescriptor;
import jetbrains.mps.smodel.SModelRepositoryAdapter;
import java.util.Set;
import jetbrains.mps.smodel.SModelDescriptor;
import java.io.IOException;
import java.util.ArrayList;
import com.intellij.openapi.vcs.rollback.RollbackProgressListener;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.vcs.diff.ChangeSet;
import jetbrains.mps.vcs.diff.changes.ModelChange;
import jetbrains.mps.internal.collections.runtime.IterableUtils;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.util.Computable;
import jetbrains.mps.vcs.diff.ModelChangeSet;
import jetbrains.mps.vcs.diff.ChangeSetBuilder;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.smodel.SNodePointer;
import com.intellij.openapi.fileEditor.FileEditor;
import com.intellij.openapi.command.undo.UndoManager;
import org.junit.Test;
import java.util.Random;
import jetbrains.mps.vcs.diff.changes.NodeCopier;
import jetbrains.mps.vcs.diff.changes.NodeGroupChange;
import jetbrains.mps.vcs.diff.changes.AddRootChange;
import jetbrains.mps.vcs.diff.changes.ModuleDependencyChange;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.project.AbstractModule;
import jetbrains.mps.extapi.model.EditableSModel;
import jetbrains.mps.project.structure.modules.ModuleReference;
import jetbrains.mps.workbench.actions.model.DeleteModelHelper;
import jetbrains.mps.smodel.BaseEditableSModelDescriptor;
import org.junit.BeforeClass;
import jetbrains.mps.smodel.SReference;
import com.intellij.openapi.util.registry.Registry;
import jetbrains.mps.TestMain;
import org.junit.AfterClass;

public class ChangesManagerTest {
  private static final File DESTINATION_PROJECT_DIR = new File(FileUtil.getTempDir(), "testConflicts");
  private static final File PROJECT_ARCHIVE = new File("testbench/modules/fugue.zip");
  private static final String PROJECT_FILE = "fugue.mpr";
  private static final String MODEL_PREFIX = "ru.geevee.fugue.";
  private static Project ourProject;
  private static boolean ourEnabled;
  private CurrentDifferenceRegistry myRegistry;
  private Project myProject;
  private boolean myWaitCompleted;
  private final Object myWaitLock = new Object();
  private ChangeListManagerImpl myChangeListManager;
  private CurrentDifference myHtmlDiff;
  private CurrentDifference myUiDiff;
  private CurrentDifference myUtilDiff;
  private AbstractVcs myGitVcs;
  private com.intellij.openapi.project.Project myIdeaProject;
  private VirtualFile myUtilVirtualFile;
  private Runnable myAfterReloadTask;
  private Map<String, FileStatus> myExpectedFileStatuses = MapSequence.fromMap(new HashMap<String, FileStatus>());
  private FileStatusManager myFileStatusManager;

  public ChangesManagerTest() {
  }

  @Before
  public void init() {
    myProject = ourProject;
    myIdeaProject = ProjectHelper.toIdeaProject(myProject);
    myRegistry = CurrentDifferenceRegistry.getInstance(myIdeaProject);
    waitForChangesManager();

    myGitVcs = AllVcses.getInstance(myIdeaProject).getByName("Git");
    assert myGitVcs != null;

    myHtmlDiff = getCurrentDifference("html");
    myUiDiff = getCurrentDifference("ui");
    myUtilDiff = getCurrentDifference("util");

    myChangeListManager = ChangeListManagerImpl.getInstanceImpl(myIdeaProject);
    myFileStatusManager = FileStatusManager.getInstance(myIdeaProject);

    setAutoaddPolicy(VcsShowConfirmationOption.Value.DO_NOTHING_SILENTLY);

    myUtilVirtualFile = VirtualFileUtils.getVirtualFile(((DefaultSModelDescriptor) myUtilDiff.getModelDescriptor()).getSource().getFile());

    FSChangesWatcher.instance().addReloadListener(new ChangesManagerTest.MyReloadListener());

    myRegistry.getCommandQueue().setHadExceptions(false);

    MapSequence.fromMap(myExpectedFileStatuses).put("html.SAHParser", FileStatus.MODIFIED);
    MapSequence.fromMap(myExpectedFileStatuses).put("ui.DocumentLayout", FileStatus.MODIFIED);
    MapSequence.fromMap(myExpectedFileStatuses).put("ui.HTMLPanel", FileStatus.MODIFIED);

    if (!(ourEnabled)) {
      myChangeListManager.ensureUpToDate(false);
      try {
        SwingUtilities.invokeAndWait(new Runnable() {
          public void run() {
            myFileStatusManager.fileStatusesChanged();
          }
        });
      } catch (InterruptedException e) {
        throw new AssertionError(e);
      } catch (InvocationTargetException e) {
        throw new AssertionError(e);
      }

      checkAndEnable();
      ourEnabled = true;
    }
  }

  private void setAutoaddPolicy(VcsShowConfirmationOption.Value value) {
    ProjectLevelVcsManager vcsManager = ProjectLevelVcsManager.getInstance(myIdeaProject);
    vcsManager.getStandardConfirmation(VcsConfiguration.StandardConfirmation.ADD, myGitVcs).setValue(value);
  }

  @After
  public void dispose() throws InvocationTargetException, InterruptedException {
    SwingUtilities.invokeAndWait(new Runnable() {
      public void run() {
        myIdeaProject.getComponent(InspectorTool.class).getInspector().editNode(null, null);
      }
    });
    Assert.assertFalse(myRegistry.getCommandQueue().hadExceptions());
  }

  private void waitForSomething(Runnable waitScheduling) {
    synchronized (myWaitLock) {
      myWaitCompleted = false;
      waitScheduling.run();
    }
    while (!(myWaitCompleted)) {
      synchronized (myWaitLock) {
        try {
          myWaitLock.wait();
        } catch (InterruptedException e) {
          e.printStackTrace();
        }
      }
    }
  }

  private void waitCompleted() {
    synchronized (myWaitLock) {
      myWaitCompleted = true;
      myWaitLock.notify();
    }
  }

  private void doSomethingAndWaitForFileStatusChange(@NotNull final Runnable task, @NotNull final VirtualFile file, @Nullable final FileStatus expectedFileStatus) {
    waitForSomething(new Runnable() {
      public void run() {
        final FileStatus statusBefore = myFileStatusManager.getStatus(file);
        final Wrappers._T<FileStatusListener> listener = new Wrappers._T<FileStatusListener>();
        final _FunctionTypes._void_P0_E0 stopIfNeeded = new _FunctionTypes._void_P0_E0() {
          public void invoke() {
            if ((expectedFileStatus == null ?
              statusBefore != myFileStatusManager.getStatus(file) :
              expectedFileStatus == myFileStatusManager.getStatus(file)
            )) {
              myFileStatusManager.removeFileStatusListener(listener.value);
              // Wait until changes manager is notified about changed file status 
              try {
                Thread.sleep(100);
              } catch (InterruptedException e) {
                e.printStackTrace();
              }
              waitCompleted();
            }
          }
        };
        listener.value = new FileStatusListener() {
          @Override
          public void fileStatusesChanged() {
            stopIfNeeded.invoke();
          }

          @Override
          public void fileStatusChanged(@NotNull VirtualFile f) {
            stopIfNeeded.invoke();
          }
        };
        myFileStatusManager.addFileStatusListener(listener.value);
        task.run();
        VcsDirtyScopeManager.getInstance(myIdeaProject).fileDirty(file);
        myChangeListManager.scheduleUpdate();
        stopIfNeeded.invoke();
      }
    });
  }

  private void waitForChangesManager() {
    waitForSomething(new Runnable() {
      public void run() {
        myRegistry.getCommandQueue().addTask(new Runnable() {
          public void run() {
            waitCompleted();
          }
        });
      }
    });
  }

  private CurrentDifference getCurrentDifference(String shortName) {
    return myRegistry.getCurrentDifference((DefaultSModelDescriptor) SModelRepository.getInstance().getModelDescriptor(SModelFqName.fromString(MODEL_PREFIX + shortName)));
  }

  private void checkAndEnable() {
    Assert.assertNull(myHtmlDiff.getChangeSet());
    Assert.assertNull(myUiDiff.getChangeSet());
    Assert.assertNull(myUtilDiff.getChangeSet());

    myHtmlDiff.setEnabled(true);
    myUiDiff.setEnabled(true);
    myUtilDiff.setEnabled(true);
    waitForChangesManager();

    Assert.assertTrue(ListSequence.fromList(check_4gxggu_a0a9a92(myHtmlDiff.getChangeSet())).isNotEmpty());
    Assert.assertTrue(ListSequence.fromList(check_4gxggu_a0a01a92(myUiDiff.getChangeSet())).isNotEmpty());
    Assert.assertNull(myUtilDiff.getChangeSet());
  }

  private void checkRootStatuses() {
    final NodeFileStatusMapping fsm = myIdeaProject.getComponent(NodeFileStatusMapping.class);
    final List<DefaultSModelDescriptor> interestingModels = Arrays.asList(myHtmlDiff.getModelDescriptor(), myUiDiff.getModelDescriptor(), myUtilDiff.getModelDescriptor());
    // query for first time 
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        ListSequence.fromList(interestingModels).translate(new ITranslator2<DefaultSModelDescriptor, SNode>() {
          public Iterable<SNode> translate(DefaultSModelDescriptor md) {
            return md.getSModel().getRootNodes();
          }
        }).visitAll(new IVisitor<SNode>() {
          public void visit(SNode r) {
            fsm.getStatus(r);
          }
        });
      }
    });
    // wait while statuses update 
    waitForChangesManager();
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        for (SNode r : ListSequence.fromList(interestingModels).translate(new ITranslator2<DefaultSModelDescriptor, SNode>() {
          public Iterable<SNode> translate(DefaultSModelDescriptor md) {
            return md.getSModel().getRootNodes();
          }
        })) {
          String simpleName = NameUtil.shortNameFromLongName(SNodeOperations.getModelLongName(r.getModel())) + "." + r.getName();
          FileStatus expectedStatus = MapSequence.fromMap(myExpectedFileStatuses).get(simpleName);
          FileStatus actualStatus = fsm.getStatus(r);
          actualStatus = (FileStatus.NOT_CHANGED == actualStatus ?
            null :
            actualStatus
          );
          Assert.assertSame(expectedStatus, actualStatus);
        }
      }
    });
  }

  private void modifyModel() {
    runCommandAndWait(new Runnable() {
      public void run() {
        SModel model = myUtilDiff.getModelDescriptor().getSModel();
        SNode root = ListSequence.fromList(SModelOperations.getRoots(model, "jetbrains.mps.baseLanguage.structure.ClassConcept")).findFirst(new IWhereFilter<SNode>() {
          public boolean accept(SNode r) {
            return "ImageLoader".equals(SPropertyOperations.getString(r, "name"));
          }
        });
        SPropertyOperations.set(Sequence.fromIterable(BehaviorReflection.invokeNonVirtual((Class<Iterable<SNode>>) ((Class) Object.class), root, "jetbrains.mps.baseLanguage.structure.Classifier", "call_methods_5292274854859311639", new Object[]{})).findFirst(new IWhereFilter<SNode>() {
          public boolean accept(SNode m) {
            return "getImageAttempts".equals(SPropertyOperations.getString(m, "name"));
          }
        }), "name", "getImageAttempts2");
        ListSequence.fromList(SLinkOperations.getTargets(root, "member", true)).removeWhere(new IWhereFilter<SNode>() {
          public boolean accept(SNode it) {
            return jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.isInstanceOf(it, "jetbrains.mps.baseLanguage.structure.FieldDeclaration");
          }
        });
      }
    });

    waitForChangesManager();
    Assert.assertTrue(ListSequence.fromList(check_4gxggu_a0a3a13(myUtilDiff.getChangeSet())).isNotEmpty());

    MapSequence.fromMap(myExpectedFileStatuses).put("util.ImageLoader", FileStatus.MODIFIED);
    checkRootStatuses();
  }

  private void saveAndCommit() {
    runCommandAndWait(new Runnable() {
      public void run() {
        myUtilDiff.getModelDescriptor().save();
      }
    });

    myChangeListManager.ensureUpToDate(false);
    final Change change = myChangeListManager.getChange(myUtilVirtualFile);
    assert change != null;
    doSomethingAndWaitForFileStatusChange(new Runnable() {
      public void run() {
        myGitVcs.getCheckinEnvironment().commit(Arrays.asList(change), "dumb commit");
      }
    }, myUtilVirtualFile, null);

    waitForChangesManager();
    Assert.assertNull(myUtilDiff.getChangeSet());

    MapSequence.fromMap(myExpectedFileStatuses).removeKey("util.ImageLoader");
    checkRootStatuses();
  }

  private void uncommit() {
    doSomethingAndWaitForFileStatusChange(new Runnable() {
      public void run() {
        try {
          GitUtils.uncommmit(myIdeaProject, myIdeaProject.getBaseDir());
        } catch (VcsException e) {
          throw new AssertionError(e);
        }
      }
    }, myUtilVirtualFile, null);

    waitForChangesManager();
    Assert.assertTrue(ListSequence.fromList(check_4gxggu_a0a3a33(myUtilDiff.getChangeSet())).isNotEmpty());

    MapSequence.fromMap(myExpectedFileStatuses).put("util.ImageLoader", FileStatus.MODIFIED);
    checkRootStatuses();
  }

  private SNode createNewRoot(SModel modelContent) {
    SNode root = (SNode) new jetbrains.mps.smodel.SNode(InternUtil.intern("jetbrains.mps.baseLanguage.structure.ClassConcept"));
    SPropertyOperations.set(root, "name", "NewRoot");
    SModelOperations.addRootNode(modelContent, root);
    return root;
  }

  private void modifyExternally() throws ModelReadException {
    int changesBefore = ListSequence.fromList(check_4gxggu_a0a0a53(myUtilDiff.getChangeSet())).count();
    final SModel modelContent = ModelPersistence.readModel(((DefaultSModelDescriptor) myUtilDiff.getModelDescriptor()).getSource().getFile(), false);
    createNewRoot(modelContent);
    final EditableSModelDescriptor modelDescriptor = myUtilDiff.getModelDescriptor();
    waitForSomething(new Runnable() {
      public void run() {
        SModelRepository.getInstance().addModelRepositoryListener(new SModelRepositoryAdapter() {
          @Override
          public void modelsReplaced(Set<SModelDescriptor> modelDescriptors) {
            if (modelDescriptors.contains(modelDescriptor)) {
              SModelRepository.getInstance().removeModelRepositoryListener(this);
            }
            waitCompleted();
          }
        });
        ModelAccess.instance().runWriteInEDT(new Runnable() {
          public void run() {
            try {
              myUtilVirtualFile.setBinaryContent(ModelPersistence.modelToString(modelContent).getBytes(FileUtil.DEFAULT_CHARSET));
            } catch (IOException e) {
              throw new AssertionError(e);
            }
          }
        });
        ModelAccess.instance().flushEventQueue();
      }
    });
    waitForChangesManager();
    Assert.assertEquals(changesBefore + 1, ListSequence.fromList(check_4gxggu_a1a6a53(myUtilDiff.getChangeSet())).count());

    MapSequence.fromMap(myExpectedFileStatuses).put("util.NewRoot", FileStatus.ADDED);
    checkRootStatuses();
  }

  private void rollback() throws VcsException {
    final List<VcsException> exceptions = ListSequence.fromList(new ArrayList<VcsException>());
    doSomethingAndWaitForFileStatusChange(new Runnable() {
      public void run() {
        myGitVcs.getRollbackEnvironment().rollbackChanges(Arrays.asList(myChangeListManager.getChange(myUtilVirtualFile)), exceptions, RollbackProgressListener.EMPTY);
      }
    }, myUtilVirtualFile, null);

    if (ListSequence.fromList(exceptions).isNotEmpty()) {
      throw ListSequence.fromList(exceptions).first();
    }
    waitForChangesManager();
    Assert.assertTrue(ListSequence.fromList(check_4gxggu_a0a5a63(myUtilDiff.getChangeSet())).isEmpty());

    SetSequence.fromSet(MapSequence.fromMap(myExpectedFileStatuses).keySet()).where(new IWhereFilter<String>() {
      public boolean accept(String k) {
        return k.startsWith("util.");
      }
    }).toListSequence().visitAll(new IVisitor<String>() {
      public void visit(String k) {
        MapSequence.fromMap(myExpectedFileStatuses).removeKey(k);
      }
    });
    checkRootStatuses();
  }

  private String getChangeSetString(ChangeSet changeSet) {
    return getChangeSetString(changeSet.getModelChanges());
  }

  private String getChangeSetString(List<ModelChange> modelChanges) {
    return IterableUtils.join(ListSequence.fromList(modelChanges).select(new ISelector<ModelChange, String>() {
      public String select(ModelChange c) {
        return c.toString();
      }
    }).sort(new ISelector<String, String>() {
      public String select(String s) {
        return s;
      }
    }, true), "|");
  }

  private void assertChangeSetIsCorrect(final ChangeSet changeSet) {
    ChangeSet rebuiltChangeSet = ModelAccess.instance().runReadAction(new Computable<ModelChangeSet>() {
      public ModelChangeSet compute() {
        return ChangeSetBuilder.buildChangeSet(changeSet.getOldModel(), changeSet.getNewModel());
      }
    });
    Assert.assertEquals(getChangeSetString(rebuiltChangeSet), getChangeSetString(changeSet));
  }

  private void waitAndCheck(CurrentDifference currentDifference) {
    waitForChangesManager();
    assertChangeSetIsCorrect(currentDifference.getChangeSet());
  }

  private void runCommandAndWait(Runnable r) {
    ModelAccess.instance().runCommandInEDT(r, myProject);
    ModelAccess.instance().flushEventQueue();
  }

  private void doSomethingAndUndo(CurrentDifference diff, _FunctionTypes._return_P0_E0<? extends SNode>... tasks) {
    doSomethingAndUndo(diff, false, tasks);
  }

  private void doSomethingAndUndo(CurrentDifference diff, boolean checkAfterEachUndo, _FunctionTypes._return_P0_E0<? extends SNode>... tasks) {
    doSomethingAndUndo(diff, checkAfterEachUndo, Arrays.asList(tasks));
  }

  private void doSomethingAndUndo(CurrentDifference diff, boolean checkAfterEachUndo, List<_FunctionTypes._return_P0_E0<? extends SNode>> tasks) {
    checkRootStatuses();
    Map<String, FileStatus> statusesBefore = new HashMap<String, FileStatus>(myExpectedFileStatuses);
    String stringBefore = getChangeSetString(diff.getChangeSet());

    final List<SNodeReference> affectedNodePointers = ListSequence.fromList(new ArrayList<SNodeReference>());
    for (final _FunctionTypes._return_P0_E0<? extends SNode> t : ListSequence.fromList(tasks)) {
      runCommandAndWait(new Runnable() {
        public void run() {
          SNode node = t.invoke();
          assert node == null || SNodeOperations.isRoot(node);
          ListSequence.fromList(affectedNodePointers).addElement((node == null ?
            null :
            new SNodePointer(node)
          ));
        }
      });
      waitAndCheck(diff);
      checkRootStatuses();
    }

    undoAndCheck(diff, affectedNodePointers, checkAfterEachUndo);
    Assert.assertEquals(stringBefore, getChangeSetString(diff.getChangeSet()));

    myExpectedFileStatuses = statusesBefore;
    checkRootStatuses();
  }

  private void undoAndCheck(CurrentDifference diff, List<SNodeReference> affectedNodePointers, boolean checkAfterEachUndo) {
    for (final SNodeReference np : ListSequence.fromList(affectedNodePointers).reversedList()) {
      try {
        SwingUtilities.invokeAndWait(new Runnable() {
          public void run() {
            FileEditor fe = null;
            if (np != null) {
              fe = new DummyFileEditor(np);
            }
            UndoManager.getInstance(myIdeaProject).undo(fe);
            check_4gxggu_a3a0a0a0a0a54(fe);
          }
        });
      } catch (Throwable t) {
        throw new AssertionError(t);
      }
      if (checkAfterEachUndo) {
        waitAndCheck(diff);
      }
    }
    if (!(checkAfterEachUndo)) {
      waitAndCheck(diff);
    }
  }

  private SNode getDocumentLayoutRoot() {
    SModel model = myUiDiff.getModelDescriptor().getSModel();
    return ListSequence.fromList(SModelOperations.getRoots(model, "jetbrains.mps.baseLanguage.structure.ClassConcept")).findFirst(new IWhereFilter<SNode>() {
      public boolean accept(SNode r) {
        return "DocumentLayout".equals(SPropertyOperations.getString(r, "name"));
      }
    });
  }

  @Test
  public void modifySaveCommit() throws VcsException {
    checkRootStatuses();
    modifyModel();
    saveAndCommit();
    uncommit();
  }

  @Test
  public void modifyExternallyRollback() throws ModelReadException, IOException, VcsException {
    modifyModel();
    modifyExternally();
    rollback();
  }

  @Test
  public void removeModifiedRoot() {
    doSomethingAndUndo(myUiDiff, new _FunctionTypes._return_P0_E0<SNode>() {
      public SNode invoke() {
        SNode root = getDocumentLayoutRoot();
        jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.deleteNode(root);
        return (SNode) null;
      }
    });
  }

  @Test
  public void addRoot() {
    final Wrappers._T<SNode> root = new Wrappers._T<SNode>();
    doSomethingAndUndo(myUiDiff, new _FunctionTypes._return_P0_E0<SNode>() {
      public SNode invoke() {
        SModel model = myUiDiff.getModelDescriptor().getSModel();
        root.value = createNewRoot(model);
        MapSequence.fromMap(myExpectedFileStatuses).put("ui.NewRoot", FileStatus.ADDED);
        return (SNode) null;
      }
    }, new _FunctionTypes._return_P0_E0<SNode>() {
      public SNode invoke() {
        SPropertyOperations.set(root.value, "name", "NewRootName");
        MapSequence.fromMap(myExpectedFileStatuses).removeKey("ui.NewRootName");
        MapSequence.fromMap(myExpectedFileStatuses).put("ui.NewRootName", FileStatus.ADDED);
        return root.value;
      }
    });
  }

  @Test
  public void changeProperty() {
    final Wrappers._T<SNode> method = new Wrappers._T<SNode>();
    doSomethingAndUndo(myUiDiff, new _FunctionTypes._return_P0_E0<SNode>() {
      public SNode invoke() {
        method.value = Sequence.fromIterable(BehaviorReflection.invokeNonVirtual((Class<Iterable<SNode>>) ((Class) Object.class), getDocumentLayoutRoot(), "jetbrains.mps.baseLanguage.structure.Classifier", "call_methods_5292274854859311639", new Object[]{})).findFirst(new IWhereFilter<SNode>() {
          public boolean accept(SNode m) {
            return "selectAll".equals(SPropertyOperations.getString(m, "name"));
          }
        });
        Assert.assertNotNull(method.value);
        SPropertyOperations.set(method.value, "name", "selectEverything");
        return jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.getContainingRoot(method.value);
      }
    }, new _FunctionTypes._return_P0_E0<SNode>() {
      public SNode invoke() {
        SPropertyOperations.set(method.value, "name", "selectEverySinglePiece");
        return jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.getContainingRoot(method.value);
      }
    });
  }

  @Test
  public void changeReference() {
    final Wrappers._T<SNode> root = new Wrappers._T<SNode>();
    final Wrappers._T<SNode> method = new Wrappers._T<SNode>();
    doSomethingAndUndo(myUiDiff, new _FunctionTypes._return_P0_E0<SNode>() {
      public SNode invoke() {
        root.value = getDocumentLayoutRoot();
        method.value = Sequence.fromIterable(BehaviorReflection.invokeNonVirtual((Class<Iterable<SNode>>) ((Class) Object.class), root.value, "jetbrains.mps.baseLanguage.structure.Classifier", "call_methods_5292274854859311639", new Object[]{})).findFirst(new IWhereFilter<SNode>() {
          public boolean accept(SNode m) {
            return "getSize".equals(SPropertyOperations.getString(m, "name"));
          }
        });
        Assert.assertNotNull(method.value);
        SLinkOperations.setTarget(jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.cast(SLinkOperations.getTarget(method.value, "returnType", true), "jetbrains.mps.baseLanguage.structure.ClassifierType"), "classifier", root.value, false);
        return root.value;
      }
    }, new _FunctionTypes._return_P0_E0<SNode>() {
      public SNode invoke() {
        SLinkOperations.setTarget(jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.cast(SLinkOperations.getTarget(method.value, "returnType", true), "jetbrains.mps.baseLanguage.structure.ClassifierType"), "classifier", Sequence.fromIterable(BehaviorReflection.invokeNonVirtual((Class<Iterable<SNode>>) ((Class) Object.class), root.value, "jetbrains.mps.baseLanguage.structure.Classifier", "call_nestedClassifiers_5292274854859193142", new Object[]{})).first(), false);
        return jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.getContainingRoot(method.value);
      }
    });
  }

  @Test
  public void moveNode() {
    final Wrappers._T<SNode> root = new Wrappers._T<SNode>();
    final Wrappers._T<SNode> field = new Wrappers._T<SNode>();
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        root.value = getDocumentLayoutRoot();
        field.value = Sequence.fromIterable(BehaviorReflection.invokeNonVirtual((Class<Iterable<SNode>>) ((Class) Object.class), root.value, "jetbrains.mps.baseLanguage.structure.ClassConcept", "call_fields_5292274854859383272", new Object[]{})).findFirst(new IWhereFilter<SNode>() {
          public boolean accept(SNode f) {
            return "textPositions".equals(SPropertyOperations.getString(f, "name"));
          }
        });
      }
    });
    Assert.assertNotNull(field.value);

    _FunctionTypes._return_P0_E0<? extends SNode> moveUpTwice = new _FunctionTypes._return_P0_E0<SNode>() {
      public SNode invoke() {
        jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.insertPrevSiblingChild(field.value, jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.getPrevSibling(field.value));
        jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.insertPrevSiblingChild(field.value, jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.getPrevSibling(field.value));
        return jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.getContainingRoot(field.value);
      }
    };
    _FunctionTypes._return_P0_E0<? extends SNode> moveDown = new _FunctionTypes._return_P0_E0<SNode>() {
      public SNode invoke() {
        jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.insertNextSiblingChild(field.value, jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.getNextSibling(field.value));
        return jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.getContainingRoot(field.value);
      }
    };
    _FunctionTypes._return_P0_E0<? extends SNode> moveToOtherClass = new _FunctionTypes._return_P0_E0<SNode>() {
      public SNode invoke() {
        SNode inner = jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.cast(Sequence.fromIterable(BehaviorReflection.invokeNonVirtual((Class<Iterable<SNode>>) ((Class) Object.class), root.value, "jetbrains.mps.baseLanguage.structure.Classifier", "call_nestedClassifiers_5292274854859193142", new Object[]{})).first(), "jetbrains.mps.baseLanguage.structure.ClassConcept");
        ListSequence.fromList(SLinkOperations.getTargets(inner, "member", true)).addElement(field.value);
        return jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.getContainingRoot(field.value);
      }
    };

    List<_FunctionTypes._return_P0_E0<? extends SNode>> tasks = ListSequence.fromList(new ArrayList<_FunctionTypes._return_P0_E0<? extends SNode>>());
    for (int i = 0; i < 3; i++) {
      ListSequence.fromList(tasks).addElement(moveUpTwice);
    }
    for (int i = 0; i < 19; i++) {
      ListSequence.fromList(tasks).addElement(moveDown);
    }
    ListSequence.fromList(tasks).addElement(moveToOtherClass);
    doSomethingAndUndo(myUiDiff, false, tasks);
  }

  @Test
  public void inlineVariable() {
    final Wrappers._T<SNode> root = new Wrappers._T<SNode>();
    final Wrappers._T<SNode> method = new Wrappers._T<SNode>();
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        root.value = getDocumentLayoutRoot();
        method.value = Sequence.fromIterable(BehaviorReflection.invokeNonVirtual((Class<Iterable<SNode>>) ((Class) Object.class), root.value, "jetbrains.mps.baseLanguage.structure.Classifier", "call_methods_5292274854859311639", new Object[]{})).findFirst(new IWhereFilter<SNode>() {
          public boolean accept(SNode f) {
            return "getTextPosition".equals(SPropertyOperations.getString(f, "name"));
          }
        });
      }
    });
    doSomethingAndUndo(myUiDiff, true, new _FunctionTypes._return_P0_E0<SNode>() {
      public SNode invoke() {
        SNode ifBefore = (SNode) new jetbrains.mps.smodel.SNode(InternUtil.intern("jetbrains.mps.baseLanguage.structure.IfStatement"));
        jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.insertPrevSiblingChild(ListSequence.fromList(SLinkOperations.getTargets(SLinkOperations.getTarget(method.value, "body", true), "statement", true)).first(), ifBefore);
        return root.value;
      }
    }, new _FunctionTypes._return_P0_E0<SNode>() {
      public SNode invoke() {
        SNode foreachBody = SLinkOperations.getTarget(jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.cast(ListSequence.fromList(SLinkOperations.getTargets(SLinkOperations.getTarget(method.value, "body", true), "statement", true)).getElement(1), "jetbrains.mps.baseLanguage.structure.ForeachStatement"), "body", true);
        SNode declarationStatement = jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.cast(ListSequence.fromList(SLinkOperations.getTargets(foreachBody, "statement", true)).getElement(0), "jetbrains.mps.baseLanguage.structure.LocalVariableDeclarationStatement");
        final SNode declaration = SLinkOperations.getTarget(declarationStatement, "localVariableDeclaration", true);
        final SNode initializer = SLinkOperations.getTarget(declaration, "initializer", true);
        ListSequence.fromList(jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.getDescendants(foreachBody, "jetbrains.mps.baseLanguage.structure.VariableReference", false, new String[]{})).where(new IWhereFilter<SNode>() {
          public boolean accept(SNode it) {
            return jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.isInstanceOf(SLinkOperations.getTarget(jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.cast(it, "jetbrains.mps.baseLanguage.structure.VariableReference"), "variableDeclaration", false), "jetbrains.mps.baseLanguage.structure.LocalVariableDeclaration");
          }
        }).toListSequence().where(new IWhereFilter<SNode>() {
          public boolean accept(SNode vr) {
            return SLinkOperations.getTarget(vr, "variableDeclaration", false) == declaration;
          }
        }).visitAll(new IVisitor<SNode>() {
          public void visit(SNode vr) {
            jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.replaceWithAnother(vr, jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.copyNode(initializer));
          }
        });
        jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.deleteNode(declarationStatement);
        return root.value;
      }
    }, new _FunctionTypes._return_P0_E0<SNode>() {
      public SNode invoke() {
        jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.deleteNode(ListSequence.fromList(SLinkOperations.getTargets(SLinkOperations.getTarget(method.value, "body", true), "statement", true)).getElement(2));
        jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.deleteNode(ListSequence.fromList(SLinkOperations.getTargets(SLinkOperations.getTarget(method.value, "body", true), "statement", true)).getElement(1));
        return root.value;
      }
    });
  }

  @Test
  public void rollbackAllSerially() {
    checkRootStatuses();

    Random random = new Random(239);
    String stringBeforeAll = getChangeSetString(myUiDiff.getChangeSet());
    final SModel model = myUiDiff.getModelDescriptor().getSModel();

    List<SNodeReference> affectedNodePointers = ListSequence.fromList(new ArrayList<SNodeReference>());

    while (true) {
      List<ModelChange> changesBefore = ListSequence.fromListWithValues(new ArrayList<ModelChange>(), myUiDiff.getChangeSet().getModelChanges());
      if (ListSequence.fromList(changesBefore).isEmpty()) {
        break;
      }
      final ModelChange changeToPick = ListSequence.fromList(changesBefore).getElement(random.nextInt(ListSequence.fromList(changesBefore).count()));
      runCommandAndWait(new Runnable() {
        public void run() {
          changeToPick.getOppositeChange().apply(model, new NodeCopier(model));
        }
      });
      waitAndCheck(myUiDiff);

      Assert.assertEquals(ListSequence.fromList(changesBefore).count() - 1, ListSequence.fromList(check_4gxggu_a1a6a8a55(myUiDiff.getChangeSet())).count());

      ListSequence.fromList(affectedNodePointers).addElement(new SNodePointer(myUiDiff.getModelDescriptor().getReference(), changeToPick.getRootId()));
    }

    MapSequence.fromMap(myExpectedFileStatuses).removeKey("ui.DocumentLayout");
    MapSequence.fromMap(myExpectedFileStatuses).removeKey("ui.HTMLPanel");
    checkRootStatuses();

    undoAndCheck(myUiDiff, affectedNodePointers, false);
    Assert.assertEquals(stringBeforeAll, getChangeSetString(myUiDiff.getChangeSet()));

    MapSequence.fromMap(myExpectedFileStatuses).put("ui.DocumentLayout", FileStatus.MODIFIED);
    MapSequence.fromMap(myExpectedFileStatuses).put("ui.HTMLPanel", FileStatus.MODIFIED);
    checkRootStatuses();
  }

  @Test
  public void rollbackAllAtomically() {
    checkRootStatuses();

    String stringBeforeAll = getChangeSetString(myUiDiff.getChangeSet());
    final SModel model = myUiDiff.getModelDescriptor().getSModel();

    List<SNodeReference> affectedRootPointers = ListSequence.fromList(check_4gxggu_a0a0a5a65(myUiDiff.getChangeSet())).select(new ISelector<ModelChange, SNodeReference>() {
      public SNodeReference select(ModelChange ch) {
        return ((SNodeReference) new SNodePointer(myUiDiff.getModelDescriptor().getSModelReference(), ch.getRootId()));
      }
    }).distinct().toListSequence();
    final List<ModelChange> oppositeChanges = ListSequence.fromList(check_4gxggu_a0a0g0ec(myUiDiff.getChangeSet())).select(new ISelector<ModelChange, ModelChange>() {
      public ModelChange select(ModelChange ch) {
        return ch.getOppositeChange();
      }
    }).toListSequence();
    runCommandAndWait(new Runnable() {
      public void run() {
        final NodeCopier nc = new NodeCopier(model);
        ListSequence.fromList(oppositeChanges).where(new IWhereFilter<ModelChange>() {
          public boolean accept(ModelChange ch) {
            return ch instanceof NodeGroupChange;
          }
        }).visitAll(new IVisitor<ModelChange>() {
          public void visit(ModelChange ch) {
            ((NodeGroupChange) ch).prepare();
          }
        });
        ListSequence.fromList(oppositeChanges).visitAll(new IVisitor<ModelChange>() {
          public void visit(ModelChange ch) {
            ch.apply(model, nc);
          }
        });
        nc.restoreIds(true);
      }
    });
    waitAndCheck(myUiDiff);
    Assert.assertTrue(ListSequence.fromList(check_4gxggu_a0a9a65(myUiDiff.getChangeSet())).isEmpty());

    MapSequence.fromMap(myExpectedFileStatuses).removeKey("ui.DocumentLayout");
    MapSequence.fromMap(myExpectedFileStatuses).removeKey("ui.HTMLPanel");
    checkRootStatuses();

    undoAndCheck(myUiDiff, Arrays.asList(ListSequence.fromList(affectedRootPointers).first()), false);
    Assert.assertEquals(stringBeforeAll, getChangeSetString(myUiDiff.getChangeSet()));

    MapSequence.fromMap(myExpectedFileStatuses).put("ui.DocumentLayout", FileStatus.MODIFIED);
    MapSequence.fromMap(myExpectedFileStatuses).put("ui.HTMLPanel", FileStatus.MODIFIED);
    checkRootStatuses();
  }

  private void checkOneAddedRoot(CurrentDifference newModelDiff) {
    waitForChangesManager();
    List<ModelChange> changes = check_4gxggu_a0b0fc(newModelDiff.getChangeSet());
    Assert.assertEquals(2, ListSequence.fromList(changes).count());
    Assert.assertTrue(ListSequence.fromList(changes).any(new IWhereFilter<ModelChange>() {
      public boolean accept(ModelChange it) {
        return it instanceof AddRootChange;
      }
    }));
    Assert.assertTrue(ListSequence.fromList(changes).any(new IWhereFilter<ModelChange>() {
      public boolean accept(ModelChange it) {
        return it instanceof ModuleDependencyChange;
      }
    }));
  }

  @Test
  public void createNewModel() {
    final Wrappers._T<CurrentDifference> newModelDiff = new Wrappers._T<CurrentDifference>();
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        String modelName = "newmodel";
        SModule module = myUiDiff.getModelDescriptor().getModule();
        ((AbstractModule) module).createModel(MODEL_PREFIX + modelName, module.getModelRoots().iterator().next(), null);
        newModelDiff.value = getCurrentDifference(modelName);
      }
    });
    final EditableSModel md = newModelDiff.value.getModelDescriptor();
    ModelAccess.instance().runWriteInEDT(new Runnable() {
      public void run() {
        md.load();
        md.save();
      }
    });
    ModelAccess.instance().flushEventQueue();

    final VirtualFile vf = VirtualFileUtils.getVirtualFile(((DefaultSModelDescriptor) md).getSource().getFile());
    doSomethingAndWaitForFileStatusChange(new Runnable() {
      public void run() {
      }
    }, vf, FileStatus.UNKNOWN);

    newModelDiff.value.setEnabled(true);
    waitForChangesManager();
    Assert.assertTrue((int) ListSequence.fromList(check_4gxggu_a0a0l0gc(newModelDiff.value.getChangeSet())).count() == 0);

    checkRootStatuses();

    runCommandAndWait(new Runnable() {
      public void run() {
        SModel m = ((SModelDescriptor) md).getSModel();
        ((jetbrains.mps.smodel.SModel) m).addLanguage(ModuleReference.fromString("f3061a53-9226-4cc5-a443-f952ceaf5816(jetbrains.mps.baseLanguage)"));
        createNewRoot(m);
      }
    });
    checkOneAddedRoot(newModelDiff.value);

    MapSequence.fromMap(myExpectedFileStatuses).put("newmodel.NewRoot", FileStatus.UNKNOWN);
    checkRootStatuses();

    doSomethingAndWaitForFileStatusChange(new Runnable() {
      public void run() {
        myChangeListManager.addUnversionedFiles(myChangeListManager.getDefaultChangeList(), Arrays.asList(vf));
      }
    }, vf, null);
    myChangeListManager.ensureUpToDate(false);
    checkOneAddedRoot(newModelDiff.value);

    MapSequence.fromMap(myExpectedFileStatuses).put("newmodel.NewRoot", FileStatus.ADDED);
    checkRootStatuses();
  }

  private void waitForReloadFinished() {
    waitForSomething(new Runnable() {
      public void run() {
        synchronized (ChangesManagerTest.this) {
          myAfterReloadTask = new Runnable() {
            public void run() {
              synchronized (ChangesManagerTest.this) {
                myAfterReloadTask = null;
              }
              waitCompleted();
            }
          };
        }
      }
    });
  }

  @Test
  public void deleteModelAndRollback() {
    setAutoaddPolicy(VcsShowConfirmationOption.Value.DO_ACTION_SILENTLY);

    checkRootStatuses();

    final EditableSModel md = myUiDiff.getModelDescriptor();
    String changeSetStringBefore = getChangeSetString(myUiDiff.getChangeSet());
    runCommandAndWait(new Runnable() {
      public void run() {
        DeleteModelHelper.deleteModel(myIdeaProject, md.getModule(), md, false, true);
      }
    });
    waitForChangesManager();

    try {
      SwingUtilities.invokeAndWait(new Runnable() {
        public void run() {
          UndoManager.getInstance(myIdeaProject).undo(null);
        }
      });
    } catch (Exception e) {
      e.printStackTrace();
      Assert.fail();
    }
    waitForReloadFinished();
    ModelAccess.instance().flushEventQueue();
    waitForChangesManager();
    myUiDiff = getCurrentDifference("ui");
    myUiDiff.setEnabled(true);
    waitForChangesManager();
    doSomethingAndWaitForFileStatusChange(new Runnable() {
      public void run() {
      }
    }, VirtualFileUtils.getVirtualFile(((BaseEditableSModelDescriptor) myUiDiff.getModelDescriptor()).getSource().getFile()), FileStatus.MODIFIED);
    waitForChangesManager();
    Assert.assertEquals(changeSetStringBefore, getChangeSetString(myUiDiff.getChangeSet()));

    checkRootStatuses();

    setAutoaddPolicy(VcsShowConfirmationOption.Value.DO_NOTHING_SILENTLY);
  }

  @BeforeClass
  public static void setUp() {
    SReference.disableLogging();
    Registry.get("vcs.showConsole").setValue(false);

    ourProject = TestMain.startTestOnProjectCopy(PROJECT_ARCHIVE, DESTINATION_PROJECT_DIR, PROJECT_FILE, "jetbrains.mps.vcs", "Git4Idea", "jetbrains.mps.ide.make");
    FSChangesWatcher.instance().initComponent(true);
  }

  @AfterClass
  public static void tearDown() {
    TestMain.finishTestOnProjectCopy(ourProject, DESTINATION_PROJECT_DIR);
  }

  private class MyReloadListener implements FSChangesWatcher.IReloadListener {
    public MyReloadListener() {
    }

    @Override
    public void reloadStarted() {
    }

    @Override
    public void reloadFinished() {
      synchronized (this) {
        check_4gxggu_a0a0a2lc(myAfterReloadTask);
      }
    }
  }

  private static List<ModelChange> check_4gxggu_a0a9a92(ChangeSet checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModelChanges();
    }
    return null;
  }

  private static List<ModelChange> check_4gxggu_a0a01a92(ChangeSet checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModelChanges();
    }
    return null;
  }

  private static List<ModelChange> check_4gxggu_a0a3a13(ChangeSet checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModelChanges();
    }
    return null;
  }

  private static List<ModelChange> check_4gxggu_a0a3a33(ChangeSet checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModelChanges();
    }
    return null;
  }

  private static List<ModelChange> check_4gxggu_a0a0a53(ChangeSet checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModelChanges();
    }
    return null;
  }

  private static List<ModelChange> check_4gxggu_a1a6a53(ChangeSet checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModelChanges();
    }
    return null;
  }

  private static List<ModelChange> check_4gxggu_a0a5a63(ChangeSet checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModelChanges();
    }
    return null;
  }

  private static void check_4gxggu_a3a0a0a0a0a54(FileEditor checkedDotOperand) {
    if (null != checkedDotOperand) {
      checkedDotOperand.dispose();
    }

  }

  private static List<ModelChange> check_4gxggu_a1a6a8a55(ChangeSet checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModelChanges();
    }
    return null;
  }

  private static List<ModelChange> check_4gxggu_a0a0a5a65(ChangeSet checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModelChanges();
    }
    return null;
  }

  private static List<ModelChange> check_4gxggu_a0a0g0ec(ChangeSet checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModelChanges();
    }
    return null;
  }

  private static List<ModelChange> check_4gxggu_a0a9a65(ChangeSet checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModelChanges();
    }
    return null;
  }

  private static List<ModelChange> check_4gxggu_a0b0fc(ChangeSet checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModelChanges();
    }
    return null;
  }

  private static List<ModelChange> check_4gxggu_a0a0l0gc(ChangeSet checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModelChanges();
    }
    return null;
  }

  private static void check_4gxggu_a0a0a2lc(Runnable checkedDotOperand) {
    if (null != checkedDotOperand) {
      checkedDotOperand.run();
    }

  }
}
