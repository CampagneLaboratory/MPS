package jetbrains.mps.vcs.annotation;

/*Generated by MPS */

import com.intellij.openapi.vcs.annotate.LineAnnotationAspect;
import com.intellij.vcsUtil.VcsUtil;
import java.awt.FontMetrics;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.ILeftCombinator;

/*package*/ class AnnotationAspectSubcolumn {
  private AnnotationColumn myAnnotationColumn;
  private LineAnnotationAspect myAnnotationAspect;
  private int myWidth;
  private boolean myEnabled;

  public AnnotationAspectSubcolumn(AnnotationColumn annotationColumn, LineAnnotationAspect annotationAspect) {
    myAnnotationColumn = annotationColumn;
    myAnnotationAspect = annotationAspect;
    myEnabled = VcsUtil.isAspectAvailableByDefault(getId());
  }

  public String getTextForFileLine(int fileLine) {
    return myAnnotationAspect.getValue(fileLine);
  }

  public int getWidth() {
    return myWidth;
  }

  public void computeWidth(final FontMetrics fontMetrics, Iterable<Integer> fileLines) {
    myWidth = Sequence.fromIterable(fileLines).foldLeft(0, new ILeftCombinator<Integer, Integer>() {
      public Integer combine(Integer s, Integer fl) {
        return Math.max(s, fontMetrics.stringWidth(getTextForFileLine(fl) + " "));
      }
    });
  }

  public String getId() {
    return (myAnnotationAspect == null ?
      null :
      myAnnotationAspect.getId()
    );
  }

  public boolean isEnabled() {
    return myEnabled;
  }

  public void setEnabled(boolean enabled) {
    VcsUtil.setAspectAvailability(getId(), enabled);
    myEnabled = enabled;
    myAnnotationColumn.invalidateLayout();
  }
}
