package jetbrains.mps.vcs;

/*Generated by MPS */

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.smodel.SModel;
import jetbrains.mps.smodel.DefaultSModelDescriptor;
import com.intellij.openapi.application.ApplicationManager;
import jetbrains.mps.watching.ModelChangesWatcher;
import jetbrains.mps.util.Computable;
import java.io.File;
import java.io.IOException;
import jetbrains.mps.smodel.ModelAccess;
import com.intellij.openapi.ui.Messages;
import jetbrains.mps.util.FileUtil;
import jetbrains.mps.smodel.persistence.def.ModelPersistence;
import com.intellij.openapi.project.ProjectManager;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.vfs.VirtualFile;
import jetbrains.mps.ide.vfs.VirtualFileUtils;
import jetbrains.mps.ide.dialogs.BaseDialog;
import jetbrains.mps.smodel.SModelDescriptor;
import jetbrains.mps.smodel.SModelRepository;
import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.project.GlobalOperationContext;
import jetbrains.mps.project.ModuleContext;
import jetbrains.mps.ide.project.ProjectHelper;
import javax.swing.JFrame;
import com.intellij.openapi.wm.WindowManager;
import jetbrains.mps.vcs.integration.ModelDiffTool;
import jetbrains.mps.vcs.diff.ui.ModelDifferenceDialog;
import jetbrains.mps.vcs.diff.ui.SimpleDiffRequest;
import jetbrains.mps.vcs.diff.ui.OldModelDifferenceDialog;
import javax.swing.SwingUtilities;

public class DiskMemoryConflictHelper {
  protected static Log log = LogFactory.getLog(DiskMemoryConflictHelper.class);

  private DiskMemoryConflictHelper() {
  }

  public static void resolveDiskMemoryConflict(final IFile modelFile, final SModel inMemory, final DefaultSModelDescriptor modelDescriptor) {
    ApplicationManager.getApplication().invokeLater(new Runnable() {
      public void run() {
        boolean needSave = ModelChangesWatcher.instance().executeUnderBlockedReload(new Computable<Boolean>() {
          public Boolean compute() {
            try {
              File backupFile = doBackup(modelFile, inMemory);
              if (modelFile.exists()) {
                return showDiskMemoryQuestion(modelFile, inMemory, backupFile);
              } else {
                return showDeletedFromDiskQuestion(inMemory, backupFile);
              }
            } catch (IOException e) {
              if (log.isErrorEnabled()) {
                log.error("", e);
              }
              throw new RuntimeException(e);
            }
          }
        });
        if (needSave) {
          ModelAccess.instance().runWriteActionInCommand(new Runnable() {
            public void run() {
              modelDescriptor.updateDiskTimestamp();
              modelDescriptor.save();
            }
          });
        } else {
          ModelAccess.instance().runWriteAction(new Runnable() {
            public void run() {
              modelDescriptor.reloadFromDisk();
            }
          });
        }
      }
    });
  }

  private static boolean showDeletedFromDiskQuestion(SModel inMemory, File backupFile) {
    int result = Messages.showYesNoDialog("Model file for model " + inMemory + " was externally deleted from disk.\n" + "Backup of it was saved to \"" + backupFile.getAbsolutePath() + "\"\nDo you wish to restore it?", "Model Deleted Externally", Messages.getQuestionIcon());
    return result == 0;
  }

  private static boolean showDiskMemoryQuestion(IFile modelFile, SModel inMemory, File backupFile) {
    String message = "Changes have been made to " + inMemory + " model in memory and on disk.\n" + "Backup of both versions was saved to \"" + backupFile.getAbsolutePath() + "\"\n" + "Which version to use?";
    String title = "Model Versions Conflict";
    String diskVersion = "Load &File System Version";
    String memoryVersion = "Save &Memory Version";
    String showDiffDialog = "Show &Difference";
    String[] options = {diskVersion, memoryVersion, showDiffDialog};
    int result = Messages.showDialog(message, title, options, 0, Messages.getQuestionIcon());
    if (result == -1) {
      result = 2;
    }
    if (options[result].equals(diskVersion)) {
      return false;
    } else
    if (options[result].equals(memoryVersion)) {
      return true;
    } else {
      return DiskMemoryConflictHelper.openDiffDialog(modelFile, inMemory);
    }
  }

  private static File doBackup(IFile modelFile, SModel inMemory) throws IOException {
    File tmp = FileUtil.createTmpDir();
    MergeBackupUtil.writeContentsToFile(ModelUtils.modelToBytes(inMemory), modelFile.getName(), tmp, DiskMemoryConflictHelper.DiskMemoryConflictVersion.MEMORY.getSuffix());
    if (modelFile.exists()) {
      com.intellij.openapi.util.io.FileUtil.copy(new File(modelFile.getPath()), new File(tmp.getAbsolutePath(), modelFile.getName() + "." + DiskMemoryConflictHelper.DiskMemoryConflictVersion.FILE_SYSTEM.getSuffix()));
    }
    File zipfile = MergeBackupUtil.chooseZipFileForModelFile(modelFile.getName());
    zipfile.getParentFile().mkdirs();
    FileUtil.zip(tmp, zipfile);
    FileUtil.delete(tmp);
    return zipfile;
  }

  private static boolean openDiffDialog(IFile modelFile, final SModel inMemory) {
    SModel onDisk = ModelPersistence.readModel(modelFile, false);
    if (onDisk == null) {
      onDisk = new SModel(inMemory.getSModelReference());
    }
    return DiskMemoryConflictHelper.showDiffDialog(onDisk, inMemory, modelFile, ProjectManager.getInstance().getOpenProjects()[0]);
  }

  private static boolean showDiffDialog(final SModel diskModel, final SModel memoryModel, IFile modelFile, final Project project) {
    final VirtualFile file = VirtualFileUtils.getVirtualFile(modelFile);
    if (file == null) {
      if (log.isErrorEnabled()) {
        log.error("", new AssertionError());
      }
    }
    final BaseDialog dialog = ModelAccess.instance().runReadAction(new Computable<BaseDialog>() {
      public BaseDialog compute() {
        SModelDescriptor modelDescriptor = diskModel.getModelDescriptor();
        if (modelDescriptor == null) {
          modelDescriptor = memoryModel.getModelDescriptor();
          if (modelDescriptor == null) {
            modelDescriptor = SModelRepository.getInstance().getModelDescriptor(diskModel.getSModelFqName());
          }
        }
        IOperationContext context;
        if (modelDescriptor == null) {
          context = new GlobalOperationContext();
        } else {
          context = new ModuleContext(modelDescriptor.getModule(), ProjectHelper.toMPSProject(project));
        }
        JFrame frame = WindowManager.getInstance().getFrame(project);
        if (ModelDiffTool.isNewDiffEnabled()) {
          return new ModelDifferenceDialog(diskModel, memoryModel, new SimpleDiffRequest(project, "Filesystem version (Read-Only)", "Memory Version"));
        } else {
          return new OldModelDifferenceDialog(context, frame, diskModel, memoryModel, "Disk Memory Diff", true, new String[]{"Filesystem version (Read-Only)", "Memory Version"});
        }
      }
    });
    dialog.showDialog();
    SwingUtilities.invokeLater(new Runnable() {
      public void run() {
        dialog.toFront();
      }
    });
    return true;
  }

  public static   enum DiskMemoryConflictVersion implements ModelVersion {
    FILE_SYSTEM("filesystem"),
    MEMORY("memory");

    private final String mySuffix;

    DiskMemoryConflictVersion(String suffix) {
      mySuffix = suffix;
    }

    public String getSuffix() {
      return mySuffix;
    }
  }
}
