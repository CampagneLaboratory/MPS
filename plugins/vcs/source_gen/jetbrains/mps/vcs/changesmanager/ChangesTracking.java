package jetbrains.mps.vcs.changesmanager;

/*Generated by MPS */

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import com.intellij.openapi.project.Project;
import jetbrains.mps.smodel.descriptor.EditableSModelDescriptor;
import jetbrains.mps.util.ManyToManyMap;
import jetbrains.mps.smodel.SNodeId;
import jetbrains.mps.vcs.diff.changes.ModelChange;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.vfs.IFile;
import com.intellij.openapi.vfs.VirtualFile;
import jetbrains.mps.ide.vfs.VirtualFileUtils;
import com.intellij.openapi.vcs.impl.VcsFileStatusProvider;
import com.intellij.openapi.vcs.ProjectLevelVcsManager;
import jetbrains.mps.smodel.SModel;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import com.intellij.openapi.vcs.FileStatus;
import jetbrains.mps.smodel.persistence.def.ModelPersistence;
import jetbrains.mps.smodel.persistence.def.ModelReadException;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.vcs.diff.ChangeSet;
import jetbrains.mps.vcs.diff.ChangeSetBuilder;
import jetbrains.mps.vcs.diff.ChangeSetImpl;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import java.util.Set;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.internal.collections.runtime.IVisitor;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.internal.collections.runtime.ITranslator2;
import jetbrains.mps.vcs.diff.changes.AddRootChange;
import jetbrains.mps.vcs.diff.changes.NodeGroupChange;
import jetbrains.mps.vcs.diff.changes.NodeChange;
import java.util.Arrays;
import jetbrains.mps.vcs.diff.changes.DeleteRootChange;
import java.util.Collections;
import jetbrains.mps.smodel.SModelAdapter;
import jetbrains.mps.smodel.event.SModelPropertyEvent;
import jetbrains.mps.vcs.diff.changes.SetPropertyChange;
import jetbrains.mps.smodel.event.SModelReferenceEvent;
import jetbrains.mps.smodel.SReference;
import jetbrains.mps.vcs.diff.changes.SetReferenceChange;

public class ChangesTracking {
  protected static Log log = LogFactory.getLog(ChangesTracking.class);

  private Project myProject;
  private CurrentDifference myDifference;
  private SimpleCommandQueue myQueue;
  private EditableSModelDescriptor myModelDescriptor;
  private ChangesTracking.MyModelListener myModelListener = new ChangesTracking.MyModelListener();
  private boolean myDisposed = false;
  private ManyToManyMap<SNodeId, ModelChange> myNodesToDirectChanges = new ManyToManyMap<SNodeId, ModelChange>();

  public ChangesTracking(@NotNull Project project, @NotNull CurrentDifference difference) {
    myDifference = difference;
    myProject = project;
    myModelDescriptor = myDifference.getModelDescriptor();
    myQueue = CurrentDifferenceRegistry.getInstance(project).getCommandQueue();
    synchronized (this) {
      myModelDescriptor.addModelListener(myModelListener);
    }
  }

  public void dispose() {
    synchronized (this) {
      if (!(myDisposed)) {
        myDisposed = true;
        myModelDescriptor.removeModelListener(myModelListener);
      }
    }
  }

  private void buildCaches() {
    myNodesToDirectChanges.clear();
    for (ModelChange ch : ListSequence.fromList(myDifference.getChangeSet().getModelChanges())) {
      for (SNodeId id : Sequence.fromIterable(getNodeIdsForChange(ch))) {
        myNodesToDirectChanges.addLink(id, ch);
      }
    }
  }

  /*package*/ void scheduleFullUpdate() {
    myQueue.addTask(new Runnable() {
      public void run() {
        update();
      }
    });
  }

  private void update() {
    myQueue.assertSoftlyIsCommandThread();
    if (!(myDifference.isEnabled())) {
      return;
    }
    myDifference.removeChangeSet();

    IFile modelFile = myModelDescriptor.getModelFile();
    if (modelFile == null || !(modelFile.exists())) {
      return;
    }
    VirtualFile modelVFile = VirtualFileUtils.getVirtualFile(modelFile);

    assert myProject.getComponent(VcsFileStatusProvider.class) != null;

    if (modelVFile == null || myProject.getComponent(ProjectLevelVcsManager.class).getVcsFor(modelVFile) == null) {
      return;
    }

    final SModel currentModel = myModelDescriptor.getSModel();
    final Wrappers._T<SModel> baseVersionModel = new Wrappers._T<SModel>(null);
    FileStatus status = myProject.getComponent(VcsFileStatusProvider.class).getFileStatus(modelVFile);
    if (FileStatus.NOT_CHANGED == status) {
      return;
    }
    if (BaseVersionUtil.isAddedFileStatus(status)) {
      baseVersionModel.value = new SModel(currentModel.getSModelReference());
    } else {
      String content = BaseVersionUtil.getBaseVersionContent(modelVFile, myProject);
      if (content == null && status != FileStatus.NOT_CHANGED && !(BaseVersionUtil.isAddedFileStatus(status))) {
        if (log.isErrorEnabled()) {
          log.error("Base version content is null while file status is " + status);
        }
      }
      if (content == null) {
        return;
      }
      try {
        baseVersionModel.value = ModelPersistence.readModel(content, false);
      } catch (ModelReadException e) {
        if (log.isWarnEnabled()) {
          log.warn("", e);
        }
        return;
      }
    }
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        ChangeSet changeSet = ChangeSetBuilder.buildChangeSet(baseVersionModel.value, currentModel, true);
        myDifference.setChangeSet((ChangeSetImpl) changeSet);
        buildCaches();
      }
    });
  }

  private void addChange(@NotNull ModelChange change) {
    for (SNodeId id : Sequence.fromIterable(getNodeIdsForChange(change))) {
      myNodesToDirectChanges.addLink(id, change);
    }
    myDifference.addChange(change);
  }

  private void removeChange(@NotNull ModelChange change) {
    myNodesToDirectChanges.clearSecond(change);
    myDifference.removeChange(change);
  }

  private <C extends ModelChange> void removeChanges(SNodeId nodeId, final Class<C> changeClass, final _FunctionTypes._return_P1_E0<? extends Boolean, ? super C> condition) {
    Set<ModelChange> changes = myNodesToDirectChanges.getByFirst(nodeId);
    List<ModelChange> toRemove = SetSequence.fromSet(changes).where(new IWhereFilter<ModelChange>() {
      public boolean accept(ModelChange ch) {
        return changeClass.isInstance(ch) && condition.invoke((C) ch);
      }
    }).toListSequence();
    ListSequence.fromList(toRemove).visitAll(new IVisitor<ModelChange>() {
      public void visit(ModelChange it) {
        removeChange(it);
      }
    });
  }

  private void buildAndAddChanges(_FunctionTypes._void_P1_E0<? super ChangeSetBuilder> builderTask) {
    ChangeSet cs = myDifference.getChangeSet();
    ChangeSetBuilder builder = ChangeSetBuilder.createBuilder(cs);
    builderTask.invoke(builder);
    ListSequence.fromList(builder.getNewChanges()).visitAll(new IVisitor<ModelChange>() {
      public void visit(ModelChange ch) {
        addChange(ch);
      }
    });
  }

  @Nullable
  private SNode getOldNode(@NotNull SNodeId id) {
    return check_5iuzi5_a0a0a8(myDifference.getChangeSet()).getNodeById(id);
  }

  private void runUpdateTask(final _FunctionTypes._void_P0_E0 task, SNode currentNode) {
    final List<SNodeId> ancestors = ListSequence.fromList(SNodeOperations.getAncestors(currentNode, null, true)).select(new ISelector<SNode, SNodeId>() {
      public SNodeId select(SNode a) {
        return a.getSNodeId();
      }
    }).toListSequence();
    if (myDifference.getChangeSet() == null) {
      return;
    }
    myQueue.runTask(new Runnable() {
      public void run() {
        if (myDifference.getChangeSet() == null) {
          return;
        }
        if (ListSequence.fromList(ancestors).translate(new ITranslator2<SNodeId, ModelChange>() {
          public Iterable<ModelChange> translate(SNodeId a) {
            return myNodesToDirectChanges.getByFirst(a);
          }
        }).any(new IWhereFilter<ModelChange>() {
          public boolean accept(ModelChange ch) {
            return ch instanceof AddRootChange || ch instanceof NodeGroupChange;
          }
        })) {
          // ignore 
        } else {
          myDifference.getBroadcaster().changeUpdateStarted();
          ModelAccess.instance().runReadAction(new Runnable() {
            public void run() {
              task.invoke();
            }
          });
          myDifference.getBroadcaster().changeUpdateFinished();
        }
      }
    });
  }

  private static Iterable<SNodeId> getNodeIdsForChange(@NotNull ModelChange change) {
    if (change instanceof NodeChange) {
      return Arrays.asList(((NodeChange) change).getAffectedNodeId());
    } else if (change instanceof AddRootChange || change instanceof DeleteRootChange) {
      return Arrays.asList(change.getRootId());
    } else if (change instanceof NodeGroupChange) {
      NodeGroupChange ngc = (NodeGroupChange) change;
      List<SNode> children = change.getChangeSet().getNewModel().getNodeById(ngc.getParentNodeId()).getChildren(ngc.getRole());
      return ListSequence.fromList(children).page(ngc.getResultBegin(), ngc.getResultBegin()).select(new ISelector<SNode, SNodeId>() {
        public SNodeId select(SNode n) {
          return n.getSNodeId();
        }
      });
    }
    return Sequence.fromIterable(Collections.<SNodeId>emptyList());
  }

  private static SModel check_5iuzi5_a0a0a8(ChangeSet checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getOldModel();
    }
    return null;
  }

  private static boolean eq_5iuzi5_a0a0a0a2a3a0a0a0a0a0(Object a, Object b) {
    return (a != null ?
      a.equals(b) :
      a == b
    );
  }

  private static boolean eq_5iuzi5_a0a0a0a2a3a0a0a0a0b0(Object a, Object b) {
    return (a != null ?
      a.equals(b) :
      a == b
    );
  }

  private class MyModelListener extends SModelAdapter {
    public MyModelListener() {
    }

    @Override
    public void propertyChanged(final SModelPropertyEvent event) {
      runUpdateTask(new _FunctionTypes._void_P0_E0() {
        public void invoke() {
          final SNodeId nodeId = event.getNode().getSNodeId();
          final String propertyName = event.getPropertyName();

          removeChanges(nodeId, SetPropertyChange.class, new _FunctionTypes._return_P1_E0<Boolean, SetPropertyChange>() {
            public Boolean invoke(SetPropertyChange ch) {
              return eq_5iuzi5_a0a0a0a2a3a0a0a0a0a0(propertyName, ch.getPropertyName());
            }
          });
          buildAndAddChanges(new _FunctionTypes._void_P1_E0<ChangeSetBuilder>() {
            public void invoke(ChangeSetBuilder b) {
              b.buildPropertyChanges(getOldNode(nodeId), event.getNode(), propertyName);
            }
          });
        }
      }, event.getNode());
    }

    private void processReferenceEvent(final SModelReferenceEvent event) {
      runUpdateTask(new _FunctionTypes._void_P0_E0() {
        public void invoke() {
          final SReference ref = event.getReference();
          final SNodeId refNodeId = ref.getSourceNode().getSNodeId();

          removeChanges(refNodeId, SetReferenceChange.class, new _FunctionTypes._return_P1_E0<Boolean, SetReferenceChange>() {
            public Boolean invoke(SetReferenceChange ch) {
              return eq_5iuzi5_a0a0a0a2a3a0a0a0a0b0(ref.getRole(), ch.getRole());
            }
          });
          buildAndAddChanges(new _FunctionTypes._void_P1_E0<ChangeSetBuilder>() {
            public void invoke(ChangeSetBuilder b) {
              b.buildReferenceChanges(getOldNode(refNodeId), ref.getSourceNode(), ref.getRole());
            }
          });
        }
      }, event.getReference().getSourceNode());
    }

    @Override
    public void referenceAdded(SModelReferenceEvent event) {
      processReferenceEvent(event);
    }

    @Override
    public void referenceRemoved(SModelReferenceEvent event) {
      processReferenceEvent(event);
    }
  }
}
