package jetbrains.mps.vcs.changesmanager.editor;

/*Generated by MPS */

import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.nodeEditor.EditorMessageOwner;
import javax.swing.JScrollPane;
import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.vcs.diff.ui.common.ChangeGroup;
import jetbrains.mps.smodel.SModel;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.vcs.diff.ui.common.ChangeEditorMessage;
import jetbrains.mps.internal.collections.runtime.ITranslator2;
import jetbrains.mps.vcs.diff.changes.ModelChange;
import jetbrains.mps.vcs.diff.ui.common.ChangeEditorMessageFactory;
import jetbrains.mps.vcs.diff.ui.common.Bounds;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.internal.collections.runtime.ILeftCombinator;
import java.awt.Rectangle;
import jetbrains.mps.nodeEditor.cells.EditorCell;
import java.util.List;
import jetbrains.mps.smodel.event.SModelEvent;
import jetbrains.mps.nodeEditor.EditorContext;
import jetbrains.mps.nodeEditor.cells.EditorCell_Constant;

public class BaseVersionEditorComponent extends EditorComponent implements EditorMessageOwner {
  private JScrollPane myScrollPane;

  public BaseVersionEditorComponent(IOperationContext operationContext, ChangeGroup changeGroup) {
    super(operationContext);
    // TODO better operation context 
    final SModel baseModel = ListSequence.fromList(changeGroup.getChanges()).first().getChangeSet().getOldModel();
    SNode baseRoot = baseModel.getNodeById(ListSequence.fromList(changeGroup.getChanges()).first().getRootId());
    editNode(baseRoot);

    Iterable<ChangeEditorMessage> messages = ListSequence.fromList(changeGroup.getChanges()).translate(new ITranslator2<ModelChange, ChangeEditorMessage>() {
      public Iterable<ChangeEditorMessage> translate(ModelChange ch) {
        return ChangeEditorMessageFactory.createMessages(baseModel, ch, BaseVersionEditorComponent.this, null);
      }
    });
    Bounds verticalBounds = Sequence.fromIterable(messages).select(new ISelector<ChangeEditorMessage, Bounds>() {
      public Bounds select(ChangeEditorMessage m) {
        return m.getBounds(BaseVersionEditorComponent.this);
      }
    }).reduceLeft(new ILeftCombinator<Bounds, Bounds>() {
      public Bounds combine(Bounds a, Bounds b) {
        return a.merge(b);
      }
    });
    Rectangle cellsRect = Sequence.fromIterable(messages).select(new ISelector<ChangeEditorMessage, Rectangle>() {
      public Rectangle select(ChangeEditorMessage m) {
        return m.getCell(BaseVersionEditorComponent.this).getBounds();
      }
    }).reduceLeft(new ILeftCombinator<Rectangle, Rectangle>() {
      public Rectangle combine(Rectangle a, Rectangle b) {
        return a.union(b);
      }
    });
    Rectangle viewRect = new Rectangle(0, (int) verticalBounds.start(), (int) cellsRect.getMaxX(), verticalBounds.length());

    myScrollPane = new JScrollPane(this, JScrollPane.VERTICAL_SCROLLBAR_NEVER, JScrollPane.HORIZONTAL_SCROLLBAR_NEVER);
    myScrollPane.setPreferredSize(viewRect.getSize());
    myScrollPane.getViewport().setViewPosition(viewRect.getLocation());
  }

  protected EditorCell createRootCell(List<SModelEvent> events) {
    if (getEditedNode() == null || getEditedNode().isDeleted()) {
      EditorContext editorContext = getEditorContext();
      return new EditorCell_Constant(editorContext, getEditedNode(), "");
    }
    return getEditorContext().createRootCell(getEditedNode(), events);
  }

  public JScrollPane getScrollPane() {
    return myScrollPane;
  }
}
