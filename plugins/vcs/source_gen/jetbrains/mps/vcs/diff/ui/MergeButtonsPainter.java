package jetbrains.mps.vcs.diff.ui;

/*Generated by MPS */

import javax.swing.Icon;
import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.ide.projectPane.Icons;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.vcs.diff.MergeContext;
import jetbrains.mps.vcs.diff.changes.ModelChange;
import java.util.Arrays;
import jetbrains.mps.smodel.ModelAccess;
import java.awt.image.BufferedImage;
import java.awt.Graphics2D;
import java.awt.geom.AffineTransform;
import javax.swing.ImageIcon;

public class MergeButtonsPainter extends ButtonsPainter {
  private static final Icon MIRRORED_APPLY_ICON;

  private MergeRootsDialog myDialog;

  public MergeButtonsPainter(MergeRootsDialog dialog, EditorComponent editorComponent, ChangeGroupBuilder changeGroupBuilder) {
    super(2, editorComponent, changeGroupBuilder);
    myDialog = dialog;
  }

  protected Iterable<FoldingAreaButton> createButtonsForChangeGroup(ChangeGroup changeGroup, int y) {
    int rightX = -GAP - ICON_SIZE - LEFT_MARGIN;
    int leftX = rightX - GAP - ICON_SIZE;
    int applyX = (isHighlightLeft() ?
      rightX :
      leftX
    );
    int excludeX = (isHighlightLeft() ?
      leftX :
      rightX
    );
    FoldingAreaButton apply = new MergeButtonsPainter.MyButton(changeGroup, applyX, y, "Apply", (isHighlightLeft() ?
      MIRRORED_APPLY_ICON :
      Icons.APPLY
    ), new _FunctionTypes._void_P2_E0<MergeContext, Iterable<ModelChange>>() {
      public void invoke(MergeContext context, Iterable<ModelChange> changes) {
        context.applyChanges(changes);
      }
    });
    FoldingAreaButton exclude = new MergeButtonsPainter.MyButton(changeGroup, excludeX, y, "Exclude", Icons.EXCLUDE, new _FunctionTypes._void_P2_E0<MergeContext, Iterable<ModelChange>>() {
      public void invoke(MergeContext context, Iterable<ModelChange> changes) {
        context.excludeChanges(changes);
      }
    });
    return Arrays.asList(apply, exclude);
  }

  public static MergeButtonsPainter addTo(MergeRootsDialog dialog, DiffEditor diffEditor, ChangeGroupBuilder changeGroupBuilder, boolean inspector) {
    EditorComponent editorComponent = diffEditor.getEditorComponent(inspector);
    MergeButtonsPainter painter = new MergeButtonsPainter(dialog, editorComponent, changeGroupBuilder);
    editorComponent.getLeftEditorHighlighter().addFoldingAreaPainter(painter);
    return painter;
  }

  private class MyButton extends FoldingAreaButton {
    private _FunctionTypes._void_P2_E0<? super MergeContext, ? super Iterable<ModelChange>> myAction;

    private MyButton(ChangeGroup changeGroup, int x, int y, String name, Icon icon, _FunctionTypes._void_P2_E0<? super MergeContext, ? super Iterable<ModelChange>> action) {
      super(changeGroup, x, y, name, icon);
      myAction = action;
    }

    public void performAction() {
      ModelAccess.instance().runWriteActionInCommand(new Runnable() {
        public void run() {
          myAction.invoke(getChangeGroupBuilder().getMergeContext(), getChangeGroup().getChanges());
          myDialog.rehighlight();
        }
      });
    }
  }

  static {
    Icon icon = Icons.APPLY;
    BufferedImage image = new BufferedImage(icon.getIconWidth(), icon.getIconHeight(), BufferedImage.TYPE_INT_RGB);
    Graphics2D g2d = ((Graphics2D) image.getGraphics());
    g2d.setTransform(AffineTransform.getScaleInstance(-1, 1));
    icon.paintIcon(null, g2d, -icon.getIconWidth(), 0);
    MIRRORED_APPLY_ICON = new ImageIcon(image);
  }
}
