package jetbrains.mps.vcs.diff.ui;

/*Generated by MPS */

import com.intellij.openapi.diff.DiffTool;
import jetbrains.mps.logging.Logger;
import com.intellij.openapi.diff.DiffRequest;
import jetbrains.mps.vcs.diff.ModelMergeRequest;
import com.intellij.openapi.diff.DiffContent;
import jetbrains.mps.smodel.SModel;
import jetbrains.mps.vcs.ModelMergeRequestConstants;
import jetbrains.mps.smodel.SModelDescriptor;
import jetbrains.mps.smodel.SModelRepository;
import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.project.ModuleContext;
import javax.swing.SwingUtilities;
import jetbrains.mps.vcs.ModelUtils;
import com.intellij.openapi.diff.DiffManager;
import java.io.IOException;
import jetbrains.mps.vcs.VcsSettingsHolder;

public class ModelMergeTool implements DiffTool {
  private static final Logger LOG = Logger.getLogger(ModelMergeTool.class);

  public ModelMergeTool() {
  }

  public void show(final DiffRequest request) {
    ModelMergeRequest mrequest = (ModelMergeRequest) request;
    try {
      DiffContent[] contents = mrequest.getContents();
      final SModel baseModel = ModelDiffTool.readModel(contents[ModelMergeRequestConstants.ORIGINAL], mrequest.getFile().getPath());
      final SModel mineModel = ModelDiffTool.readModel(contents[ModelMergeRequestConstants.CURRENT], mrequest.getFile().getPath());
      final SModel newModel = ModelDiffTool.readModel(contents[ModelMergeRequestConstants.LAST_REVISION], mrequest.getFile().getPath());

      SModelDescriptor modelDescriptor = SModelRepository.getInstance().getModelDescriptor(baseModel.getSModelReference());
      if (modelDescriptor == null) {
        modelDescriptor = SModelRepository.getInstance().getModelDescriptor(mineModel.getSModelFqName());
      }
      IOperationContext context = new ModuleContext(modelDescriptor.getModule(), request.getProject());
      if (NewMergeModelsDialog.isNewMergeEnabled()) {
        // TODO new dialog 
        final NewMergeModelsDialog dialog = new NewMergeModelsDialog(request.getProject(), context, baseModel, mineModel, newModel);
        SwingUtilities.invokeLater(new Runnable() {
          public void run() {
            dialog.toFront();
          }
        });
        dialog.showDialog();
        if (dialog.getResultModel() != null) {
          byte[] bytes = ModelUtils.modelToBytes(dialog.getResultModel());
          mrequest.resolved(bytes);
        }
      } else {
        final MergeModelsDialog dialog = new MergeModelsDialog(context, baseModel, mineModel, newModel);

        SwingUtilities.invokeLater(new Runnable() {
          public void run() {
            dialog.toFront();
          }
        });
        dialog.showDialog();
        if (dialog.getResultModel() != null) {
          byte[] bytes = ModelUtils.modelToBytes(dialog.getResultModel());
          mrequest.resolved(bytes);
        }
      }
    } catch (ModelDiffTool.ReadException e) {
      LOG.warning("Can't read models. Using text based diff...", e);
      DiffTool ideaDiffTool = DiffManager.getInstance().getIdeaDiffTool();
      if (ideaDiffTool.canShow(request)) {
        ideaDiffTool.show(request);
      }
    } catch (IOException e) {
      LOG.error(e);
    }
  }

  public boolean canShow(DiffRequest request) {
    if (VcsSettingsHolder.instance().getSettings().isTextModeEnabled()) {
      return false;
    }
    return (request instanceof ModelMergeRequest);
  }
}
