package jetbrains.mps.vcs.diff.ui;

/*Generated by MPS */

import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.nodeEditor.inspector.InspectorEditorComponent;
import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.nodeEditor.cells.EditorCell;
import java.util.List;
import jetbrains.mps.smodel.event.SModelEvent;
import jetbrains.mps.nodeEditor.EditorContext;
import jetbrains.mps.nodeEditor.cells.EditorCell_Constant;
import jetbrains.mps.nodeEditor.AdditionalPainter;
import jetbrains.mps.smodel.ModelAccess;
import com.intellij.openapi.util.Computable;
import jetbrains.mps.smodel.SNodeId;
import java.awt.Point;
import java.awt.Rectangle;

public class DiffEditorComponent extends EditorComponent {
  private InspectorEditorComponent myInspector;

  public DiffEditorComponent(IOperationContext context, SNode node) {
    super(context);
    myInspector = new InspectorEditorComponent();
    myInspector.setReadOnly(true);
    editNode(node, context);
  }

  public void inspect(SNode node) {
    myInspector.inspectNode(node, getOperationContext());
    removeAllChangesFrom(myInspector);
    if (myInspector.getHighlightManager().getMessageFor(node) == null) {
    }
  }

  public EditorCell createRootCell() {
    return createRootCell(null);
  }

  public InspectorEditorComponent getInspector() {
    return myInspector;
  }

  public EditorCell createRootCell(List<SModelEvent> events) {
    if (getEditedNode() == null || getEditedNode().isDeleted()) {
      EditorContext editorContext = getEditorContext();
      return new EditorCell_Constant(editorContext, getEditedNode(), "");
    }
    return getEditorContext().createRootCell(getEditedNode(), events);
  }

  private void removeAllChangesFrom(EditorComponent component) {
    for (AdditionalPainter painter : getAdditionalPainters()) {
      if (painter instanceof OldChangesBlock) {
        ((OldChangesBlock) painter).removeFrom(component);
      }
    }
  }

  @Override
  public void editNode(final SNode node, IOperationContext operationContext) {
    super.editNode(node, operationContext);
    setReadOnly(ModelAccess.instance().runReadAction(new Computable<Boolean>() {
      public Boolean compute() {
        return node != null && node.getModel().isNotEditable();
      }
    }));
  }

  public void removeAllChanges() {
    removeAllChangesFrom(this);
    removeAllChangesFrom(myInspector);
  }

  public SNode getFirstVisibleNode() {
    return getFirstVisibleNode(getEditedNode());
  }

  private SNode getFirstVisibleNode(SNode node) {
    EditorCell cell = findNodeCell(node);
    if (cell == null) {
      return null;
    }
    if (cell.getY() > getViewport().getViewPosition().y) {
      return node;
    }
    SNode result = null;
    int resultY = Integer.MAX_VALUE;
    for (SNode child : node.getChildrenIterable()) {
      SNode visibleForChild = getFirstVisibleNode(child);
      if (visibleForChild != null) {
        int thisY = findNodeCell(visibleForChild).getY();
        if (thisY < resultY) {
          resultY = thisY;
          result = visibleForChild;
        }
      }
    }
    return result;
  }

  public void synchronizeViewWith(final DiffEditorComponent otherComponent) {
    if (this == otherComponent) {
      return;
    }
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        SNode visibleNode = getFirstVisibleNode();
        if (visibleNode != null) {
          SNodeId id = visibleNode.getSNodeId();
          int newRelativePos = getViewport().getViewPosition().y - findNodeCell(visibleNode).getY();
          SNode sNode = otherComponent.getEditedNode();
          if (sNode == null) {
            return;
          }
          SNode nodeById = sNode.getModel().getNodeById(id);
          EditorCell oldCell = otherComponent.findNodeCell(nodeById);
          Point position = getViewport().getViewPosition();
          if (oldCell != null) {
            otherComponent.getViewport().setViewPosition(new Point((int) position.getX(), newRelativePos + oldCell.getY()));
            Rectangle viewRect = otherComponent.getViewport().getViewRect();
            if (viewRect.y + viewRect.height > otherComponent.getHeight()) {
              otherComponent.getViewport().setViewPosition(new Point(viewRect.x, otherComponent.getHeight() - viewRect.height));
            }
          }
        }
      }
    });
  }
}
