package jetbrains.mps.vcs.diff.ui;

/*Generated by MPS */

import jetbrains.mps.workbench.action.BaseAction;
import com.intellij.openapi.util.IconLoader;
import jetbrains.mps.ide.projectPane.Icons;
import com.intellij.openapi.actionSystem.AnActionEvent;
import java.util.Map;
import jetbrains.mps.vcs.diff.changes.ModelChange;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.ITranslator2;
import jetbrains.mps.smodel.SNodeId;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.smodel.SModel;
import jetbrains.mps.smodel.descriptor.EditableSModelDescriptor;

public abstract class RevertRootsAction extends BaseAction {
  private ModelDifferenceDialog myModelDifferenceDialog;

  public RevertRootsAction(ModelDifferenceDialog modelDifferenceDialog) {
    super("Revert Root", null, IconLoader.getIcon("/actions/rollback.png", Icons.class));
    myModelDifferenceDialog = modelDifferenceDialog;
  }

  protected void doExecute(AnActionEvent event, Map<String, Object> map) {
    Iterable<ModelChange> changes = Sequence.fromIterable(Sequence.fromArray(getRoots())).translate(new ITranslator2<SNodeId, ModelChange>() {
      public Iterable<ModelChange> translate(SNodeId r) {
        return myModelDifferenceDialog.getChangesForRoot(r);
      }
    });
    myModelDifferenceDialog.rollbackChanges(changes, new _FunctionTypes._void_P0_E0() {
      public void invoke() {
        after();
      }
    });
  }

  @Override
  protected void doUpdate(AnActionEvent event, Map<String, Object> map) {
    super.doUpdate(event, map);
    SModel newModel = myModelDifferenceDialog.getChangeSet().getNewModel();
    boolean enabled = getRoots().length != 0 && newModel.getModelDescriptor() instanceof EditableSModelDescriptor;
    event.getPresentation().setEnabled(enabled);
    event.getPresentation().setVisible(enabled);
    event.getPresentation().setText("Revert Root" + ((getRoots().length != 1 ?
      "s" :
      ""
    )));
  }

  protected abstract void after();

  protected abstract SNodeId[] getRoots();
}
