package jetbrains.mps.vcs.diff.ui;

/*Generated by MPS */

import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.nodeEditor.EditorComponent;
import jetbrains.mps.nodeEditor.cells.EditorCell;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.smodel.SNodeId;
import java.awt.Point;
import java.awt.Rectangle;
import jetbrains.mps.smodel.SModel;
import jetbrains.mps.nodeEditor.CellSelectionListener;
import javax.swing.event.ChangeListener;
import javax.swing.event.ChangeEvent;
import jetbrains.mps.internal.collections.runtime.IVisitor;

public class DiffEditorsGroup {
  private List<DiffEditor> myDiffEditors = ListSequence.fromList(new ArrayList<DiffEditor>());
  private DiffEditorsGroup.MyCellSelectionListener myCellSelectionListener = new DiffEditorsGroup.MyCellSelectionListener();
  private boolean myViewportSetInProgress = false;

  public DiffEditorsGroup() {
  }

  public void add(DiffEditor diffEditor) {
    ListSequence.fromList(myDiffEditors).addElement(diffEditor);
    diffEditor.getMainEditor().addCellSelectionListener(myCellSelectionListener);
    diffEditor.getMainEditor().getViewport().addChangeListener(new DiffEditorsGroup.MyViewportChangeListener(diffEditor));
  }

  private static SNode getFirstVisibleNode(EditorComponent editor, SNode node) {
    EditorCell cell = editor.findNodeCell(node);
    if (cell == null) {
      return null;
    }
    if (cell.getY() > editor.getViewport().getViewPosition().y) {
      return node;
    }
    SNode result = null;
    int resultY = Integer.MAX_VALUE;
    for (SNode child : node.getChildrenIterable()) {
      SNode visibleForChild = getFirstVisibleNode(editor, child);
      if (visibleForChild != null) {
        EditorCell nodeCell = editor.findNodeCell(visibleForChild);
        assert nodeCell != null;
        int thisY = nodeCell.getY();
        if (thisY < resultY) {
          resultY = thisY;
          result = visibleForChild;
        }
      }
    }
    return result;
  }

  private static void synchronizeViewWithOther(final EditorComponent thisEditor, final EditorComponent otherEditor) {
    if (thisEditor == otherEditor) {
      return;
    }
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        SNode visibleNode = getFirstVisibleNode(thisEditor, thisEditor.getEditedNode());
        if (visibleNode != null) {
          SNodeId id = visibleNode.getSNodeId();
          int newRelativePos = thisEditor.getViewport().getViewPosition().y - thisEditor.findNodeCell(visibleNode).getY();
          SNode sNode = otherEditor.getEditedNode();
          if (sNode == null) {
            return;
          }
          SNode nodeById = sNode.getModel().getNodeById(id);
          EditorCell oldCell = otherEditor.findNodeCell(nodeById);
          Point position = thisEditor.getViewport().getViewPosition();
          if (oldCell != null) {
            otherEditor.getViewport().setViewPosition(new Point((int) position.getX(), newRelativePos + oldCell.getY()));
            Rectangle viewRect = otherEditor.getViewport().getViewRect();
            if (viewRect.y + viewRect.height > otherEditor.getHeight()) {
              otherEditor.getViewport().setViewPosition(new Point(viewRect.x, otherEditor.getHeight() - viewRect.height));
            }
          }
        }
      }
    });
  }

  private static SNodeId check_s6qw4f_a0a0a0a0a(SNode checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getSNodeId();
    }
    return null;
  }

  private static SNode check_s6qw4f_a0a0a0a0a0(EditorCell checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getSNode();
    }
    return null;
  }

  private static SNode check_s6qw4f_a0a0a0a1a0a0a0(SModel checkedDotOperand, SNodeId selectionId) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getNodeById(selectionId);
    }
    return null;
  }

  private static SModel check_s6qw4f_a0a0a0a0b0a0a0a(SNode checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getModel();
    }
    return null;
  }

  private class MyCellSelectionListener implements CellSelectionListener {
    public MyCellSelectionListener() {
    }

    public void selectionChanged(EditorComponent component, EditorCell oldSelection, final EditorCell newSelection) {
      ModelAccess.instance().runReadAction(new Runnable() {
        public void run() {
          SNodeId selectionId = check_s6qw4f_a0a0a0a0a(check_s6qw4f_a0a0a0a0a0(newSelection));
          if (selectionId != null) {
            for (DiffEditor diffEditor : ListSequence.fromList(myDiffEditors)) {
              diffEditor.inspect(check_s6qw4f_a0a0a0a1a0a0a0(check_s6qw4f_a0a0a0a0b0a0a0a(diffEditor.getMainEditor().getEditedNode()), selectionId));
            }
          }
        }
      });
    }
  }

  private class MyViewportChangeListener implements ChangeListener {
    private DiffEditor myDiffEditor;

    private MyViewportChangeListener(DiffEditor diffEditor) {
      myDiffEditor = diffEditor;
    }

    public void stateChanged(ChangeEvent event) {
      if (myViewportSetInProgress) {
        return;
      }
      myViewportSetInProgress = true;
      ListSequence.fromList(myDiffEditors).visitAll(new IVisitor<DiffEditor>() {
        public void visit(DiffEditor other) {
          synchronizeViewWithOther(myDiffEditor.getMainEditor(), other.getMainEditor());
        }
      });
      myViewportSetInProgress = false;
    }
  }
}
