package jetbrains.mps.vcs.platform.integration;

/*Generated by MPS */

import com.intellij.openapi.diff.impl.mergeTool.MergeTool;
import jetbrains.mps.logging.Logger;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import com.intellij.openapi.diff.DiffRequest;
import com.intellij.openapi.diff.impl.mergeTool.MergeRequestImpl;
import com.intellij.openapi.vfs.VirtualFile;
import com.intellij.openapi.vfs.LocalFileSystem;
import java.io.File;
import jetbrains.mps.vcs.platform.util.MergeBackupUtil;
import com.intellij.openapi.diff.DiffContent;
import jetbrains.mps.smodel.SModel;
import jetbrains.mps.smodel.persistence.def.ModelPersistence;
import jetbrains.mps.vcs.util.MergeConstants;
import jetbrains.mps.util.FileUtil;
import jetbrains.mps.smodel.persistence.def.ModelReadException;
import jetbrains.mps.vcs.diff.ui.merge.MergeModelsDialog;
import javax.swing.SwingUtilities;
import java.io.IOException;
import jetbrains.mps.fileTypes.MPSFileTypeFactory;
import com.intellij.openapi.ui.DialogWrapper;
import jetbrains.mps.smodel.ModelAccess;
import org.jetbrains.annotations.Nullable;

public class ModelMergeTool extends MergeTool {
  private static final Logger LOG = Logger.getLogger(ModelMergeTool.class);
  protected static Log log = LogFactory.getLog(ModelMergeTool.class);

  public ModelMergeTool() {
  }

  public void show(final DiffRequest request) {
    MergeRequestImpl mrequest = (MergeRequestImpl) request;
    try {
      VirtualFile file = getFileFromMergeRequest(mrequest);
      if (file == null) {
        if (log.isErrorEnabled()) {
          log.error("No file");
        }
        file = LocalFileSystem.getInstance().findFileByPath("/");
      }
      File backupFile = MergeBackupUtil.zipModel(request.getContents(), file);
      DiffContent[] contents = mrequest.getContents();
      final SModel baseModel;
      final SModel mineModel;
      final SModel newModel;
      try {
        baseModel = ModelPersistence.readModel(contents[MergeConstants.ORIGINAL].getDocument().getText(), false);
        mineModel = ModelPersistence.readModel(new String(contents[MergeConstants.CURRENT].getBytes(), FileUtil.DEFAULT_CHARSET), false);
        newModel = ModelPersistence.readModel(new String(contents[MergeConstants.LAST_REVISION].getBytes(), FileUtil.DEFAULT_CHARSET), false);
      } catch (ModelReadException e) {
        if (log.isWarnEnabled()) {
          log.warn("Couldn't read model, invoking text merge", e);
        }
        super.show(request);
        return;
      }

      final MergeModelsDialog dialog = new MergeModelsDialog(baseModel, mineModel, newModel, mrequest);
      SwingUtilities.invokeLater(new Runnable() {
        public void run() {
          dialog.toFront();
        }
      });
      dialog.show();
      if (dialog.getResultModel() != null) {
        String asString = ModelPersistence.modelToString(dialog.getResultModelWithFixedId());
        resolved(mrequest, asString);
        MergeBackupUtil.packMergeResult(backupFile, file.getName(), asString);
      }
      dialog.unregisterResultModel();
    } catch (IOException e) {
      LOG.error(e);
    }
  }

  public boolean canShow(DiffRequest request) {
    return super.canShow(request) && request.getContents()[MergeConstants.ORIGINAL].getContentType() == MPSFileTypeFactory.MODEL_FILE_TYPE;
  }

  private static void resolved(MergeRequestImpl req, final String result) {
    req.setResult(DialogWrapper.OK_EXIT_CODE);
    final VirtualFile modelFile = getFileFromMergeRequest(req);
    ModelAccess.instance().runWriteInEDT(new Runnable() {
      public void run() {
        try {
          modelFile.setBinaryContent(result.getBytes(FileUtil.DEFAULT_CHARSET));
        } catch (IOException e) {
          if (log.isErrorEnabled()) {
            log.error("", e);
          }
        }
      }
    });
  }

  @Nullable
  private static VirtualFile getFileFromMergeRequest(MergeRequestImpl mergeRequest) {
    DiffContent resultContent = mergeRequest.getResultContent();
    if (resultContent instanceof MergeRequestImpl.MergeContent) {
      return ((MergeRequestImpl.MergeContent) resultContent).getFile();
    }
    return null;
  }
}
