package jetbrains.mps.vcs.diff.ui;

/*Generated by MPS */

import com.intellij.openapi.ui.DialogWrapper;
import com.intellij.openapi.actionSystem.DataProvider;
import jetbrains.mps.vcs.diff.ModelChangeSet;
import org.jetbrains.mps.openapi.model.SNodeId;
import com.intellij.openapi.project.Project;
import jetbrains.mps.vcs.diff.ui.common.DiffEditor;
import java.util.List;
import jetbrains.mps.vcs.diff.ui.common.ChangeGroupLayout;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.vcs.diff.ui.common.DiffEditorSeparator;
import jetbrains.mps.vcs.diff.ui.common.DiffEditorsGroup;
import javax.swing.JPanel;
import java.awt.GridBagLayout;
import java.awt.BorderLayout;
import com.intellij.openapi.actionSystem.ActionToolbar;
import com.intellij.openapi.diff.ex.DiffStatusBar;
import com.intellij.openapi.diff.impl.util.TextDiffType;
import com.intellij.openapi.actionSystem.DefaultActionGroup;
import jetbrains.mps.vcs.diff.ui.common.NextPreviousTraverser;
import java.awt.Component;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.workbench.action.BaseAction;
import jetbrains.mps.vcs.diff.ui.common.Bounds;
import javax.swing.JSplitPane;
import jetbrains.mps.vcs.diff.changes.ModelChange;
import com.intellij.openapi.actionSystem.ActionManager;
import com.intellij.openapi.actionSystem.ActionPlaces;
import javax.swing.SwingUtilities;
import java.awt.DisplayMode;
import java.awt.GraphicsEnvironment;
import java.awt.Dimension;
import com.intellij.openapi.util.DimensionService;
import jetbrains.mps.internal.collections.runtime.IVisitor;
import jetbrains.mps.vcs.diff.ui.common.DiffChangeGroupLayout;
import javax.swing.JComponent;
import org.jetbrains.annotations.NonNls;
import jetbrains.mps.vcs.diff.ui.common.DiffModelTree;
import com.intellij.openapi.util.Ref;
import org.jetbrains.annotations.NotNull;
import javax.swing.Action;
import jetbrains.mps.smodel.SModel;
import jetbrains.mps.vcs.diff.ui.common.DiffTemporaryModule;
import java.awt.GridBagConstraints;
import java.awt.Insets;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.util.NameUtil;
import jetbrains.mps.vcs.diff.ui.common.ChangeGroupMessages;
import jetbrains.mps.vcs.diff.ChangeSetBuilder;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.smodel.descriptor.EditableSModelDescriptor;
import jetbrains.mps.smodel.SModelRepository;
import com.intellij.openapi.wm.WindowManager;
import java.awt.GraphicsDevice;
import java.awt.HeadlessException;
import jetbrains.mps.smodel.SModelDescriptor;

public class RootDifferenceDialog extends DialogWrapper implements DataProvider {
  private ModelChangeSet myChangeSet;
  private SNodeId myRootId;
  private Project myProject;
  private String[] myTitles;
  private DiffEditor myOldEditor;
  private DiffEditor myNewEditor;
  private List<ChangeGroupLayout> myChangeGroupLayouts = ListSequence.fromList(new ArrayList<ChangeGroupLayout>());
  private List<DiffEditorSeparator> myEditorSeparators = ListSequence.fromList(new ArrayList<DiffEditorSeparator>());
  private DiffEditorsGroup myDiffEditorsGroup = new DiffEditorsGroup();
  private JPanel myTopPanel = new JPanel(new GridBagLayout());
  private JPanel myBottomPanel = new JPanel(new GridBagLayout());
  private JPanel myContainer = new JPanel(new BorderLayout());
  private ActionToolbar myActionToolbar;
  private DiffStatusBar myStatusBar = new DiffStatusBar(TextDiffType.DIFF_TYPES);
  private DefaultActionGroup myActionGroup;
  private NextPreviousTraverser myTraverser;

  public RootDifferenceDialog(Project project, ModelChangeSet changeSet, SNodeId rootId, String rootName, String[] titles, Component parent, boolean isEditable, @Nullable BaseAction[] actions, @Nullable final Bounds firstChange) {
    super(parent, true);
    setTitle("Difference for " + rootName);

    myChangeSet = changeSet;
    myRootId = rootId;
    myProject = project;
    myTitles = titles;

    myOldEditor = addEditor(0, myChangeSet.getOldModel());
    myNewEditor = addEditor(1, myChangeSet.getNewModel());

    linkEditors(true);
    linkEditors(false);

    JSplitPane splitPane = new JSplitPane(JSplitPane.VERTICAL_SPLIT, myTopPanel, myBottomPanel);
    splitPane.setResizeWeight(0.7);

    myActionGroup = new DefaultActionGroup();
    if (actions != null) {
      myActionGroup.addAll(actions);
      myActionGroup.addSeparator();
    }
    myTraverser = new NextPreviousTraverser(myChangeGroupLayouts, myNewEditor.getMainEditor());
    myActionGroup.addAll(myTraverser.previousAction(), myTraverser.nextAction());
    myActionGroup.addSeparator();
    if (isEditable) {
      myActionGroup.add(new RevertRootsAction(rootName) {
        protected Iterable<ModelChange> getChanges() {
          return myChangeSet.getChangesForRoot(myRootId);
        }

        protected void after() {
          rehighlight();
        }
      });
    }

    myActionToolbar = ActionManager.getInstance().createActionToolbar(ActionPlaces.UNKNOWN, myActionGroup, true);
    myTraverser.setActionToolbar(myActionToolbar);

    myContainer.add(myActionToolbar.getComponent(), BorderLayout.NORTH);
    myContainer.add(splitPane, BorderLayout.CENTER);
    myContainer.add(myStatusBar, BorderLayout.SOUTH);

    highlightAllChanges();

    if (firstChange != null) {
      SwingUtilities.invokeLater(new Runnable() {
        public void run() {
          myTraverser.goToBounds(firstChange);
        }
      });
    } else {
      myTraverser.goToFirstChangeLater();
    }

    DisplayMode displayMode = check_vu2gar_a0jb0q(check_vu2gar_a0a53a61(GraphicsEnvironment.getLocalGraphicsEnvironment()));
    int width = (displayMode == null ?
      800 :
      displayMode.getWidth() - 100
    );
    int height = (displayMode == null ?
      600 :
      displayMode.getHeight() - 100
    );
    myContainer.setPreferredSize(new Dimension(width, height));
    Dimension size = DimensionService.getInstance().getSize(getDimensionServiceKey());
    if (size == null) {
      myContainer.setPreferredSize(new Dimension(width, height));
    }

    init();
  }

  public SNodeId getRootId() {
    return myRootId;
  }

  public void setRootId(SNodeId rootId, String rootName) {
    myRootId = rootId;
    setTitle("Difference for " + rootName);
    myOldEditor.editRoot(myProject, myRootId, myChangeSet.getOldModel());
    myNewEditor.editRoot(myProject, myRootId, myChangeSet.getNewModel());
    rehighlight();
    myTraverser.goToFirstChangeLater();
  }

  public void setRootId(SNodeId rootId, String rootName, ModelChangeSet changeSet) {
    myChangeSet = changeSet;
    ListSequence.fromList(myChangeGroupLayouts).visitAll(new IVisitor<ChangeGroupLayout>() {
      public void visit(ChangeGroupLayout it) {
        ((DiffChangeGroupLayout) it).setChangeSet(myChangeSet);
      }
    });
    setRootId(rootId, rootName);
  }

  @Nullable
  protected JComponent createCenterPanel() {
    return myContainer;
  }

  public String getDimensionServiceKey() {
    return getClass().getName();
  }

  @Nullable
  public Object getData(@NonNls String dataId) {
    if (DiffModelTree.NODE_ID_DATAKEY.is(dataId)) {
      return new Ref<SNodeId>(myRootId);
    }
    return null;
  }

  @NotNull
  protected Action[] createActions() {
    return new Action[0];
  }

  private DiffEditor addEditor(int index, SModel model) {
    final DiffEditor result = new DiffEditor(DiffTemporaryModule.getOperationContext(myProject, model), model.getNodeById(myRootId), myTitles[index], index == 0);

    GridBagConstraints gbc = new GridBagConstraints(index * 2, 0, 1, 1, 1, 1, GridBagConstraints.CENTER, GridBagConstraints.BOTH, new Insets(5, (index == 0 ?
      5 :
      0
    ), 5, (index == 2 ?
      5 :
      0
    )), 0, 0);
    myTopPanel.add(result.getTopComponent(), gbc);
    myBottomPanel.add(result.getInspector().getExternalComponent(), gbc);

    myDiffEditorsGroup.add(result);
    return result;
  }

  private void highlightAllChanges() {
    ListSequence.fromList(myChangeGroupLayouts).visitAll(new IVisitor<ChangeGroupLayout>() {
      public void visit(ChangeGroupLayout b) {
        b.invalidate();
      }
    });
    for (ModelChange change : Sequence.fromIterable(myChangeSet.getChangesForRoot(myRootId))) {
      higlightChange(myOldEditor, myChangeSet.getOldModel(), change);
      higlightChange(myNewEditor, myChangeSet.getNewModel(), change);
    }
    ListSequence.fromList(myChangeGroupLayouts).visitAll(new IVisitor<ChangeGroupLayout>() {
      public void visit(ChangeGroupLayout b) {
        b.invalidate();
      }
    });

    myOldEditor.repaintAndRebuildEditorMessages();
    myNewEditor.repaintAndRebuildEditorMessages();

    int count = Sequence.fromIterable(myChangeSet.getChangesForRoot(myRootId)).count();
    myStatusBar.setText((count == 0 ?
      "no differences" :
      NameUtil.formatNumericalString(count, "difference")
    ));
  }

  private void linkEditors(boolean inspector) {
    // create change group builder, trapecium strip and merge buttons painter 
    // 'mine' parameter means mine changeset, 'inspector' - highlight inspector editor component 
    ChangeGroupLayout layout = new DiffChangeGroupLayout(null, myChangeSet, myOldEditor, myNewEditor, inspector);
    ChangeGroupMessages.startMaintaining(layout);
    ListSequence.fromList(myChangeGroupLayouts).addElement(layout);
    DiffEditorSeparator separator = new DiffEditorSeparator(layout);
    GridBagConstraints gbc = new GridBagConstraints(1, 0, 1, 1, 0, 1, GridBagConstraints.CENTER, GridBagConstraints.BOTH, new Insets(5, 0, 5, 0), 0, 0);
    ((inspector ?
      myBottomPanel :
      myTopPanel
    )).add(separator, gbc);
    ListSequence.fromList(myEditorSeparators).addElement(separator);
    if (!(myChangeSet.getNewModel().isNotEditable())) {
      DiffButtonsPainter.addTo(this, myOldEditor, layout, inspector);
      DiffButtonsPainter.addTo(this, myNewEditor, layout, inspector);
    }
  }

  private void higlightChange(DiffEditor diffEditor, SModel model, ModelChange change) {
    diffEditor.highlightChange(model, change, null);
  }

  public void rehighlight() {
    ChangeSetBuilder.rebuildChangeSet(myChangeSet);
    myNewEditor.unhighlightAllChanges();
    myOldEditor.unhighlightAllChanges();

    if (myNewEditor.getEditedNode() == null) {
      myNewEditor.editRoot(myProject, myRootId, myChangeSet.getNewModel());
    }

    myNewEditor.getMainEditor().rebuildEditorContent();
    myOldEditor.getMainEditor().rebuildEditorContent();

    highlightAllChanges();
  }

  /*package*/ void rollbackChanges(Iterable<ModelChange> changes) {
    ModelChange.rollbackChanges(changes);
    rehighlight();
  }

  protected JComponent getMainComponent() {
    return myContainer;
  }

  @Override
  public void dispose() {
    myActionGroup.removeAll();
    myActionGroup = null;
    myOldEditor.dispose();
    myOldEditor = null;
    myNewEditor.dispose();
    myNewEditor = null;
    ListSequence.fromList(myEditorSeparators).visitAll(new IVisitor<DiffEditorSeparator>() {
      public void visit(DiffEditorSeparator s) {
        s.dispose();
      }
    });
    ListSequence.fromList(myEditorSeparators).clear();
    myEditorSeparators = null;
    super.dispose();
  }

  public static void invokeDialog(final SModel oldModel, final SModel newModel, final SNodeId rootId, final Project project, final String[] contentTitles, @Nullable final Bounds scrollTo) {
    assert contentTitles.length == 2;

    jetbrains.mps.project.Project p = ProjectHelper.toMPSProject(project);
    DiffTemporaryModule.createModuleForModel(oldModel, "old", p);
    DiffTemporaryModule.createModuleForModel(newModel, "new", p);

    final Wrappers._T<RootDifferenceDialog> dialog = new Wrappers._T<RootDifferenceDialog>();
    ModelAccess.instance().runReadAction(new _Adapters._return_P0_E0_to_Runnable_adapter(new _FunctionTypes._return_P0_E0<RootDifferenceDialog>() {
      public RootDifferenceDialog invoke() {
        ModelChangeSet changeSet = ChangeSetBuilder.buildChangeSet(oldModel, newModel, true);

        SNode node = newModel.getNodeById(rootId);
        if (node == null) {
          node = oldModel.getNodeById(rootId);
        }
        String rootName = (node == null ?
          "root" :
          node.getPresentation()
        );

        boolean isEditable = newModel.getModelDescriptor() instanceof EditableSModelDescriptor && check_vu2gar_a0a0g0a7a23(SModelRepository.getInstance().getModelDescriptor(newModel.getSModelReference())) == newModel;

        return dialog.value = new RootDifferenceDialog(project, changeSet, rootId, rootName, contentTitles, WindowManager.getInstance().getFrame(project), isEditable, null, scrollTo);
      }
    }));
    dialog.value.show();
  }

  private static DisplayMode check_vu2gar_a0jb0q(GraphicsDevice checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getDisplayMode();
    }
    return null;
  }

  private static GraphicsDevice check_vu2gar_a0a53a61(GraphicsEnvironment checkedDotOperand) throws HeadlessException {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getDefaultScreenDevice();
    }
    return null;
  }

  private static SModel check_vu2gar_a0a0g0a7a23(SModelDescriptor checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getSModel();
    }
    return null;
  }
}
