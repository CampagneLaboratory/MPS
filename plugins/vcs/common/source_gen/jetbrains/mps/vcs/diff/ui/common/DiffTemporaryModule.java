package jetbrains.mps.vcs.diff.ui.common;

/*Generated by MPS */

import jetbrains.mps.project.AbstractModule;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.project.Project;
import jetbrains.mps.project.structure.modules.ModuleReference;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.project.ModuleId;
import java.util.List;
import java.util.Arrays;
import jetbrains.mps.smodel.SModelReference;
import jetbrains.mps.smodel.IScope;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.project.GlobalScope;
import jetbrains.mps.smodel.ScopeOperations;
import jetbrains.mps.project.IModule;
import jetbrains.mps.smodel.SModelRepository;
import jetbrains.mps.smodel.CopyUtil;
import jetbrains.mps.smodel.SModelId;
import jetbrains.mps.smodel.MPSModuleOwner;
import jetbrains.mps.smodel.MPSModuleRepository;
import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.project.ModuleContext;
import jetbrains.mps.ide.project.ProjectHelper;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.smodel.BaseSpecialModelDescriptor;
import jetbrains.mps.smodel.descriptor.EditableSModelDescriptor;

public class DiffTemporaryModule extends AbstractModule {
  private SModel myModel;
  private Project myProject;

  private DiffTemporaryModule(SModel model, String version, Project project) {
    setModuleReference(new ModuleReference(SModelOperations.getModelName(model) + "@" + version, ModuleId.regular()));
    myModel = model;
    myProject = project;
  }

  @Override
  public String toString() {
    return getModuleFqName();
  }

  @Override
  public List<SModel> getOwnModelDescriptors() {
    return Arrays.asList(((SModel) myModel.getModelDescriptor()));
  }

  @Override
  protected AbstractModule.ModuleScope createScope() {
    return new DiffTemporaryModule.DiffModuleScope();
  }

  private DiffTemporaryModule.DiffModuleContext createContext() {
    return new DiffTemporaryModule.DiffModuleContext();
  }

  private SModel findModel(SModelReference reference) {
    if (reference.equals(myModel.getReference())) {
      return myModel.getModelDescriptor();
    }
    List<IScope> scopes = ListSequence.fromList(new ArrayList<IScope>());
    IScope ps = myProject.getScope();
    if (ps != null) {
      ListSequence.fromList(scopes).addElement(ps);
    }
    ListSequence.fromList(scopes).addElement(GlobalScope.getInstance());
    for (IScope scope : ListSequence.fromList(scopes)) {
      SModel md = scope.getModelDescriptor(reference);
      if (md != null) {
        return md;
      }
    }
    // if we can't find model using full reference, try to find by fq-name 
    // this is needed for viewing diff on models saved before MPS 2.0 M5 
    for (IScope scope : ListSequence.fromList(scopes)) {
      SModel md = ScopeOperations.getModelDescriptor(scope, reference.getSModelFqName());
      if (md != null) {
        return md;
      }
    }
    return null;
  }

  public static void createModuleForModel(SModel model, String version, Project project) {
    createModuleForModel(model, version, project, false);
  }

  public static void createModuleForModel(SModel model, String version, Project project, boolean mergeResultModel) {
    if (model.getModelDescriptor() != null) {
      return;
    }
    IModule module = null;
    if (mergeResultModel) {
      SModel mdInRepo = SModelRepository.getInstance().getModelDescriptor(model.getReference());
      if (mdInRepo != null) {
        module = mdInRepo.getModule();
      }
    }

    if (module == null) {
      module = new DiffTemporaryModule(model, version, project);
    }
    jetbrains.mps.smodel.SModel m = (jetbrains.mps.smodel.SModel) model;
    m.setModelDescriptor(new DiffTemporaryModule.DiffSModelDescriptor(module, m, mergeResultModel));
  }

  public static void setSModelId(SModel model, String version) {
    SModelReference modelRef = model.getReference();
    CopyUtil.changeModelReference(model, new SModelReference(modelRef.getSModelFqName(), genMergeSModelId(modelRef.getSModelId(), version)));
  }

  public static void resetSModelId(SModel model) {
    SModelReference modelRef = model.getReference();
    assert modelRef.getSModelId() instanceof SModelId.ForeignSModelId;
    CopyUtil.changeModelReference(model, new SModelReference(modelRef.getSModelFqName(), getOriginalSModelId((SModelId.ForeignSModelId) modelRef.getSModelId())));
  }

  public static void registerModel(SModel model, MPSModuleOwner owner) {
    IModule module = model.getModelDescriptor().getModule();
    MPSModuleRepository.getInstance().registerModule(module, owner);
    SModelRepository.getInstance().registerModelDescriptor(model.getModelDescriptor(), module);
  }

  public static void unregisterModel(SModel model, MPSModuleOwner owner) {
    IModule module = model.getModelDescriptor().getModule();
    MPSModuleRepository.getInstance().registerModule(module, owner);
    SModelRepository.getInstance().unRegisterModelDescriptor(model.getModelDescriptor(), module);

  }

  public static IOperationContext getOperationContext(com.intellij.openapi.project.Project project, SModel model) {
    SModel md = model.getModelDescriptor();
    assert md != null;
    IModule module = md.getModule();
    if (module instanceof DiffTemporaryModule) {
      return ((DiffTemporaryModule) module).createContext();
    } else {
      return new ModuleContext(module, ProjectHelper.toMPSProject(project));
    }
  }

  public static org.jetbrains.mps.openapi.model.SModelId genMergeSModelId(org.jetbrains.mps.openapi.model.SModelId modelId, String version) {
    return SModelId.foreign("merge_" + version + "#" + modelId.toString());
  }

  public static org.jetbrains.mps.openapi.model.SModelId getOriginalSModelId(SModelId.ForeignSModelId modelId) {
    String id = modelId.getId();
    return SModelId.fromString(id.substring(id.indexOf("#") + 1));
  }

  private class DiffModuleScope extends AbstractModule.ModuleScope {
    private DiffModuleScope() {
    }

    @Override
    protected Set<IModule> getInitialModules() {
      Set<IModule> result = SetSequence.fromSet(new HashSet<IModule>());
      SetSequence.fromSet(result).addElement(DiffTemporaryModule.this);
      SetSequence.fromSet(result).addSequence(Sequence.fromIterable(GlobalScope.getInstance().getVisibleModules()));
      return result;
    }

    @Override
    protected Set<Language> getInitialUsedLanguages() {
      return SetSequence.fromSetWithValues(new HashSet<Language>(), GlobalScope.getInstance().getVisibleLanguages());
    }

    @Override
    public SModel resolve(org.jetbrains.mps.openapi.model.SModelReference reference) {
      return findModel((SModelReference) reference);
    }
  }

  public static class DiffSModelDescriptor extends BaseSpecialModelDescriptor implements EditableSModelDescriptor {
    private IModule myModule;
    private boolean myEditable;

    private DiffSModelDescriptor(IModule module, jetbrains.mps.smodel.SModel model, boolean editable) {
      super(model.getReference());
      myModule = module;
      mySModel = model;
      myEditable = editable;
    }

    @Override
    public IModule getModule() {
      return myModule;
    }

    @Override
    public SModel resolveModel(SModelReference reference) {
      if (myModule instanceof DiffTemporaryModule.DiffModuleScope) {
        return ((DiffTemporaryModule) myModule).findModel(reference);
      } else {
        return super.resolveModel(reference);
      }
    }

    @Override
    public void reloadFromDisk() {
    }

    @Override
    public void updateDiskTimestamp() {
    }

    @Override
    public void rename(String newModelName, boolean changeFile) {
      throw new UnsupportedOperationException();
    }

    @Override
    public boolean isReadOnly() {
      return !(myEditable);
    }

    @Override
    public void setChanged(boolean b) {
    }

    @Override
    public boolean isChanged() {
      return false;
    }

    @Override
    public void save() {
    }

    @Override
    protected jetbrains.mps.smodel.SModel createModel() {
      throw new UnsupportedOperationException();
    }

    @Override
    public boolean needsReloading() {
      return false;
    }
  }

  private class DiffModuleContext extends ModuleContext {
    private DiffModuleContext() {
      super(DiffTemporaryModule.this, myProject);
    }

    @Override
    public IModule getModule() {
      return DiffTemporaryModule.this;
    }
  }
}
