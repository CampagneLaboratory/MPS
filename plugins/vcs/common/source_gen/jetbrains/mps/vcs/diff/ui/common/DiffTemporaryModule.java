package jetbrains.mps.vcs.diff.ui.common;

/*Generated by MPS */

import jetbrains.mps.project.AbstractModule;
import jetbrains.mps.smodel.SModel;
import jetbrains.mps.project.Project;
import jetbrains.mps.project.structure.modules.ModuleReference;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.project.ModuleId;
import java.util.List;
import java.util.Collections;
import org.jetbrains.mps.openapi.model.SModelReference;
import jetbrains.mps.smodel.IScope;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.project.GlobalScope;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.smodel.ScopeOperations;
import jetbrains.mps.smodel.SModelDescriptor;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.smodel.SModelRepository;
import jetbrains.mps.smodel.CopyUtil;
import jetbrains.mps.smodel.SModelFqName;
import jetbrains.mps.smodel.SModelId;
import jetbrains.mps.smodel.MPSModuleOwner;
import jetbrains.mps.smodel.MPSModuleRepository;
import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.project.ModuleContext;
import jetbrains.mps.ide.project.ProjectHelper;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.smodel.BaseSpecialModelDescriptor;
import jetbrains.mps.smodel.descriptor.EditableSModelDescriptor;

public class DiffTemporaryModule extends AbstractModule {
  private SModel myModel;
  private Project myProject;

  private DiffTemporaryModule(SModel model, String version, Project project) {
    setModuleReference(new ModuleReference(SModelOperations.getModelName(((org.jetbrains.mps.openapi.model.SModel) model.getModelDescriptor())) + "@" + version, ModuleId.regular()));
    myModel = model;
    myProject = project;
  }

  @Override
  public String toString() {
    return getModuleName();
  }

  @Override
  public List<org.jetbrains.mps.openapi.model.SModel> getModels() {
    return Collections.<org.jetbrains.mps.openapi.model.SModel>singletonList(myModel.getModelDescriptor());
  }

  @Override
  protected AbstractModule.ModuleScope createScope() {
    return new DiffTemporaryModule.DiffModuleScope();
  }

  private DiffTemporaryModule.DiffModuleContext createContext() {
    return new DiffTemporaryModule.DiffModuleContext();
  }

  private org.jetbrains.mps.openapi.model.SModel findModel(SModelReference reference) {
    if (reference.equals(myModel.getReference())) {
      return myModel.getModelDescriptor();
    }
    List<IScope> scopes = ListSequence.fromList(new ArrayList<IScope>());
    IScope ps = myProject.getScope();
    if (ps != null) {
      ListSequence.fromList(scopes).addElement(ps);
    }
    ListSequence.fromList(scopes).addElement(GlobalScope.getInstance());
    for (IScope scope : ListSequence.fromList(scopes)) {
      org.jetbrains.mps.openapi.model.SModel md = scope.getModelDescriptor(reference);
      if (md != null) {
        return md;
      }
    }
    // if we can't find model using full reference, try to find by fq-name 
    // this is needed for viewing diff on models saved before MPS 2.0 M5 
    for (IScope scope : ListSequence.fromList(scopes)) {
      org.jetbrains.mps.openapi.model.SModel md = Sequence.fromIterable(((Iterable<org.jetbrains.mps.openapi.model.SModel>) ScopeOperations.getModelsByName(scope, reference.getModelName()))).first();
      if (md != null) {
        return md;
      }
    }
    return null;
  }

  private static void createModuleForModel(SModel model, String version, Project project, boolean mergeResultModel) {
    SModelDescriptor md = model.getModelDescriptor();
    if (!(md instanceof SModel.FakeModelDescriptor)) {
      return;
    }
    SModule module = null;
    if (mergeResultModel) {
      org.jetbrains.mps.openapi.model.SModel mdInRepo = SModelRepository.getInstance().getModelDescriptor(model.getReference());
      if (mdInRepo != null) {
        module = mdInRepo.getModule();
      }
    }

    if (module == null) {
      module = new DiffTemporaryModule(model, version, project);
    }
    model.setModelDescriptor(new DiffTemporaryModule.DiffSModelDescriptor(module, model, mergeResultModel));
  }

  public static void createModuleAndRegister(SModel model, String version, Project project, boolean mergeResultModel) {
    if (version != null) {
      setSModelId(model, version);
    }
    createModuleForModel(model, (version == null ?
      "module" :
      version
    ), project, mergeResultModel);
    registerModel(model.getModelDescriptor(), project);
  }

  private static void setSModelId(SModel model, String version) {
    SModelReference modelRef = model.getReference();
    CopyUtil.changeModelReference(model.getModelDescriptor(), new jetbrains.mps.smodel.SModelReference(SModelFqName.fromString(modelRef.getModelName()), genMergeSModelId(modelRef.getModelId(), version)));
  }

  public static void resetSModelId(org.jetbrains.mps.openapi.model.SModel model) {
    SModelReference modelRef = model.getReference();
    assert modelRef.getModelId() instanceof SModelId.ForeignSModelId;
    CopyUtil.changeModelReference(model, new jetbrains.mps.smodel.SModelReference(SModelFqName.fromString(modelRef.getModelName()), getOriginalSModelId((SModelId.ForeignSModelId) modelRef.getModelId())));
  }

  private static void registerModel(org.jetbrains.mps.openapi.model.SModel model, MPSModuleOwner owner) {
    SModule module = model.getModule();
    MPSModuleRepository.getInstance().registerModule(module, owner);
    SModelRepository.getInstance().registerModelDescriptor(model, module);
  }

  public static void unregisterModel(org.jetbrains.mps.openapi.model.SModel model, MPSModuleOwner owner) {
    SModule module = model.getModule();
    SModelRepository.getInstance().unRegisterModelDescriptor(model, module);
    MPSModuleRepository.getInstance().unregisterModule(module, owner);
  }

  public static IOperationContext getOperationContext(com.intellij.openapi.project.Project project, SModel model) {
    org.jetbrains.mps.openapi.model.SModel md = model.getModelDescriptor();
    assert md != null;
    SModule module = md.getModule();
    if (module instanceof DiffTemporaryModule) {
      return ((DiffTemporaryModule) module).createContext();
    } else {
      return new ModuleContext(module, ProjectHelper.toMPSProject(project));
    }
  }

  public static org.jetbrains.mps.openapi.model.SModelId genMergeSModelId(org.jetbrains.mps.openapi.model.SModelId modelId, String version) {
    return SModelId.foreign("merge_" + version + "#" + modelId.toString());
  }

  public static org.jetbrains.mps.openapi.model.SModelId getOriginalSModelId(SModelId.ForeignSModelId modelId) {
    String id = modelId.getId();
    return SModelId.fromString(id.substring(id.indexOf("#") + 1));
  }

  private class DiffModuleScope extends AbstractModule.ModuleScope {
    private DiffModuleScope() {
    }

    @Override
    protected Set<SModule> getInitialModules() {
      Set<SModule> result = SetSequence.fromSet(new HashSet<SModule>());
      SetSequence.fromSet(result).addElement(DiffTemporaryModule.this);
      SetSequence.fromSet(result).addSequence(Sequence.fromIterable(GlobalScope.getInstance().getVisibleModules()));
      return result;
    }

    @Override
    protected Set<Language> getInitialUsedLanguages() {
      return SetSequence.fromSetWithValues(new HashSet<Language>(), GlobalScope.getInstance().getVisibleLanguages());
    }

    @Override
    public org.jetbrains.mps.openapi.model.SModel resolve(SModelReference reference) {
      return findModel((jetbrains.mps.smodel.SModelReference) reference);
    }
  }

  public static class DiffSModelDescriptor extends BaseSpecialModelDescriptor implements EditableSModelDescriptor {
    private SModule myModule;
    private boolean myEditable;

    private DiffSModelDescriptor(SModule module, SModel model, boolean editable) {
      super(model.getReference());
      myModule = module;
      mySModel = model;
      myEditable = editable;
    }

    @Override
    public SModule getModule() {
      return myModule;
    }

    @Override
    public org.jetbrains.mps.openapi.model.SModel resolveModel(SModelReference reference) {
      if (myModule instanceof DiffTemporaryModule.DiffModuleScope) {
        return ((DiffTemporaryModule) myModule).findModel(reference);
      } else {
        return super.resolveModel(reference);
      }
    }

    @Override
    public void reloadFromSource() {
    }

    @Override
    public void updateTimestamp() {
    }

    @Override
    public void rename(String newModelName, boolean changeFile) {
      throw new UnsupportedOperationException();
    }

    @Override
    public boolean isReadOnly() {
      return !(myEditable);
    }

    @Override
    public void setChanged(boolean b) {
    }

    @Override
    public boolean isChanged() {
      return false;
    }

    @Override
    public void save() {
    }

    @Override
    protected SModel createModel() {
      throw new UnsupportedOperationException();
    }

    @Override
    public boolean needsReloading() {
      return false;
    }
  }

  private class DiffModuleContext extends ModuleContext {
    private DiffModuleContext() {
      super(DiffTemporaryModule.this, myProject);
    }

    @Override
    public SModule getModule() {
      return DiffTemporaryModule.this;
    }
  }
}
