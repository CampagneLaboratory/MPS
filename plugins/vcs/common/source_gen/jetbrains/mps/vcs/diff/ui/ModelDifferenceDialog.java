package jetbrains.mps.vcs.diff.ui;

/*Generated by MPS */

import com.intellij.openapi.ui.DialogWrapper;
import com.intellij.openapi.actionSystem.DataProvider;
import com.intellij.openapi.project.Project;
import jetbrains.mps.vcs.diff.ModelChangeSet;
import org.jetbrains.mps.openapi.model.SNodeId;
import javax.swing.JPanel;
import java.awt.BorderLayout;
import com.intellij.ui.JBSplitter;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.SwingConstants;
import com.intellij.openapi.actionSystem.ActionToolbar;
import com.intellij.openapi.diff.ex.DiffStatusBar;
import com.intellij.openapi.diff.impl.util.TextDiffType;
import com.intellij.openapi.actionSystem.DefaultActionGroup;
import jetbrains.mps.vcs.diff.ui.common.GoToNeighbourRootActions;
import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.annotations.Nullable;
import com.intellij.openapi.diff.DiffRequest;
import jetbrains.mps.util.SNodeOperations;
import org.jetbrains.mps.openapi.model.EditableSModel;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.vcs.diff.ui.common.DiffModelUtil;
import jetbrains.mps.vcs.diff.ChangeSetBuilder;
import jetbrains.mps.vcs.diff.ui.common.InvokeTextDiffAction;
import com.intellij.openapi.diff.DiffManager;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import com.intellij.ui.ScrollPaneFactory;
import com.intellij.openapi.actionSystem.ActionManager;
import com.intellij.openapi.actionSystem.ActionPlaces;
import java.awt.Dimension;
import com.intellij.openapi.util.DimensionService;
import org.jetbrains.annotations.NotNull;
import javax.swing.Action;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.vcs.diff.ui.common.Bounds;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.annotations.NonNls;
import jetbrains.mps.vcs.diff.ui.common.DiffModelTree;
import com.intellij.openapi.util.Ref;
import jetbrains.mps.workbench.action.BaseAction;
import java.util.List;
import java.util.ArrayList;
import jetbrains.mps.vcs.diff.changes.ModelChange;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.ITranslator2;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.vcs.diff.changes.ChangeType;
import jetbrains.mps.vcs.diff.changes.AddRootChange;
import jetbrains.mps.vcs.diff.changes.DeleteRootChange;
import jetbrains.mps.vcs.diff.ui.common.ChangeColors;
import java.util.Arrays;

public class ModelDifferenceDialog extends DialogWrapper implements DataProvider {
  private Project myProject;
  private ModelChangeSet myChangeSet;
  private ModelChangeSet myMetadataChangeSet;
  private SNodeId myRootId;

  private ModelDifferenceDialog.ModelDifferenceTree myTree;
  private JPanel myComponent = new JPanel(new BorderLayout());
  private JBSplitter myPanel = new JBSplitter(true, 0.25f);
  private RootDifferencePane myRootDifferencePane = null;
  private final JComponent myNoRootPanel = new JLabel("Select root to show", SwingConstants.CENTER);
  private ActionToolbar myToolbar;
  private DiffStatusBar myStatusBar = new DiffStatusBar(TextDiffType.DIFF_TYPES);

  private DefaultActionGroup myActionGroup;
  private GoToNeighbourRootActions myGoToNeighbourRootActions;

  private String[] myContentTitles;
  private boolean myEditable;
  private boolean myOldRegistered;
  private boolean myNewRegistered;


  public ModelDifferenceDialog(Project project, final SModel oldModel, final SModel newModel, String oldTitle, String newTitle, @Nullable DiffRequest diffRequest) {
    super(project);
    myProject = project;
    myOldRegistered = SNodeOperations.isRegistered(oldModel);
    myNewRegistered = SNodeOperations.isRegistered(newModel);
    myEditable = newModel instanceof EditableSModel && myNewRegistered;
    final Wrappers._T<String> title = new Wrappers._T<String>();
    ModelAccess.instance().runWriteAction(new Runnable() {
      public void run() {
        title.value = SModelOperations.getModelName(oldModel);
        if (isEmpty_vk52pz_a0b0a0a0a0g0v(title.value)) {
          title.value = SModelOperations.getModelName(newModel);
        }

        if (!(myNewRegistered)) {
          DiffModelUtil.renameModelAndRegister(newModel, "new");
        }
        if (!(myOldRegistered)) {
          DiffModelUtil.renameModelAndRegister(oldModel, "old");
        }
      }
    });
    myContentTitles = new String[]{oldTitle, newTitle};
    assert myContentTitles.length == 2;

    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        setTitle("Difference for model: " + title.value);
        myChangeSet = ChangeSetBuilder.buildChangeSet(oldModel, newModel, true);
      }
    });
    ModelAccess.instance().runWriteAction(new Runnable() {
      public void run() {
        SModel newMetaModel = MetadataUtil.createMetadataModel(newModel, "metadata_new", myEditable);
        SModel oldMetaModel = MetadataUtil.createMetadataModel(oldModel, "metadata_old", false);
        myMetadataChangeSet = ChangeSetBuilder.buildChangeSet(oldMetaModel, newMetaModel, true);
      }
    });

    myActionGroup = new DefaultActionGroup();
    if (diffRequest != null) {
      myActionGroup.add(new InvokeTextDiffAction("View as Text", "View model difference using as text difference of XML contents", this, diffRequest, DiffManager.getInstance().getIdeaDiffTool()));
    }

    init();

    getWindow().addWindowListener(new WindowAdapter() {
      @Override
      public void windowClosed(WindowEvent event) {
        syncMetadataChanges();
        ModelAccess.instance().runWriteAction(new Runnable() {
          public void run() {
            MetadataUtil.dispose(myMetadataChangeSet.getOldModel());
            MetadataUtil.dispose(myMetadataChangeSet.getNewModel());
            if (!(myOldRegistered)) {
              DiffModelUtil.unregisterModel(myChangeSet.getOldModel());
            }
            if (!(myNewRegistered)) {
              DiffModelUtil.unregisterModel(myChangeSet.getNewModel());
            }
          }
        });
        getWindow().removeWindowListener(this);
      }
    });
  }



  @Nullable
  @Override
  protected JComponent createCenterPanel() {
    myPanel.setSplitterProportionKey(getClass().getName() + "ModelTreeSplitter");
    myTree = new ModelDifferenceDialog.ModelDifferenceTree();
    myPanel.setFirstComponent(ScrollPaneFactory.createScrollPane(myTree));
    myPanel.setSecondComponent(myNoRootPanel);

    myGoToNeighbourRootActions = new ModelDifferenceDialog.MyGoToNeighbourRootActions();
    myGoToNeighbourRootActions.previous().registerCustomShortcutSet(GoToNeighbourRootActions.PREV_ROOT_SHORTCUT, myComponent);
    myGoToNeighbourRootActions.next().registerCustomShortcutSet(GoToNeighbourRootActions.NEXT_ROOT_SHORTCUT, myComponent);

    myToolbar = ActionManager.getInstance().createActionToolbar(ActionPlaces.UNKNOWN, myActionGroup, true);
    myToolbar.updateActionsImmediately();

    myComponent.add(myToolbar.getComponent(), BorderLayout.NORTH);
    myComponent.add(myPanel, BorderLayout.CENTER);
    myComponent.add(myStatusBar, BorderLayout.SOUTH);

    Dimension size = DimensionService.getInstance().getSize(getDimensionServiceKey());
    if (size == null) {
      myComponent.setPreferredSize(new Dimension(500, 700));
    }

    return myComponent;
  }



  @NotNull
  @Override
  protected Action[] createActions() {
    return new Action[0];
  }

  @Override
  public String getDimensionServiceKey() {
    return getClass().getName();
  }

  @Nullable
  @Override
  public JComponent getPreferredFocusedComponent() {
    return (myTree.isShowing() ?
      myTree :
      super.getPreferredFocusedComponent()
    );
  }

  @Nullable
  @Override
  protected JComponent createSouthPanel() {
    return null;
  }

  @Override
  protected void dispose() {
    if (myRootDifferencePane != null) {
      myRootDifferencePane.dispose();
    }
    super.dispose();
  }



  /*package*/ void rebuildChangeSets() {
    ChangeSetBuilder.rebuildChangeSet(myChangeSet);
    ChangeSetBuilder.rebuildChangeSet(myMetadataChangeSet);
    myTree.rebuildLater();
  }

  public boolean isEditable() {
    return myEditable;
  }

  private void syncMetadataChanges() {
    if (myEditable) {
      ModelAccess.instance().runWriteActionInCommand(new Runnable() {
        public void run() {
          MetadataUtil.applyMetadataChanges(myChangeSet.getNewModel(), myMetadataChangeSet.getNewModel());
        }
      });
    }
  }

  public void resetCurrentRoot() {
    if (myRootDifferencePane == null) {
      return;
    }

    myRootDifferencePane.unregisterShortcuts(myComponent);
    myPanel.setSecondComponent(myNoRootPanel);
    myRootDifferencePane.dispose();
    myRootDifferencePane = null;
    myRootId = null;
    myStatusBar.setText("");
    syncMetadataChanges();
  }

  private void changeCurrentRoot(@Nullable final SNodeId rootId) {
    if (myRootDifferencePane != null && myRootId == rootId) {
      return;
    }
    syncMetadataChanges();

    myRootId = rootId;
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        ModelChangeSet changeSet = (rootId == null ?
          myMetadataChangeSet :
          myChangeSet
        );
        SNodeId nodeId = (rootId == null ?
          ListSequence.fromList(SModelOperations.getRoots(myMetadataChangeSet.getOldModel(), null)).first().getNodeId() :
          rootId
        );
        if (myRootDifferencePane == null) {
          myRootDifferencePane = new RootDifferencePane(myProject, changeSet, nodeId, myTree.getNameForRoot(rootId), myContentTitles, myEditable, myStatusBar);
          DefaultActionGroup actionGroup = new DefaultActionGroup();
          actionGroup.addAll(myRootDifferencePane.getActions());
          ActionToolbar toolbar = ActionManager.getInstance().createActionToolbar(ActionPlaces.UNKNOWN, actionGroup, true);
          myRootDifferencePane.registerShortcuts(myComponent);
          JPanel panel = new JPanel(new BorderLayout());
          panel.add(toolbar.getComponent(), BorderLayout.NORTH);
          panel.add(myRootDifferencePane.getPanel(), BorderLayout.CENTER);
          myPanel.setSecondComponent(panel);
          myRootDifferencePane.navigateInitial(null);
        } else {
          myRootDifferencePane.setRootId(nodeId, changeSet);
        }
      }
    });
  }

  public void setCurrentRoot(@Nullable SNodeId rootId) {
    myTree.setSelected(rootId);
    changeCurrentRoot(rootId);
  }

  @Nullable
  public SNodeId getCurrentRoot() {
    return myRootId;
  }



  private void closeTreeComponent() {
    myActionGroup.unregisterCustomShortcutSet(myComponent);
    myGoToNeighbourRootActions.previous().unregisterCustomShortcutSet(myComponent);
    myGoToNeighbourRootActions.next().unregisterCustomShortcutSet(myComponent);
    myPanel.setFirstComponent(null);
    myComponent.remove(myToolbar.getComponent());
  }

  public static void showRootDifference(Project project, final SModel oldModel, final SModel newModel, final SNodeId rootId, String oldTitle, String newTitile, @Nullable final Bounds scrollTo, DiffRequest diffRequest) {
    final ModelDifferenceDialog dialog = new ModelDifferenceDialog(project, oldModel, newModel, oldTitle, newTitile, diffRequest);
    dialog.setCurrentRoot(rootId);
    dialog.closeTreeComponent();
    if (rootId == null) {
      dialog.setTitle("Metadata difference for model");
    } else {
      ModelAccess.instance().runReadAction(new Runnable() {
        public void run() {
          SNode node = newModel.getNode(rootId);
          if (node == null) {
            node = oldModel.getNode(rootId);
          }
          String rootName = (node == null ?
            "root" :
            node.getPresentation()
          );
          dialog.setTitle("Difference for " + rootName);
          dialog.myRootDifferencePane.navigateInitial(scrollTo);
        }
      });
    }
    dialog.show();
  }



  @Nullable
  public Object getData(@NonNls String dataId) {
    if (DiffModelTree.NODE_ID_DATAKEY.is(dataId)) {
      return new Ref<SNodeId>(myRootId);
    }
    return null;
  }



  public class MyGoToNeighbourRootActions extends GoToNeighbourRootActions.GoToByTree {
    public MyGoToNeighbourRootActions() {
      super(myTree);
    }

    @Nullable
    @Override
    protected SNodeId getCurrentNodeId() {
      return getCurrentRoot();
    }

    @Override
    public void setCurrentNodeId(@Nullable SNodeId nodeId) {
      changeCurrentRoot(nodeId);
    }
  }



  private class ModelDifferenceTree extends DiffModelTree {
    private ModelDifferenceTree() {
    }

    @Override
    protected Iterable<BaseAction> getRootActions() {
      List<BaseAction> actions = ListSequence.fromList(new ArrayList<BaseAction>());

      if (myEditable) {
        ListSequence.fromList(actions).addElement(new RevertRootsAction("roots") {
          @Override
          protected Iterable<ModelChange> getChanges() {
            return Sequence.fromIterable(Sequence.fromArray(getSelectedNodes(DiffModelTree.RootTreeNode.class, null))).translate(new ITranslator2<DiffModelTree.RootTreeNode, ModelChange>() {
              public Iterable<ModelChange> translate(DiffModelTree.RootTreeNode r) {
                return myChangeSet.getChangesForRoot(r.getRootId());
              }
            });
          }

          @Override
          protected void after() {
            rebuildChangeSets();
          }

          @Override
          protected String getRevertTitle() {
            Iterable<SNodeId> roots = Sequence.fromIterable(Sequence.fromArray(getSelectedNodes(DiffModelTree.RootTreeNode.class, null))).select(new ISelector<DiffModelTree.RootTreeNode, SNodeId>() {
              public SNodeId select(DiffModelTree.RootTreeNode rtn) {
                return rtn.getRootId();
              }
            });
            if ((int) Sequence.fromIterable(roots).count() == 1) {
              return (Sequence.fromIterable(roots).first() == null ?
                "Properties" :
                "Root"
              );
            } else if (Sequence.fromIterable(roots).any(new IWhereFilter<SNodeId>() {
              public boolean accept(SNodeId r) {
                return r == null;
              }
            })) {
              return "Roots and Properties ";
            }
            return "Roots";
          }
        });
      }
      return actions;
    }

    @Override
    protected void updateRootCustomPresentation(@NotNull DiffModelTree.RootTreeNode rootTreeNode) {
      ChangeType compositeChangeType = ChangeType.CHANGE;
      if (rootTreeNode.getRootId() != null) {
        ModelChange firstChange = Sequence.fromIterable(myChangeSet.getChangesForRoot(rootTreeNode.getRootId())).first();
        if (firstChange instanceof AddRootChange || firstChange instanceof DeleteRootChange) {
          compositeChangeType = firstChange.getType();
        } else if (firstChange == null) {
          compositeChangeType = null;
        }
      } else {
        if (myMetadataChangeSet == null || ListSequence.fromList(myMetadataChangeSet.getModelChanges()).isEmpty()) {
          compositeChangeType = null;
        }
      }
      rootTreeNode.setColor((compositeChangeType == null ?
        null :
        ChangeColors.getForTree(compositeChangeType)
      ));
    }

    @Override
    protected Iterable<SModel> getModels() {
      return Arrays.asList(myChangeSet.getNewModel(), myChangeSet.getOldModel());
    }

    @Override
    protected Iterable<SNodeId> getAffectedRoots() {
      return myChangeSet.getAffectedRoots();
    }

    @Override
    protected void onUnselect() {
      resetCurrentRoot();
    }

    @Override
    protected void onSelectRoot(@Nullable SNodeId rootId) {
      changeCurrentRoot(rootId);
    }
  }

  public static boolean isEmpty_vk52pz_a0b0a0a0a0g0v(String str) {
    return str == null || str.length() == 0;
  }
}
