package jetbrains.mps.vcs.diff.ui;

/*Generated by MPS */

import com.intellij.openapi.ui.DialogWrapper;
import com.intellij.openapi.project.Project;
import jetbrains.mps.vcs.diff.ModelChangeSet;
import javax.swing.JPanel;
import java.awt.BorderLayout;
import jetbrains.mps.smodel.SModel;
import com.intellij.openapi.diff.DiffRequest;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.vcs.diff.ui.common.DiffTemporaryModule;
import jetbrains.mps.smodel.descriptor.EditableSModelDescriptor;
import jetbrains.mps.smodel.SModelRepository;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.vcs.diff.ChangeSetBuilder;
import jetbrains.mps.internal.collections.runtime.Sequence;
import com.intellij.openapi.actionSystem.DefaultActionGroup;
import jetbrains.mps.workbench.action.ActionUtils;
import jetbrains.mps.vcs.diff.ui.common.InvokeTextDiffAction;
import com.intellij.openapi.diff.DiffManager;
import com.intellij.openapi.actionSystem.ActionToolbar;
import com.intellij.openapi.actionSystem.ActionManager;
import com.intellij.openapi.actionSystem.ActionPlaces;
import com.intellij.ui.ScrollPaneFactory;
import java.awt.Dimension;
import com.intellij.openapi.util.DimensionService;
import jetbrains.mps.vcs.diff.ui.common.SimpleDiffRequest;
import org.jetbrains.annotations.Nullable;
import javax.swing.JComponent;
import javax.swing.Action;
import jetbrains.mps.vcs.diff.ChangeSet;
import jetbrains.mps.smodel.SNodeId;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.vcs.diff.ui.common.Bounds;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import com.intellij.openapi.wm.WindowManager;
import jetbrains.mps.vcs.diff.changes.ModelChange;
import jetbrains.mps.smodel.SModelDescriptor;
import jetbrains.mps.vcs.diff.ui.common.GoToNeighbourRootActions;
import jetbrains.mps.vcs.diff.ui.common.DiffModelTree;
import jetbrains.mps.workbench.action.BaseAction;
import java.util.List;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.ITranslator2;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.vcs.diff.changes.ChangeType;
import jetbrains.mps.vcs.diff.changes.AddRootChange;
import jetbrains.mps.vcs.diff.changes.DeleteRootChange;
import jetbrains.mps.vcs.diff.ui.common.ChangeColors;
import java.util.Arrays;

public class ModelDifferenceDialog extends DialogWrapper {
  private Project myProject;
  private ModelChangeSet myChangeSet;
  private ModelChangeSet myMetadataChangeSet;
  private ModelDifferenceDialog.ModelDifferenceTree myTree;
  private JPanel myPanel = new JPanel(new BorderLayout());
  private RootDifferenceDialog myRootDifferenceDialog = null;
  private boolean myGoingToNeighbour = false;
  private String[] myContentTitles;
  private boolean myEditable;

  public ModelDifferenceDialog(final SModel oldModel, final SModel newModel, DiffRequest diffRequest) {
    super(diffRequest.getProject());
    myProject = diffRequest.getProject();
    final jetbrains.mps.project.Project p = ProjectHelper.toMPSProject(myProject);
    DiffTemporaryModule.createModuleForModel(oldModel, "old", p);
    DiffTemporaryModule.createModuleForModel(newModel, "new", p);
    myContentTitles = diffRequest.getContentTitles();
    assert myContentTitles.length == 2;
    myEditable = newModel.getModelDescriptor() instanceof EditableSModelDescriptor && check_vk52pz_a0a0h0a(SModelRepository.getInstance().getModelDescriptor(newModel.getSModelReference())) == newModel;
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        setTitle("Difference for model: " + SModelOperations.getModelName(oldModel));
        myChangeSet = ChangeSetBuilder.buildChangeSet(oldModel, newModel, true);
        if (Sequence.fromIterable(myChangeSet.getChangesForRoot(null)).isNotEmpty()) {
          SModel oldMetaModel = MetadataUtil.createMetadataModel(oldModel);
          SModel newMetaModel = MetadataUtil.createMetadataModel(newModel);
          DiffTemporaryModule.createModuleForModel(oldMetaModel, "old", p);
          DiffTemporaryModule.createModuleForModel(newMetaModel, "new", p, true);
          myMetadataChangeSet = ChangeSetBuilder.buildChangeSet(oldMetaModel, newMetaModel, true);
        }
      }
    });

    myTree = new ModelDifferenceDialog.ModelDifferenceTree();

    DefaultActionGroup actionGroup = ActionUtils.groupFromActions(new InvokeTextDiffAction("View as Text", "View model difference using as text difference of XML contents", this, diffRequest, DiffManager.getInstance().getIdeaDiffTool()));
    ActionToolbar toolbar = ActionManager.getInstance().createActionToolbar(ActionPlaces.UNKNOWN, actionGroup, true);
    toolbar.updateActionsImmediately();
    myPanel.add(toolbar.getComponent(), BorderLayout.NORTH);
    myPanel.add(ScrollPaneFactory.createScrollPane(myTree), BorderLayout.CENTER);
    Dimension size = DimensionService.getInstance().getSize(getDimensionServiceKey());
    if (size == null) {
      myPanel.setPreferredSize(new Dimension(500, 700));
    }

    init();
  }

  public ModelDifferenceDialog(SModel oldModel, SModel newModel, Project project, String oldTitle, String newTitle) {
    this(oldModel, newModel, new SimpleDiffRequest(project, new SModel[]{oldModel, newModel}, new String[]{oldTitle, newTitle}));
  }

  @Nullable
  protected JComponent createCenterPanel() {
    return myPanel;
  }

  protected Action[] createActions() {
    return new Action[0];
  }

  public String getDimensionServiceKey() {
    return getClass().getName();
  }

  /*package*/ void rebuildChangeSets() {
    ChangeSetBuilder.rebuildChangeSet(myChangeSet);
    if (myMetadataChangeSet != null) {
      ChangeSetBuilder.rebuildChangeSet(myMetadataChangeSet);
    }
    myTree.rebuildLater();
  }

  public ChangeSet getChangeSet() {
    return myChangeSet;
  }

  public String[] getContentTitles() {
    return myContentTitles;
  }

  /*package*/ Project getProject() {
    return myProject;
  }

  public boolean isEditable() {
    return myEditable;
  }

  @Nullable
  public SNodeId getNeighbourRoot(@NotNull SNodeId rootId, boolean next) {
    return myTree.getNeighbourRoot(rootId, next);
  }

  /*package*/ void startGoingToNeighbour() {
    myGoingToNeighbour = true;
  }

  public void invokeRootDifference(SNodeId rootId) {
    invokeRootDifference(rootId, null);
  }

  public void invokeRootDifference(final SNodeId rootId, @Nullable final Bounds scrollTo) {
    if (myRootDifferenceDialog != null) {
      return;
    }

    myGoingToNeighbour = false;
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        ModelChangeSet changeSet = (rootId == null ?
          myMetadataChangeSet :
          myChangeSet
        );
        SNodeId nodeId = (rootId == null ?
          ListSequence.fromList(SModelOperations.getRoots(myMetadataChangeSet.getOldModel(), null)).first().getSNodeId() :
          rootId
        );
        String rootName = (rootId == null ?
          "Model Properties" :
          myTree.getNameForRoot(rootId)
        );

        myRootDifferenceDialog = new RootDifferenceDialog(myProject, changeSet, nodeId, rootName, myContentTitles, (isVisible() ?
          getWindow() :
          WindowManager.getInstance().getFrame(myProject)
        ), myEditable, new ModelDifferenceDialog.MyGoToNeighbourRootActions().getActions(), scrollTo);
      }
    });
    myRootDifferenceDialog.show();
    if (rootId == null && myEditable) {
      ModelAccess.instance().runWriteActionInCommand(new Runnable() {
        public void run() {
          MetadataUtil.applyMetadataChanges(myChangeSet.getNewModel(), myMetadataChangeSet.getNewModel());
        }
      });
    }
    myRootDifferenceDialog = null;
    if (!(myGoingToNeighbour) && !(isVisible())) {
      close(NEXT_USER_EXIT_CODE);
      return;
    }
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        rebuildChangeSets();
      }
    });
  }

  /*package*/ void rootDialogClosed() {
    myRootDifferenceDialog = null;
    if (!(myGoingToNeighbour) && !(isVisible())) {
      close(DialogWrapper.NEXT_USER_EXIT_CODE);
    } else {
      rebuildChangeSets();
    }
  }

  public Iterable<ModelChange> getChangesForRoot(SNodeId rootId) {
    return myChangeSet.getChangesForRoot(rootId);
  }

  public Iterable<ModelChange> getMetadataChanges() {
    return myChangeSet.getChangesForRoot(null);
  }

  private static SModel check_vk52pz_a0a0h0a(SModelDescriptor checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getSModel();
    }
    return null;
  }

  public class MyGoToNeighbourRootActions extends GoToNeighbourRootActions {
    public MyGoToNeighbourRootActions() {
    }

    protected void goTo(@NotNull final SNodeId rootId) {
      // <node> 
      // <node> 
      // <node> 
      ModelAccess.instance().runReadAction(new Runnable() {
        public void run() {
          myRootDifferenceDialog.setRootId(rootId);
        }
      });
    }

    @Nullable
    protected SNodeId getNeighbourId(boolean next) {
      return (myRootDifferenceDialog == null ?
        null :
        getNeighbourRoot(myRootDifferenceDialog.getRootId(), next)
      );
    }
  }

  private class ModelDifferenceTree extends DiffModelTree {
    private ModelDifferenceTree() {
      super(DiffTemporaryModule.getOperationContext(myProject, myChangeSet.getNewModel()));
    }

    protected Iterable<BaseAction> getRootActions() {
      List<BaseAction> actions = ListSequence.fromList(new ArrayList<BaseAction>());

      ListSequence.fromList(actions).addElement(new InvokeRootDifferenceAction(ModelDifferenceDialog.this));

      if (myEditable) {
        ListSequence.fromList(actions).addElement(new RevertRootsAction("roots") {
          protected Iterable<ModelChange> getChanges() {
            return Sequence.fromIterable(Sequence.fromArray(getSelectedNodes(DiffModelTree.RootTreeNode.class, null))).translate(new ITranslator2<DiffModelTree.RootTreeNode, ModelChange>() {
              public Iterable<ModelChange> translate(DiffModelTree.RootTreeNode r) {
                return (r.getRootId() == null ?
                  getMetadataChanges() :
                  getChangesForRoot(r.getRootId())
                );
              }
            });
          }

          protected void after() {
            ModelDifferenceDialog.this.rebuildChangeSets();
          }

          @Override
          protected String getRevertTitle() {
            Iterable<SNodeId> roots = Sequence.fromIterable(Sequence.fromArray(getSelectedNodes(DiffModelTree.RootTreeNode.class, null))).select(new ISelector<DiffModelTree.RootTreeNode, SNodeId>() {
              public SNodeId select(DiffModelTree.RootTreeNode rtn) {
                return rtn.getRootId();
              }
            });
            if ((int) Sequence.fromIterable(roots).count() == 1) {
              return (Sequence.fromIterable(roots).first() == null ?
                "Properties" :
                "Root"
              );
            } else if (Sequence.fromIterable(roots).any(new IWhereFilter<SNodeId>() {
              public boolean accept(SNodeId r) {
                return r == null;
              }
            })) {
              return "Roots and Properties ";
            }
            return "Roots";
          }
        });
      }
      return actions;
    }

    protected void updateRootCustomPresentation(@NotNull DiffModelTree.RootTreeNode rootTreeNode) {
      ChangeType compositeChangeType = ChangeType.CHANGE;
      if (rootTreeNode.getRootId() != null) {
        ModelChange firstChange = Sequence.fromIterable(myChangeSet.getChangesForRoot(rootTreeNode.getRootId())).first();
        if (firstChange instanceof AddRootChange || firstChange instanceof DeleteRootChange) {
          compositeChangeType = firstChange.getType();
        }
      }
      rootTreeNode.setColor(ChangeColors.getForTree(compositeChangeType));
    }

    protected Iterable<SModel> getModels() {
      return Arrays.asList(myChangeSet.getNewModel(), myChangeSet.getOldModel());
    }

    protected Iterable<SNodeId> getAffectedRoots() {
      return myChangeSet.getAffectedRoots();
    }
  }
}
