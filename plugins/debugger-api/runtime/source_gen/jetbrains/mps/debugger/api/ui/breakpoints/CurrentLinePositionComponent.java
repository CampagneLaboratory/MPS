package jetbrains.mps.debugger.api.ui.breakpoints;

/*Generated by MPS */

import jetbrains.mps.debugger.core.CurrentLinePositionComponentEx;
import jetbrains.mps.debug.api.AbstractDebugSession;
import com.intellij.openapi.components.ProjectComponent;
import jetbrains.mps.debug.api.SessionChangeListener;
import jetbrains.mps.debug.api.DebugSessionManagerComponent;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.fileEditor.FileEditorManager;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import jetbrains.mps.debug.api.programState.IStackFrame;
import jetbrains.mps.debug.api.programState.ILocation;
import jetbrains.mps.debug.api.programState.NullLocation;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.generator.traceInfo.TraceInfoUtil;
import jetbrains.mps.debug.api.SessionChangeAdapter;

public class CurrentLinePositionComponent extends CurrentLinePositionComponentEx<AbstractDebugSession> implements ProjectComponent {
  private final SessionChangeListener myChangeListener = new CurrentLinePositionComponent.MySessionChangeListener();
  private final DebugSessionManagerComponent.DebugSessionListener myCurrentDebugSessionListener = new CurrentLinePositionComponent.MyCurrentDebugSessionListener();

  public CurrentLinePositionComponent(Project project, FileEditorManager fileEditorManager) {
    super(project, fileEditorManager);
  }

  @Override
  public void projectOpened() {
  }

  @Override
  public void projectClosed() {
  }

  @NotNull
  @Override
  public String getComponentName() {
    return "Current Line Position Project Component";
  }

  @Override
  public void initComponent() {
    super.init();
    DebugSessionManagerComponent component = myProject.getComponent(DebugSessionManagerComponent.class);
    component.addDebugSessionListener(myCurrentDebugSessionListener);
  }

  @Override
  public void disposeComponent() {
    DebugSessionManagerComponent component = myProject.getComponent(DebugSessionManagerComponent.class);
    component.removeDebugSessionListener(myCurrentDebugSessionListener);
    super.dispose();
  }

  protected AbstractDebugSession getCurrentSession() {
    return myProject.getComponent(DebugSessionManagerComponent.class).getDebugSessionByCurrentTab();
  }

  protected Tuples._3<String, String, Integer> getPosition(AbstractDebugSession session) {
    IStackFrame stackFrame = session.getUiState().getStackFrame();
    if (stackFrame != null) {
      ILocation location = stackFrame.getLocation();
      if (location != null && !((location instanceof NullLocation))) {
        String unitName = location.getUnitName();
        String fileName = location.getFileName();
        int lineNumber = location.getLineNumber();
        return MultiTuple.<String,String,Integer>from(unitName, fileName, lineNumber);
      }
    }
    return null;
  }

  public SNode getNode(AbstractDebugSession session) {
    Tuples._3<String, String, Integer> position = getPosition(session);
    if (position == null) {
      return null;
    }

    String unitName = position._0();
    String fileName = position._1();
    int lineNumber = (int) position._2();

    // todo broken here: need to use language specific method 
    return TraceInfoUtil.getNode(unitName, fileName, lineNumber);
  }

  private class MyCurrentDebugSessionListener implements DebugSessionManagerComponent.DebugSessionListener {
    private MyCurrentDebugSessionListener() {
    }

    @Override
    public void registered(AbstractDebugSession session) {
      session.addChangeListener(myChangeListener);
    }

    @Override
    public void currentSessionChanged(AbstractDebugSession newDebugSession) {
      CurrentLinePositionComponent.this.currentSessionChanged(newDebugSession);
    }

    @Override
    public void detached(AbstractDebugSession newDebugSession) {
      detachPainter(newDebugSession);
      newDebugSession.removeChangeListener(myChangeListener);
    }
  }

  private class MySessionChangeListener extends SessionChangeAdapter {
    private MySessionChangeListener() {
    }

    @Override
    public void stateChanged(AbstractDebugSession session) {
      reAttachPainter(session);
    }

    @Override
    public void paused(AbstractDebugSession debugSession) {
      reAttachPainter(debugSession);
    }

    @Override
    public void resumed(AbstractDebugSession debugSession) {
      detachPainter(debugSession);
    }
  }
}
