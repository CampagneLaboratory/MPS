package jetbrains.mps.debug.api;

/*Generated by MPS */

import org.jetbrains.annotations.Nullable;
import jetbrains.mps.debug.api.programState.IThread;
import org.jetbrains.annotations.NotNull;
import java.util.List;
import jetbrains.mps.debug.api.programState.IStackFrame;
import jetbrains.mps.util.annotation.ToRemove;
import java.util.Collections;
import java.util.Map;
import jetbrains.mps.debug.api.programState.IWatchable;
import jetbrains.mps.debug.api.programState.IValue;

public abstract class AbstractUiState {
  protected static final int NO_FRAME = -1;

  protected final AbstractDebugSession myAbstractDebugSession;

  protected AbstractUiState(AbstractDebugSession session) {
    myAbstractDebugSession = session;
  }

  @Nullable
  public abstract IThread getThread();

  @NotNull
  public abstract List<? extends IThread> getThreads();

  @Nullable
  public abstract IStackFrame getStackFrame();

  public abstract boolean isPausedOnBreakpoint();

  @Deprecated
  @ToRemove(version = 2.5)
  protected IThread findThread() {
    return null;
  }

  protected abstract AbstractUiState selectThreadInternal(@Nullable IThread thread);

  protected abstract AbstractUiState selectFrameInternal(int frame);

  protected int findStackFrameIndex() {
    // impl 
    IThread thread = getThread();
    if (thread == null) {
      return NO_FRAME;
    }
    if (thread.getFramesCount() > 0) {
      return myAbstractDebugSession.getDebuggableFramesSelector().findDeepestDebuggableFrameIndex(thread.getFrames());
    }
    return NO_FRAME;
  }

  public void selectThread(@Nullable IThread thread) {
    AbstractUiState newState = selectThreadInternal(thread);
    if (newState != this) {
      myAbstractDebugSession.trySetState(this, newState);
    }
  }

  public void selectFrame(int frame) {
    AbstractUiState newState = selectFrameInternal(frame);
    if (newState != this) {
      myAbstractDebugSession.trySetState(this, newState);
    }
  }

  @NotNull
  public List<IStackFrame> getStackFrames() {
    IThread thread = getThread();
    if (thread != null) {
      return thread.getFrames();
    }
    return Collections.emptyList();
  }

  public int getStackFramesCount() {
    IThread thread = getThread();
    if (thread != null) {
      return thread.getFramesCount();
    }
    return 0;
  }

  @Nullable
  public IStackFrame getStackFrame(int index) {
    assert index >= 0;
    List<IStackFrame> frames = getStackFrames();
    if (index >= frames.size()) {
      return null;
    }
    return frames.get(index);
  }

  @NotNull
  @Deprecated
  @ToRemove(version = 2.5)
  public Map<IWatchable, IValue> getWatchableValues() {
    IStackFrame stackFrame = getStackFrame();
    if (stackFrame != null) {
      return stackFrame.getWatchableValues();
    }
    return Collections.emptyMap();
  }

  @NotNull
  public List<IWatchable> getWatchables() {
    IStackFrame stackFrame = getStackFrame();
    if (stackFrame != null) {
      return stackFrame.getVisibleWatchables();
    }
    return Collections.emptyList();
  }

  @Nullable
  @Deprecated
  @ToRemove(version = 2.5)
  public IValue getVariableValue(IWatchable variable) {
    IStackFrame stackFrame = getStackFrame();
    if (stackFrame != null) {
      return stackFrame.getValue(variable);
    }
    return null;
  }

  @Nullable
  @Deprecated
  @ToRemove(version = 2.5)
  public String getSourceFileName() {
    IStackFrame stackFrame = getStackFrame();
    if (stackFrame == null) {
      return null;
    }
    return stackFrame.getLocation().getFileName();
  }

  @Deprecated
  @ToRemove(version = 2.5)
  public int getPosition() {
    IStackFrame stackFrame = getStackFrame();
    if (stackFrame == null) {
      return 0;
    }
    return stackFrame.getLocation().getLineNumber();
  }
}
