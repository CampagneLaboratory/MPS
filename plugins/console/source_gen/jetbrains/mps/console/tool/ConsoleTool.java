package jetbrains.mps.console.tool;

/*Generated by MPS */

import com.intellij.openapi.components.State;
import com.intellij.openapi.components.Storage;
import com.intellij.openapi.components.StoragePathMacros;
import jetbrains.mps.ide.tools.BaseTabbedProjectTool;
import com.intellij.openapi.components.PersistentStateComponent;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import com.intellij.openapi.project.Project;
import jetbrains.mps.icons.MPSIcons;
import com.intellij.openapi.wm.ToolWindowAnchor;
import org.jetbrains.annotations.Nullable;
import javax.swing.Icon;
import jetbrains.mps.plugins.tool.IComponentDisposer;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.smodel.behaviour.BehaviorReflection;
import com.intellij.ui.content.Content;

@State(name = "ConsoleHistory", storages = @Storage(file = StoragePathMacros.WORKSPACE_FILE)
)
public class ConsoleTool extends BaseTabbedProjectTool implements PersistentStateComponent<ConsoleTool.MyState> {

  private ConsoleTool.MyState loadedState;
  private List<BaseConsoleTab> myTabs = ListSequence.fromList(new ArrayList<BaseConsoleTab>());


  public ConsoleTool(Project project) {
    super(project, "Console", -1, MPSIcons.ToolWindows.OpenTerminal_13x13, ToolWindowAnchor.BOTTOM, true);
  }



  public Project getProject() {
    return super.getProject();
  }



  @Override
  protected boolean isInitiallyAvailable() {
    return true;
  }


  private boolean pasteAsRef = true;


  public boolean getPasteAsRef() {
    return pasteAsRef;
  }



  public void runWithoutPasteAsRef(Runnable toRun) {
    pasteAsRef = false;
    toRun.run();
    pasteAsRef = true;
  }



  private BaseConsoleTab addConsoleTab(@Nullable ConsoleTool.TabState tabState, @Nullable Icon icon) {
    String title = check_xg3v07_a0a0q(tabState);
    String history = check_xg3v07_a0b0q(tabState);
    if (icon == null) {
      icon = MPSIcons.ToolWindows.OpenTerminal_13x13;
    }
    if (title == null) {
      title = "Console";
    }
    BaseConsoleTab tab;
    if (check_xg3v07_a5a61(tabState)) {
      tab = new HistoryConsoleTab(this, title, history);
    } else {
      tab = new ConsoleTab(this, title, history);
    }
    ListSequence.fromList(myTabs).addElement(tab);
    addTab(tab, title, icon, new IComponentDisposer<BaseConsoleTab>() {
      public void disposeComponent(BaseConsoleTab ct) {
        ListSequence.fromList(myTabs).removeElement(ct);
        ct.disposeConsoleTab();
      }
    });
    return tab;
  }



  @Override
  protected void doRegister() {
    super.doRegister();
    initTabs();
  }



  private void initTabs() {
    if (loadedState != null) {
      for (ConsoleTool.TabState tabState : ListSequence.fromList(loadedState.tabs)) {
        BaseConsoleTab tab = addConsoleTab(tabState, null);
        getContentManager().getContent(tab).setPinned(true);
      }
    }
    if (ListSequence.fromList(myTabs).count() == 0) {
      BaseConsoleTab tab = addConsoleTab(null, null);
      getContentManager().getContent(tab).setPinned(true);
    }
    check_xg3v07_a2a02(getContentManager().getContent(0), this);
  }



  public static class TabState {
    public String title;
    public boolean isHistoryTab;
    public String history;
  }



  public static class MyState {
    public ArrayList<ConsoleTool.TabState> tabs = new ArrayList<ConsoleTool.TabState>();
  }



  public void loadState(ConsoleTool.MyState state) {
    loadedState = state;
  }



  public void executeCommand(final SNode command) {
    final ConsoleTool.TabState tabState = new ConsoleTool.TabState();
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        tabState.title = BehaviorReflection.invokeVirtual(String.class, command, "virtual_getPresentation_1213877396640", new Object[]{});
      }
    });
    tabState.isHistoryTab = true;
    final BaseConsoleTab tab = addConsoleTab(tabState, null);
    ModelAccess.instance().runWriteActionInCommand(new Runnable() {
      public void run() {
        tab.execute(command, null, null);
      }
    });
  }



  public ConsoleTab getCurrentEditableTab() {
    if (ListSequence.fromList(myTabs).getElement(this.getCurrentTabIndex()) instanceof ConsoleTab) {
      return as_xg3v07_a0a0a0eb(ListSequence.fromList(myTabs).getElement(this.getCurrentTabIndex()), ConsoleTab.class);
    }
    return as_xg3v07_a0b0eb(ListSequence.fromList(myTabs).getElement(0), ConsoleTab.class);
  }



  @Nullable
  public ConsoleTool.MyState getState() {
    ConsoleTool.MyState result = new ConsoleTool.MyState();
    for (BaseConsoleTab tab : ListSequence.fromList(myTabs)) {
      if (!(getContentManager().getContent(tab).isPinned())) {
        break;
      }
      ConsoleTool.TabState tabState = new ConsoleTool.TabState();
      tabState.history = tab.saveHistory();
      tabState.title = tab.getTitle();
      tabState.isHistoryTab = !(tab instanceof ConsoleTab);
      if (tabState.history == null || tabState.title == null) {
        break;
      }
      result.tabs.add(tabState);
    }
    return result;
  }



  private static String check_xg3v07_a0a0q(ConsoleTool.TabState checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.title;
    }
    return null;
  }

  private static String check_xg3v07_a0b0q(ConsoleTool.TabState checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.history;
    }
    return null;
  }

  private static boolean check_xg3v07_a5a61(ConsoleTool.TabState checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.isHistoryTab;
    }
    return false;
  }

  private static void check_xg3v07_a2a02(Content checkedDotOperand, ConsoleTool checkedDotThisExpression) {
    if (null != checkedDotOperand) {
      checkedDotOperand.setCloseable(false);
    }

  }

  private static <T> T as_xg3v07_a0a0a0eb(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }

  private static <T> T as_xg3v07_a0b0eb(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
