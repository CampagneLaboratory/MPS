package jetbrains.mps.build.util;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import java.util.UUID;
import jetbrains.mps.generator.TransientModelsModule;
import jetbrains.mps.build.behavior.BuildSource_JavaLibrary_Behavior;
import java.util.List;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.internal.collections.runtime.IVisitor;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import org.jetbrains.annotations.Nullable;

public class JavaExportUtil {
  public JavaExportUtil() {
  }
  public static void requireLibrary(final VisibleArtifacts artifacts, SNode library, SNode contextNode, final RequiredDependenciesBuilder builder) {
    if (SNodeOperations.getContainingRoot(library) == SNodeOperations.getContainingRoot(contextNode)) {
      return;
    }


    SNode target = SNodeOperations.as(artifacts.toOriginalNode(library), MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 6057319140845467763l, "jetbrains.mps.build.structure.BuildSource_JavaLibrary"));
    if (target == null || SNodeOperations.getModel(target).getModule() instanceof TransientModelsModule) {
      // problem with transient models, already reported 
      return;
    }

    if (BuildSource_JavaLibrary_Behavior.call_canExportByParts_5610619299014309362(target)) {
      List<Tuples._2<SNode, Boolean>> result = ListSequence.fromList(new ArrayList<Tuples._2<SNode, Boolean>>());

      for (SNode element : ListSequence.fromList(SLinkOperations.getChildren(target, MetaAdapterFactory.getContainmentLink(new UUID(8755280088213897754l, -5075149991798053422l), 6057319140845467763l, 6057319140845478673l, "elements")))) {
        SNode jcp = SNodeOperations.as(element, MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 3717132724152913083l, "jetbrains.mps.build.structure.BuildSource_JavaLibraryCP"));
        if ((jcp == null)) {
          return;
        }
        SNode classpath = SLinkOperations.getTarget(jcp, MetaAdapterFactory.getContainmentLink(new UUID(8755280088213897754l, -5075149991798053422l), 3717132724152913083l, 3717132724152913085l, "classpath"));
        if (SNodeOperations.isInstanceOf(classpath, MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 1258644073388922138l, "jetbrains.mps.build.structure.BuildSource_JavaJar"))) {
          Tuples._2<SNode, String> resource = artifacts.getResource(SLinkOperations.getTarget(SNodeOperations.cast(classpath, MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 1258644073388922138l, "jetbrains.mps.build.structure.BuildSource_JavaJar")), MetaAdapterFactory.getContainmentLink(new UUID(8755280088213897754l, -5075149991798053422l), 1258644073388922138l, 3717132724152837090l, "path")));
          SNode jarArtifact = SNodeOperations.as(resource._0(), MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 7389400916848036997l, "jetbrains.mps.build.structure.BuildLayout_Node"));
          if (jarArtifact != null) {
            ListSequence.fromList(result).addElement(MultiTuple.<SNode,Boolean>from(jarArtifact, isNotEmptyString(resource._1())));
          }
        } else if (SNodeOperations.isInstanceOf(classpath, MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 5610619299014446503l, "jetbrains.mps.build.structure.BuildSource_JavaLibraryExternalJar"))) {
          Tuples._2<SNode, Boolean> requiredJar = requireJar(artifacts, SLinkOperations.getTarget(SLinkOperations.getTarget(SNodeOperations.cast(classpath, MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 5610619299014446503l, "jetbrains.mps.build.structure.BuildSource_JavaLibraryExternalJar")), MetaAdapterFactory.getContainmentLink(new UUID(8755280088213897754l, -5075149991798053422l), 5610619299014446503l, 5610619299014446504l, "extJar")), MetaAdapterFactory.getReferenceLink(new UUID(8755280088213897754l, -5075149991798053422l), 5610619299014309452l, 5610619299014309453l, "jar")), contextNode);
          if (requiredJar != null) {
            ListSequence.fromList(result).addElement(requiredJar);
          }
        } else if (SNodeOperations.isInstanceOf(classpath, MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 5610619299014531832l, "jetbrains.mps.build.structure.BuildSource_JavaLibraryExternalJarFolder"))) {
          SNode requiredJarFolder = requireJarFolder(artifacts, SLinkOperations.getTarget(SLinkOperations.getTarget(SNodeOperations.cast(classpath, MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 5610619299014531832l, "jetbrains.mps.build.structure.BuildSource_JavaLibraryExternalJarFolder")), MetaAdapterFactory.getContainmentLink(new UUID(8755280088213897754l, -5075149991798053422l), 5610619299014531832l, 5610619299014531834l, "extFolder")), MetaAdapterFactory.getReferenceLink(new UUID(8755280088213897754l, -5075149991798053422l), 5610619299014531647l, 5610619299014531648l, "folder")), contextNode);
          if (requiredJarFolder != null) {
            ListSequence.fromList(result).addElement(MultiTuple.<SNode,Boolean>from(requiredJarFolder, true));
          }
        } else {
          // fatal, unknown element 
          ListSequence.fromList(result).clear();
          break;
        }
      }

      if (ListSequence.fromList(result).isNotEmpty()) {
        artifacts.needsFetch(contextNode);
        for (Tuples._2<SNode, Boolean> pair : ListSequence.fromList(result)) {
          if ((boolean) pair._1()) {
            builder.addWithContent(pair._0());
          } else {
            builder.add(pair._0());
          }
        }
        return;
      }
    }

    SNode artifact = SNodeOperations.as(artifacts.findArtifact(target), MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 7389400916848036997l, "jetbrains.mps.build.structure.BuildLayout_Node"));
    if (artifact != null) {
      artifacts.needsFetch(contextNode);
      if (SNodeOperations.isInstanceOf(artifact, MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 2913098736709465755l, "jetbrains.mps.build.structure.BuildLayout_ExportAsJavaLibrary"))) {
        ListSequence.fromList(SLinkOperations.getChildren(SNodeOperations.cast(artifact, MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 2913098736709465755l, "jetbrains.mps.build.structure.BuildLayout_ExportAsJavaLibrary")), MetaAdapterFactory.getContainmentLink(new UUID(8755280088213897754l, -5075149991798053422l), 4701820937132344003l, 7389400916848037006l, "children"))).select(new ISelector<SNode, SNode>() {
          public SNode select(SNode it) {
            return SNodeOperations.as(artifacts.findArtifact(it), MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 7389400916848036997l, "jetbrains.mps.build.structure.BuildLayout_Node"));
          }
        }).visitAll(new IVisitor<SNode>() {
          public void visit(SNode it) {
            if (it != null) {
              builder.add(it);
            }
          }
        });
      } else {
        builder.add(artifact, target);
      }
    }
  }
  public static void requireModule(VisibleArtifacts artifacts, SNode module, SNode contextNode, RequiredDependenciesBuilder builder) {

    SNode target = SNodeOperations.as(artifacts.toOriginalNode(module), MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 7389400916848073784l, "jetbrains.mps.build.structure.BuildSource_JavaModule"));

    // dependencies closure 
    JavaModulesClosure closure = new JavaModulesClosure(artifacts.getGenContext(), target).closure(true);

    // searh for artifacts 
    Iterable<SNode> required = Sequence.fromIterable(((Iterable<SNode>) closure.getModules())).concat(Sequence.fromIterable(((Iterable<SNode>) closure.getJars())).select(new ISelector<SNode, SNode>() {
      public SNode select(SNode it) {
        return SLinkOperations.getTarget(it, MetaAdapterFactory.getContainmentLink(new UUID(8755280088213897754l, -5075149991798053422l), 1258644073388922138l, 3717132724152837090l, "path"));
      }
    })).concat(Sequence.fromIterable(Sequence.<SNode>singleton(target)));
    boolean hasDependencies = false;
    for (SNode n : Sequence.fromIterable(required)) {
      if (SNodeOperations.getContainingRoot(n) == SNodeOperations.getContainingRoot(contextNode)) {
        continue;
      }

      SNode artifact = SNodeOperations.as(artifacts.findArtifact(n), MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 7389400916848036997l, "jetbrains.mps.build.structure.BuildLayout_Node"));
      if (artifact != null) {
        builder.add(artifact, n);
        hasDependencies = true;
      }
    }

    for (SNode lib : Sequence.fromIterable((Iterable<SNode>) closure.getLibraries())) {
      if (SNodeOperations.getContainingRoot(lib) == SNodeOperations.getContainingRoot(contextNode)) {
        continue;
      }

      requireLibrary(artifacts, lib, contextNode, builder);
    }

    for (SNode extJar : CollectionSequence.fromCollection(closure.getExternalJars())) {
      if (SNodeOperations.getContainingRoot(extJar) == SNodeOperations.getContainingRoot(contextNode)) {
        continue;
      }

      Tuples._2<SNode, Boolean> jarImport = requireJar(artifacts, extJar, contextNode);
      if (jarImport != null) {
        if ((boolean) jarImport._1()) {
          builder.addWithContent(jarImport._0());
        } else {
          builder.add(jarImport._0());
        }
        hasDependencies = true;
      }
    }

    for (Tuples._2<SNode, String> extJarInFolder : CollectionSequence.fromCollection(closure.getExternalJarsInFolder())) {
      if (SNodeOperations.getContainingRoot(extJarInFolder._0()) == SNodeOperations.getContainingRoot(contextNode)) {
        continue;
      }

      SNode folderNode = requireJarFolder(artifacts, extJarInFolder._0(), contextNode);
      if (folderNode != null) {
        builder.addWithContent(folderNode);
        hasDependencies = true;
      }
    }

    if (hasDependencies) {
      artifacts.needsFetch(contextNode);
    }
  }
  @Nullable
  public static Tuples._2<SNode, Boolean> requireJar(VisibleArtifacts artifacts, SNode jar, SNode contextNode) {
    if (SNodeOperations.getContainingRoot(jar) == SNodeOperations.getContainingRoot(contextNode)) {
      return null;
    }

    SNode target = SNodeOperations.as(artifacts.toOriginalNode(jar), MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 5610619299013425874l, "jetbrains.mps.build.structure.BuildSource_SingleFile"));
    if (target == null) {
      return null;
    }

    SNode artifact = null;
    boolean withContent = false;
    if (SNodeOperations.isInstanceOf(target, MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 7389400916848036997l, "jetbrains.mps.build.structure.BuildLayout_Node"))) {
      artifact = SNodeOperations.as(artifacts.findArtifact(target), MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 7389400916848036997l, "jetbrains.mps.build.structure.BuildLayout_Node"));
    } else if (SNodeOperations.isInstanceOf(target, MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 5248329904287794582l, "jetbrains.mps.build.structure.BuildInputSingleFile"))) {
      Tuples._2<SNode, String> resource = artifacts.getResource(SLinkOperations.getTarget(SNodeOperations.cast(target, MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 5248329904287794582l, "jetbrains.mps.build.structure.BuildInputSingleFile")), MetaAdapterFactory.getContainmentLink(new UUID(8755280088213897754l, -5075149991798053422l), 5248329904287794582l, 5248329904287794586l, "path")));
      artifact = SNodeOperations.as(resource._0(), MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 7389400916848036997l, "jetbrains.mps.build.structure.BuildLayout_Node"));
      withContent = isNotEmptyString(resource._1());
    }
    if (artifact == null) {
      return null;
    }
    return MultiTuple.<SNode,Boolean>from(artifact, withContent);
  }
  @Nullable
  public static SNode requireJarFolder(VisibleArtifacts artifacts, SNode jarFolder, SNode contextNode) {
    if (SNodeOperations.getContainingRoot(jarFolder) == SNodeOperations.getContainingRoot(contextNode)) {
      return null;
    }

    SNode target = SNodeOperations.as(artifacts.toOriginalNode(jarFolder), MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 5610619299014531543l, "jetbrains.mps.build.structure.BuildSource_SingleFolder"));
    if (target == null) {
      return null;
    }

    SNode artifact = null;
    if (SNodeOperations.isInstanceOf(target, MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 7389400916848004876l, "jetbrains.mps.build.structure.BuildLayout_AbstractContainer"))) {
      artifact = SNodeOperations.as(artifacts.findArtifact(target), MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 7389400916848004876l, "jetbrains.mps.build.structure.BuildLayout_AbstractContainer"));
    } else if (SNodeOperations.isInstanceOf(target, MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 2303926226081001727l, "jetbrains.mps.build.structure.BuildInputSingleFolder"))) {
      artifact = SNodeOperations.as(artifacts.getResource(SLinkOperations.getTarget(SNodeOperations.cast(target, MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 2303926226081001727l, "jetbrains.mps.build.structure.BuildInputSingleFolder")), MetaAdapterFactory.getContainmentLink(new UUID(8755280088213897754l, -5075149991798053422l), 2303926226081001727l, 2303926226081001728l, "path")))._0(), MetaAdapterFactory.getConcept(new UUID(8755280088213897754l, -5075149991798053422l), 7389400916848004876l, "jetbrains.mps.build.structure.BuildLayout_AbstractContainer"));
    }
    return artifact;

  }
  private static boolean isNotEmptyString(String str) {
    return str != null && str.length() > 0;
  }
}
