package jetbrains.mps.build.util;

/*Generated by MPS */

import jetbrains.mps.smodel.SNode;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.smodel.behaviour.BehaviorReflection;
import java.util.Stack;
import jetbrains.mps.build.behavior.BuildString_Behavior;
import jetbrains.mps.util.Pair;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;

public class FileSetUtil {
  public FileSetUtil() {
  }

  public static Iterable<SNode> getImplicitFilesets(SNode container) {
    Iterable<SNode> result = ListSequence.fromList(SLinkOperations.getTargets(container, "children", true)).where(new IWhereFilter<SNode>() {
      public boolean accept(SNode it) {
        return SNodeOperations.isInstanceOf(it, "jetbrains.mps.build.structure.BuildLayout_FileSet");
      }
    }).select(new ISelector<SNode, SNode>() {
      public SNode select(SNode it) {
        return SNodeOperations.cast(it, "jetbrains.mps.build.structure.BuildLayout_FileSet");
      }
    });

    for (SNode folder : ListSequence.fromList(SLinkOperations.getTargets(container, "children", true)).where(new IWhereFilter<SNode>() {
      public boolean accept(SNode it) {
        return SNodeOperations.isInstanceOf(it, "jetbrains.mps.build.structure.BuildLayout_Folder") || SNodeOperations.isInstanceOf(it, "jetbrains.mps.build.structure.BuildLayout_Filemode");
      }
    })) {
      result = Sequence.fromIterable(result).concat(Sequence.fromIterable(getImplicitFilesets(SNodeOperations.cast(folder, "jetbrains.mps.build.structure.BuildLayout_Container"))));
    }
    return result;
  }

  public static Iterable<SNode> getExplicitFilemodeRoots(SNode container) {
    Iterable<SNode> result = ListSequence.fromList(SLinkOperations.getTargets(container, "children", true)).where(new IWhereFilter<SNode>() {
      public boolean accept(SNode it) {
        return SNodeOperations.isInstanceOf(it, "jetbrains.mps.build.structure.BuildLayout_Filemode");
      }
    }).select(new ISelector<SNode, SNode>() {
      public SNode select(SNode it) {
        return SNodeOperations.cast(it, "jetbrains.mps.build.structure.BuildLayout_Filemode");
      }
    });

    for (SNode folder : ListSequence.fromList(SLinkOperations.getTargets(container, "children", true)).where(new IWhereFilter<SNode>() {
      public boolean accept(SNode it) {
        return SNodeOperations.isInstanceOf(it, "jetbrains.mps.build.structure.BuildLayout_Folder") || SNodeOperations.isInstanceOf(it, "jetbrains.mps.build.structure.BuildLayout_Filemode");
      }
    })) {
      result = Sequence.fromIterable(result).concat(Sequence.fromIterable(getExplicitFilemodeRoots(SNodeOperations.cast(folder, "jetbrains.mps.build.structure.BuildLayout_Container"))));
    }
    return Sequence.fromIterable(result).where(new IWhereFilter<SNode>() {
      public boolean accept(SNode it) {
        return hasExplicitFilesets(it);
      }
    });
  }

  public static boolean hasExplicitFilesets(SNode container) {
    return ListSequence.fromList(SLinkOperations.getTargets(container, "children", true)).any(new IWhereFilter<SNode>() {
      public boolean accept(SNode it) {
        return !(SNodeOperations.isInstanceOf(it, "jetbrains.mps.build.structure.BuildLayout_FileSet")) && !(SNodeOperations.isInstanceOf(it, "jetbrains.mps.build.structure.BuildLayout_Filemode")) && (!(SNodeOperations.isInstanceOf(it, "jetbrains.mps.build.structure.BuildLayout_Folder")) || hasExplicitFilesets(SNodeOperations.cast(it, "jetbrains.mps.build.structure.BuildLayout_Container")));
      }
    });
  }

  public static SNode getFilesetLayoutContainer(SNode contextContainer) {
    if (SNodeOperations.isInstanceOf(contextContainer, "jetbrains.mps.build.structure.BuildLayout_ContainerAcceptingFileSet")) {
      return SNodeOperations.cast(contextContainer, "jetbrains.mps.build.structure.BuildLayout_ContainerAcceptingFileSet");
    }
    while (SNodeOperations.isInstanceOf(contextContainer, "jetbrains.mps.build.structure.BuildLayout_Folder") || SNodeOperations.isInstanceOf(contextContainer, "jetbrains.mps.build.structure.BuildLayout_Filemode")) {
      contextContainer = SNodeOperations.as(SNodeOperations.getParent(contextContainer), "jetbrains.mps.build.structure.BuildLayout_Node");
    }
    if (SNodeOperations.isInstanceOf(contextContainer, "jetbrains.mps.build.structure.BuildLayout_ContainerAcceptingFileSet") && BehaviorReflection.invokeVirtual(Boolean.TYPE, SNodeOperations.cast(contextContainer, "jetbrains.mps.build.structure.BuildLayout_ContainerAcceptingFileSet"), "virtual_hasPrefixAttribute_6408167411310575232", new Object[]{})) {
      return SNodeOperations.cast(contextContainer, "jetbrains.mps.build.structure.BuildLayout_ContainerAcceptingFileSet");
    }
    return null;
  }

  public static String getPrefix(SNode fileset, MacroHelper helper) {
    SNode parent = SNodeOperations.getParent(fileset);
    return getContainerPrefix(parent, helper);
  }

  public static String getContainerPrefix(SNode container, MacroHelper helper) {
    Stack<String> stack = new Stack<String>();
    while (SNodeOperations.isInstanceOf(container, "jetbrains.mps.build.structure.BuildLayout_Folder") || SNodeOperations.isInstanceOf(container, "jetbrains.mps.build.structure.BuildLayout_Filemode")) {
      if (SNodeOperations.isInstanceOf(container, "jetbrains.mps.build.structure.BuildLayout_Folder")) {
        stack.push(BuildString_Behavior.call_getText_4380385936562005550(SLinkOperations.getTarget(SNodeOperations.cast(container, "jetbrains.mps.build.structure.BuildLayout_Folder"), "containerName", true), helper));
      }
      container = SNodeOperations.getParent(container);
    }
    if (SNodeOperations.isInstanceOf(container, "jetbrains.mps.build.structure.BuildLayout_ContainerAcceptingFileSet") && BehaviorReflection.invokeVirtual(Boolean.TYPE, SNodeOperations.cast(container, "jetbrains.mps.build.structure.BuildLayout_ContainerAcceptingFileSet"), "virtual_hasPrefixAttribute_6408167411310575232", new Object[]{})) {
      StringBuilder sb = new StringBuilder();
      while (!(stack.isEmpty())) {
        String folderName = stack.pop();
        if (sb.length() > 0) {
          sb.append("/");
        }
        sb.append(folderName);
      }
      return sb.toString();
    }
    return null;
  }

  public static Pair<String, String> getFilemode(SNode fileset, MacroHelper helper) {
    SNode parent = SNodeOperations.getParent(fileset);
    String filemode = null;
    String dirmode = null;
    while (SNodeOperations.isInstanceOf(parent, "jetbrains.mps.build.structure.BuildLayout_Folder") || SNodeOperations.isInstanceOf(parent, "jetbrains.mps.build.structure.BuildLayout_Filemode")) {
      if (SNodeOperations.isInstanceOf(parent, "jetbrains.mps.build.structure.BuildLayout_Filemode")) {
        if (filemode == null && isNotEmpty_ae3l0k_a0a0a0a3a7(SPropertyOperations.getString(SNodeOperations.cast(parent, "jetbrains.mps.build.structure.BuildLayout_Filemode"), "filemode"))) {
          filemode = SPropertyOperations.getString(SNodeOperations.cast(parent, "jetbrains.mps.build.structure.BuildLayout_Filemode"), "filemode");
        }
        if (dirmode == null && isNotEmpty_ae3l0k_a0a1a0a3a7(SPropertyOperations.getString(SNodeOperations.cast(parent, "jetbrains.mps.build.structure.BuildLayout_Filemode"), "dirmode"))) {
          dirmode = SPropertyOperations.getString(SNodeOperations.cast(parent, "jetbrains.mps.build.structure.BuildLayout_Filemode"), "dirmode");
        }
      }
      parent = SNodeOperations.getParent(parent);
    }
    if (SNodeOperations.isInstanceOf(parent, "jetbrains.mps.build.structure.BuildLayout_ContainerAcceptingFileSet") && BehaviorReflection.invokeVirtual(Boolean.TYPE, SNodeOperations.cast(parent, "jetbrains.mps.build.structure.BuildLayout_ContainerAcceptingFileSet"), "virtual_hasFileModeAttribute_6408167411310575237", new Object[]{})) {
      return (dirmode != null || filemode != null ?
        new Pair(dirmode, filemode) :
        null
      );
    }
    return null;
  }

  public static boolean isExplicit(SNode fileset) {
    return getFilesetLayoutContainer(SNodeOperations.as(SNodeOperations.getParent(fileset), "jetbrains.mps.build.structure.BuildLayout_Node")) == null;
  }

  public static boolean isNotEmpty_ae3l0k_a0a0a0a3a7(String str) {
    return str != null && str.length() > 0;
  }

  public static boolean isNotEmpty_ae3l0k_a0a1a0a3a7(String str) {
    return str != null && str.length() > 0;
  }
}
