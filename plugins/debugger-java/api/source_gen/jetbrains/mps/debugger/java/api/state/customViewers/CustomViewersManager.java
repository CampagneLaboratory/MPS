package jetbrains.mps.debugger.java.api.state.customViewers;

/*Generated by MPS */

import com.intellij.openapi.components.ApplicationComponent;
import jetbrains.mps.logging.Logger;
import java.util.Set;
import jetbrains.mps.debugger.java.api.state.proxy.ValueWrapperFactory;
import java.util.HashSet;
import org.jetbrains.annotations.NonNls;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.debugger.java.api.state.proxy.JavaValue;
import jetbrains.mps.debugger.java.api.state.proxy.ValueWrapper;
import com.intellij.openapi.application.ApplicationManager;

public class CustomViewersManager implements ApplicationComponent {
  private static Logger LOG = Logger.getLogger(CustomViewersManager.class);
  private final Set<ValueWrapperFactory> myFactories = new HashSet<ValueWrapperFactory>();

  public CustomViewersManager() {
  }

  @Override
  public void initComponent() {
  }

  @NonNls
  @NotNull
  @Override
  public String getComponentName() {
    return "Custom Viewers Manager";
  }

  @Override
  public void disposeComponent() {
  }

  public void addFactory(ValueWrapperFactory factory) {
    myFactories.add(factory);
  }

  public void removeFactory(ValueWrapperFactory factory) {
    myFactories.remove(factory);
  }

  public Set<ValueWrapperFactory> getValueWrapperFactories(@NotNull final JavaValue originalValue) {
    Set<ValueWrapperFactory> result = new HashSet<ValueWrapperFactory>();
    for (ValueWrapperFactory factory : myFactories) {
      if (factory.canWrapValue(originalValue)) {
        result.add(factory);
      }
    }
    return result;
  }

  public ValueWrapper getValueWrapper(JavaValue originalValue, @NotNull String className) {
    // searching for wrappers 
    Set<ValueWrapperFactory> factories = getValueWrapperFactories(originalValue);
    if (factories.isEmpty()) {
      return null;
    }
    if (factories.size() > 1) {
      LOG.warning("several custom viewers found for value; using the random one");
    }
    ValueWrapperFactory factory = factories.iterator().next();
    return factory.createValueWrapper(originalValue);
  }

  public static CustomViewersManager getInstance() {
    return ApplicationManager.getApplication().getComponent(CustomViewersManager.class);
  }
}
