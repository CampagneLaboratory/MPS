package jetbrains.mps.debugger.java.runtime.evaluation.container;

/*Generated by MPS */

import jetbrains.mps.generator.generationTypes.InMemoryJavaGenerationHandler;
import java.util.List;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.Sequence;
import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.generator.GenerationStatus;
import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.progress.ProgressMonitor;
import jetbrains.mps.smodel.SModelOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.debugger.java.api.evaluation.transform.TransformatorBuilder;

public class TransformingGenerationHandler extends InMemoryJavaGenerationHandler {
  private final List<_FunctionTypes._void_P1_E0<? super SNode>> myGenerationListeners = ListSequence.fromList(new ArrayList<_FunctionTypes._void_P1_E0<? super SNode>>());

  public TransformingGenerationHandler(boolean reloadClasses, boolean keepSources, Iterable<_FunctionTypes._void_P1_E0<? super SNode>> listeners) {
    super(reloadClasses, keepSources);
    ListSequence.fromList(myGenerationListeners).addSequence(Sequence.fromIterable(listeners));
  }

  @Override
  public boolean canHandle(SModel inputModel) {
    return inputModel != null;
  }

  @Override
  public boolean handleOutput(SModule module, SModel inputModel, GenerationStatus status, IOperationContext context, ProgressMonitor monitor) {
    SModel model = status.getOutputModel();
    if (model != null) {
      final SNode evaluator = SModelOperations.getRootByName(model, Properties.EVALUATOR_NAME);
      if (evaluator != null) {
        try {
          assert SNodeOperations.getModel(evaluator) != null;
          TransformatorBuilder.getInstance().build(evaluator, true).transformEvaluator();
          if (Properties.IS_DEVELOPER_MODE) {
            for (_FunctionTypes._void_P1_E0<? super SNode> listener : ListSequence.fromList(myGenerationListeners)) {
              listener.invoke(evaluator);
            }
          }
        } catch (Throwable t) {
          LOG.error(null, t);
        }

      }
    }
    return super.handleOutput(module, inputModel, status, context, monitor);
  }
}
