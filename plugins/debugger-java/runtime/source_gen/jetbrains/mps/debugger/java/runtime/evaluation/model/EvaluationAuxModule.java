package jetbrains.mps.debugger.java.runtime.evaluation.model;

/*Generated by MPS */

import jetbrains.mps.project.*;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.project.structure.model.ModelRootManager;
import jetbrains.mps.smodel.ModuleRepositoryFacade;
import jetbrains.mps.smodel.Language;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import com.intellij.openapi.project.Project;

import java.util.Set;

import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;

import jetbrains.mps.project.structure.modules.ModuleReference;
import jetbrains.mps.smodel.IScope;
import jetbrains.mps.smodel.MPSModuleRepository;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.smodel.SModelRepository;
import jetbrains.mps.cleanup.CleanupManager;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.project.structure.modules.ModuleDescriptor;
import jetbrains.mps.project.structure.model.ModelRoot;
import java.util.Collection;
import jetbrains.mps.smodel.SModelDescriptor;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;

public class EvaluationAuxModule extends AbstractModule {
  public static boolean JAVA_STUBS = true;
  @NotNull
  private static final ModelRootManager STUBS_MANAGER = (JAVA_STUBS ?
    new ModelRootManager(ModuleRepositoryFacade.getInstance().getModule("jetbrains.mps.baseLanguage", Language.class).getModuleReference().getModuleId().toString(), "jetbrains.mps.baseLanguage.stubs.JavaStubs") :
    new ModelRootManager(ModuleRepositoryFacade.getInstance().getModule("jetbrains.mps.baseLanguage", Language.class).getModuleReference().getModuleId().toString(), "jetbrains.mps.baseLanguage.stubs.AllMembersJavaStubs")
  );
  public static final String DEBUGGER_JAVA_ID = "debugger_java";
  protected static Log log = LogFactory.getLog(EvaluationAuxModule.class);

  private Project myProject;
  private final Set<StubPath> myStubPaths = SetSequence.fromSet(new HashSet<StubPath>());
  private final Set<ModuleReference> myUsedLanguages = SetSequence.fromSet(new HashSet<ModuleReference>());
  private volatile IScope myScope;

  public EvaluationAuxModule(Project project) {
    this.myProject = project;
    ModuleReference reference = new ModuleReference("Debug Evaluation Aux Module", ModuleId.regular());
    this.setModuleReference(reference);
  }

  public MPSProject getMPSProject() {
    return this.myProject.getComponent(MPSProject.class);
  }

  @Nullable
  public Class getClass(String fqName) {
    return null;
  }

  @NotNull
  public IScope getScope() {
    if (myScope == null) {
      myScope = new EvaluationAuxScope(this);
    }
    return myScope;
  }

  public ModuleDescriptor getModuleDescriptor() {
    return null;
  }

  public void setModuleDescriptor(ModuleDescriptor moduleDescriptor, boolean reloadClasses) {
    throw new UnsupportedOperationException();
  }

  public String getGeneratorOutputPath() {
    return null;
  }

  public String getTestsGeneratorOutputPath() {
    return null;
  }

  public void save() {
  }

  @Override
  public void addUsedLanguage(ModuleReference reference) {
    SetSequence.fromSet(myUsedLanguages).addElement(reference);
  }

  @Override
  public Set<ModuleReference> getUsedLanguagesReferences() {
    return myUsedLanguages;
  }

  @Override
  public Set<StubPath> getStubPaths() {
    return myStubPaths;
  }

  public StubPath addStubPath(String stubPath) {
    StubPath path = new StubPath(stubPath, STUBS_MANAGER);
    if (SetSequence.fromSet(myStubPaths).contains(path)) {
      path = null;
    } else {
      SetSequence.fromSet(myStubPaths).addElement(path);
    }
    invalidateClassPath();
    MPSModuleRepository.getInstance().fireModuleChanged(this);
    return path;
  }

  @Override
  protected Set<SModelRoot> doUpdateModelsSet() {
    Set<SModelRoot> result = new HashSet<SModelRoot>();
    for (StubPath stub : SetSequence.fromSet(myStubPaths)) {
      ModelRoot root = new ModelRoot();
      root.setPath(stub.getPath());
      root.setManager(stub.getManager());
      try {
        SModelRoot smodelRoot = new SModelRoot(root);
        Collection<SModelDescriptor> loaded = smodelRoot.getManager().load(root, this);
        for (SModelDescriptor descriptor : CollectionSequence.fromCollection(loaded)) {
          if (SModelRepository.getInstance().getModelDescriptor(descriptor.getSModelReference()) == null) {
            SModelRepository.getInstance().registerModelDescriptor(descriptor, this);
          }
        }
        result.add(smodelRoot);
      } catch (Exception e) {
        if (log.isErrorEnabled()) {
          log.error("", e);
        }
      }
    }
    return result;
  }

  @NotNull
  public String toString() {
    return "Debug Evaluation Aux Module";
  }
}
