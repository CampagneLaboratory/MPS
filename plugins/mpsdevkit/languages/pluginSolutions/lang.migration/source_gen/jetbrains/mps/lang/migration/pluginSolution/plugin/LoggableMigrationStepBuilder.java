package jetbrains.mps.lang.migration.pluginSolution.plugin;

/*Generated by MPS */

import jetbrains.mps.ide.platform.actions.core.MoveNodesBuilder;
import jetbrains.mps.smodel.Language;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.smodel.structure.Extension;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.project.Project;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.migration.util.util.NodeReferenceUtil;
import jetbrains.mps.lang.typesystem.runtime.HUtil;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.smodel.structure.ExtensionPoint;
import jetbrains.mps.internal.collections.runtime.IVisitor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.smodel.LanguageAspect;
import jetbrains.mps.smodel.SModelInternal;
import jetbrains.mps.smodel.adapter.ids.MetaIdFactory;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import jetbrains.mps.smodel.SModelUtil_new;

public class LoggableMigrationStepBuilder extends MoveNodesBuilder.MoveNodesBuilderBase {
  protected Language myModule;
  protected SNode myStep;

  public static class LoggableMigrationStepBuilder_extension extends Extension.Default<MoveNodesBuilder.MoveNodesBuilderProvider> {
    public LoggableMigrationStepBuilder_extension() {
      super("jetbrains.mps.ide.platform.MoveNodesBuilder");
    }
    public MoveNodesBuilder.MoveNodesBuilderProvider get() {
      return new MoveNodesBuilder.MoveNodesBuilderProvider() {
        public MoveNodesBuilder createMoveNodesBuilder(SModule module, Project project) {
          if (module instanceof Language) {
            return new LoggableMigrationStepBuilder(((Language) module));
          } else {
            return null;
          }
        }
      };
    }
  }

  public LoggableMigrationStepBuilder(Language module) {
    myModule = module;
    int version = module.getModuleVersion();
    myStep = SConceptOperations.createNewNode(SNodeOperations.asInstanceConcept(MetaAdapterFactory.getConcept(0x9882f4ad195546feL, 0x826994189e5dbbf2L, 0x67236d4a5836cabbL, "jetbrains.mps.lang.migration.util.structure.RefactoringStep")));
    SPropertyOperations.set(myStep, MetaAdapterFactory.getProperty(0x9882f4ad195546feL, 0x826994189e5dbbf2L, 0x67236d4a5836cabbL, 0x67236d4a5836cabcL, "fromVersion"), "" + (version));
  }
  public MoveNodesBuilder.IncompleteMoveNode moveNode(final SNode from) {

    SNode nodeFrom = NodeReferenceUtil.makeReflection(from);
    final SNode moveNodeItem = createMoveNode_t528rj_a0c0g(SNodeOperations.cast(HUtil.copyIfNecessary(nodeFrom), MetaAdapterFactory.getConcept(0x9882f4ad195546feL, 0x826994189e5dbbf2L, 0x2b3f57492c1648ccL, "jetbrains.mps.lang.migration.util.structure.AbstractNodeReference")), SNodeOperations.cast(HUtil.copyIfNecessary(null), MetaAdapterFactory.getConcept(0x9882f4ad195546feL, 0x826994189e5dbbf2L, 0x2b3f57492c1648ccL, "jetbrains.mps.lang.migration.util.structure.AbstractNodeReference")));
    Sequence.fromIterable(new ExtensionPoint<MoveNodesContributor>("jetbrains.mps.lang.migration.pluginSolution.MoveNodesContributor").getObjects()).visitAll(new IVisitor<MoveNodesContributor>() {
      public void visit(MoveNodesContributor it) {
        it.adjustMoveNodesItem(moveNodeItem, SNodeOperations.getModel(from).getModule().getRepository());
      }
    });
    ListSequence.fromList(SLinkOperations.getChildren(myStep, MetaAdapterFactory.getContainmentLink(0x9882f4ad195546feL, 0x826994189e5dbbf2L, 0x67236d4a5836cabbL, 0x67236d4a5836d7f3L, "part"))).addElement(moveNodeItem);
    return new MoveNodesBuilder.IncompleteMoveNode() {
      public void setTarget(SNode to) {
        SLinkOperations.setTarget(moveNodeItem, MetaAdapterFactory.getContainmentLink(0x9882f4ad195546feL, 0x826994189e5dbbf2L, 0x67236d4a5830221eL, 0x67236d4a58343d17L, "toNode"), NodeReferenceUtil.makeReflection(to));
      }
    };
  }

  public void commit(Runnable callback) {
    callback.run();
    SModel model = LanguageAspect.MIGRATION.getOrCreate(myModule);
    SModelInternal m = (SModelInternal) (SModel) model;
    m.addLanguage(MetaAdapterFactory.getLanguage(MetaIdFactory.langId(0x9882f4ad195546feL, 0x826994189e5dbbf2L), "jetbrains.mps.lang.migration.util"));
    SModelOperations.addRootNode(model, myStep);
    myModule.setModuleVersion(SPropertyOperations.getInteger(myStep, MetaAdapterFactory.getProperty(0x9882f4ad195546feL, 0x826994189e5dbbf2L, 0x67236d4a5836cabbL, 0x67236d4a5836cabcL, "fromVersion")) + 1);
  }
  private static SNode createMoveNode_t528rj_a0c0g(Object p0, Object p1) {
    PersistenceFacade facade = PersistenceFacade.getInstance();
    SNode n1 = SModelUtil_new.instantiateConceptDeclaration(MetaAdapterFactory.getConcept(0x9882f4ad195546feL, 0x826994189e5dbbf2L, 0x67236d4a5830221eL, "jetbrains.mps.lang.migration.util.structure.MoveNode"), null, null, false);
    if (p0 != null) {
      n1.addChild(MetaAdapterFactory.getContainmentLink(0x9882f4ad195546feL, 0x826994189e5dbbf2L, 0x67236d4a5830221eL, 0x67236d4a58343d15L, "fromNode"), (SNode) p0);
    }
    if (p1 != null) {
      n1.addChild(MetaAdapterFactory.getContainmentLink(0x9882f4ad195546feL, 0x826994189e5dbbf2L, 0x67236d4a5830221eL, 0x67236d4a58343d17L, "toNode"), (SNode) p1);
    }
    return n1;
  }
}
