package jetbrains.mps.lang.structure.pluginSolution.plugin;

/*Generated by MPS */

import jetbrains.mps.ide.findusages.model.SearchResults;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.IVisitor;
import jetbrains.mps.ide.findusages.model.SearchResult;
import jetbrains.mps.project.MPSProject;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import java.util.Set;
import jetbrains.mps.ide.platform.refactoring.RefactoringAccessEx;
import jetbrains.mps.ide.platform.refactoring.RefactoringViewAction;
import jetbrains.mps.ide.platform.refactoring.RefactoringViewItem;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.ide.refactoring.RefactoringViewItemImpl;
import java.util.List;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;

public class RefactoringViewUtil {

  private static SearchResults<SNode> nodesToRefactoringResult(Iterable<SNode> nodes, final String category) {
    final SearchResults<SNode> result = new SearchResults<SNode>();
    Sequence.fromIterable(nodes).visitAll(new IVisitor<SNode>() {
      public void visit(SNode it) {
        result.getSearchResults().add(new SearchResult<SNode>(it, category));
      }
    });
    return result;
  }

  public static void refactor(final MPSProject mpsProject, final Iterable<SNode> nodes, final _FunctionTypes._void_P1_E0<? super Set<SNode>> toExecuteWithIncluded, String header) {
    SearchResults sr = nodesToRefactoringResult(nodes, "References");
    RefactoringAccessEx.getInstance().showRefactoringView(mpsProject.getProject(), new RefactoringViewAction() {
      public void performAction(final RefactoringViewItem refactoringViewItem) {
        ModelAccess.instance().runWriteActionInCommand(new Runnable() {
          public void run() {
            Iterable<SNode> includedNodes;
            if (refactoringViewItem instanceof RefactoringViewItemImpl) {
              List<SNodeReference> nodeRefs = as_y6hz2r_a0a0a0a1a0a0a0a0a0a0b0a1a3(refactoringViewItem, RefactoringViewItemImpl.class).getUsagesView().getIncludedResultNodes();
              includedNodes = ListSequence.fromList(nodeRefs).select(new ISelector<SNodeReference, SNode>() {
                public SNode select(SNodeReference it) {
                  return it.resolve(mpsProject.getRepository());
                }
              });
            } else {
              includedNodes = nodes;
            }
            toExecuteWithIncluded.invoke(SetSequence.fromSetWithValues(new HashSet<SNode>(), Sequence.fromIterable(includedNodes).where(new IWhereFilter<SNode>() {
              public boolean accept(SNode it) {
                return it != null;
              }
            })));
          }
        });
        refactoringViewItem.close();
      }
    }, sr, false, header);
  }
  private static <T> T as_y6hz2r_a0a0a0a1a0a0a0a0a0a0b0a1a3(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
