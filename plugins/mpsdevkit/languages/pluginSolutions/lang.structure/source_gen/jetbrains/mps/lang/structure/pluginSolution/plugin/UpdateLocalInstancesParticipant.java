package jetbrains.mps.lang.structure.pluginSolution.plugin;

/*Generated by MPS */

import jetbrains.mps.ide.platform.actions.core.MoveNodeRefactoringParticipant;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.smodel.structure.Extension;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SProperty;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import java.util.List;
import org.jetbrains.mps.openapi.module.SRepository;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.ide.platform.actions.core.RefactoringParticipant;
import java.util.Map;
import org.jetbrains.mps.openapi.module.SearchScope;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.Collection;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import jetbrains.mps.internal.collections.runtime.ISelector;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.ide.findusages.model.SearchResults;
import jetbrains.mps.ide.findusages.model.SearchResult;
import jetbrains.mps.ide.platform.actions.core.RefactoringSession;
import jetbrains.mps.ide.platform.actions.core.MoveNodesDefault;

public class UpdateLocalInstancesParticipant<I, F> implements MoveNodeRefactoringParticipant<Tuples._2<Language, I>, Tuples._2<Language, F>> {

  private StructureSpecialization<I, F> myStructureSpecialization;
  public UpdateLocalInstancesParticipant(StructureSpecialization<I, F> structureSpecialization) {
    myStructureSpecialization = structureSpecialization;
  }

  public static class UpdateConceptInstances_extension extends Extension.Default<MoveNodeRefactoringParticipant<?, ?>> {
    public UpdateConceptInstances_extension() {
      super("jetbrains.mps.ide.platform.MoveNodeParticipantEP");
    }
    public MoveNodeRefactoringParticipant<?, ?> get() {
      return new UpdateLocalInstancesParticipant<SConcept, SConcept>(new MoveConceptSpecialization());
    }
  }
  public static class UpdatePropertyInstances_extension extends Extension.Default<MoveNodeRefactoringParticipant<?, ?>> {
    public UpdatePropertyInstances_extension() {
      super("jetbrains.mps.ide.platform.MoveNodeParticipantEP");
    }
    public MoveNodeRefactoringParticipant<?, ?> get() {
      return new UpdateLocalInstancesParticipant<SProperty, SProperty>(new MovePropertySpecialization());
    }
  }
  public static class UpdateContainmentLinkInstances_extension extends Extension.Default<MoveNodeRefactoringParticipant<?, ?>> {
    public UpdateContainmentLinkInstances_extension() {
      super("jetbrains.mps.ide.platform.MoveNodeParticipantEP");
    }
    public MoveNodeRefactoringParticipant<?, ?> get() {
      return new UpdateLocalInstancesParticipant<SContainmentLink, SContainmentLink>(new MoveContainmentLinkSpecialization());
    }
  }
  public static class UpdateReferenceLinkInstances_extension extends Extension.Default<MoveNodeRefactoringParticipant<?, ?>> {
    public UpdateReferenceLinkInstances_extension() {
      super("jetbrains.mps.ide.platform.MoveNodeParticipantEP");
    }
    public MoveNodeRefactoringParticipant<?, ?> get() {
      return new UpdateLocalInstancesParticipant<SReferenceLink, SReferenceLink>(new MoveReferenceLinkSpecialization());
    }
  }

  public MoveNodeRefactoringParticipant.MoveNodeRefactoringDataCollector<Tuples._2<Language, I>, Tuples._2<Language, F>> getDataCollector() {
    return myStructureSpecialization;
  }

  public List<String> getOptions(Tuples._2<Language, I> initialState, SRepository repository) {
    if (initialState != null) {
      return ListSequence.fromListAndArray(new ArrayList<String>(), getDescription());
    } else {
      return ListSequence.fromList(new ArrayList<String>());
    }
  }
  public String getDescription() {
    return "Update instances in current project";
  }

  public List<RefactoringParticipant.Change<Tuples._2<Language, I>, Tuples._2<Language, F>>> getChanges(final Tuples._2<Language, I> initialState, SRepository repository, Map<String, Boolean> options, SearchScope searchScope) {
    if (!(MapSequence.fromMap(options).get(getDescription())) || initialState == null) {
      return ListSequence.fromList(new ArrayList<RefactoringParticipant.Change<Tuples._2<Language, I>, Tuples._2<Language, F>>>());
    }
    Collection<SNode> instances = myStructureSpecialization.findInstances(initialState._1(), searchScope);

    return CollectionSequence.fromCollection(instances).select(new ISelector<SNode, RefactoringParticipant.Change<Tuples._2<Language, I>, Tuples._2<Language, F>>>() {
      public RefactoringParticipant.Change<Tuples._2<Language, I>, Tuples._2<Language, F>> select(SNode instance) {
        final SNodeReference nodeRef = instance.getReference();
        final SearchResults searchResults = new SearchResults();
        searchResults.add(new SearchResult<SNode>(instance, "instance"));
        RefactoringParticipant.Change<Tuples._2<Language, I>, Tuples._2<Language, F>> change = new RefactoringParticipant.Change<Tuples._2<Language, I>, Tuples._2<Language, F>>() {
          public MoveNodeRefactoringParticipant<Tuples._2<Language, I>, Tuples._2<Language, F>> getParticipant() {
            return UpdateLocalInstancesParticipant.this;
          }
          public SearchResults getSearchResults() {
            return searchResults;
          }
          public boolean needsToPreserveOldNode() {
            return false;
          }
          public void confirm(final Tuples._2<Language, F> finalState, final SRepository repository, final RefactoringSession refactoringSession) {
            refactoringSession.registerChange(new Runnable() {
              public void run() {
                SNode node = nodeRef.resolve(repository);
                MoveNodesDefault.CopyMapObject copyMap = MoveNodesDefault.CopyMapObject.getCopyMap(refactoringSession);
                if (node == null || MapSequence.fromMap(copyMap.getCopyMap()).containsKey(node)) {
                  myStructureSpecialization.doReplaceInstance(MapSequence.fromMap(copyMap.getCopyMap()).get(node), initialState._1(), finalState._1());
                }
                myStructureSpecialization.doReplaceInstance(node, initialState._1(), finalState._1());
              }
            });
          }
        };
        return change;
      }
    }).toListSequence();
  }

}
