package jetbrains.mps.quickQueryLanguage.pluginSolution.plugin;

/*Generated by MPS */

import com.intellij.openapi.ui.DialogWrapper;
import org.apache.log4j.Logger;
import org.apache.log4j.LogManager;
import javax.swing.JPanel;
import java.awt.BorderLayout;
import jetbrains.mps.ide.embeddableEditor.SimpleEmbeddableEditor;
import jetbrains.mps.project.Project;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.ide.findusages.view.optionseditor.components.ScopeEditor;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.ide.findusages.view.optionseditor.options.ScopeOptions;
import java.awt.Dimension;
import jetbrains.mps.quickQueryLanguage.runtime.Query;
import jetbrains.mps.ide.findusages.model.scopes.FindUsagesScope;
import javax.swing.JComponent;
import jetbrains.mps.ide.embeddableEditor.MakeUtils;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;

public abstract class BaseQQDialog extends DialogWrapper {
  private static Logger LOG = LogManager.getLogger(BaseQQDialog.class);

  private final JPanel myPanel = new JPanel(new BorderLayout());
  private SimpleEmbeddableEditor myEditor;

  private final Project myProject;

  private SNode myQueryNode;
  private SModel myTempModel;

  private ScopeEditor myScope;
  private boolean myDisposed = false;


  public BaseQQDialog(String title, String okButtonText, Project project, final SNode concept) {
    super(ProjectHelper.toIdeaProject(project));

    setTitle(title);
    setOKButtonText(okButtonText);
    setCancelButtonText("&Cancel");
    setModal(false);

    myProject = project;

    myProject.getRepository().getModelAccess().executeCommand(new Runnable() {
      public void run() {
        myScope = new ScopeEditor(new ScopeOptions());

        myQueryNode = createQuery(concept);
        myTempModel = QuickQueryUtils.createTemporaryModelWithQuery(myQueryNode);

        myEditor = new SimpleEmbeddableEditor(myProject, true);
        myEditor.editNode(myQueryNode);
      }
    });
    myPanel.add(this.myEditor, BorderLayout.CENTER);
    myPanel.add(this.myScope.getComponent(), BorderLayout.SOUTH);

    myPanel.setPreferredSize(new Dimension(500, 500));

    init();
  }



  protected abstract SNode createQuery(SNode concept);

  protected abstract void executeQuery(Project project, Query query, FindUsagesScope scope);



  @Override
  protected JComponent createCenterPanel() {
    return this.myPanel;
  }

  @Override
  public void doOKAction() {
    MakeUtils.make(myProject, myTempModel, new _FunctionTypes._void_P1_E0<Boolean>() {
      public void invoke(Boolean isSuccessful) {
        // todo: enable after modal in doOkAction! 
        // <node> 

        if (isSuccessful) {
          myProject.getRepository().getModelAccess().runReadAction(new Runnable() {
            public void run() {
              Query query = QuickQueryUtils.loadCompiledQuery(myQueryNode);
              if (query == null) {
                return;
              }

              FindUsagesScope scope = BaseQQDialog.this.myScope.getOptions().getScope(myProject);
              executeQuery(myProject, query, scope);
            }
          });
        } else {
          // todo: log 
        }
      }
    });

    super.doOKAction();
  }



  @Override
  protected String getDimensionServiceKey() {
    return "#" + this.getClass().getCanonicalName();
  }



  @Override
  public void dispose() {
    if (myDisposed) {
      return;
    }
    myDisposed = true;
    myProject.getRepository().getModelAccess().runWriteInEDT(new Runnable() {
      public void run() {
        myEditor.disposeEditor();
        // todo: enable after modal in doOkAction! 
        // <node> 
      }
    });
    super.dispose();
  }
}
