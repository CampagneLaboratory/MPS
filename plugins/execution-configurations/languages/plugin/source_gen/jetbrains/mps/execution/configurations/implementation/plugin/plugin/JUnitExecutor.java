package jetbrains.mps.execution.configurations.implementation.plugin.plugin;

/*Generated by MPS */

import jetbrains.mps.baseLanguage.unitTest.execution.settings.JUnitSettings_Configuration;
import jetbrains.mps.debug.api.IDebuggerSettings;
import jetbrains.mps.baseLanguage.execution.api.JavaRunParameters_Configuration;
import java.util.List;
import jetbrains.mps.baseLanguage.unitTest.execution.client.ITestNodeWrapper;
import com.intellij.execution.process.ProcessHandler;
import com.intellij.execution.ExecutionException;
import jetbrains.mps.baseLanguage.unitTest.execution.client.RunCachesManager;
import jetbrains.mps.baseLanguage.unitTest.execution.client.JUnit_Command;
import com.intellij.execution.process.ProcessAdapter;
import com.intellij.execution.process.ProcessEvent;
import jetbrains.mps.baseLanguage.execution.api.JavaRunParameters;
import jetbrains.mps.util.test.CachesUtil;

public class JUnitExecutor implements Executor {
  private final JUnitSettings_Configuration myJUnitSettings;
  private final IDebuggerSettings myDebuggerSettings;
  private final JavaRunParameters_Configuration myJavaRunParameters;
  private final List<ITestNodeWrapper> myTestNodes;

  public JUnitExecutor(JUnitSettings_Configuration jUnitSettings, IDebuggerSettings debuggerSettings, JavaRunParameters_Configuration javaRunParameters, List<ITestNodeWrapper> testNodes) {
    myJUnitSettings = jUnitSettings;
    myDebuggerSettings = debuggerSettings;
    myJavaRunParameters = javaRunParameters;
    myTestNodes = testNodes;
  }

  @Override
  public ProcessHandler execute() throws ExecutionException {
    final boolean reuseCaches = myJUnitSettings.getReuseCaches() && RunCachesManager.acquireLock();
    ProcessHandler commandProcess = new JUnit_Command().setDebuggerSettings_String(myDebuggerSettings.getCommandLine(true)).createProcess(myTestNodes, this.prepareJavaParamsForTests(reuseCaches, myJUnitSettings.getCachesDir()));
    commandProcess.addProcessListener(new ProcessAdapter() {
      @Override
      public void processTerminated(ProcessEvent p0) {
        if (reuseCaches) {
          RunCachesManager.releaseLock();
        }
      }
    });
    return commandProcess;
  }

  public JavaRunParameters prepareJavaParamsForTests(boolean reuseCaches, String cachesDir) {
    JavaRunParameters_Configuration javaRunParams = myJavaRunParameters;
    JavaRunParameters parameters = javaRunParams.getJavaRunParameters().clone();
    String vmFromJava = javaRunParams.getJavaRunParameters().getVmOptions();
    if (vmFromJava == null) {
      vmFromJava = "";
    }
    if (reuseCaches) {
      String runIdString = "-D" + CachesUtil.REUSE_CACHES_DIR + "=\"" + cachesDir + "\"";
      parameters.setVmOptions(vmFromJava + " " + runIdString);
    }
    return parameters;
  }

}
