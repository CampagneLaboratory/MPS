package jetbrains.mps.core.query.actions;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.smodel.behaviour.BehaviorReflection;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import org.jetbrains.annotations.NotNull;

public class PrecedenceUtil {
  public PrecedenceUtil() {
  }

  /*package*/ static SNode getTargetForLeftTransform(SNode context, SNode result) {
    int prio = BehaviorReflection.invokeVirtual(Integer.TYPE, result, "virtual_getPriority_7352592509980890960", new Object[]{});
    SNode targetNode = context;
    for (SNode parentNode = SNodeOperations.getParent(targetNode); parentNode != null && SNodeOperations.isInstanceOf(parentNode, "jetbrains.mps.core.query.structure.MqlExpression") && BehaviorReflection.invokeVirtual(Integer.TYPE, SNodeOperations.cast(parentNode, "jetbrains.mps.core.query.structure.MqlExpression"), "virtual_getPriority_7352592509980890960", new Object[]{}) < prio; parentNode = SNodeOperations.getParent(targetNode)) {
      if (BehaviorReflection.invokeVirtual(Integer.TYPE, SNodeOperations.cast(parentNode, "jetbrains.mps.core.query.structure.MqlExpression"), "virtual_getPriority_7352592509980890960", new Object[]{}) == -1) {
        // we do not go through expressions like parentheses or calls 
        break;
      }
      if (SNodeOperations.isInstanceOf(parentNode, "jetbrains.mps.core.query.structure.MqlBinaryExpr") && SNodeOperations.getContainingLinkDeclaration(targetNode) == SLinkOperations.findLinkDeclaration("jetbrains.mps.core.query.structure.MqlBinaryExpr", "right")) {
        // if parent expression is BinaryOperation having higher priority and target is rhigh child of it 
        // then we should rather transform current target and add additional parenthesis around resulting expression 
        break;
      }
      targetNode = SNodeOperations.cast(parentNode, "jetbrains.mps.core.query.structure.MqlExpression");
    }
    return targetNode;
  }

  /*package*/ static SNode getTargetForRightTransform(@NotNull SNode contextNode, SNode result) {
    int prio = BehaviorReflection.invokeVirtual(Integer.TYPE, result, "virtual_getPriority_7352592509980890960", new Object[]{});
    SNode targetNode = contextNode;
    for (SNode parentNode = SNodeOperations.getParent(targetNode); parentNode != null && SNodeOperations.isInstanceOf(parentNode, "jetbrains.mps.core.query.structure.MqlExpression") && BehaviorReflection.invokeVirtual(Integer.TYPE, SNodeOperations.cast(parentNode, "jetbrains.mps.core.query.structure.MqlExpression"), "virtual_getPriority_7352592509980890960", new Object[]{}) < prio; parentNode = SNodeOperations.getParent(targetNode)) {
      if (BehaviorReflection.invokeVirtual(Integer.TYPE, SNodeOperations.cast(parentNode, "jetbrains.mps.core.query.structure.MqlExpression"), "virtual_getPriority_7352592509980890960", new Object[]{}) == -1) {
        // we do not go through expressions like parentheses or calls 
        break;
      }
      if (SNodeOperations.isInstanceOf(parentNode, "jetbrains.mps.core.query.structure.MqlBinaryExpr") && SNodeOperations.getContainingLinkDeclaration(targetNode) == SLinkOperations.findLinkDeclaration("jetbrains.mps.core.query.structure.MqlBinaryExpr", "left")) {
        // if parent expression is BinaryOperation and target is left child of it 
        // then we should rather transform current target 
        break;
      }
      if (SNodeOperations.isInstanceOf(parentNode, "jetbrains.mps.core.query.structure.MqlDotExpression") && SNodeOperations.getContainingLinkDeclaration(targetNode) == SLinkOperations.findLinkDeclaration("jetbrains.mps.core.query.structure.MqlDotExpression", "left")) {
        // if parent expression is DotExpression and target is operang ("left" part of the expression) 
        // then we should rather transform current target 
        break;
      }

      targetNode = SNodeOperations.cast(parentNode, "jetbrains.mps.core.query.structure.MqlExpression");
    }
    return targetNode;
  }

  public static SNode parenthesiseAndRotateIfNecessary(@NotNull SNode contextNode) {
    if (SNodeOperations.isInstanceOf(SNodeOperations.getParent(contextNode), "jetbrains.mps.core.query.structure.MqlExpression")) {
      int prio = BehaviorReflection.invokeVirtual(Integer.TYPE, SNodeOperations.cast(SNodeOperations.getParent(contextNode), "jetbrains.mps.core.query.structure.MqlExpression"), "virtual_getPriority_7352592509980890960", new Object[]{});
      boolean needWrapping = prio >= 0 && prio < BehaviorReflection.invokeVirtual(Integer.TYPE, contextNode, "virtual_getPriority_7352592509980890960", new Object[]{});
      if (!(needWrapping) && prio >= 0 && prio == BehaviorReflection.invokeVirtual(Integer.TYPE, contextNode, "virtual_getPriority_7352592509980890960", new Object[]{})) {
        if (SNodeOperations.isInstanceOf(SNodeOperations.getParent(contextNode), "jetbrains.mps.core.query.structure.MqlTriplex") && SNodeOperations.getContainingLinkDeclaration(contextNode) != SLinkOperations.findLinkDeclaration("jetbrains.mps.core.query.structure.MqlTriplex", "elseexpr")) {
          needWrapping = true;
        }
      }
      if (needWrapping) {
        SNode result = SNodeOperations.replaceWithNewChild(contextNode, "jetbrains.mps.core.query.structure.MqlParentheses");
        SLinkOperations.setTarget(result, "expr", contextNode, true);
        return result;
      } else if (SNodeOperations.isInstanceOf(contextNode, "jetbrains.mps.core.query.structure.MqlBinaryExpr")) {
        PrecedenceUtil.rotateIfNecessary(SNodeOperations.cast(contextNode, "jetbrains.mps.core.query.structure.MqlBinaryExpr"));
      }
    }
    return contextNode;
  }

  private static void rotate(SNode expr, SNode child) {
    boolean isRight = SLinkOperations.getTarget(expr, "right", true) == child;
    SNode backsideExpr = (isRight ?
      SLinkOperations.getTarget(child, "left", true) :
      SLinkOperations.getTarget(child, "right", true)
    );
    SNodeOperations.detachNode(child);
    SNodeOperations.replaceWithAnother(expr, child);
    if ((backsideExpr != null)) {
      SNodeOperations.replaceWithAnother(backsideExpr, expr);
    }
    if (isRight) {
      SLinkOperations.setTarget(expr, "right", backsideExpr, true);
    } else {
      SLinkOperations.setTarget(expr, "left", backsideExpr, true);
    }
  }

  private static boolean needsRotate(SNode expr, SNode child) {
    int childPrio = BehaviorReflection.invokeVirtual(Integer.TYPE, child, "virtual_getPriority_7352592509980890960", new Object[]{});
    int opPrio = BehaviorReflection.invokeVirtual(Integer.TYPE, expr, "virtual_getPriority_7352592509980890960", new Object[]{});
    if (childPrio == opPrio) {
      boolean isRight = SLinkOperations.getTarget(expr, "right", true) == child;
      int assoc = BehaviorReflection.invokeVirtual(Integer.TYPE, expr, "virtual_getAssociativity_5322644393894740267", new Object[]{});
      if (assoc != 0) {
        return assoc == -1 && isRight || assoc == 1 && !(isRight);
      }
    }
    return childPrio > opPrio;
  }

  public static void rotateIfNecessary(SNode expr) {
    rotateParentsIfNecessary(rotateChildrenIfNecessary(expr));
  }

  private static SNode rotateChildrenIfNecessary(SNode node) {
    SNode expr = node;
    boolean checkMore = true;
    while (checkMore) {
      checkMore = false;
      while (SNodeOperations.isInstanceOf(SLinkOperations.getTarget(expr, "left", true), "jetbrains.mps.core.query.structure.MqlBinaryExpr") && needsRotate(expr, SNodeOperations.cast(SLinkOperations.getTarget(expr, "left", true), "jetbrains.mps.core.query.structure.MqlBinaryExpr"))) {
        SNode left = SNodeOperations.cast(SLinkOperations.getTarget(expr, "left", true), "jetbrains.mps.core.query.structure.MqlBinaryExpr");
        rotate(expr, left);
        rotateChildrenIfNecessary(expr);
        expr = left;
      }
      while (SNodeOperations.isInstanceOf(SLinkOperations.getTarget(expr, "right", true), "jetbrains.mps.core.query.structure.MqlBinaryExpr") && needsRotate(expr, SNodeOperations.cast(SLinkOperations.getTarget(expr, "right", true), "jetbrains.mps.core.query.structure.MqlBinaryExpr"))) {
        SNode right = SNodeOperations.cast(SLinkOperations.getTarget(expr, "right", true), "jetbrains.mps.core.query.structure.MqlBinaryExpr");
        rotate(expr, right);
        rotateChildrenIfNecessary(expr);
        expr = right;
        checkMore = true;
      }
    }
    return expr;
  }

  private static void rotateParentsIfNecessary(SNode expr) {
    while (SNodeOperations.isInstanceOf(SNodeOperations.getParent(expr), "jetbrains.mps.core.query.structure.MqlBinaryExpr")) {
      SNode parent = SNodeOperations.cast(SNodeOperations.getParent(expr), "jetbrains.mps.core.query.structure.MqlBinaryExpr");
      SNode newtop = rotateChildrenIfNecessary(parent);
      if (newtop == parent) {
        break;
      }
      expr = parent;
    }
    if (SNodeOperations.isInstanceOf(SNodeOperations.getParent(expr), "jetbrains.mps.core.query.structure.MqlUnary")) {
      SNode parent = SNodeOperations.cast(SNodeOperations.getParent(expr), "jetbrains.mps.core.query.structure.MqlUnary");
      SLinkOperations.setTarget(parent, "expr", SLinkOperations.getTarget(expr, "left", true), true);
      SNodeOperations.replaceWithAnother(parent, expr);
      SLinkOperations.setTarget(expr, "left", parent, true);
    }
  }
}
