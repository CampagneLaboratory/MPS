package jetbrains.mps.web.viewer.handlers;

/*Generated by MPS */

import jetbrains.mps.openapi.editor.cells.EditorCell;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.openapi.editor.cells.EditorCell_Collection;
import jetbrains.mps.nodeEditor.cellLayout.CellLayout_Indent;
import jetbrains.mps.lang.editor.table.runtime.EditorCell_Table;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.nodeEditor.cells.EditorCell_Label;
import java.util.Iterator;
import jetbrains.mps.editor.runtime.style.StyleAttributes;
import jetbrains.mps.openapi.editor.cells.CellTraversalUtil;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.awt.Color;
import jetbrains.mps.nodeEditor.MPSFonts;
import jetbrains.mps.nodeEditor.cells.APICellAdapter;
import jetbrains.mps.nodeEditor.cellLayout.CellLayout_Horizontal;
import jetbrains.mps.nodeEditor.cellLayout.CellLayout_Vertical;
import jetbrains.mps.openapi.editor.style.StyleAttribute;

public class CellToHtmlGenerator {
  private final EditorCell rootCell;
  private final SNode selectedNode;

  private StringBuilder builder;


  public CellToHtmlGenerator(EditorCell rootCell, SNode selectedNode) {
    this.rootCell = rootCell;
    this.selectedNode = selectedNode;
  }



  public String generate() {
    builder = new StringBuilder();
    generateHtmlForCell(rootCell, 0);
    return builder.toString();
  }



  private void generateHtmlForCell(EditorCell cell, int indention) {
    if (cell instanceof EditorCell_Collection && isEmptyCollection((EditorCell_Collection) cell)) {
      return;
    }
    if (cell instanceof EditorCell_Collection && ((EditorCell_Collection) cell).getCellLayout() instanceof CellLayout_Indent) {
      generateHtmlForIndent(((EditorCell_Collection) cell), indention);
      return;
    }
    appendOpeningDiv(cell, indention);

    if (cell instanceof EditorCell_Table) {
      generateHtmlForTable(cell);
    } else if (cell instanceof EditorCell_Collection) {
      for (EditorCell child : Sequence.fromIterable(((EditorCell_Collection) cell))) {
        generateHtmlForCell(child, 0);
        builder.append('\n');
      }
    } else if (cell instanceof EditorCell_Label) {
      String text = ((EditorCell_Label) cell).getText();
      builder.append(((text == null || text.length() == 0) ?
        "&nbsp;" :
        text
      ));
    }
    appendClosingDiv();
  }



  private void generateHtmlForTable(EditorCell cell) {
    builder.append("<table border=\"1\">");
    for (Iterator<EditorCell> rowsIterator = ((EditorCell_Table) cell).iterator(); rowsIterator.hasNext();) {
      EditorCell nextRow = rowsIterator.next();
      assert nextRow instanceof EditorCell_Collection;
      builder.append("<tr>");

      int index = -1;
      for (Iterator<EditorCell> cellIterator = ((EditorCell_Collection) nextRow).iterator(); cellIterator.hasNext(); index++) {
        EditorCell nextCell = cellIterator.next();
        if (index < 0 || !(cellIterator.hasNext())) {
          //  skipping first cell 
          continue;
        }

        builder.append("<td>");
        generateHtmlForCell(nextCell, 0);
        builder.append('\n');
        builder.append("</td>");
      }
      assert index > 0;
      builder.append("</tr>");

    }
    builder.append("</table>");
  }



  private boolean isEmptyCollection(EditorCell_Collection collection) {
    for (EditorCell editorCell : collection) {
      if (!(editorCell instanceof EditorCell_Collection)) {
        return false;
      }
      if (!(isEmptyCollection((EditorCell_Collection) editorCell))) {
        return false;
      }
    }
    return true;
  }



  private void generateHtmlForIndent(EditorCell_Collection collection, int indention) {
    boolean needWrapper = (indention == 0);
    if (needWrapper) {
      appendOpeningDiv(collection, indention);
    }
    if (collection.getStyle().get(StyleAttributes.INDENT_LAYOUT_INDENT)) {
      indention++;
    }
    for (EditorCell child : Sequence.fromIterable(collection)) {
      generateHtmlForCell(child, indention);
    }
    if (needWrapper) {
      appendClosingDiv();
    }
  }

  private boolean isOnNewLine(EditorCell cell) {
    if (cell.getStyle().get(StyleAttributes.INDENT_LAYOUT_ON_NEW_LINE)) {
      return true;
    }

    if (cell.getParent() != null && cell.getParent().getStyle().get(StyleAttributes.INDENT_LAYOUT_CHILDREN_NEWLINE)) {
      return true;
    }

    EditorCell prevCell = CellTraversalUtil.getPrevSibling(cell);
    if (prevCell != null) {
      return isOnNewLineRightChild(prevCell);
    } else {
      EditorCell parentCell = cell.getParent();
      while (parentCell != null) {
        if (isOnNewLine(parentCell)) {
          return true;
        }
        parentCell = parentCell.getParent();
      }
    }
    return true;
  }

  private boolean isOnNewLineRightChild(EditorCell prevCell) {
    if (prevCell == null) {
      return false;
    }
    if (prevCell.getStyle().get(StyleAttributes.INDENT_LAYOUT_NEW_LINE)) {
      return true;
    }
    if (prevCell instanceof EditorCell_Collection) {
      EditorCell rightChild = ((EditorCell_Collection) prevCell).lastCell();
      return isOnNewLineRightChild(rightChild);
    }
    return false;
  }



  private void appendClosingDiv() {
    builder.append("</div>");
  }



  private void appendOpeningDiv(EditorCell cell, int indention) {
    builder.append("<div");
    addClasses(cell, indention);
    addTextAttributes(cell, indention);
    addTargetNodeId(cell);
    builder.append(">");
  }



  private void addClasses(EditorCell cell, int indention) {
    String classes = "";
    if (cell instanceof EditorCell_Collection) {
      classes = classes + getClassesForCollection(((EditorCell_Collection) cell));
    }
    classes += getClassesForCell(cell, indention);
    if (cell.getSNode().equals(selectedNode) && SNodeOperations.getContainingRoot(selectedNode) != selectedNode) {
      classes += " selected-cell";
    }
    if ((classes != null && classes.length() > 0)) {
      builder.append(" class = \"");
      builder.append(classes);
      builder.append("\"");
    }
  }

  private void addTextAttributes(EditorCell cell, int indention) {
    StringBuilder temp = new StringBuilder();
    if (cell instanceof EditorCell_Label) {
      Color fg = cell.getStyle().get(StyleAttributes.TEXT_COLOR);
      Color bg = cell.getStyle().get(StyleAttributes.TEXT_BACKGROUND_COLOR);
      if (fg != null && fg != Color.BLACK) {
        temp.append("color:#" + colorToHEX(fg) + ";");
      }
      if (bg != null && bg != Color.WHITE) {
        temp.append("background:#" + colorToHEX(bg) + ";");
      }
      int font = cell.getStyle().get(StyleAttributes.FONT_STYLE);
      if ((font & MPSFonts.BOLD) > 0) {
        temp.append("font-weight: bold;");
      }
      if ((font & MPSFonts.ITALIC) > 0) {
        temp.append("font-style: italic;");
      }
      if (Boolean.TRUE.equals(cell.getStyle().get(StyleAttributes.DRAW_BORDER))) {
        temp.append("border: solid 1px;");
      }

    }
    if (isOnNewLine(cell)) {
      temp.append("padding-left:" + indention * 2 + "em;");
    }

    if (isNotEmpty_je17c5_a0e0y(temp.toString())) {
      builder.append(" style=\"" + temp.toString() + "\"");
    }
  }

  private String colorToHEX(Color color) {
    String strColor = Integer.toHexString(color.getRGB());
    return strColor.substring(2, strColor.length());
  }



  private void addTargetNodeId(EditorCell cell) {
    if (cell instanceof EditorCell_Label) {
      SNode targetNode = APICellAdapter.getSNodeWRTReference(cell);
      if (targetNode == null) {
        return;
      }
      if (targetNode == cell.getSNode()) {
        return;
      }
      String targetNodeId = " target-node-id = \"" + targetNode.getNodeId() + "\"";
      String targetModelId = " target-model-id = \"" + targetNode.getModel().getModelId() + "\"";
      String targetModuleId = " target-module-id = \"" + targetNode.getModel().getModule().getModuleId() + "\"";
      builder.append(targetNodeId);
      builder.append(targetModelId);
      builder.append(targetModuleId);
    }
    if (cell.isBig()) {
      builder.append(" data-node = \"" + cell.getSNode().getNodeId() + "\"");
    }
  }



  private String getClassesForCollection(EditorCell_Collection collection) {
    StringBuilder clazz = new StringBuilder();
    if (collection.getCellLayout() instanceof CellLayout_Horizontal) {
      clazz.append("horizontal-layout ");
    } else if (collection.getCellLayout() instanceof CellLayout_Vertical) {
      clazz.append("vertical-layout ");
    }
    if (getStyleForLast(StyleAttributes.INDENT_LAYOUT_NEW_LINE, collection)) {
      clazz.append("indent-layout-new-line ");
    }
    clazz.append("n-list ");

    return clazz.toString();
  }



  private Boolean getStyleForLast(StyleAttribute<Boolean> style, EditorCell cell) {
    if (cell == null) {
      return false;
    }
    Boolean result = cell.getStyle().get(style);
    if (result) {
      return result;
    }
    if (cell instanceof EditorCell_Collection) {
      return getStyleForLast(style, ((EditorCell_Collection) cell).lastCell());
    } else {
      return false;
    }
  }

  private String getClassesForCell(EditorCell cell, int indention) {
    StringBuilder clazz = new StringBuilder();
    if (cell.getStyle().get(StyleAttributes.INDENT_LAYOUT_NEW_LINE)) {
      clazz.append("indent-layout-new-line ");
    }
    if (cell.getStyle().get(StyleAttributes.INDENT_LAYOUT_ON_NEW_LINE)) {
      clazz.append("indent-layout-on-new-line ");
    }

    if (isOnNewLine(cell)) {
      clazz.append("");
    }

    if (cell instanceof EditorCell_Label) {
      clazz.append("n-leaf ");
      if (Boolean.TRUE.equals(cell.getStyle().get(StyleAttributes.PUNCTUATION_LEFT))) {
        clazz.append("n-pleft ");
      }
      if (Boolean.TRUE.equals(cell.getStyle().get(StyleAttributes.PUNCTUATION_RIGHT))) {
        clazz.append("n-pright ");
      }
      if (isEmpty_je17c5_a0d0g0gb(((EditorCell_Label) cell).getText())) {
        clazz.append("n-empty");
      }
    }

    return clazz.toString();
  }

  public static boolean isNotEmpty_je17c5_a0e0y(String str) {
    return str != null && str.length() > 0;
  }

  public static boolean isEmpty_je17c5_a0d0g0gb(String str) {
    return str == null || str.length() == 0;
  }
}
