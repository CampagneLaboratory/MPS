package jetbrains.mps.web.viewer.handlers;

/*Generated by MPS */

import jetbrains.mps.web.core.server.Handler;
import jetbrains.mps.project.Project;
import com.sun.net.httpserver.HttpExchange;
import jetbrains.mps.web.core.server.HttpUtil;
import jetbrains.mps.web.JsonBuilder;
import java.util.Map;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.project.ModuleId;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.smodel.SModelId;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.smodel.SNodeId;

public class NameHandler implements Handler {
  public void handle(String requestUrl, Project project, HttpExchange exchange) throws Exception {
    // response format: {"module-name" : "name"} 
    // requestUrls: 
    // /name.json -> project name 
    // /name.json?module-id=Q1&model-id=Q2&node-id=Q3 
    // more parameters - more results 
    HttpUtil.doJsonResponse(getNames(HttpUtil.getQueryParameters(exchange), project).toString(), exchange);
  }



  private static JsonBuilder getNames(final Map<String, String> parameters, final Project project) {
    final JsonBuilder result = JsonBuilder.object();
    result.addProperty("project-name", project.getName());

    System.out.println(parameters);

    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        if (!(MapSequence.fromMap(parameters).containsKey("module-id"))) {
          return;
        }
        SModule module = project.getRepository().getModule(ModuleId.fromString(MapSequence.fromMap(parameters).get("module-id")));
        if (module == null) {
          return;
        }
        result.addProperty("module-name", module.getModuleName());
        result.addProperty("module-id", MapSequence.fromMap(parameters).get("module-id"));

        if (!(MapSequence.fromMap(parameters).containsKey("model-id"))) {
          return;
        }
        SModel model = module.resolveInDependencies(SModelId.fromString(MapSequence.fromMap(parameters).get("model-id")));
        if (model == null) {
          return;
        }
        result.addProperty("model-name", model.getModelName());
        result.addProperty("model-id", MapSequence.fromMap(parameters).get("model-id"));

        if (!(MapSequence.fromMap(parameters).containsKey("node-id"))) {
          return;
        }
        SNode node = model.getNode(SNodeId.fromString(MapSequence.fromMap(parameters).get("node-id")));
        if (node == null) {
          return;
        }
        result.addProperty("node-name", node.getPresentation());
        result.addProperty("node-id", MapSequence.fromMap(parameters).get("node-id"));
      }
    });

    return result;
  }
}
