package jetbrains.mps.ide.mpsmigration.v33;

/*Generated by MPS */

import jetbrains.mps.migration.global.BaseProjectMigration;
import jetbrains.mps.project.Project;
import org.jetbrains.mps.openapi.persistence.ModelFactory;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import jetbrains.mps.persistence.PersistenceRegistry;
import jetbrains.mps.persistence.FilePerRootModelPersistence;
import org.jetbrains.mps.openapi.module.SearchScope;
import jetbrains.mps.lang.smodel.query.runtime.CommandUtil;
import jetbrains.mps.lang.smodel.query.runtime.QueryExecutionContext;
import jetbrains.mps.persistence.PersistenceVersionAware;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.internal.collections.runtime.IVisitor;
import org.jetbrains.mps.openapi.model.EditableSModel;
import jetbrains.mps.internal.collections.runtime.ISelector;
import org.jetbrains.mps.openapi.persistence.DataSource;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.extapi.persistence.FileDataSource;
import jetbrains.mps.vfs.FileSystem;
import jetbrains.mps.project.MPSExtentions;
import jetbrains.mps.persistence.FilePerRootDataSource;

public class Persistence8Elimination extends BaseProjectMigration {
  public static final String ID = "jetbrains.mps.v8_elimination";

  public Persistence8Elimination() {
    super(Persistence8Elimination.ID);
  }
  @Override
  public String getDescription() {
    return "Migrate v8 models";
  }
  @Override
  public boolean doExecute(Project p) {
    final ModelFactory defaultModelFactory = PersistenceFacade.getInstance().getDefaultModelFactory();
    final ModelFactory perRootModelFactory = PersistenceRegistry.getInstance().getFolderModelFactory(FilePerRootModelPersistence.FACTORY_ID);

    {
      final SearchScope scope = CommandUtil.createScope(p);
      QueryExecutionContext context = new QueryExecutionContext() {
        public SearchScope getDefaultSearchScope() {
          return scope;
        }
      };
      Iterable<PersistenceVersionAware> models = Sequence.fromIterable(CommandUtil.models(CommandUtil.createConsoleScope(null, false, context))).ofType(PersistenceVersionAware.class).where(new IWhereFilter<PersistenceVersionAware>() {
        public boolean accept(PersistenceVersionAware it) {
          return it.getPersistenceVersion() < 9;
        }
      }).where(new IWhereFilter<PersistenceVersionAware>() {
        public boolean accept(PersistenceVersionAware it) {
          return it.getModelFactory() == defaultModelFactory || it.getModelFactory() == perRootModelFactory;
        }
      });

      Sequence.fromIterable(models).visitAll(new IVisitor<PersistenceVersionAware>() {
        public void visit(PersistenceVersionAware model) {
          model.load();
          model.setPersistenceVersion(9);
          ((EditableSModel) model).setChanged(true);
          ((EditableSModel) model).save();
        }
      });

      Sequence.fromIterable(models).select(new ISelector<PersistenceVersionAware, DataSource>() {
        public DataSource select(PersistenceVersionAware it) {
          return it.getSource();
        }
      }).select(new ISelector<DataSource, IFile>() {
        public IFile select(DataSource it) {
          if (it instanceof FileDataSource) {
            IFile modelFile = as_jjkivq_a0a0a0a0a0a0a0a0g0d0e(it, FileDataSource.class).getFile();
            String modelPath = modelFile.getPath();
            return FileSystem.getInstance().getFileByPath(modelPath.substring(0, modelPath.length() - MPSExtentions.DOT_MODEL.length()) + MPSExtentions.DOT_REFACTORINGS);
          } else if (it instanceof FilePerRootDataSource) {
            return as_jjkivq_a0a0a0a0a0a0a0a0g0d0e_0(it, FilePerRootDataSource.class).getFile(MPSExtentions.DOT_REFACTORINGS);
          } else {
            return null;
          }
        }
      }).where(new IWhereFilter<IFile>() {
        public boolean accept(IFile it) {
          return it != null && it.exists();
        }
      }).visitAll(new IVisitor<IFile>() {
        public void visit(IFile it) {
          it.delete();
        }
      });
    }

    return true;
  }
  private static <T> T as_jjkivq_a0a0a0a0a0a0a0a0g0d0e(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
  private static <T> T as_jjkivq_a0a0a0a0a0a0a0a0g0d0e_0(Object o, Class<T> type) {
    return (type.isInstance(o) ? (T) o : null);
  }
}
