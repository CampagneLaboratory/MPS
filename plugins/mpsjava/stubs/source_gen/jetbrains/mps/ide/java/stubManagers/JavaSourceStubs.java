package jetbrains.mps.ide.java.stubManagers;

/*Generated by MPS */

import jetbrains.mps.smodel.persistence.ModelRootManagerBase;
import java.util.Collection;
import jetbrains.mps.smodel.SModelDescriptor;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.project.SModelRoot;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.vfs.FileSystem;
import jetbrains.mps.smodel.LanguageID;
import org.jetbrains.mps.openapi.persistence.ModelRoot;
import jetbrains.mps.project.MPSExtentions;
import jetbrains.mps.smodel.SModelReference;
import jetbrains.mps.stubs.javastub.classpath.StubHelper;
import jetbrains.mps.stubs.BaseStubModelDescriptor;
import jetbrains.mps.smodel.SModelRepository;

public class JavaSourceStubs extends ModelRootManagerBase {
  public JavaSourceStubs() {
  }

  @Override
  public Collection<SModelDescriptor> load(@NotNull SModelRoot modelRoot) {
    List<SModelDescriptor> result = ListSequence.fromList(new ArrayList<SModelDescriptor>());
    IFile file = FileSystem.getInstance().getFileByPath(modelRoot.getPath());
    if (file.exists() && file.isDirectory()) {
      JavaSourceStubs.this.getModelDescriptors(result, "", file, LanguageID.JAVA, modelRoot);
    } else {
      // ... 
      throw new RuntimeException("Java source stubs: " + modelRoot.getPath() + " isn't a good path");
    }
    return result;
  }

  /*package*/ void getModelDescriptors(List<SModelDescriptor> result, String pkg, IFile dir, String languageId, ModelRoot modelRoot) {
    List<IFile> subdirs = ListSequence.fromList(new ArrayList<IFile>());
    List<IFile> files = ListSequence.fromList(new ArrayList<IFile>());
    for (IFile c : ListSequence.fromList(dir.getChildren())) {
      if (c.isDirectory()) {
        ListSequence.fromList(subdirs).addElement(c);
      } else if (c.getName().endsWith(MPSExtentions.DOT_JAVAFILE)) {
        ListSequence.fromList(files).addElement(c);
      }
    }

    // Depth first 

    for (IFile subdir : ListSequence.fromList(subdirs)) {
      String newPkg = (pkg.equals("") ?
        subdir.getName() :
        pkg + "." + subdir.getName()
      );
      JavaSourceStubs.this.getModelDescriptors(result, newPkg, subdir, languageId, modelRoot);
    }

    if (!(files.isEmpty())) {
      SModelReference modelReference = StubHelper.uidForPackageInStubs(pkg, languageId, modelRoot.getModule().getModuleReference());
      BaseStubModelDescriptor smd;

      if (SModelRepository.getInstance().getModelDescriptor(modelReference) != null) {
        SModelDescriptor descriptor = SModelRepository.getInstance().getModelDescriptor(modelReference);
        assert descriptor instanceof BaseStubModelDescriptor;
        smd = (BaseStubModelDescriptor) descriptor;

      } else {

        smd = new JavaSourceStubModelDescriptor(modelReference, new JavaSourceStubModelDS(), modelRoot.getModule());

        for (IFile file : ListSequence.fromList(files)) {
          ((JavaSourceStubModelDescriptor) smd).getSource().addPath(file.getPath(), modelRoot);
        }

      }

      ListSequence.fromList(result).addElement(smd);
    }

  }
}
