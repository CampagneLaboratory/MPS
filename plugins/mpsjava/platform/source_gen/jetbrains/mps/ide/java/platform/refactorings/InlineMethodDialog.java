package jetbrains.mps.ide.java.platform.refactorings;

/*Generated by MPS */

import jetbrains.mps.ide.platform.refactoring.RefactoringDialog;
import jetbrains.mps.smodel.SNode;
import com.intellij.openapi.project.Project;
import jetbrains.mps.smodel.IOperationContext;
import javax.swing.JPanel;
import javax.swing.BoxLayout;
import javax.swing.border.EmptyBorder;
import javax.swing.ButtonGroup;
import javax.swing.JRadioButton;
import java.awt.Component;
import jetbrains.mps.smodel.ModelAccess;
import javax.swing.JOptionPane;
import javax.swing.AbstractAction;
import java.awt.event.ActionEvent;
import org.jetbrains.annotations.Nullable;
import javax.swing.JComponent;
import java.awt.BorderLayout;
import javax.swing.Action;
import javax.swing.JLabel;
import com.intellij.openapi.ui.DialogWrapper;

public class InlineMethodDialog extends RefactoringDialog {
  private String myErrors;
  private InlineMethodDialogModel myModel;
  private InlineMethodDialog.PreviewAction myPreviewAction;

  public InlineMethodDialog(SNode node, Project project, IOperationContext operationContext) {
    super(project, true);
    setTitle("Inline Method");
    setResizable(false);

    this.myModel = new InlineMethodDialogModel(node, operationContext);
    init();
  }

  private JPanel createCheckBoxes() {
    JPanel checkboxesPanel = new JPanel();
    checkboxesPanel.setLayout(new BoxLayout(checkboxesPanel, BoxLayout.Y_AXIS));

    checkboxesPanel.setBorder(new EmptyBorder(10, 0, 0, 0));
    ButtonGroup group = new ButtonGroup();
    JRadioButton button1 = this.createButton(group, checkboxesPanel, false, "Inline this invocation only and keep the method");
    JRadioButton button2 = this.createButton(group, checkboxesPanel, true, "Inline all invocations and remove the method");

    if (myModel.isRecusive()) {
      button2.setEnabled(false);
    }
    if (myModel.getMethodCall() != null) {
      button1.setSelected(true);
      myModel.setForAll(false);
      myPreviewAction.setEnabled(false);
    } else {
      button1.setEnabled(false);
      button2.setSelected(true);
      myModel.setForAll(true);
      myPreviewAction.setEnabled(true);
    }
    return checkboxesPanel;
  }

  public void tryToShow(Component parentComponent) {
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        InlineMethodDialog.this.myErrors = InlineMethodRefactoringAnalyzer.getErrors(InlineMethodDialog.this.myModel);
      }
    });
    if (this.myErrors == null) {
      this.show();
    } else {
      JOptionPane.showMessageDialog(parentComponent, this.myErrors, "Can't perform refactoring", JOptionPane.ERROR_MESSAGE);
    }
  }

  private JRadioButton createButton(ButtonGroup group, JPanel checkboxesPanel, final boolean forAll, String text) {
    JRadioButton button1 = new JRadioButton(new AbstractAction(text) {
      public void actionPerformed(ActionEvent e) {
        InlineMethodDialog.this.myModel.setForAll(forAll);
        myPreviewAction.setEnabled(forAll);
      }
    });
    group.add(button1);
    checkboxesPanel.add(button1);
    return button1;
  }

  @Nullable
  protected JComponent createCenterPanel() {
    JPanel panel = new JPanel(new BorderLayout());
    panel.add(createCheckBoxes(), BorderLayout.CENTER);
    return panel;
  }

  @Override
  protected void createDefaultActions() {
    super.createDefaultActions();
    myPreviewAction = new InlineMethodDialog.PreviewAction();
  }

  @Override
  protected Action[] createActions() {
    return new Action[]{getRefactorAction(), myPreviewAction, getCancelAction()};
  }

  /**
   * This method will be called on pressing "Refactor" button in dialog.
   * 
   */
  protected void doRefactoringAction() {
    myModel.onOk(myProject);
    super.doRefactoringAction();
  }

  @Nullable
  @Override
  protected JComponent createNorthPanel() {
    JLabel label = new JLabel();
    label.setText(myModel.getMethodPresentation());
    return label;
  }

  public class PreviewAction extends DialogWrapper.DialogWrapperAction {
    public PreviewAction() {
      super("Preview");
    }

    protected void doAction(ActionEvent event) {
      myModel.preview(myProject);
      close(DialogWrapper.OK_EXIT_CODE);
    }
  }
}
