package jetbrains.mps.ide.java.platform.refactorings;

/*Generated by MPS */

import com.intellij.openapi.ui.DialogWrapper;
import jetbrains.mps.smodel.IOperationContext;
import java.util.Set;
import jetbrains.mps.smodel.SModelDescriptor;
import com.intellij.ui.treeStructure.SimpleTree;
import org.jetbrains.mps.openapi.model.SNodeReference;
import com.intellij.openapi.project.Project;
import java.awt.HeadlessException;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.project.AbstractModule;
import jetbrains.mps.smodel.SModel;
import jetbrains.mps.smodel.SModelReference;
import jetbrains.mps.smodel.SModelOperations;
import javax.swing.tree.DefaultMutableTreeNode;
import jetbrains.mps.ide.platform.modeltree.ModelTreeNode;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.smodel.SModelStereotype;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.ide.platform.modeltree.ModelTreeBuilder;
import org.jetbrains.annotations.Nullable;
import javax.swing.JComponent;
import javax.swing.tree.DefaultTreeModel;
import javax.swing.tree.TreeSelectionModel;
import jetbrains.mps.ide.platform.modeltree.ModelTreeCellRenderer;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import javax.swing.event.TreeSelectionListener;
import javax.swing.event.TreeSelectionEvent;
import jetbrains.mps.smodel.SNodePointer;
import javax.swing.JScrollPane;
import com.intellij.ui.ScrollPaneFactory;
import java.awt.Dimension;
import org.jetbrains.annotations.NonNls;

public abstract class BaseChooseNodeDialog extends DialogWrapper {
  private IOperationContext myContext;
  private Set<SModelDescriptor> myVisibleModels;
  private SimpleTree myTree;
  private SNodeReference mySelectedNode;

  public BaseChooseNodeDialog(Project project, IOperationContext context, SModelDescriptor contextModel, String title) throws HeadlessException {
    super(project, true);
    setTitle(title);
    myContext = context;
    initVisibleModels(contextModel);

    init();
  }

  protected abstract boolean isAcceptable(SNode node);

  private void initVisibleModels(SModelDescriptor modelDescriptor) {
    myVisibleModels = SetSequence.fromSet(new HashSet<SModelDescriptor>());
    SetSequence.fromSet(myVisibleModels).addElement(modelDescriptor);
    for (SModelDescriptor nextOwnModelDescriptor : ListSequence.fromList(((AbstractModule) modelDescriptor.getModule()).getOwnModelDescriptors())) {
      SetSequence.fromSet(myVisibleModels).addElement(nextOwnModelDescriptor);
    }
    SModel model = modelDescriptor.getSModel();
    for (SModelReference sm : SModelOperations.getImportedModelUIDs(model)) {
      SModelDescriptor importedModelDescriptor = myContext.getScope().getModelDescriptor(sm);
      if (importedModelDescriptor != null) {
        SetSequence.fromSet(myVisibleModels).addElement(importedModelDescriptor);
      }
    }
  }

  private DefaultMutableTreeNode createRootNode() {
    ModelTreeNode rootNode = new ModelTreeNode("Root");
    for (SModelDescriptor descriptor : SetSequence.fromSet(myVisibleModels).where(new IWhereFilter<SModelDescriptor>() {
      public boolean accept(SModelDescriptor it) {
        return !(SModelStereotype.isStubModelStereotype(it.getStereotype()));
      }
    }).sort(new ISelector<SModelDescriptor, String>() {
      public String select(SModelDescriptor it) {
        return it.getSModelReference().toString();
      }
    }, true)) {
      rootNode.add(ModelTreeBuilder.createSModelTreeNode(descriptor));
    }
    return rootNode;
  }

  public SNodeReference getResult() {
    return mySelectedNode;
  }

  @Nullable
  @Override
  protected JComponent createCenterPanel() {
    final DefaultMutableTreeNode rootNode = createRootNode();
    myTree = new SimpleTree(new DefaultTreeModel(rootNode));
    myTree.getSelectionModel().setSelectionMode(TreeSelectionModel.SINGLE_TREE_SELECTION);
    myTree.setCellRenderer(new ModelTreeCellRenderer());
    myTree.setRootVisible(false);
    myTree.setShowsRootHandles(true);
    new ModelTreeBuilder(myTree) {
      @Override
      protected void initTreeNode(final ModelTreeNode node) {
        if (node.getUserObject() instanceof SModelDescriptor) {
          ModelAccess.instance().runReadInEDT(new Runnable() {
            @Override
            public void run() {
              initModelDescriptorNode(node, (SModelDescriptor) node.getUserObject());
            }
          });
        }
      }

      private void initModelDescriptorNode(ModelTreeNode node, SModelDescriptor descriptor) {
        SModel sModel = descriptor.getSModel();
        for (SNode nextRoot : Sequence.fromIterable(ModelTreeBuilder.sortChildNodes(ListSequence.fromList(jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations.getRoots(sModel, "jetbrains.mps.lang.core.structure.BaseConcept")).where(new IWhereFilter<SNode>() {
          public boolean accept(SNode it) {
            return isAcceptable(it);
          }
        })))) {
          ModelTreeNode modelRootTreeNode = ModelTreeBuilder.createSNodeTreeNode(nextRoot);
          modelRootTreeNode.setLeaf(true);
          ModelTreeBuilder.insertChildSNodeTreeNode(node, modelRootTreeNode, SPropertyOperations.getString(nextRoot, "virtualPackage"));
        }

        notifyNodeStructureChanged(node);
      }
    };
    myTree.getSelectionModel().addTreeSelectionListener(new TreeSelectionListener() {
      @Override
      public void valueChanged(TreeSelectionEvent event) {
        Object selectedNode = event.getPath().getLastPathComponent();
        if (selectedNode instanceof ModelTreeNode) {
          ModelTreeNode treeNode = ((ModelTreeNode) selectedNode);
          if (treeNode.getUserObject() instanceof SNodeReference) {
            mySelectedNode = ((SNodePointer) treeNode.getUserObject());
            getOKAction().setEnabled(true);
            return;
          }
        }
        getOKAction().setEnabled(false);
        mySelectedNode = null;
      }
    });

    JScrollPane scrollPane = ScrollPaneFactory.createScrollPane(myTree);
    scrollPane.setPreferredSize(new Dimension(700, 500));
    return scrollPane;
  }

  @Nullable
  @NonNls
  @Override
  protected String getDimensionServiceKey() {
    return getClass().getName();
  }
}
