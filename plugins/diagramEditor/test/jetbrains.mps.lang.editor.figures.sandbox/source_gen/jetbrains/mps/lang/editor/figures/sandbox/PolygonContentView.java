package jetbrains.mps.lang.editor.figures.sandbox;

/*Generated by MPS */

import jetbrains.jetpad.projectional.view.PolygonView;
import jetbrains.jetpad.projectional.view.PolyLineView;
import jetbrains.jetpad.cell.TextCell;
import jetbrains.jetpad.values.Color;
import jetbrains.jetpad.cell.view.CellView;
import jetbrains.jetpad.cell.text.TextEditing;
import jetbrains.jetpad.projectional.view.RectView;
import jetbrains.jetpad.geometry.Vector;
import jetbrains.jetpad.model.event.EventHandler;
import jetbrains.jetpad.model.property.PropertyChangeEvent;
import jetbrains.jetpad.geometry.Rectangle;
import jetbrains.jetpad.mapper.Mapper;
import jetbrains.jetpad.projectional.view.View;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.jetpad.model.property.Property;

public class PolygonContentView extends PolygonView {
  private static final int FOLDING_SIZE = 6;
  private static final int WIDTH = 40;
  private static final int HEIGHT = 50;
  private PolyLineView myPolyLine = new PolyLineView();
  private TextCell myCell = new TextCell();
  private TextCell myMetaTextCell = new TextCell();

  public PolygonContentView() {
    color().set(Color.LIGHT_BLUE);
    children().add(myPolyLine);
    CellView myCellView = new CellView();
    myCell.addTrait(TextEditing.textEditing());
    myCell.textColor().set(Color.GRAY);
    myCellView.cell.set(myCell);
    children().add(myCellView);
    RectView space = new RectView();
    space.background().set(Color.LIGHT_BLUE);
    space.dimension().set(new Vector(0, 5));
    children().add(space);
    CellView metaTextCellView = new CellView();
    metaTextCellView.cell.set(myMetaTextCell);
    myMetaTextCell.bold().set(true);
    children().add(metaTextCellView);
    bounds().addHandler(new EventHandler<PropertyChangeEvent<Rectangle>>() {
      public void onEvent(PropertyChangeEvent<Rectangle> event) {
        adjustPoints(event.getNewValue().dimension.x - 1, event.getNewValue().dimension.y - 1);
      }
    });
    initSynchronizers();
  }

  private void initSynchronizers() {
    new Mapper<PolygonContentView, PolygonContentView>(this, this) {
      @Override
      protected void registerSynchronizers(Mapper.SynchronizersConfiguration configuration) {
        super.registerSynchronizers(configuration);
      }
    }.attachRoot();
  }

  @Override
  protected void doValidate(View.ValidationContext context) {
    super.doValidate(context);
    int width = WIDTH;
    int height = FOLDING_SIZE;
    for (View nextChild : ListSequence.fromList(children())) {
      if (nextChild == myPolyLine || !((nextChild.visible().get()))) {
        continue;
      }
      Rectangle childBounds = nextChild.bounds().get();
      width = Math.max(width, childBounds.dimension.x + FOLDING_SIZE);
      height += childBounds.dimension.y;
    }
    if (height < HEIGHT) {
      height = HEIGHT;
    }
    int yOffset = bounds().get().origin.y + FOLDING_SIZE / 2;
    int xOrigin = bounds().get().origin.x;
    for (View nextChild : ListSequence.fromList(children())) {
      if (nextChild == myPolyLine || !((nextChild.visible().get()))) {
        continue;
      }
      Rectangle childBounds = nextChild.bounds().get();
      nextChild.moveTo(new Vector(xOrigin + (width - childBounds.dimension.x) / 2, yOffset));
      yOffset += childBounds.dimension.y;
    }
    context.bounds(new Rectangle(bounds().get().origin, new Vector(width + 1, height + 1)), baseLine());
    if (!((myPolyLine.valid().get()))) {
      validate();
    }
  }

  private void adjustPoints(int width, int height) {
    points.clear();
    points.add(new Vector(FOLDING_SIZE, 0));
    points.add(new Vector(width, 0));
    points.add(new Vector(width, height));
    points.add(new Vector(0, height));
    points.add(new Vector(0, FOLDING_SIZE));
    points.add(new Vector(FOLDING_SIZE, 0));
    myPolyLine.points.clear();
    myPolyLine.points.add(new Vector(FOLDING_SIZE, 0));
    myPolyLine.points.add(new Vector(width, 0));
    myPolyLine.points.add(new Vector(width, height));
    myPolyLine.points.add(new Vector(0, height));
    myPolyLine.points.add(new Vector(0, FOLDING_SIZE));
    myPolyLine.points.add(new Vector(FOLDING_SIZE, 0));
  }

  public Property<String> text() {
    return myCell.text();
  }

  public Property<String> metaText() {
    return myMetaTextCell.text();
  }


}
