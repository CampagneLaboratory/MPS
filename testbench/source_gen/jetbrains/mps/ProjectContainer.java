package jetbrains.mps;

/*Generated by MPS */

import java.util.Set;
import jetbrains.mps.project.Project;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import javax.swing.SwingUtilities;
import java.io.File;
import org.jetbrains.annotations.NotNull;
import java.io.IOException;
import org.apache.log4j.Priority;
import org.apache.log4j.Logger;
import org.apache.log4j.LogManager;

public class ProjectContainer {
  private Set<Project> myProjects;


  public ProjectContainer() {
    myProjects = SetSequence.fromSet(new HashSet<Project>());
  }



  public void dispose() {
    clear();
  }



  private void clear() {
    try {
      for (final Project project : myProjects) {
        assert project != null && !(project.isDisposed()) : "Project was already disposed";
        SwingUtilities.invokeAndWait(new Runnable() {
          public void run() {
            project.dispose();
          }
        });
      }
    } catch (Exception e) {
      e.printStackTrace();
    }
    SetSequence.fromSet(myProjects).clear();
  }



  public Set<Project> getProjects() {
    return myProjects;
  }



  public Project getProject(File anotherProjectFile) {
    assert containsProject(anotherProjectFile);
    for (Project project : SetSequence.fromSet(myProjects)) {
      if (hasPath(project, anotherProjectFile)) {
        return project;
      }
    }
    assert false : "Could not find the project";
    return null;
  }



  public void addProject(@NotNull Project project) {
    assert !(SetSequence.fromSet(myProjects).contains(project));
    SetSequence.fromSet(this.myProjects).addElement(project);
  }



  public void disposeProject(@NotNull Project project) {
    assert SetSequence.fromSet(myProjects).contains(project);
    SetSequence.fromSet(myProjects).removeElement(project);
    project.dispose();
  }



  public void size() {
    SetSequence.fromSet(myProjects).count();
  }



  public boolean containsProject(File anotherProjectFile) {
    assert myProjects != null;
    for (Project project : SetSequence.fromSet(myProjects)) {
      if (hasPath(project, anotherProjectFile)) {
        return true;
      }
    }
    return false;
  }



  private static boolean hasPath(Project project, File path) {
    File projectFile = project.getProjectFile();
    if (projectFile == null) {
      return false;
    }
    try {
      String myProjectPath = projectFile.getCanonicalPath();
      String newProjectPath = path.getCanonicalPath();
      return myProjectPath.equals(newProjectPath);
    } catch (IOException e) {
      if (LOG.isEnabledFor(Priority.ERROR)) {
        LOG.error("Cannot access the project file in container", e);
      }
    }
    return false;
  }

  protected static Logger LOG = LogManager.getLogger(ProjectContainer.class);
}
