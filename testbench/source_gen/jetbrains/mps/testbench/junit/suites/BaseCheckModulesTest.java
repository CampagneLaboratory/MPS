package jetbrains.mps.testbench.junit.suites;

/*Generated by MPS */

import org.junit.runner.RunWith;
import jetbrains.mps.testbench.junit.runners.ParameterizedMpsTest;
import jetbrains.mps.project.Project;
import org.jetbrains.mps.openapi.module.SModule;
import org.junit.runners.Parameterized;
import java.util.List;
import java.lang.reflect.InvocationTargetException;
import jetbrains.mps.testbench.junit.runners.ContextProjextSupport;
import jetbrains.mps.testbench.junit.runners.MpsTestsSupport;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.Set;
import java.util.HashSet;
import org.junit.AfterClass;

@RunWith(value = ParameterizedMpsTest.class)
public class BaseCheckModulesTest {
  private static CheckingTestStatistic ourStatistic;
  private static Project ourContextProject;
  protected final SModule myModule;

  public BaseCheckModulesTest(SModule module) {
    this.myModule = module;
  }

  @Parameterized.Parameters
  public static List<Object[]> testParameters() throws InvocationTargetException, InterruptedException {
    // load excluded modules from system property, can be specified by MpsTestConfiguration annotation? 
    // MpsTestConfiguration options: env, context project, excluded/included modules/models/nodes, modules type (for generators/constraints)? 
    // can be extended with right modules set 
    return createTestParametersFromModules(contextModules());
  }

  public static Iterable<? extends SModule> contextModules() throws InvocationTargetException, InterruptedException {
    ourStatistic = new CheckingTestStatistic();
    ourContextProject = ContextProjextSupport.getContextProject();
    // todo: exception in case of failed compilation? 
    MpsTestsSupport.makeAllInCreatedEnvironment();
    MpsTestsSupport.reloadAllAfterMake();
    return ourContextProject.getModules();
  }

  public static List<Object[]> createTestParametersFromModules(Iterable<? extends SModule> modules) {
    ArrayList<Object[]> res = new ArrayList<Object[]>();
    for (SModule module : modules) {
      res.add(new Object[]{module});
    }
    Collections.sort(res, new Comparator<Object[]>() {
      @Override
      public int compare(Object[] o1, Object[] o2) {
        return String.valueOf(o1[0]).compareTo(String.valueOf(o2[0]));
      }
    });
    return res;
  }

  public static Set<SModule> excludeModules(Iterable<? extends SModule> modules, Set<String> excludedModules) {
    Set<SModule> result = new HashSet<SModule>();
    for (SModule module : modules) {
      if (!(excludedModules.contains(module.getModuleName()))) {
        result.add(module);
      }
    }
    return result;
  }

  public static Project getContextProject() {
    return ourContextProject;
  }

  public static CheckingTestStatistic getStatistic() {
    return ourStatistic;
  }

  @AfterClass
  public static void cleanUp() {
    // ActiveEnvironment.get().disposeProject(ourContextProject); 
    ourStatistic.printStatistic();
  }
}
