package jetbrains.mps.testbench.junit.suites;

/*Generated by MPS */

import org.junit.runner.RunWith;
import jetbrains.mps.testbench.junit.runners.TeamCityParameterized;
import jetbrains.mps.project.Project;
import org.jetbrains.mps.openapi.module.SModule;
import org.junit.runners.Parameterized;
import java.util.List;
import java.lang.reflect.InvocationTargetException;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.tool.environment.Environment;
import jetbrains.mps.tool.environment.EnvironmentContainer;
import jetbrains.mps.tool.environment.ProjectStrategy;
import jetbrains.mps.testbench.junit.runners.FromDirWithModulesProjectStrategy;
import jetbrains.mps.tool.environment.EnvironmentConfig;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.Set;
import java.util.HashSet;
import org.junit.AfterClass;

@RunWith(value = TeamCityParameterized.class)
public class BaseCheckModulesTest {
  private static CheckingTestStatistic ourStatistic;
  private static Project ourContextProject;
  protected final SModule myModule;
  public BaseCheckModulesTest(SModule module) {
    this.myModule = module;
  }

  @Parameterized.Parameters
  public static List<Object[]> testParameters() throws InvocationTargetException, InterruptedException {
    // load excluded modules from system property, can be specified by MpsTestConfiguration annotation? 
    // MpsTestConfiguration options: env, context project, excluded/included modules/models/nodes, modules type (for generators/constraints)? 
    // can be extended with right modules set 
    initEnvironment(null);
    return createTestParametersFromModules(ourContextProject.getModules());
  }

  protected static void initEnvironment(@Nullable String dir) throws InvocationTargetException, InterruptedException {
    Environment env = EnvironmentContainer.getOrCreate(BaseCheckModulesTest.createConfig());

    ourStatistic = new CheckingTestStatistic();
    ProjectStrategy strategy = (dir == null ? new FromDirWithModulesProjectStrategy() : new FromDirWithModulesProjectStrategy(dir));
    ourContextProject = env.createProject(strategy);
  }

  private static EnvironmentConfig createConfig() {
    return EnvironmentConfig.defaultConfig().loadIdea(false);
  }

  protected static List<Object[]> createTestParametersFromModules(Iterable<? extends SModule> modules) {
    ArrayList<Object[]> res = new ArrayList<Object[]>();
    for (SModule module : modules) {
      res.add(new Object[]{module});
    }
    Collections.sort(res, new Comparator<Object[]>() {
      @Override
      public int compare(Object[] o1, Object[] o2) {
        return String.valueOf(o1[0]).compareTo(String.valueOf(o2[0]));
      }
    });
    return res;
  }

  protected static Set<SModule> excludeModules(Iterable<? extends SModule> modules, Set<String> excludedModules) {
    Set<SModule> result = new HashSet<SModule>();
    for (SModule module : modules) {
      if (!(excludedModules.contains(module.getModuleName()))) {
        result.add(module);
      }
    }
    return result;
  }

  public static Project getContextProject() {
    return ourContextProject;
  }

  public static CheckingTestStatistic getStatistic() {
    return ourStatistic;
  }

  @AfterClass
  public static void cleanUp() {
    ourStatistic.printStatistic();
  }
}
