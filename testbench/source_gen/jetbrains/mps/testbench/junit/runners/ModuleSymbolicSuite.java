package jetbrains.mps.testbench.junit.runners;

/*Generated by MPS */

import jetbrains.mps.project.IModule;
import jetbrains.mps.smodel.MPSModuleRepository;
import org.junit.runner.Description;
import org.junit.runner.Runner;
import org.junit.runner.notification.Failure;
import org.junit.runner.notification.RunNotifier;
import org.junit.runners.ParentRunner;
import org.junit.runners.model.InitializationError;
import org.junit.runners.model.RunnerBuilder;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;
import java.util.ArrayList;
import java.util.List;

public class ModuleSymbolicSuite extends ParentRunner<Runner> {
  private List<Runner> myRunners = new ArrayList<Runner>();
  private String myModuleRef;
  private RunnerBuilder myBuilder;
  private boolean initialized = false;

  public ModuleSymbolicSuite(Class<?> klass, RunnerBuilder builder) throws InitializationError {
    this(builder, klass);
    String[] tests = getAnnotatedTests(klass);
    String[] classes = getAnnotatedClassNames(klass);
    for (int i = 0; i < tests.length && i < classes.length; i++) {
      myRunners.add(new ModuleSymbolicSuite.DelegatingRunner(classes[i], tests[i].split(",")));
    }
    for (String name : classes) {
    }
    this.myModuleRef = getAnnotatedModule(klass);
  }

  protected ModuleSymbolicSuite(RunnerBuilder builder, Class<?> klass) throws InitializationError {
    this(klass);
    this.myBuilder = builder;
  }

  protected ModuleSymbolicSuite(Class<?> klass) throws InitializationError {
    super(klass);
  }

  @Override
  protected List<Runner> getChildren() {
    return myRunners;
  }

  @Override
  protected Description describeChild(Runner child) {
    return child.getDescription();
  }

  @Override
  protected void runChild(Runner child, RunNotifier notifier) {
    if (!(initialized)) {
      initialize();
    }
    child.run(notifier);
  }

  private void initialize() {
    IModule mod = MPSModuleRepository.getInstance().getModule(jetbrains.mps.project.structure.modules.ModuleReference.fromString(myModuleRef));
    for (Runner child : myRunners) {
      ((ModuleSymbolicSuite.DelegatingRunner) child).init(mod, myBuilder);
    }
    this.initialized = true;
  }

  private static String getAnnotatedModule(Class<?> klass) throws InitializationError {
    ModuleSymbolicSuite.ModuleReference mrefAnn = klass.getAnnotation(ModuleSymbolicSuite.ModuleReference.class);
    if (mrefAnn == null) {
      throw new InitializationError(String.format("class '%s' must have a ModuleReference annotation", klass.getName()));
    }
    return mrefAnn.value();
  }

  private static String[] getAnnotatedClassNames(Class<?> klass) throws InitializationError {
    ModuleSymbolicSuite.ModuleClassSymbols symAnn = klass.getAnnotation(ModuleSymbolicSuite.ModuleClassSymbols.class);
    if (symAnn == null) {
      throw new InitializationError(String.format("class '%s' must have a ModuleClassSymbols annotation", klass.getName()));
    }
    return symAnn.classes();
  }

  private static String[] getAnnotatedTests(Class<?> klass) throws InitializationError {
    ModuleSymbolicSuite.ModuleClassSymbols symAnn = klass.getAnnotation(ModuleSymbolicSuite.ModuleClassSymbols.class);
    if (symAnn == null) {
      throw new InitializationError(String.format("class '%s' must have a ModuleClassSymbols annotation", klass.getName()));
    }
    return symAnn.tests();
  }

  public static class DelegatingRunner extends Runner {
    private Runner myDelegate;
    private String myClassName;
    private String[] myTests;

    public DelegatingRunner(String klassName, String[] tests) {
      this.myClassName = klassName;
      this.myTests = tests;
    }

    public void run(RunNotifier notifier) {
      if (myDelegate == null) {
        notifier.fireTestFailure(new Failure(getDescription(), new IllegalStateException("no runner for " + myClassName)));
      } else {
        myDelegate.run(notifier);
      }
    }

    public Description getDescription() {
      if (false && myDelegate != null) {
        return myDelegate.getDescription();
      }
      Description desc = Description.createSuiteDescription(myClassName);
      for (String test : myTests) {
        // this is the only way to construct Description from string 
        desc.addChild(Description.createSuiteDescription(String.format("%s(%s)", test, myClassName)));
      }
      return desc;
    }

    private void init(IModule mod, RunnerBuilder builder) {
      Class klass = mod.getClass(myClassName);
      if (klass != null) {
        this.myDelegate = builder.safeRunnerForClass(klass);
      }
    }
  }

  @Retention(RetentionPolicy.RUNTIME)
  @Target(value = {ElementType.TYPE})
public static   @interface ModuleClassSymbols {
    String[] classes();
    String[] tests();
}

@Retention(RetentionPolicy.RUNTIME)
@Target(value = {ElementType.TYPE})
public static @interface ModuleReference {
  String value();
}
}
