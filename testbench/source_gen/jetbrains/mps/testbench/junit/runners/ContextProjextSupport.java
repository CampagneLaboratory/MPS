package jetbrains.mps.testbench.junit.runners;

/*Generated by MPS */

import jetbrains.mps.project.Project;
import org.jetbrains.annotations.Nullable;
import java.io.File;
import jetbrains.mps.tool.environment.ActiveEnvironment;
import java.util.List;
import jetbrains.mps.library.ModulesMiner;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.smodel.ModuleRepositoryFacade;
import java.util.Set;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.vfs.FileSystem;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;

public class ContextProjextSupport {
  public static String MODULES_ROOT_PROPERTY = "mps.junit.modules.root";
  public static String PROJECT_PATH_PROPERTY = "mps.junit.project";


  public static Project getContextProject() {
    Project project = getProjectFromProjectPath();
    if (project != null) {
      return project;
    }

    project = getProjectFromDirectoryWithModules();
    if (project != null) {
      return project;
    }

    throw new IllegalStateException("can't load context project");
  }



  /**
   * Do not forget set previous context project path after your test!
   * 
   * @return previous context project path
   */
  @Nullable
  public static File setContextProjectPath(@Nullable File projectPath) {
    // todo: create methods like this for modules.root 
    String previous = System.getProperty(PROJECT_PATH_PROPERTY);
    if (projectPath != null) {
      System.setProperty(PROJECT_PATH_PROPERTY, projectPath.getAbsolutePath());
    } else {
      System.clearProperty(PROJECT_PATH_PROPERTY);
    }
    return (previous != null ?
      new File(previous) :
      null
    );
  }

  @Nullable
  private static Project getProjectFromProjectPath() {
    if (System.getProperty(PROJECT_PATH_PROPERTY) == null) {
      return null;
    }
    // todo: check currently opened projects 
    return ActiveEnvironment.get().openProject(new File(System.getProperty(PROJECT_PATH_PROPERTY)));
  }



  @Nullable
  private static Project getProjectFromDirectoryWithModules() {
    if (System.getProperty(MODULES_ROOT_PROPERTY) == null) {
      return null;
    }

    final List<ModulesMiner.ModuleHandle> modules = collectHandles(new File(System.getProperty(MODULES_ROOT_PROPERTY)));
    // todo: check currently opened projects 
    final Project project = ActiveEnvironment.get().createDummyProject();
    ModelAccess.instance().runWriteAction(new Runnable() {
      public void run() {
        for (ModulesMiner.ModuleHandle moduleHandle : ListSequence.fromList(modules)) {
          SModule module = ModuleRepositoryFacade.createModule(moduleHandle, project);
          project.addModule(module.getModuleReference());
        }
      }
    });

    return project;
  }



  private static List<ModulesMiner.ModuleHandle> collectHandles(File rootFolder) {
    // todo: remove 
    Set<IFile> excludes = SetSequence.fromSet(new HashSet<IFile>());
    String mpsDir = System.getProperty("user.dir");
    SetSequence.fromSet(excludes).addElement(FileSystem.getInstance().getFileByPath(mpsDir + File.separator + "IdeaPlugin"));
    // todo: end remove 

    List<ModulesMiner.ModuleHandle> minedHandles = ModulesMiner.getInstance().collectModules(FileSystem.getInstance().getFileByPath(rootFolder.getAbsolutePath()), excludes, false);
    return ListSequence.fromList(minedHandles).where(new IWhereFilter<ModulesMiner.ModuleHandle>() {
      public boolean accept(ModulesMiner.ModuleHandle it) {
        // temporary ignore .iml files 
        return !(it.getFile().getName().endsWith(".iml"));
      }
    }).toListSequence();
  }
}
