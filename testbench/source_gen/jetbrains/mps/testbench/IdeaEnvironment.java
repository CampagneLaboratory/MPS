package jetbrains.mps.testbench;

/*Generated by MPS */

import jetbrains.mps.tool.environment.Environment;
import jetbrains.mps.tool.environment.EnvironmentConfig;
import java.util.Set;
import jetbrains.mps.project.Project;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.tool.environment.ActiveEnvironment;
import org.apache.log4j.BasicConfigurator;
import org.apache.log4j.Logger;
import org.apache.log4j.Level;
import jetbrains.mps.ide.IdeMain;
import jetbrains.mps.TestMain;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.io.File;
import com.intellij.openapi.project.ex.ProjectManagerEx;
import com.intellij.openapi.project.ProjectManager;
import jetbrains.mps.project.StandaloneMPSProject;
import jetbrains.mps.util.FileUtil;
import jetbrains.mps.project.structure.project.ProjectDescriptor;
import jetbrains.mps.ide.ThreadUtils;
import com.intellij.ide.IdeEventQueue;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.smodel.DefaultModelAccess;
import jetbrains.mps.tool.common.util.PathUtil;
import com.intellij.openapi.application.PathMacros;

public class IdeaEnvironment implements Environment {
  private final EnvironmentConfig config;
  private final Set<Project> openedProjects = SetSequence.fromSet(new HashSet<Project>());


  public IdeaEnvironment(EnvironmentConfig config) {
    this.config = config;

    // todo: if creationg of environment fails? is it publication before we need it? 
    ActiveEnvironment.activateEnvironment(this);

    // todo: use plugins and libs 

    // part from ProjectTest 
    BasicConfigurator.configure();
    Logger.getRootLogger().setLevel(Level.ERROR);
    IdeMain.setTestMode(IdeMain.TestMode.CORE_TEST);

    // todo: inline 
    TestMain.configureMPS(SetSequence.fromSet(config.plugins()).toGenericArray(String.class));
    Testbench.initLibs();

    // todo: is it right place? 
    for (String macro : SetSequence.fromSet(MapSequence.fromMap(config.macros()).keySet())) {
      setMacro(macro, MapSequence.fromMap(config.macros()).get(macro));
    }
  }



  public EnvironmentConfig getConfig() {
    return config;
  }

  public boolean hasIdeaInstance() {
    return true;
  }



  public Project openProject(File projectFile) {
    // part from ProjectTest 
    // todo: inline 
    Project project = TestMain.loadProject(projectFile);
    return SetSequence.fromSet(openedProjects).addElement(project);
  }

  public Project createDummyProject() {
    ProjectManagerEx.getInstanceEx();
    // from CheckProjectStructureHelper 
    com.intellij.openapi.project.Project ideaProject = ProjectManager.getInstance().getDefaultProject();
    StandaloneMPSProject project = new StandaloneMPSProject(ideaProject);
    File projectFile = FileUtil.createTmpFile();
    project.setProjectFile(projectFile);
    projectFile.deleteOnExit();
    project.init(new ProjectDescriptor());
    project.projectOpened();

    SetSequence.fromSet(openedProjects).addElement(project);
    return project;
  }

  public void disposeProject(final Project project) {
    ((StandaloneMPSProject) project).projectClosed();

    // part from ProjectTest 
    ThreadUtils.runInUIThreadAndWait(new Runnable() {
      public void run() {
        project.dispose();
        IdeEventQueue.getInstance().flushQueue();
        System.gc();
      }
    });
    // comment from ProjectTest: magic 
    ModelAccess.instance().flushEventQueue();
    ThreadUtils.runInUIThreadAndWait(new Runnable() {
      public void run() {
        IdeEventQueue.getInstance().flushQueue();
      }
    });

    SetSequence.fromSet(openedProjects).removeElement(project);
  }

  public void disposeEnvironment() {
    // from ModuleTestSuite 
    TestMain.PROJECT_CONTAINER.clear();

    for (Project project : SetSequence.fromSetWithValues(new HashSet<Project>(), openedProjects)) {
      disposeProject(project);
    }

    // todo: fix it in right way 
    ModelAccess.setInstance(new DefaultModelAccess());

    // part from ProjectTest 
    TestMain.disposeMPS();

    ActiveEnvironment.deactivateEnvironment(this);
  }



  private void setMacro(String macroName, File file) {
    // todo: move canonicalization logic to EnvironmentBuilder on addMacro, or in utils? 
    String canonicalPath = PathUtil.getCanonicalPath(file.getPath());
    File canonicalFile = new File(canonicalPath);
    if (canonicalFile.exists() && canonicalFile.isDirectory()) {
      PathMacros.getInstance().setMacro(macroName, canonicalPath);
    }
  }
}
