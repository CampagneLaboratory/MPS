package jetbrains.mps.testbench;

/*Generated by MPS */

import jetbrains.mps.testbench.junit.suites.BaseCheckModulesTest;
import java.util.List;
import org.junit.runners.model.FrameworkMethod;
import org.junit.runners.model.TestClass;
import org.junit.Test;
import java.util.ArrayList;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.util.Computable;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.util.SNodeOperations;
import org.junit.Rule;
import org.junit.rules.TestWatchman;
import jetbrains.mps.testbench.junit.Order;
import org.junit.Assert;
import jetbrains.mps.internal.collections.runtime.IterableUtils;

public class ProjectTest extends BaseCheckModulesTest {
  private static List<FrameworkMethod> METHODS = new TestClass(ProjectTest.class).getAnnotatedMethods(Test.class);
  private List<FrameworkMethod> methods = new ArrayList<FrameworkMethod>();
  private GenerationResult generationResult;
  private boolean needGeneration;

  public ProjectTest(final SModule module) {
    super(module);
    this.methods.addAll(METHODS);
    needGeneration = ModelAccess.instance().runReadAction(new Computable<Boolean>() {
      @Override
      public Boolean compute() {
        for (SModel descriptor : module.getModels()) {
          if (SNodeOperations.isGeneratable(descriptor)) {
            return true;
          }
        }
        return false;
      }
    });
  }

  @Rule
  public TestWatchman watchman = new TestWatchman() {
    @Override
    public void finished(FrameworkMethod method) {
      methods.remove(method);
      if (methods.size() == 0) {
        generationResult.cleanUp();
      }
    }
  };

  @Test
  @Order(value = 1)
  public void buildModule() throws Exception {
    if (!(needGeneration)) {
      return;
    }

    generationResult = ModelAccess.instance().runReadAction(new Computable<GenerationResult>() {
      @Override
      public GenerationResult compute() {
        return GenerationResult.generateModule(myModule, BaseCheckModulesTest.getContextProject());
      }
    });

    if (!(generationResult.isBuildSucessful())) {
      List<String> errors = generationResult.buildErrors();
      Assert.assertTrue("Build errors:\n" + IterableUtils.join(errors, "\n"), errors.isEmpty());
      List<String> warns = generationResult.buildWarns();
      Assert.assertTrue("Build warnings:\n" + IterableUtils.join(warns, "\n"), warns.isEmpty());
    }
  }

  @Test
  @Order(value = 2)
  public void diffModule() throws Exception {
    if (!(needGeneration)) {
      return;
    }
    List<String> diffReport = generationResult.diff();
    Assert.assertTrue("Difference:\n" + IterableUtils.join(diffReport, "\n"), diffReport.isEmpty());
  }
}
