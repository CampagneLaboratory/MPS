package jetbrains.mps.testbench.suite.pluginSolution.plugin;

/*Generated by MPS */

import jetbrains.mps.workbench.action.BaseAction;
import javax.swing.Icon;
import com.intellij.openapi.actionSystem.AnActionEvent;
import java.util.Map;
import org.jetbrains.mps.openapi.language.SLanguage;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import jetbrains.mps.smodel.adapter.ids.MetaIdFactory;
import jetbrains.mps.InternalFlag;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import jetbrains.mps.smodel.SModelInternal;
import org.jetbrains.annotations.NotNull;
import com.intellij.openapi.project.Project;
import com.intellij.openapi.actionSystem.CommonDataKeys;
import jetbrains.mps.ide.actions.MPSCommonDataKeys;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import com.intellij.ide.IdeEventQueue;
import com.intellij.openapi.progress.ProgressManager;
import com.intellij.openapi.progress.ProgressIndicator;
import org.apache.log4j.Logger;
import org.apache.log4j.LogManager;
import java.util.List;
import org.jetbrains.mps.openapi.module.SModuleReference;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.smodel.ModuleRepositoryFacade;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.ide.ThreadUtils;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.project.AbstractModule;
import jetbrains.mps.smodel.SModelStereotype;
import org.jetbrains.mps.openapi.model.EditableSModel;
import jetbrains.mps.project.Solution;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.ISelector;
import com.intellij.openapi.wm.IdeFrame;
import com.intellij.openapi.wm.WindowManager;
import jetbrains.mps.smodel.behaviour.BehaviorReflection;

public class CollectTests_Action extends BaseAction {
  private static final Icon ICON = null;
  public CollectTests_Action() {
    super("Collect Tests", "", ICON);
    this.setIsAlwaysVisible(false);
    this.setExecuteOutsideCommand(true);
  }
  @Override
  public boolean isDumbAware() {
    return true;
  }
  public boolean isApplicable(AnActionEvent event, final Map<String, Object> _params) {
    final SLanguage lang = MetaAdapterFactory.getLanguage(MetaIdFactory.langId(0xd3c5a46fb8c247dbL, 0xad0a30b8f19c2055L), "jetbrains.mps.testbench.suite", -1);
    return InternalFlag.isInternalMode() && CollectTests_Action.this.isUserEditableModel(((SModel) MapSequence.fromMap(_params).get("modelDesc")), _params) && ((SModelInternal) ((SModel) MapSequence.fromMap(_params).get("modelDesc"))).importedLanguageIds().contains(lang);
  }
  public void doUpdate(@NotNull AnActionEvent event, final Map<String, Object> _params) {
    {
      boolean enabled = this.isApplicable(event, _params);
      this.setEnabledState(event.getPresentation(), enabled);
    }
  }
  protected boolean collectActionData(AnActionEvent event, final Map<String, Object> _params) {
    if (!(super.collectActionData(event, _params))) {
      return false;
    }
    {
      Project p = event.getData(CommonDataKeys.PROJECT);
      MapSequence.fromMap(_params).put("project", p);
      if (p == null) {
        return false;
      }
    }
    {
      SModel p = event.getData(MPSCommonDataKeys.MODEL);
      MapSequence.fromMap(_params).put("modelDesc", p);
      if (p == null) {
        return false;
      }
    }
    return true;
  }
  public void doExecute(@NotNull final AnActionEvent event, final Map<String, Object> _params) {
    final Wrappers._boolean done = new Wrappers._boolean(false);
    IdeEventQueue.getInstance().flushQueue();
    ProgressManager.getInstance().runProcessWithProgressSynchronously(new Runnable() {
      public void run() {
        ProgressIndicator proInd = ProgressManager.getInstance().getProgressIndicator();
        proInd.pushState();
        try {
          done.value = CollectTests_Action.this.doExecute(proInd, _params);
        } finally {
          proInd.popState();
        }
      }
    }, "Collecting Tests", true, ((Project) MapSequence.fromMap(_params).get("project")));
    if (!(done.value)) {
      CollectTests_Action.this.displayInfo("Collect Tests action cancelled", _params);
    }
  }
  private boolean doExecute(ProgressIndicator proInd, final Map<String, Object> _params) {
    final Logger LOG = LogManager.getLogger("jetbrains.mps.testbench.suite");
    final SModel model = ((SModel) MapSequence.fromMap(_params).get("modelDesc"));
    final Wrappers._T<List<SModuleReference>> solutions = new Wrappers._T<List<SModuleReference>>();
    final Wrappers._T<List<SModuleReference>> existing = new Wrappers._T<List<SModuleReference>>();
    ProjectHelper.getModelAccess(((Project) MapSequence.fromMap(_params).get("project"))).runReadAction(new Runnable() {
      public void run() {
        solutions.value = CollectTests_Action.this.allSolutions(_params);
        existing.value = CollectTests_Action.this.existingSolutions(model, _params);
      }
    });
    ListSequence.fromList(solutions.value).removeSequence(ListSequence.fromList(existing.value));

    int done = 0;
    for (SModuleReference mref : solutions.value) {
      if (proInd.isCanceled()) {
        return false;
      }
      proInd.setText("Processing " + mref.getModuleName());
      final SModule module = ModuleRepositoryFacade.getInstance().getModule(mref);
      if (module != null) {
        final Wrappers._T<SNode> suite = new Wrappers._T<SNode>(null);
        for (final SModel smodel : module.getModels()) {
          if (!(CollectTests_Action.this.isUserEditableGeneratableModel(smodel, _params))) {
            continue;
          }


          if (new TestCollector().collectTests(smodel, new _FunctionTypes._void_P1_E0<_FunctionTypes._return_P0_E0<? extends SNode>>() {
            public void invoke(final _FunctionTypes._return_P0_E0<? extends SNode> tref) {
              ThreadUtils.runInUIThreadAndWait(new Runnable() {
                public void run() {
                  ProjectHelper.getModelAccess(((Project) MapSequence.fromMap(_params).get("project"))).executeCommand(new Runnable() {
                    public void run() {
                      if (suite.value == null) {
                        suite.value = SModelOperations.createNewRootNode(model, SNodeOperations.asInstanceConcept(MetaAdapterFactory.getConcept(0xd3c5a46fb8c247dbL, 0xad0a30b8f19c2055L, 0x3e81ed1e2be77cb5L, "jetbrains.mps.testbench.suite.structure.ModuleSuite")));
                        SNode sref = SLinkOperations.setNewChild(suite.value, MetaAdapterFactory.getContainmentLink(0xd3c5a46fb8c247dbL, 0xad0a30b8f19c2055L, 0x3e81ed1e2be77cb5L, 0x11c3fc56a6d1cc88L, "moduleRef"), SNodeOperations.asInstanceConcept(MetaAdapterFactory.getConcept(0xd3c5a46fb8c247dbL, 0xad0a30b8f19c2055L, 0x11c3fc56a6d1cbdcL, "jetbrains.mps.testbench.suite.structure.SolutionRef")));
                        SModuleReference mref = module.getModuleReference();
                        SPropertyOperations.set(sref, MetaAdapterFactory.getProperty(0xd3c5a46fb8c247dbL, 0xad0a30b8f19c2055L, 0x11c3fc56a6d1cbdcL, 0x11c3fc56a6d1cbddL, "moduleFQName"), mref.getModuleName());
                        SPropertyOperations.set(sref, MetaAdapterFactory.getProperty(0xd3c5a46fb8c247dbL, 0xad0a30b8f19c2055L, 0x11c3fc56a6d1cbdcL, 0x11c3fc56a6d1cbdeL, "moduleID"), mref.getModuleId().toString());
                      }
                      ListSequence.fromList(SLinkOperations.getChildren(suite.value, MetaAdapterFactory.getContainmentLink(0xd3c5a46fb8c247dbL, 0xad0a30b8f19c2055L, 0x3e81ed1e2be77cb5L, 0x3e81ed1e2be77cbeL, "testRef"))).addElement(tref.invoke());
                      ((SModelInternal) model).addModelImport(smodel.getReference(), false);
                      ((AbstractModule) ((SModel) MapSequence.fromMap(_params).get("modelDesc")).getModule()).addDependency(module.getModuleReference(), false);
                    }
                  });
                }
              });
            }
          })) {
            // huh? 
          }
        }
      }
      proInd.setFraction(((double) ++done) / ListSequence.fromList(solutions.value).count());
    }
    return true;
  }
  private boolean isUserEditableModel(SModel md, final Map<String, Object> _params) {
    if (!(SModelStereotype.isUserModel(md))) {
      return false;
    }
    return md instanceof EditableSModel && !(md.isReadOnly());
  }
  private boolean isUserEditableGeneratableModel(SModel md, final Map<String, Object> _params) {
    return CollectTests_Action.this.isUserEditableModel(md, _params) && jetbrains.mps.util.SNodeOperations.isGeneratable(md);
  }
  private List<SModuleReference> allSolutions(final Map<String, Object> _params) {
    Iterable<Solution> allSolutions = ModuleRepositoryFacade.getInstance().getAllModules(Solution.class);
    return Sequence.fromIterable(allSolutions).select(new ISelector<Solution, SModuleReference>() {
      public SModuleReference select(Solution s) {
        return s.getModuleReference();
      }
    }).toListSequence();
  }
  private void displayInfo(String info, final Map<String, Object> _params) {
    IdeFrame frame = WindowManager.getInstance().getIdeFrame(((Project) MapSequence.fromMap(_params).get("project")));
    if (frame != null) {
      frame.getStatusBar().setInfo(info);
    }
  }
  private List<SModuleReference> existingSolutions(SModel model, final Map<String, Object> _params) {
    return ListSequence.fromList(SModelOperations.roots(model, MetaAdapterFactory.getConcept(0xd3c5a46fb8c247dbL, 0xad0a30b8f19c2055L, 0x3e81ed1e2be77cb5L, "jetbrains.mps.testbench.suite.structure.ModuleSuite"))).select(new ISelector<SNode, SModuleReference>() {
      public SModuleReference select(SNode ms) {
        return BehaviorReflection.invokeVirtual(SModuleReference.class, SLinkOperations.getTarget(ms, MetaAdapterFactory.getContainmentLink(0xd3c5a46fb8c247dbL, 0xad0a30b8f19c2055L, 0x3e81ed1e2be77cb5L, 0x11c3fc56a6d1cc88L, "moduleRef")), "virtual_moduleReference_1280144168199513544", new Object[]{});
      }
    }).toListSequence();
  }
}
