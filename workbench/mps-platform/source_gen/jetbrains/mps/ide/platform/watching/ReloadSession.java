package jetbrains.mps.ide.platform.watching;

/*Generated by MPS */

import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.progress.ProgressMonitor;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.progress.SubProgressKind;
import jetbrains.mps.classloading.ClassLoaderManager;
import jetbrains.mps.progress.EmptyProgressMonitor;
import jetbrains.mps.logging.Logger;

public class ReloadSession {
  private final Set<FSChangesWatcher.IReloadListener> myReloadListeners;
  private boolean myReloaded = false;
  private Set<FileProcessor> myFileProcessors = SetSequence.fromSet(new HashSet<FileProcessor>());

  public ReloadSession(Set<FSChangesWatcher.IReloadListener> reloadListeners, Set<FileProcessor> processors) {
    myReloadListeners = SetSequence.fromSetWithValues(new HashSet<FSChangesWatcher.IReloadListener>(), reloadListeners);
    myFileProcessors = SetSequence.fromSetWithValues(new HashSet<FileProcessor>(), processors);
  }



  public ReloadSession(Set<FSChangesWatcher.IReloadListener> reloadListeners) {
    this(reloadListeners, null);
  }

  public void addProcessor(FileProcessor processor) {
    SetSequence.fromSet(myFileProcessors).addElement(processor);
  }



  public FileProcessor[] getProcessors() {
    return SetSequence.fromSet(myFileProcessors).toGenericArray(FileProcessor.class);
  }

  public boolean isEmpty() {
    for (FileProcessor p : getProcessors()) {
      if (!(p.isEmpty())) {
        return false;
      }
    }
    return true;

  }

  public void doReload(final ProgressMonitor monitor) {
    assert !(myReloaded) : "Contract: do not call doReload twice on one reload session";
    myReloaded = true;

    monitor.start("Reloading ...", 2);
    fireReloadStarted();
    try {
      ModelAccess.instance().runWriteAction(new Runnable() {
        public void run() {
          int work = 1;
          for (FileProcessor fileProcessor : getProcessors()) {
            fileProcessor.update(monitor.subTask(work++, SubProgressKind.REPLACING));
          }

          if (ClassLoaderManager.getInstance().isReloadRequested()) {
            monitor.subTask(1, SubProgressKind.REPLACING).start("Reloading classes... Please wait.", 1);
            ClassLoaderManager.getInstance().reloadAll(new EmptyProgressMonitor());
          }
        }
      });
    } finally {
      LOG.info("Reload finished.");
      monitor.done();
      fireReloadFinished();
    }
  }

  private void fireReloadStarted() {
    for (FSChangesWatcher.IReloadListener l : myReloadListeners) {
      l.reloadStarted();
    }
  }

  private void fireReloadFinished() {
    for (FSChangesWatcher.IReloadListener l : myReloadListeners) {
      l.reloadFinished();
    }
  }

  private static Logger LOG = Logger.getLogger(ReloadSession.class);
}
