package jetbrains.mps.ide.platform.watching;

/*Generated by MPS */

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import com.intellij.openapi.progress.ProgressIndicator;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.reloading.ClassLoaderManager;
import jetbrains.mps.progress.EmptyProgressMonitor;

public class ReloadSession {
  protected static Log log = LogFactory.getLog(ReloadSession.class);

  private final Set<FSChangesWatcher.IReloadListener> myReloadListeners;
  private boolean myReloaded = false;
  private ModelFileProcessor myModelProcessor = new ModelFileProcessor();
  private ModuleFileProcessor myModuleProcessor = new ModuleFileProcessor();

  public ReloadSession(Set<FSChangesWatcher.IReloadListener> reloadListeners) {
    myReloadListeners = SetSequence.fromSetWithValues(new HashSet<FSChangesWatcher.IReloadListener>(), reloadListeners);
  }

  public EventProcessor[] getProcessors() {
    return new EventProcessor[]{myModuleProcessor, myModelProcessor};
  }

  public boolean isEmpty() {
    for (EventProcessor p : getProcessors()) {
      if (!(p.isEmpty())) {
        return false;
      }
    }
    return true;
  }

  public void doReload(final ProgressIndicator indicator) {
    assert !(myReloaded) : "Contract: do not call doReload twice on one reload session";
    myReloaded = true;

    fireReloadStarted();
    try {
      ModelAccess.instance().runWriteAction(new Runnable() {
        public void run() {
          myModuleProcessor.update(indicator);

          myModelProcessor.validateModules(myModuleProcessor.getProcessedModules());
          myModelProcessor.update(indicator);

          if (myModuleProcessor.needsReload()) {
            indicator.setText("Reloading classes... Please wait.");
            ClassLoaderManager.getInstance().reloadAll(new EmptyProgressMonitor());
          }
        }
      });
    } finally {
      if (log.isInfoEnabled()) {
        log.info("Reload finished.");
      }
      fireReloadFinished();
    }
  }

  private void fireReloadStarted() {
    for (FSChangesWatcher.IReloadListener l : myReloadListeners) {
      l.reloadStarted();
    }
  }

  private void fireReloadFinished() {
    for (FSChangesWatcher.IReloadListener l : myReloadListeners) {
      l.reloadFinished();
    }
  }
}
