package jetbrains.mps.ide.script.plugin;

/*Generated by MPS */

import jetbrains.mps.ide.script.plugin.migrationtool.MigrationScriptsTool;
import jetbrains.mps.project.GlobalScope;
import jetbrains.mps.project.IModule;
import jetbrains.mps.smodel.BaseScope;
import jetbrains.mps.smodel.Generator;
import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.smodel.IScope;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.smodel.SModelDescriptor;
import jetbrains.mps.smodel.SModelStereotype;
import jetbrains.mps.smodel.descriptor.EditableSModelDescriptor;
import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.module.SModule;

import java.util.LinkedHashSet;
import java.util.List;
import java.util.Set;

public abstract class AbstractMigrationScriptHelper {
  public AbstractMigrationScriptHelper() {
  }

  public static void doRunScripts(List<SNode> scripts, IScope scope, IOperationContext context) {
    context.getComponent(MigrationScriptsTool.class).startMigration(scripts, scope, context);
  }

  public static IScope createMigrationScope(List<SModelDescriptor> models, List<IModule> modules, boolean applyToSelection) {
    AbstractMigrationScriptHelper.MigrationScope migrationScope = new AbstractMigrationScriptHelper.MigrationScope();
    if (applyToSelection) {
      for (SModelDescriptor model : models) {
        migrationScope.addModel(model);
      }
      for (IModule module : modules) {
        migrationScope.addModule(module);
        if (module instanceof Language) {
          Language language = (Language) module;
          for (Generator generator : language.getGenerators()) {
            migrationScope.addModule(generator);
          }
        }
      }
    }
    // TODO: why global scope??? 
    if (migrationScope.isEmpty()) {
      for (IModule module : GlobalScope.getInstance().getVisibleModules()) {
        migrationScope.addModule(module);
      }
    }
    return migrationScope;
  }

  public static IScope createMigrationScope(List<SModelDescriptor> models, List<IModule> modules) {
    AbstractMigrationScriptHelper.MigrationScope migrationScope = new AbstractMigrationScriptHelper.MigrationScope();
    for (SModelDescriptor model : models) {
      migrationScope.addModel(model);
    }
    for (IModule module : modules) {
      migrationScope.addModule(module);
      if (module instanceof Language) {
        Language language = (Language) module;
        for (Generator generator : language.getGenerators()) {
          migrationScope.addModule(generator);
        }
      }
    }
    return migrationScope;
  }

  private static class MigrationScope extends BaseScope {
    private Set<SModelDescriptor> myModels = new LinkedHashSet<SModelDescriptor>();

    private MigrationScope() {
    }

    public void addModel(SModelDescriptor model) {
      if (!((model instanceof EditableSModelDescriptor))) {
        return;
      }
      if (((EditableSModelDescriptor) model).isReadOnly()) {
        return;
      }
      if (model.getStereotype() != null) {
        if (model.getStereotype().equals(SModelStereotype.INTERNAL) || model.getStereotype().equals(SModelStereotype.INTERNAL_COPY) || SModelStereotype.isStubModelStereotype(model.getStereotype())) {
          return;
        }
      }
      myModels.add(model);
    }

    public void addModule(IModule module) {
      if (!(module.isPackaged())) {
        for (SModelDescriptor model : module.getOwnModelDescriptors()) {
          addModel(model);
        }
      }
    }

    @Override
    public Iterable<SModule> getModules() {
      throw new UnsupportedOperationException();
    }

    @Override
    public Iterable<SModel> getModels() {
      return (Iterable) myModels;
    }

    public boolean isEmpty() {
      return myModels.isEmpty();
    }
  }
}
