package jetbrains.mps.ide.script.plugin.migrationtool;

/*Generated by MPS */

import java.util.Collection;
import jetbrains.mps.ide.findusages.model.SearchResult;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.List;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.ide.ThreadUtils;
import java.util.ArrayList;
import java.util.Set;
import java.util.HashSet;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.smodel.SNodePointer;
import jetbrains.mps.smodel.MPSModuleRepository;
import java.util.Collections;
import jetbrains.mps.progress.ProgressMonitor;
import jetbrains.mps.lang.script.runtime.AbstractMigrationRefactoring;
import jetbrains.mps.lang.script.runtime.MigrationScriptUtil;

public abstract class MigrationScriptsController {
  private final MigrationScriptFinder myFinder;

  public MigrationScriptsController(MigrationScriptFinder finder) {
    myFinder = finder;
  }

  public Collection<SearchResult<SNode>> computeAliveIncludedResults(final List<SNodeReference> includedResultNodes) {
    ThreadUtils.assertEDT();
    final List<SearchResult<SNode>> aliveIncludedResults = new ArrayList<SearchResult<SNode>>();
    final Set aliveIncludedNodes = new HashSet<SNode>();
    ModelAccess.instance().runReadAction(new Runnable() {
      @Override
      public void run() {
        List<SNodeReference> includedNodes = includedResultNodes;
        for (SNodeReference includedNode : includedNodes) {
          if (((SNodePointer) includedNode).resolve(MPSModuleRepository.getInstance()) != null) {
            aliveIncludedNodes.add(((SNodePointer) includedNode).resolve(MPSModuleRepository.getInstance()));
          }
        }
        List<SearchResult<SNode>> aliveResults = myFinder.getLastSearchResults().getAliveResults();
        for (SearchResult aliveResult : aliveResults) {
          if (aliveIncludedNodes.contains(aliveResult.getObject())) {
            aliveIncludedResults.add(aliveResult);
          }
        }
      }
    });
    return Collections.unmodifiableCollection(aliveIncludedResults);
  }

  public void process(final ProgressMonitor pmonitor, final Collection<SearchResult<SNode>> searchResults) {
    pmonitor.start("", searchResults.size());
    for (final SearchResult<SNode> seachResult : searchResults) {
      runCommand(new Runnable() {
        @Override
        public void run() {
          pmonitor.advance(1);
        }
      });
      runCommand(new Runnable() {
        public void run() {
          final SNode node = seachResult.getObject();
          if (node == null || node.getModel() == null) {
            return;
          }

          final AbstractMigrationRefactoring migrationRefactoring = myFinder.getRefactoring(seachResult);
          if (!(MigrationScriptUtil.isApplicableRefactoring(node, migrationRefactoring))) {
            return;
          }

          MigrationScriptUtil.performRefactoring(node, migrationRefactoring);
        }
      });

    }
    runCommand(new Runnable() {
      @Override
      public void run() {
        pmonitor.done();
      }
    });
  }

  public abstract void runCommand(Runnable cmd);
}
