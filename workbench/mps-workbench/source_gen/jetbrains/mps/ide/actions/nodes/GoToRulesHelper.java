package jetbrains.mps.ide.actions.nodes;

/*Generated by MPS */

import java.awt.Frame;
import jetbrains.mps.openapi.editor.cells.EditorCell;
import jetbrains.mps.smodel.IOperationContext;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.List;
import jetbrains.mps.openapi.navigation.NavigationSupport;
import jetbrains.mps.util.SNodeOperations;
import jetbrains.mps.smodel.Language;
import java.util.Collections;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.smodel.LanguageAspect;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.util.NameUtil;
import jetbrains.mps.smodel.ModuleRepositoryFacade;
import jetbrains.mps.kernel.model.SModelUtil;
import javax.swing.JPopupMenu;
import java.awt.Color;
import javax.swing.JLabel;
import javax.swing.SwingConstants;
import javax.swing.border.EmptyBorder;
import javax.swing.AbstractAction;
import javax.swing.Action;
import jetbrains.mps.ide.icons.IconManager;
import java.awt.event.ActionEvent;
import jetbrains.mps.smodel.ModelAccess;

public class GoToRulesHelper {
  public GoToRulesHelper() {
  }

  public static void go(Frame frame, EditorCell cell, IOperationContext context, SNode concept) {
    List<SNode> rules = getRules(concept, false);
    if (rules.size() == 1) {
      SNode nodeToSelect = rules.get(0);
      if ((nodeToSelect != null)) {
        NavigationSupport.getInstance().openNode(context, nodeToSelect, true, !(SNodeOperations.isRoot(nodeToSelect)));
      }
      return;
    }
    GoToRulesHelper.MyMenu m = new GoToRulesHelper.MyMenu(rules, context);
    int x = 0;
    int y = 0;
    if (cell != null) {
      x = cell.getX();
      y = cell.getY();
    }
    m.show(frame, x, y);
  }

  public static List<SNode> getRules(final SNode concept, final boolean exactConcept) {
    Language language = getDeclaringLanguage(concept);
    if (language == null) {
      return Collections.emptyList();
    }
    SModel typesystem = LanguageAspect.TYPESYSTEM.get(language);
    if (typesystem == null) {
      return Collections.emptyList();
    }

    // todo: populate rules from other typesystem models! 
    List<SNode> rules = ListSequence.fromList(SModelOperations.getRoots(typesystem, "jetbrains.mps.lang.typesystem.structure.AbstractRule")).where(new IWhereFilter<SNode>() {
      public boolean accept(SNode node) {
        return isApplicable(node, concept, exactConcept);
      }
    }).toListSequence();

    List<SNode> overriding = ListSequence.fromList(rules).where(new IWhereFilter<SNode>() {
      public boolean accept(SNode it) {
        return jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.isInstanceOf(it, "jetbrains.mps.lang.typesystem.structure.InferenceRule");
      }
    }).select(new ISelector<SNode, SNode>() {
      public SNode select(SNode it) {
        return jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.cast(it, "jetbrains.mps.lang.typesystem.structure.InferenceRule");
      }
    }).where(new IWhereFilter<SNode>() {
      public boolean accept(SNode it) {
        return SPropertyOperations.getBoolean(it, "overrides");
      }
    }).toListSequence();

    for (SNode overridingRule : overriding) {
      final SNode subConcept = getApplicableConcept(SLinkOperations.getTarget(overridingRule, "applicableNode", true));
      ListSequence.fromList(rules).removeWhere(new IWhereFilter<SNode>() {
        public boolean accept(SNode it) {
          return getApplicableConcept(SLinkOperations.getTarget(it, "applicableNode", true)) == subConcept;
        }
      });
    }

    return rules;
  }

  private static Language getDeclaringLanguage(SNode concept) {
    String languageFqName = NameUtil.namespaceFromConceptFQName(NameUtil.nodeFQName(concept));
    if (languageFqName == null) {
      return null;
    }
    return ModuleRepositoryFacade.getInstance().getModule(languageFqName, Language.class);
  }

  private static boolean isApplicable(SNode rule, SNode concept, boolean exactConcept) {
    if ((rule == null) || (concept == null)) {
      return false;
    }
    SNode applicableConcept = getApplicableConcept(SLinkOperations.getTarget(rule, "applicableNode", true));
    if (applicableConcept == null) {
      return false;
    }
    if (exactConcept) {
      return concept == applicableConcept;
    }
    return SModelUtil.isAssignableConcept(concept, applicableConcept);
  }

  private static SNode getApplicableConcept(SNode applicableNode) {
    if (jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.isInstanceOf(applicableNode, "jetbrains.mps.lang.typesystem.structure.ConceptReference")) {
      return SLinkOperations.getTarget(jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.cast(applicableNode, "jetbrains.mps.lang.typesystem.structure.ConceptReference"), "concept", false);
    } else
    if (jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.isInstanceOf(applicableNode, "jetbrains.mps.lang.typesystem.structure.PatternCondition")) {
      return jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.getConceptDeclaration(SLinkOperations.getTarget(SLinkOperations.getTarget(jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations.cast(applicableNode, "jetbrains.mps.lang.typesystem.structure.PatternCondition"), "pattern", true), "patternNode", true));
    } else {
      return null;
    }
  }

  private static class MyMenu extends JPopupMenu {
    public MyMenu(List<SNode> list, final IOperationContext operationContext) {
      setBackground(Color.WHITE);
      String caption = (list.isEmpty() ?
        "No Rules" :
        "Rules :"
      );
      JLabel label = new JLabel(caption, SwingConstants.CENTER);
      label.setBorder(new EmptyBorder(0, 20, 0, 0));
      label.setBackground(Color.LIGHT_GRAY);
      add(label);
      for (final SNode node : list) {
        if (node == null) {
          continue;
        }
        String nodeName = node.getName();
        if (nodeName == null || nodeName.equals("")) {
          nodeName = node.getConcept().getName();
        }
        add(new AbstractAction(nodeName + " (" + node.getModel() + ")") {
          {
            putValue(Action.SMALL_ICON, IconManager.getIconFor(node));
          }

          @Override
          public void actionPerformed(ActionEvent e) {
            ModelAccess.instance().runWriteInEDT(new Runnable() {
              @Override
              public void run() {
                if (SNodeOperations.isDisposed(node) || node.getModel() == null || node.getModel() == null) {
                  return;
                }
                // TODO: use node pointers here 
                NavigationSupport.getInstance().openNode(operationContext, node, true, !(SNodeOperations.isRoot(node)));
              }
            });
          }
        }).setBackground(Color.WHITE);
      }
    }
  }
}
