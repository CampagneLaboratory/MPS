package jetbrains.mps.ide.actions;

/*Generated by MPS */

import com.intellij.openapi.ui.DialogWrapper;
import javax.swing.JPanel;
import java.awt.BorderLayout;
import jetbrains.mps.smodel.Language;
import com.intellij.openapi.project.Project;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.ide.ui.MPSTree;
import jetbrains.mps.ide.ui.MPSTreeNode;
import javax.swing.JScrollPane;
import com.intellij.ui.ScrollPaneFactory;
import java.awt.Dimension;
import javax.swing.tree.TreeSelectionModel;
import javax.swing.event.TreeSelectionListener;
import javax.swing.event.TreeSelectionEvent;
import javax.swing.tree.TreePath;
import jetbrains.mps.ide.ui.smodel.SNodeTreeNode;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.util.SNodeOperations;
import jetbrains.mps.openapi.navigation.NavigationSupport;
import org.jetbrains.annotations.Nullable;
import javax.swing.JComponent;
import jetbrains.mps.ide.ui.TextTreeNode;
import jetbrains.mps.smodel.Generator;
import jetbrains.mps.project.ModuleContext;
import jetbrains.mps.ide.project.ProjectHelper;
import jetbrains.mps.icons.MPSIcons;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.ide.icons.IconManager;
import jetbrains.mps.smodel.SModelStereotype;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;
import jetbrains.mps.util.Condition;
import com.intellij.ui.treeStructure.Tree;
import javax.swing.JOptionPane;
import javax.swing.Icon;
import jetbrains.mps.smodel.IOperationContext;

public class MappingDialog extends DialogWrapper {
  private JPanel myMainComponent = new JPanel(new BorderLayout());
  private Language myLanguage;
  private Project myProject;
  private SNode myResult;
  private MPSTree myTree = new MPSTree() {
    @Override
    protected MPSTreeNode rebuild() {
      return MappingDialog.this.rebuildTree();
    }
  };

  public MappingDialog(final Project project, Language language) {
    super(project);
    setTitle("Choose Mapping Configuration");
    myProject = project;
    myLanguage = language;
    JScrollPane scrollPane = ScrollPaneFactory.createScrollPane(myTree);
    myMainComponent.add(scrollPane, BorderLayout.CENTER);
    myMainComponent.setPreferredSize(new Dimension(500, 400));
    myTree.getSelectionModel().setSelectionMode(TreeSelectionModel.SINGLE_TREE_SELECTION);
    myTree.addTreeSelectionListener(new TreeSelectionListener() {
      @Override
      public void valueChanged(TreeSelectionEvent e) {
        if (e.getNewLeadSelectionPath() == null) {
          return;
        }
        TreePath path = myTree.getSelectionModel().getSelectionPath();
        if (path == null) {
          return;
        }
        Object node = path.getLastPathComponent();
        if (!(node instanceof SNodeTreeNode)) {
          return;
        }
        final SNodeTreeNode treeNode = (SNodeTreeNode) node;
        ModelAccess.instance().runWriteInEDT(new Runnable() {
          @Override
          public void run() {
            SNode node = treeNode.getSNode();
            if (SNodeOperations.isDisposed(node) || node.getModel() == null || node.getModel() == null) {
              return;
            }
            // TODO: use node pointers here 
            NavigationSupport.getInstance().openNode(treeNode.getOperationContext(), node, true, true);
          }
        });
      }
    });
    myTree.rebuildNow();
    myTree.expandAll();

    init();
  }

  @Nullable
  @Override
  protected JComponent createCenterPanel() {
    return myMainComponent;
  }

  private MPSTreeNode rebuildTree() {
    if (myLanguage == null) {
      return null;
    }
    TextTreeNode root = new TextTreeNode("Generators");
    for (final Generator generator : myLanguage.getGenerators()) {
      ModuleContext moduleContext = new ModuleContext(generator, ProjectHelper.toMPSProject(myProject));
      MPSTreeNode generatorTreeNode = new MappingDialog.MyTreeNode(moduleContext, MPSIcons.Nodes.Generator, generator.getModuleFqName(), "generator/" + generator.getName());
      root.add(generatorTreeNode);
      for (SModel md : generator.getOwnTemplateModels()) {
        MPSTreeNode modelTreeNode = new MappingDialog.MyTreeNode(moduleContext, IconManager.getIconFor(md), md.toString(), SNodeOperations.getModelLongName(md) + "@" + SModelStereotype.getStereotype(md));
        generatorTreeNode.add(modelTreeNode);
        SModel model = md;
        for (SNode node : SModelOperations.getRoots(model, "jetbrains.mps.lang.generator.structure.MappingConfiguration")) {
          SNodeTreeNode nodeTreeNode = new SNodeTreeNode(node, null, moduleContext, new Condition<SNode>() {
            @Override
            public boolean met(SNode p0) {
              return false;
            }
          });
          modelTreeNode.add(nodeTreeNode);
        }
      }
    }
    return root;
  }

  public SNode getResult() {
    return myResult;
  }

  @Override
  protected void doOKAction() {
    Object[] selectedNode = myTree.getSelectedNodes(SNodeTreeNode.class, new Tree.NodeFilter() {
      @Override
      public boolean accept(Object p0) {
        return true;
      }
    });
    if (selectedNode.length != 1) {
      JOptionPane.showMessageDialog(this.getContentPane(), "Mapping Configuration node is not selected!");
    } else {
      myResult = (SNode) ((SNodeTreeNode) selectedNode[0]).getSNode();
      myTree.dispose();
      super.doOKAction();
    }
  }

  @Override
  public void doCancelAction() {
    myTree.dispose();
    super.doCancelAction();
  }

  /*package*/ class MyTreeNode extends MPSTreeNode {
    private Icon myIcon;
    private String myNodeIdentifier;
    private String myText;

    public MyTreeNode(IOperationContext context, Icon icon, String nodeIdentifier, String text) {
      super(context);
      myIcon = icon;
      myNodeIdentifier = nodeIdentifier;
      myText = text;

      setNodeIdentifier(myNodeIdentifier);
      setText(myText);
      setIcon(myIcon);
    }
  }
}
