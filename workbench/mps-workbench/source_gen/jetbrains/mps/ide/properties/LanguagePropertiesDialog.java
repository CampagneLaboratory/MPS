package jetbrains.mps.ide.properties;

/*Generated by MPS */

import jetbrains.mps.workbench.dialogs.project.BasePropertiesDialog;
import jetbrains.mps.smodel.Language;
import com.intellij.openapi.Disposable;
import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.ide.ThreadUtils;
import jetbrains.mps.project.Project;
import jetbrains.mps.ide.projectPane.ProjectPane;
import jetbrains.mps.ide.project.ProjectHelper;
import com.intellij.openapi.util.Disposer;

public class LanguagePropertiesDialog extends BasePropertiesDialog {
  public Language myLanguage;
  public LanguageProperties myProperties;
  public Disposable myDisposable = new Disposable() {
    public void dispose() {
    }
  };

  /*package*/ LanguagePropertiesDialog(final Language language, IOperationContext operationContext) {
    super(language.getModuleName() + " Properties", operationContext);
    myLanguage = language;
    collectLanguageProperties();
  }

  private void collectLanguageProperties() {
    myProperties = new LanguageProperties();
    myProperties.loadFrom(myLanguage.getModuleDescriptor());
  }

  protected boolean doSaveChanges() {
    if (!(checkValidity())) {
      return false;
    }
    ModelAccess.instance().runWriteActionInCommand(new Runnable() {
      public void run() {
        myProperties.saveTo(myLanguage.getModuleDescriptor());
        myLanguage.setLanguageDescriptor(myLanguage.getModuleDescriptor(), true);
        myLanguage.validateExtends();
        myLanguage.save();
      }
    }, getOperationContext().getProject());
    ThreadUtils.runInUIThreadNoWait(new Runnable() {
      public void run() {
        Project project = LanguagePropertiesDialog.this.getOperationContext().getProject();
        ProjectPane.getInstance(ProjectHelper.toIdeaProject(project)).selectModule(myLanguage, false);
      }
    });
    return true;
  }

  protected String getErrorString() {
    return checkStubModels(myProperties.getStubModels());
  }

  public void dispose() {
    super.dispose();
    Disposer.dispose(myDisposable);
  }
}
