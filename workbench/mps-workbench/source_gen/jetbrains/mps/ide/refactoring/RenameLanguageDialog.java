package jetbrains.mps.ide.refactoring;

/*Generated by MPS */

import jetbrains.mps.ide.platform.refactoring.RenameDialog;
import javax.swing.JCheckBox;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.project.Project;
import java.awt.HeadlessException;
import jetbrains.mps.ide.project.ProjectHelper;
import javax.swing.JComponent;
import java.awt.GridBagConstraints;
import java.awt.Insets;
import jetbrains.mps.smodel.MPSModuleRepository;
import javax.lang.model.SourceVersion;
import jetbrains.mps.refactoring.renameLanguage.LanguageRenamer;
import org.jetbrains.mps.openapi.module.ModelAccess;
import java.util.Set;
import java.util.LinkedHashSet;
import jetbrains.mps.smodel.ModuleRepositoryFacade;
import java.util.List;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.extapi.model.GeneratableSModel;
import jetbrains.mps.project.ModuleContext;
import jetbrains.mps.make.MakeSession;
import jetbrains.mps.make.IMakeService;
import jetbrains.mps.smodel.resources.ModelsToResources;

public class RenameLanguageDialog extends RenameDialog {
  private JCheckBox myRegenerateLanguage;
  private Language myLanguage;
  private Project myProject;

  public RenameLanguageDialog(com.intellij.openapi.project.Project project, Language language) throws HeadlessException {
    super(project, language.getModuleName(), "language");
    myLanguage = language;
    myProject = ProjectHelper.toMPSProject(project);
    setTitle("Rename Language");

    final boolean[] regenerateHolder = new boolean[]{false};
    myProject.getRepository().getModelAccess().runReadAction(new Runnable() {
      public void run() {
        regenerateHolder[0] = !(myLanguage.isBootstrap());
      }
    });
    myRegenerateLanguage.getModel().setSelected(regenerateHolder[0]);
  }

  @Override
  protected JComponent createNorthPanel() {
    super.createNorthPanel();
    myRegenerateLanguage = new JCheckBox("Rebuild Language");
    GridBagConstraints c = new GridBagConstraints();
    c.gridx = 0;
    c.gridy = 2;
    c.insets = new Insets(0, 8, 0, 8);
    c.anchor = GridBagConstraints.FIRST_LINE_START;
    myPanel.add(myRegenerateLanguage, c);
    return myPanel;
  }

  @Override
  protected void doRefactoringAction() {
    final boolean needToRegenerate = myRegenerateLanguage.getModel().isSelected();

    final String fqName = getCurrentValue();
    if (MPSModuleRepository.getInstance().getModuleByFqName(fqName) != null) {
      setErrorText("Duplicate language name");
      return;
    }
    if (!((SourceVersion.isName(fqName)))) {
      setErrorText("Language namespace should be valid Java package");
      return;
    }
    final LanguageRenamer renamer = new LanguageRenamer(myProject, myLanguage, fqName);
    ModelAccess modelAccess = myProject.getRepository().getModelAccess();
    modelAccess.executeCommand(new Runnable() {
      public void run() {
        renamer.rename(needToRegenerate);
        renamer.update();
      }
    });
    if (needToRegenerate) {
      final Set<Language> langs = new LinkedHashSet<Language>();
      modelAccess.runReadAction(new Runnable() {
        public void run() {
          langs.add(myLanguage);
          langs.addAll(ModuleRepositoryFacade.getInstance().getAllExtendingLanguages(myLanguage));
        }
      });
      for (final Language l : langs) {
        final List<SModel> models = ListSequence.fromList(new ArrayList<SModel>());
        modelAccess.runReadAction(new Runnable() {
          public void run() {
            ListSequence.fromList(models).addSequence(Sequence.fromIterable(Sequence.fromArray(l.getModels().toArray(new SModel[0]))).where(new IWhereFilter<Object>() {
              public boolean accept(Object it) {
                return it instanceof GeneratableSModel && ((GeneratableSModel) it).isGeneratable();
              }
            }));
          }
        });
        if (models == null) {
          setErrorText("Rebuild configuration is invalid");
          return;
        }
        ModuleContext context = new ModuleContext(myLanguage, myProject);
        MakeSession sess = new MakeSession(context);
        if (IMakeService.INSTANCE.get().openNewSession(sess)) {
          IMakeService.INSTANCE.get().make(sess, new ModelsToResources(context, models).resources(false));
        }
        //         GeneratorUIFacade.getInstance().generateModels(new ModuleContext(myLanguage, myProject), params.getModelDescriptors(), GeneratorUIFacade.getInstance().getDefaultGenerationHandler(), true, false); 
      }
    }
    super.doRefactoringAction();
  }
}
