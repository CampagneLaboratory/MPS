package jetbrains.mps.ide.hierarchy;

/*Generated by MPS */

import java.util.List;
import org.jetbrains.mps.openapi.model.SModel;
import java.util.ArrayList;
import jetbrains.mps.smodel.event.SModelListener;
import jetbrains.mps.ide.MPSCoreComponents;
import jetbrains.mps.project.listener.ModelCreationListener;
import com.intellij.openapi.project.Project;
import com.intellij.icons.AllIcons;
import jetbrains.mps.smodel.SModelInternal;
import jetbrains.mps.project.AbstractModule;
import jetbrains.mps.smodel.SModelRepository;
import jetbrains.mps.smodel.LanguageAspect;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.ide.ui.TreeHighlighterExtension;

public class HierarchyViewTool extends AbstractHierarchyView {
  private List<SModel> myStructureModels = new ArrayList<SModel>();
  private SModelListener myModelListener;
  private MPSCoreComponents myCoreComponents;
  private ModelCreationListener myCreationListener;

  public HierarchyViewTool(Project project, MPSCoreComponents coreComponents) {
    super(project, "Hierarchy", 8, AllIcons.Toolwindows.ToolWindowHierarchy);
    this.myCoreComponents = coreComponents;
  }

  public void onCreateStructureModel(SModel md) {
    myStructureModels.add(md);
    ((SModelInternal) md).addModelListener(myModelListener);
  }

  @Override
  public void disposeComponent() {
    super.disposeComponent();
    if (myHierarchyTree == null) {
      return;
    }
    AbstractModule.unregisterModelCreationListener(myCreationListener);
  }

  @Override
  public void projectOpened() {
    super.projectOpened();
    for (SModel md : SModelRepository.getInstance().getModelDescriptors()) {
      if (LanguageAspect.STRUCTURE.is(md)) {
        myStructureModels.add((SModelInternal) md);
      }
    }
  }

  @Override
  public void projectClosed() {
    super.projectClosed();
    myStructureModels.clear();
  }

  @Override
  protected void createTool() {
    super.createTool();
    myModelListener = new HierarchyModelListener(this.myHierarchyTree);
    this.myCreationListener = new ModelCreationListener() {
      @Override
      public boolean isApplicable(SModule module, SModel model) {
        return model.getModule() instanceof Language && LanguageAspect.STRUCTURE.equals(((Language) model.getModule()).getAspectForModel(model));
      }

      @Override
      public void onCreate(SModule module, SModel model) {
        onCreateStructureModel((SModelInternal) model);
      }
    };
    AbstractModule.registerModelCreationListener(myCreationListener);
  }

  @Override
  protected AbstractHierarchyTree createHierarchyTree(boolean isParentHierarchy) {
    ConceptHierarchyTree tree = new ConceptHierarchyTree(myCoreComponents.getLanguageHierarchyCache(), this, isParentHierarchy);
    TreeHighlighterExtension.attachHighlighters(tree, getProject());
    return tree;
  }

  @Override
  protected void doRegister() {
    for (SModel md : myStructureModels) {
      ((SModelInternal) md).addModelListener(myModelListener);
    }
  }

  @Override
  protected void doUnregister() {
    for (SModel md : myStructureModels) {
      ((SModelInternal) md).removeModelListener(myModelListener);
    }
    myStructureModels.clear();
  }

  public int getPriority() {
    return 2;
  }
}
