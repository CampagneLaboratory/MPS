package jetbrains.mps.ide.hierarchy;

/*Generated by MPS */

import java.util.List;
import jetbrains.mps.smodel.SModelDescriptor;
import java.util.ArrayList;
import jetbrains.mps.smodel.event.SModelListener;
import jetbrains.mps.ide.MPSCoreComponents;
import jetbrains.mps.smodel.LanguageHierarchyCache;
import jetbrains.mps.project.listener.ModelCreationListener;
import com.intellij.openapi.project.Project;
import jetbrains.mps.ide.projectPane.Icons;
import jetbrains.mps.project.AbstractModule;
import jetbrains.mps.project.GlobalScope;
import jetbrains.mps.smodel.LanguageAspect;
import jetbrains.mps.smodel.Language;

public class HierarchyViewTool extends AbstractHierarchyView {
  private List<SModelDescriptor> myStructureModels = new ArrayList<SModelDescriptor>();
  private SModelListener myModelListener;
  private MPSCoreComponents myCoreComponents;
  private LanguageHierarchyCache myCache;
  private ModelCreationListener myCreationListener;

  public HierarchyViewTool(Project project, MPSCoreComponents coreComponents) {
    super(project, "Hierarchy", 8, Icons.HIERARCHY_ICON);
    this.myCoreComponents = coreComponents;
  }

  public void onCreateStructureModel(SModelDescriptor md) {
    myStructureModels.add(md);
    md.addModelListener(myModelListener);
  }

  @Override
  public void disposeComponent() {
    super.disposeComponent();
    if (myHierarchyTree == null) {
      return;
    }
    AbstractModule.unregisterModelCreationListener(myCreationListener);
  }

  @Override
  public void projectOpened() {
    super.projectOpened();
    for (SModelDescriptor md : GlobalScope.getInstance().getModelDescriptors()) {
      if (LanguageAspect.STRUCTURE.is(md)) {
        myStructureModels.add(md);
      }
    }
  }

  @Override
  public void projectClosed() {
    super.projectClosed();
    myStructureModels.clear();
  }

  @Override
  protected void createTool() {
    super.createTool();
    myCache = myCoreComponents.getLanguageHierarchyCache();
    myModelListener = new HierarchyModelListener(this.myHierarchyTree);
    this.myCreationListener = new ModelCreationListener() {
      public boolean isApplicable(SModelDescriptor m) {
        return m.getModule() instanceof Language && LanguageAspect.STRUCTURE.equals(((Language) m.getModule()).getAspectForModel(m));
      }

      public void onCreate(SModelDescriptor m) {
        onCreateStructureModel(m);
      }
    };
    AbstractModule.registerModelCreationListener(myCreationListener);
  }

  protected AbstractHierarchyTree createHierarchyTree(boolean isParentHierarchy) {
    return new ConceptHierarchyTree(myCache, this, isParentHierarchy);
  }

  protected void doRegister() {
    for (SModelDescriptor md : myStructureModels) {
      md.addModelListener(myModelListener);
    }
  }

  protected void doUnregister() {
    for (SModelDescriptor md : myStructureModels) {
      md.removeModelListener(myModelListener);
    }
    myStructureModels.clear();
  }

  public int getPriority() {
    return 2;
  }
}
