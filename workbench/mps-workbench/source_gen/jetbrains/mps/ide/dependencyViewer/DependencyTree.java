package jetbrains.mps.ide.dependencyViewer;

/*Generated by MPS */

import jetbrains.mps.ide.ui.MPSTree;
import jetbrains.mps.project.Project;
import jetbrains.mps.ide.ui.MPSTreeNode;
import jetbrains.mps.ide.ui.TextMPSTreeNode;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.ide.projectPane.logicalview.nodes.ProjectModuleTreeNode;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.ide.ui.smodel.SModelTreeNode;
import jetbrains.mps.smodel.SModelInternal;
import jetbrains.mps.project.ModuleContext;
import jetbrains.mps.project.IModule;
import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.ide.ui.smodel.SNodeTreeNode;
import javax.swing.JPopupMenu;
import javax.swing.event.TreeSelectionListener;
import javax.swing.event.TreeSelectionEvent;
import javax.swing.tree.TreePath;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.ide.projectPane.NamespaceTextNode;
import jetbrains.mps.ide.ui.smodel.PackageNode;

public class DependencyTree extends MPSTree {
  private DependencyViewerScope myScope;
  private Project myProject;
  private DependenciesPanel myParent;

  public DependencyTree(DependenciesPanel parent) {
    myParent = parent;
    addTreeSelectionListener(new DependencyTree.MyTreeSelectionListener());
  }

  @Override
  protected MPSTreeNode rebuild() {
    TextMPSTreeNode root = new TextMPSTreeNode("root", null);
    for (SModule module : myScope.getModules()) {
      root.add(ProjectModuleTreeNode.createFor(myProject, module));
    }
    for (SModel model : myScope.getModels()) {
      SModelTreeNode node = new SModelTreeNode((SModelInternal) model, null, new ModuleContext((IModule) model.getModule(), myProject));
      root.add(node);
    }
    for (SNode node : myScope.getRoots()) {
      SNodeTreeNode treeNode = new SNodeTreeNode((SNode) node, null, new ModuleContext((IModule) ((SNode) node).getModel().getModule(), myProject));
      root.add(treeNode);
    }
    setRootVisible(false);
    setShowsRootHandles(true);
    return root;
  }

  @Override
  protected JPopupMenu createPopupMenu(MPSTreeNode node) {
    return null;
  }

  public void setContent(DependencyViewerScope scope, Project project) {
    myScope = scope;
    myProject = project;
    rebuildLater();
  }

  public class MyTreeSelectionListener implements TreeSelectionListener {
    public MyTreeSelectionListener() {
    }

    @Override
    public void valueChanged(TreeSelectionEvent event) {
      final TreePath[] paths = getSelectionPaths();
      if (paths == null || paths.length == 0) {
        return;
      }
      final DependencyViewerScope scope = new DependencyViewerScope();
      ModelAccess.instance().runReadAction(new Runnable() {
        public void run() {
          for (TreePath path : paths) {
            MPSTreeNode node = (MPSTreeNode) path.getLastPathComponent();
            if (node instanceof SModelTreeNode) {
              scope.add(((SModelTreeNode) node).getModel());
            }
            if (node instanceof ProjectModuleTreeNode) {
              scope.add(((ProjectModuleTreeNode) node).getModule());
            }
            if (node instanceof SNodeTreeNode) {
              scope.add(((SNodeTreeNode) node).getSNode());
            }
            if (node instanceof NamespaceTextNode) {
              for (SModule module : ((NamespaceTextNode) node).getModulesUnder()) {
                scope.add(module);
              }
              for (SModel model : ((NamespaceTextNode) node).getModelsUnder()) {
                scope.add(model);
              }
            }
            if (node instanceof PackageNode) {
              for (SNode nodeUnder : ((PackageNode) node).getNodesUnderPackage()) {
                scope.add(nodeUnder);
              }
            }

          }
        }
      });
      myParent.updateTargetsView(scope);
    }
  }
}
