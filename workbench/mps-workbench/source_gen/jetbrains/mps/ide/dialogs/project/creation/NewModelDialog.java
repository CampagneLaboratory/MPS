package jetbrains.mps.ide.dialogs.project.creation;

/*Generated by MPS */

import com.intellij.openapi.ui.DialogWrapper;
import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.project.IModule;
import javax.swing.JPanel;
import java.awt.BorderLayout;
import javax.swing.JTextField;
import javax.swing.JComboBox;
import jetbrains.mps.smodel.SModelDescriptor;
import com.intellij.openapi.project.Project;
import java.awt.HeadlessException;
import java.awt.GridLayout;
import javax.swing.JLabel;
import javax.swing.DefaultComboBoxModel;
import org.jetbrains.mps.openapi.persistence.ModelRoot;
import javax.swing.DefaultListCellRenderer;
import java.awt.Component;
import javax.swing.JList;
import java.awt.event.ItemListener;
import java.awt.event.ItemEvent;
import java.awt.event.KeyAdapter;
import java.awt.event.KeyEvent;
import jetbrains.mps.smodel.SModelStereotype;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.util.Computable;
import jetbrains.mps.workbench.dialogs.project.MPSPropertiesConfigurable;
import jetbrains.mps.workbench.dialogs.project.ModelPropertiesConfigurable;
import com.intellij.openapi.options.ex.SingleConfigurableEditor;
import jetbrains.mps.ide.project.ProjectHelper;
import javax.swing.SwingUtilities;
import jetbrains.mps.smodel.SModelFqName;
import jetbrains.mps.smodel.SModelRepository;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.smodel.LanguageAspect;
import javax.lang.model.SourceVersion;
import org.jetbrains.annotations.Nullable;
import javax.swing.JComponent;

public class NewModelDialog extends DialogWrapper {
  private IOperationContext myContext;
  private IModule myModule;
  private JPanel myContentPane = new JPanel(new BorderLayout());
  private JTextField myModelName = new JTextField();
  private JComboBox myModelStereotype = new JComboBox();
  private JComboBox myModelRoots = new JComboBox();
  private SModelDescriptor myResult;
  private String myNamespace;

  public NewModelDialog(Project project, IModule module, String namespace, IOperationContext context, String stereotype, boolean strict) throws HeadlessException {
    super(project);
    setTitle("New Model");
    myContext = context;
    myModule = module;
    myNamespace = (namespace == null ?
      "" :
      namespace
    );
    assert myModule.getModelRoots().iterator().hasNext() : "Can't create a model in solution with no model roots";
    initContentPane();
    if (stereotype != null) {
      myModelStereotype.setSelectedItem(stereotype);
      myModelStereotype.setEnabled(!(strict));
    }

    init();
  }

  public SModelDescriptor getResult() {
    return myResult;
  }

  private void initContentPane() {
    JPanel mainPanel = new JPanel(new GridLayout(0, 1));

    mainPanel.add(new JLabel("Model root:"));
    mainPanel.add(myModelRoots);
    DefaultComboBoxModel model = new DefaultComboBoxModel();
    for (ModelRoot root : myModule.getModelRoots()) {
      if (!(root.isReadOnly())) {
        model.addElement(root);
      }
    }

    if (model.getSize() == 0) {
      model.addElement("<NO MODEL ROOTS FOR SELECTED NAMESPACE>");
    }
    myModelRoots.setRenderer(new DefaultListCellRenderer() {
      @Override
      public Component getListCellRendererComponent(JList list, Object object, int i, boolean b, boolean b1) {
        if (object instanceof ModelRoot) {
          object = ((ModelRoot) object).getPresentation();
        }
        return super.getListCellRendererComponent(list, object, i, b, b1);
      }
    });
    myModelRoots.addItemListener(new ItemListener() {
      public void itemStateChanged(ItemEvent e) {
        check();
      }
    });
    myModelRoots.setModel(model);

    myModelName.setText((myNamespace.length() == 0 ?
      myNamespace :
      myNamespace + "."
    ));
    mainPanel.add(new JLabel("Model name:"));
    mainPanel.add(myModelName);
    myModelName.addKeyListener(new KeyAdapter() {
      public void keyReleased(KeyEvent event) {
        check();
      }
    });

    mainPanel.add(new JLabel("Stereotype:"));
    myModelStereotype.setEditable(true);
    myModelStereotype.setModel(new DefaultComboBoxModel(SModelStereotype.values));
    myModelStereotype.addKeyListener(new KeyAdapter() {
      public void keyReleased(KeyEvent event) {
        check();
      }
    });
    myModelStereotype.addItemListener(new ItemListener() {
      public void itemStateChanged(ItemEvent p0) {
        check();
      }
    });
    mainPanel.add(myModelStereotype);

    myContentPane.add(mainPanel, BorderLayout.NORTH);
    myContentPane.add(new JPanel(), BorderLayout.CENTER);
  }

  @Override
  protected void doOKAction() {
    if (!(check())) {
      return;
    }

    myResult = ModelAccess.instance().runWriteActionInCommand(new Computable<SModelDescriptor>() {
      public SModelDescriptor compute() {
        String fqName = getFqName();
        ModelRoot mr = (ModelRoot) myModelRoots.getSelectedItem();
        return myModule.createModel(fqName, mr, null);
      }
    }, myContext.getProject());

    assert myResult != null;

    MPSPropertiesConfigurable configurable = new ModelPropertiesConfigurable(myResult, myContext);
    final SingleConfigurableEditor configurableEditor = new SingleConfigurableEditor(ProjectHelper.toIdeaProject(myContext.getProject()), configurable, "#MPSPropertiesConfigurable");
    SwingUtilities.invokeLater(new Runnable() {
      public void run() {
        configurableEditor.show();
      }
    });


    super.doOKAction();
  }

  private String getFqName() {
    String stereo = myModelStereotype.getSelectedItem().toString().trim();
    return myModelName.getText() + ((stereo != null && stereo.length() > 0 ?
      "@" + stereo :
      ""
    ));

  }

  private boolean check() {
    Object selected = myModelRoots.getSelectedItem();
    if (!((selected instanceof ModelRoot))) {
      setErrorText("Model root is not selected");
      return false;
    }

    ModelRoot mr = ((ModelRoot) selected);

    String modelName = myModelName.getText();
    if (modelName.length() == 0) {
      setErrorText("Empty model name isn't allowed");
      return false;
    }

    SModelFqName modelUID = new SModelFqName(modelName, myModelStereotype.getSelectedItem().toString());
    if (SModelRepository.getInstance().getModelDescriptor(modelUID) != null) {
      setErrorText("Model with an uid " + modelName + " already exists");
      return false;
    }

    if (modelName.lastIndexOf(".") == modelName.length()) {
      setErrorText("Empty model short name isn't allowed");
      return false;
    }

    if (myModule instanceof Language) {
      for (LanguageAspect aspect : LanguageAspect.values()) {
        String shortName = modelName.substring(modelName.lastIndexOf(".") + 1);
        if (shortName.equals(aspect.getName())) {
          setErrorText("This name isn't allowed because '" + shortName + "' is language aspect name");
          return false;
        }
      }
    }

    if (!(SourceVersion.isName(modelName))) {
      setErrorText("Model name should be valid Java package");
      return false;
    }

    if (!(mr.canCreateModel(getFqName()))) {
      setErrorText("Can't create a model with this name under this model root");
      return false;
    }

    setErrorText(null);
    return true;
  }

  @Nullable
  protected JComponent createCenterPanel() {
    return myContentPane;
  }
}
