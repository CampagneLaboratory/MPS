package jetbrains.mps.ide.embeddableEditor;

/*Generated by MPS */

import jetbrains.mps.project.Project;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.make.script.IScript;
import jetbrains.mps.make.script.ScriptBuilder;
import jetbrains.mps.make.facet.IFacet;
import jetbrains.mps.make.facet.ITarget;
import com.intellij.openapi.application.ApplicationManager;
import jetbrains.mps.make.script.IScriptController;
import jetbrains.mps.make.script.IConfigMonitor;
import jetbrains.mps.make.script.IOption;
import jetbrains.mps.make.script.IQuery;
import jetbrains.mps.make.script.IJobMonitor;
import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.project.ProjectOperationContext;
import jetbrains.mps.make.MakeSession;
import jetbrains.mps.make.IMakeService;
import java.util.concurrent.Future;
import jetbrains.mps.make.script.IResult;
import jetbrains.mps.smodel.resources.ModelsToResources;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.concurrent.ExecutionException;

public class MakeUtils {
  public static void make(final Project project, final SModel model, final _FunctionTypes._void_P1_E0<? super Boolean> callback) {
    // todo: move out from embeddableEditor 
    // <node> 

    final IScript scr = new ScriptBuilder().withFacetNames(new IFacet.Name("jetbrains.mps.lang.core.Generate"), new IFacet.Name("jetbrains.mps.lang.core.TextGen"), new IFacet.Name("jetbrains.mps.make.facets.JavaCompile"), new IFacet.Name("jetbrains.mps.make.facets.ReloadClasses"), new IFacet.Name("jetbrains.mps.make.facets.Make")).withFinalTarget(new ITarget.Name("jetbrains.mps.make.facets.Make.make")).toScript();

    ApplicationManager.getApplication().executeOnPooledThread(new Runnable() {
      public void run() {
        IScriptController ctl = new IScriptController.Stub(new IConfigMonitor.Stub() {
          @Override
          public <T extends IOption> T relayQuery(IQuery<T> query) {
            return query.defaultOption();
          }
        }, new IJobMonitor.Stub());

        IOperationContext projectOperationContext = new ProjectOperationContext(project);
        MakeSession session = new MakeSession(projectOperationContext, null, true);
        if (IMakeService.INSTANCE.get().openNewSession(session)) {
          Future<IResult> future = IMakeService.INSTANCE.get().make(session, new ModelsToResources(projectOperationContext, Sequence.<SModel>singleton(model)).resources(false), scr, ctl);
          try {
            callback.invoke(future.get().isSucessful());
          } catch (ExecutionException e) {
            // todo: log 
            callback.invoke(false);
          } catch (InterruptedException e) {
            // todo: log 
            callback.invoke(false);
          }
        }

        // todo: log 
        callback.invoke(false);
      }
    });
  }
}
