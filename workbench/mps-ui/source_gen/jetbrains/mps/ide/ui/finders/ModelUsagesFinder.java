package jetbrains.mps.ide.ui.finders;

/*Generated by MPS */

import jetbrains.mps.ide.findusages.findalgorithm.finders.IFinder;
import jetbrains.mps.ide.findusages.model.SearchResults;
import jetbrains.mps.ide.findusages.model.SearchQuery;
import jetbrains.mps.progress.ProgressMonitor;
import jetbrains.mps.ide.findusages.model.holders.IHolder;
import jetbrains.mps.ide.findusages.model.holders.ModelHolder;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.smodel.SModelReference;
import jetbrains.mps.smodel.ModelsOnlyScope;
import jetbrains.mps.smodel.SModelStereotype;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.model.util.NodesIterable;
import org.jetbrains.mps.openapi.model.SReference;
import jetbrains.mps.ide.findusages.model.SearchResult;
import jetbrains.mps.workbench.choose.base.ModulesOnlyScope;
import jetbrains.mps.smodel.SModelRepository;
import jetbrains.mps.smodel.SModelId;
import jetbrains.mps.smodel.ModelFindOperations;
import jetbrains.mps.util.CollectionUtil;

public class ModelUsagesFinder implements IFinder {
  public ModelUsagesFinder() {
  }

  @Override
  public SearchResults find(SearchQuery query, ProgressMonitor monitor) {
    SearchResults searchResults = new SearchResults();
    IHolder holder = query.getObjectHolder();
    assert holder instanceof ModelHolder;
    SModel model = ((ModelHolder) holder).getObject();
    searchResults.getSearchedNodes().add(model);
    SModelReference modelReference = model.getReference();
    if (query.getScope() instanceof ModelsOnlyScope) {
      for (SModel modelDescriptor : (as_s8v3jk_a0a0a0g0b(query.getScope(), ModelsOnlyScope.class)).getModelDescriptors()) {
        if (monitor.isCanceled()) {
          return searchResults;
        }
        if (!(SModelStereotype.isUserModel(modelDescriptor))) {
          continue;
        }
        for (SNode node : new NodesIterable(modelDescriptor.getSModel())) {
          for (SReference reference : node.getReferences()) {
            if (!(((jetbrains.mps.smodel.SReference) reference).isExternal())) {
              continue;
            }
            SModelReference targetModelReference = reference.getTargetSModelReference();
            if (targetModelReference == null) {
              continue;
            }
            if (targetModelReference.equals(modelReference)) {
              searchResults.getSearchResults().add(new SearchResult<SNode>(node, "nodes from model"));
            }
          }
        }
      }
    } else if (false && query.getScope() instanceof ModulesOnlyScope) {
      // TODO: implement model search in Module Scope 
      for (SModel scopeModel : (as_s8v3jk_a0a0b0a6a1(query.getScope(), ModulesOnlyScope.class)).getModels()) {
        if (monitor.isCanceled()) {
          return searchResults;
        }
        SModel descriptor = SModelRepository.getInstance().getModelDescriptor((SModelId) scopeModel.getModelId());
        // <node> 
        if (!(SModelStereotype.isUserModel(scopeModel))) {
          continue;
        }
        for (SNode node : new NodesIterable(descriptor.getSModel())) {
          for (SReference reference : node.getReferences()) {
            if (!(((jetbrains.mps.smodel.SReference) reference).isExternal())) {
              continue;
            }
            SModelReference targetModelReference = reference.getTargetSModelReference();
            if (targetModelReference == null) {
              continue;
            }
            if (targetModelReference.equals(modelReference)) {
              searchResults.getSearchResults().add(new SearchResult<SNode>(node, "nodes from model"));
            }
          }
        }
      }
    } else {
      for (SModel modelDescriptor : SModelRepository.getInstance().getModelDescriptors()) {
        if (monitor.isCanceled()) {
          return searchResults;
        }
        if (!(SModelStereotype.isUserModel(modelDescriptor))) {
          continue;
        }
        if (new ModelFindOperations(modelDescriptor).hasUsages(CollectionUtil.set(modelReference))) {
          searchResults.getSearchResults().add(new SearchResult<SModel>(modelDescriptor.getSModel(), "usages in imports"));
        }
      }
    }
    return searchResults;
  }

  private static <T> T as_s8v3jk_a0a0a0g0b(Object o, Class<T> type) {
    return (type.isInstance(o) ?
      (T) o :
      null
    );
  }

  private static <T> T as_s8v3jk_a0a0b0a6a1(Object o, Class<T> type) {
    return (type.isInstance(o) ?
      (T) o :
      null
    );
  }
}
