package jetbrains.mps.ide.depanalyzer;

/*Generated by MPS */

import jetbrains.mps.ide.ui.MPSTree;
import com.intellij.openapi.actionSystem.DataProvider;
import java.util.List;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import java.util.Set;
import jetbrains.mps.project.IModule;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.ide.ui.MPSTreeNode;
import jetbrains.mps.project.structure.modules.ModuleReference;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.smodel.MPSModuleRepository;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.project.structure.modules.ModuleDescriptor;
import jetbrains.mps.project.structure.modules.Dependency;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.project.structure.modules.LanguageDescriptor;
import jetbrains.mps.project.structure.modules.DevkitDescriptor;
import jetbrains.mps.project.DevKit;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.ide.ui.TextMPSTreeNode;
import javax.swing.JPopupMenu;
import com.intellij.openapi.actionSystem.DefaultActionGroup;
import jetbrains.mps.workbench.action.ActionUtils;
import jetbrains.mps.workbench.action.BaseAction;
import com.intellij.openapi.actionSystem.ActionManager;
import com.intellij.openapi.actionSystem.ActionPlaces;
import org.jetbrains.annotations.NonNls;
import jetbrains.mps.workbench.MPSDataKeys;

public class DependencyPathTree extends MPSTree implements DataProvider {
  private List<Tuples._3<Set<IModule>, Set<IModule>, Set<IModule>>> myAllDependencies = ListSequence.fromList(new ArrayList<Tuples._3<Set<IModule>, Set<IModule>, Set<IModule>>>());
  private boolean myShowRuntime;

  public DependencyPathTree() {
  }

  public void setShowRuntime(boolean showRuntime) {
    myShowRuntime = showRuntime;
  }

  public boolean isShowRuntime() {
    return myShowRuntime;
  }

  public void resetDependencies() {
    ListSequence.fromList(myAllDependencies).clear();
  }

  public void addDependency(Iterable<IModule> from, Iterable<IModule> to, Iterable<IModule> usedLanguage) {
    ListSequence.fromList(myAllDependencies).addElement(MultiTuple.<Set<IModule>,Set<IModule>,Set<IModule>>from(SetSequence.fromSetWithValues(new HashSet<IModule>(), from), SetSequence.fromSetWithValues(new HashSet<IModule>(), to), SetSequence.fromSetWithValues(new HashSet<IModule>(), usedLanguage)));
  }

  private void addChildDep(MPSTreeNode parent, IModule m, DependencyPathTree.DepType type, String role, Set<IModule> dep, Set<IModule> ulang, Set<DependencyPathTree.Dep> visited) {
    MPSTreeNode child = buildDependency(m, type, role, dep, ulang, visited);
    if (child != null) {
      parent.add(child);
    }
  }

  public void addChildDeps(MPSTreeNode parent, Iterable<ModuleReference> list, DependencyPathTree.DepType type, String role, Set<IModule> dep, Set<IModule> ulang, Set<DependencyPathTree.Dep> visited) {
    for (ModuleReference m : Sequence.fromIterable(list)) {
      addChildDep(parent, MPSModuleRepository.getInstance().getModule(m), type, role, dep, ulang, visited);
    }
  }

  @Nullable
  private MPSTreeNode buildDependency(IModule from, DependencyPathTree.DepType type, String role, Set<IModule> dependency, Set<IModule> usedlangauge, Set<DependencyPathTree.Dep> visited) {
    if ((type == DependencyPathTree.DepType.D || type == DependencyPathTree.DepType.R && isShowRuntime()) && SetSequence.fromSet(dependency).contains(from)) {
      return new DependencyTreeLeafNode(from, role, null);
    }
    if (type == DependencyPathTree.DepType.UL && SetSequence.fromSet(usedlangauge).contains(from)) {
      return new DependencyTreeLeafNode(from, role, null);
    }
    DependencyPathTree.Dep dep = new DependencyPathTree.Dep(from, type);
    if (SetSequence.fromSet(visited).contains(dep)) {
      return null;
    }
    SetSequence.fromSet(visited).addElement(dep);

    MPSTreeNode result = new DependencyTreeNode(from, role, null);

    switch (type) {
      case M:
        ModuleDescriptor m = from.getModuleDescriptor();
        if (m == null) {
          break;
        }

        addChildDeps(result, ListSequence.fromList(((List<Dependency>) m.getDependencies())).select(new ISelector<Dependency, ModuleReference>() {
          public ModuleReference select(Dependency it) {
            return it.getModuleRef();
          }
        }), DependencyPathTree.DepType.D, "depends on ", dependency, usedlangauge, visited);

        if (m instanceof LanguageDescriptor) {
          addChildDeps(result, ((LanguageDescriptor) m).getExtendedLanguages(), DependencyPathTree.DepType.D, "extends language ", dependency, usedlangauge, visited);
        }

        addChildDeps(result, m.getUsedDevkits(), DependencyPathTree.DepType.DK, "uses devkit ", dependency, usedlangauge, visited);

        addChildDeps(result, m.getUsedLanguages(), DependencyPathTree.DepType.UL, "uses language ", dependency, usedlangauge, visited);

        break;

      case DK:
        DevkitDescriptor dk = ((DevKit) from).getModuleDescriptor();
        addChildDeps(result, dk.getExtendedDevkits(), DependencyPathTree.DepType.DK, "extends devkit ", dependency, usedlangauge, visited);
        addChildDeps(result, dk.getExportedLanguages(), DependencyPathTree.DepType.DK, "exports language ", dependency, usedlangauge, visited);
        addChildDeps(result, dk.getExportedSolutions(), DependencyPathTree.DepType.DK, "exports solution ", dependency, usedlangauge, visited);
        break;

      case UL:
        LanguageDescriptor ul = ((Language) from).getModuleDescriptor();
        addChildDeps(result, ul.getExtendedLanguages(), DependencyPathTree.DepType.UL, "extends language ", dependency, usedlangauge, visited);
        if (isShowRuntime()) {
          addChildDeps(result, ul.getRuntimeModules(), DependencyPathTree.DepType.R, "exports runtime ", dependency, usedlangauge, visited);
        }
        addChildDeps(result, ListSequence.fromList(((List<Dependency>) ul.getDependencies())).where(new IWhereFilter<Dependency>() {
          public boolean accept(Dependency it) {
            return it.isReexport();
          }
        }).select(new ISelector<Dependency, ModuleReference>() {
          public ModuleReference select(Dependency it) {
            return it.getModuleRef();
          }
        }), DependencyPathTree.DepType.D, "re-exports dependency on ", dependency, usedlangauge, visited);
        break;

      case D:
        ModuleDescriptor m2 = from.getModuleDescriptor();
        addChildDeps(result, ListSequence.fromList(((List<Dependency>) m2.getDependencies())).where(new IWhereFilter<Dependency>() {
          public boolean accept(Dependency it) {
            return it.isReexport();
          }
        }).select(new ISelector<Dependency, ModuleReference>() {
          public ModuleReference select(Dependency it) {
            return it.getModuleRef();
          }
        }), DependencyPathTree.DepType.D, "re-export dependency on ", dependency, usedlangauge, visited);
        addChildDeps(result, ListSequence.fromList(((List<Dependency>) m2.getDependencies())).where(new IWhereFilter<Dependency>() {
          public boolean accept(Dependency it) {
            return !(it.isReexport());
          }
        }).select(new ISelector<Dependency, ModuleReference>() {
          public ModuleReference select(Dependency it) {
            return it.getModuleRef();
          }
        }), DependencyPathTree.DepType.R, "depends on ", dependency, usedlangauge, visited);

        if (from instanceof Language) {
          addChildDeps(result, ((LanguageDescriptor) m2).getExtendedLanguages(), DependencyPathTree.DepType.D, "extends language ", dependency, usedlangauge, visited);
        }
        break;

      case R:
        ModuleDescriptor m3 = from.getModuleDescriptor();
        addChildDeps(result, ListSequence.fromList(((List<Dependency>) m3.getDependencies())).select(new ISelector<Dependency, ModuleReference>() {
          public ModuleReference select(Dependency it) {
            return it.getModuleRef();
          }
        }), DependencyPathTree.DepType.R, "depends on ", dependency, usedlangauge, visited);
      default:
    }

    return (result.getChildCount() > 0 ?
      result :
      null
    );
  }

  protected MPSTreeNode rebuild() {
    MPSTreeNode result = new TextMPSTreeNode((ListSequence.fromList(myAllDependencies).isEmpty() ?
      "no dependencies selected" :
      "Dependencies found"
    ), null);
    for (Tuples._3<Set<IModule>, Set<IModule>, Set<IModule>> dep : ListSequence.fromList(myAllDependencies)) {
      for (IModule m : SetSequence.fromSet(dep._0())) {
        addChildDep(result, m, DependencyPathTree.DepType.M, "", dep._1(), dep._2(), SetSequence.fromSet(new HashSet<DependencyPathTree.Dep>()));
      }
    }
    setRootVisible(ListSequence.fromList(myAllDependencies).isEmpty());
    setShowsRootHandles(ListSequence.fromList(myAllDependencies).isNotEmpty());
    expandAll();
    return result;
  }

  @Override
  protected JPopupMenu createPopupMenu(MPSTreeNode node) {
    DefaultActionGroup group = ActionUtils.groupFromActions(((BaseAction) ActionManager.getInstance().getAction("jetbrains.mps.ide.actions.ModuleProperties_Action")));
    return ActionManager.getInstance().createActionPopupMenu(ActionPlaces.UNKNOWN, group).getComponent();
  }

  @Nullable
  public Object getData(@NonNls String id) {
    DependencyTreeNode current = as_9bg0dz_a0a0a9(getCurrentNode(), DependencyTreeNode.class);
    if (current == null) {
      return null;
    }
    if (id.equals(MPSDataKeys.OPERATION_CONTEXT.getName())) {
      return current.getOperationContext();
    }
    if (id.equals(MPSDataKeys.MODULE.getName())) {
      return current.getModule();
    }
    return null;
  }

  private static <T> T as_9bg0dz_a0a0a9(Object o, Class<T> type) {
    return (type.isInstance(o) ?
      (T) o :
      null
    );
  }

  public static   enum DepType {
    M(),
    DK(),
    UL(),
    D(),
    R();

    DepType() {
    }
  }

  public static class Dep {
    private IModule myModule;
    private DependencyPathTree.DepType myType;

    public Dep(IModule module, DependencyPathTree.DepType type) {
      myModule = module;
      myType = type;
    }

    public boolean equals(Object o) {
      if (!(o instanceof DependencyPathTree.Dep)) {
        return false;
      }
      DependencyPathTree.Dep d = (DependencyPathTree.Dep) o;
      return d.myModule.equals(myModule) && d.myType == myType;
    }

    public int hashCode() {
      return myModule.hashCode() + myType.hashCode();
    }
  }
}
