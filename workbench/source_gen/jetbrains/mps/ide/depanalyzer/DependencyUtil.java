package jetbrains.mps.ide.depanalyzer;

/*Generated by MPS */

import java.util.List;
import jetbrains.mps.project.IModule;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.project.structure.modules.ModuleDescriptor;
import jetbrains.mps.project.structure.modules.LanguageDescriptor;
import jetbrains.mps.project.structure.modules.GeneratorDescriptor;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.project.structure.modules.ModuleReference;
import jetbrains.mps.smodel.Generator;
import jetbrains.mps.project.structure.modules.DevkitDescriptor;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.smodel.MPSModuleRepository;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.baseLanguage.tuples.runtime.Tuples;
import jetbrains.mps.baseLanguage.tuples.runtime.MultiTuple;

public class DependencyUtil {
  public DependencyUtil() {
  }

  public static List<DependencyUtil.Link> dependencies(DependencyUtil.Role role, IModule module, boolean trackRuntime) {
    List<DependencyUtil.Link> result = ListSequence.fromList(new ArrayList<DependencyUtil.Link>());
    ModuleDescriptor descr = module.getModuleDescriptor();
    if (descr == null) {
      return result;
    }
    switch (role) {
      case None:
        // first step 
        addDeps(result, descr.getUsedDevkits(), DependencyUtil.Role.UsedDevkit, DependencyUtil.LinkType.UsesDevkit);
        addDeps(result, descr.getUsedLanguages(), DependencyUtil.Role.UsedLanguage, DependencyUtil.LinkType.UsesLanguage);
        addDeps(result, getReexportDeps(descr), DependencyUtil.Role.DTDependency_, DependencyUtil.LinkType.ReexportsDep);
        addDeps(result, getNonreexportDeps(descr), DependencyUtil.Role.DTDependency_, DependencyUtil.LinkType.Depends);
        if (descr instanceof LanguageDescriptor) {
          addDeps(result, ListSequence.fromList(((List<GeneratorDescriptor>) as_he47wm_a0a0a0b0a0f0a3a0(descr, LanguageDescriptor.class).getGenerators())).select(new ISelector<GeneratorDescriptor, ModuleReference>() {
            public ModuleReference select(GeneratorDescriptor it) {
              return it.getModuleReference();
            }
          }), DependencyUtil.Role.Generator, DependencyUtil.LinkType.Generator);
          addDeps(result, (as_he47wm_a0a1a1a5a0d0a(descr, LanguageDescriptor.class)).getExtendedLanguages(), DependencyUtil.Role.DTDependency_, DependencyUtil.LinkType.ExtendsLanguage);
        }
        if (descr instanceof GeneratorDescriptor) {
          GeneratorDescriptor gen = (GeneratorDescriptor) descr;
          ListSequence.fromList(result).addElement(new DependencyUtil.Link((as_he47wm_a0a0a0a0b0g0a3a0(module, Generator.class)).getSourceLanguage(), DependencyUtil.Role.GeneratorLanguage, DependencyUtil.LinkType.GeneratorLanguage));
        }
        break;

      case UsedDevkit:
        DevkitDescriptor devkit = as_he47wm_a0a0a1d0a(descr, DevkitDescriptor.class);
        if (devkit == null) {
          break;
        }
        addDeps(result, devkit.getExtendedDevkits(), DependencyUtil.Role.UsedDevkit, DependencyUtil.LinkType.ExtendsDevkit);
        addDeps(result, devkit.getExportedLanguages(), DependencyUtil.Role.UsedLanguage, DependencyUtil.LinkType.ExportsLanguage);
        addDeps(result, devkit.getExportedSolutions(), DependencyUtil.Role.DTDependency_, DependencyUtil.LinkType.ExportsSolution);
        break;

      case UsedLanguage:
        LanguageDescriptor lang = as_he47wm_a0a0a2d0a(descr, LanguageDescriptor.class);
        if (lang == null) {
          break;
        }
        addDeps(result, lang.getExtendedLanguages(), DependencyUtil.Role.UsedLanguage, DependencyUtil.LinkType.ExtendsLanguage);
        if (trackRuntime) {
          addDeps(result, lang.getRuntimeModules(), DependencyUtil.Role.RTDependency, DependencyUtil.LinkType.ExportsRuntime);
          if (!(lang.getRuntimeStubModels().isEmpty())) {
            ListSequence.fromList(result).addElement(new DependencyUtil.Link(module, DependencyUtil.Role.RTLibraries, DependencyUtil.LinkType.ExportsRuntimeLib));
          }
        }
        break;

      case DTDependency_:
        addDeps(result, getReexportDeps(descr), DependencyUtil.Role.DTDependency_, DependencyUtil.LinkType.ReexportsDep);
        if (descr instanceof LanguageDescriptor) {
          addDeps(result, (as_he47wm_a0a1a0a1a3d0a(descr, LanguageDescriptor.class)).getExtendedLanguages(), DependencyUtil.Role.DTDependency_, DependencyUtil.LinkType.ExtendsLanguage);
        }
        if (trackRuntime) {
          addDeps(result, getNonreexportDeps(descr), DependencyUtil.Role.RTDependency, DependencyUtil.LinkType.Depends);
        }
        break;

      case RTDependency:
        addDeps(result, getReexportDeps(descr), DependencyUtil.Role.RTDependency, DependencyUtil.LinkType.ReexportsDep);
        addDeps(result, getNonreexportDeps(descr), DependencyUtil.Role.RTDependency, DependencyUtil.LinkType.Depends);
        break;

      case RTLibraries:
        break;

      case Generator:

        break;

      case GeneratorLanguage:
        addDeps(result, check_he47wm_b0a0h3a0(as_he47wm_a0b0a0h3a0(descr, LanguageDescriptor.class)), DependencyUtil.Role.GeneratorLanguage, DependencyUtil.LinkType.ExtendsLanguage);
        addDeps(result, check_he47wm_b0b0h3a0(as_he47wm_a0b0b0h3a0(descr, LanguageDescriptor.class)), DependencyUtil.Role.DTDependency, DependencyUtil.LinkType.ExportsRuntime);
        break;

      default:
    }
    return result;
  }

  private static void addDeps(List<DependencyUtil.Link> result, Iterable<ModuleReference> modules, final DependencyUtil.Role role, final DependencyUtil.LinkType linktype) {
    if (modules == null) {
      return;
    }
    ListSequence.fromList(result).addSequence(Sequence.fromIterable(modules).select(new ISelector<ModuleReference, IModule>() {
      public IModule select(ModuleReference ref) {
        return MPSModuleRepository.getInstance().getModule(ref);
      }
    }).where(new IWhereFilter<IModule>() {
      public boolean accept(IModule module) {
        return module != null;
      }
    }).select(new ISelector<IModule, DependencyUtil.Link>() {
      public DependencyUtil.Link select(IModule module) {
        return new DependencyUtil.Link(module, role, linktype);
      }
    }));
  }

  private static Iterable<ModuleReference> getReexportDeps(ModuleDescriptor descr) {
    return ListSequence.fromList(((List<jetbrains.mps.project.structure.modules.Dependency>) descr.getDependencies())).where(new IWhereFilter<jetbrains.mps.project.structure.modules.Dependency>() {
      public boolean accept(jetbrains.mps.project.structure.modules.Dependency dep) {
        return dep.isReexport();
      }
    }).select(new ISelector<jetbrains.mps.project.structure.modules.Dependency, ModuleReference>() {
      public ModuleReference select(jetbrains.mps.project.structure.modules.Dependency dep) {
        return dep.getModuleRef();
      }
    });
  }

  private static Iterable<ModuleReference> getNonreexportDeps(ModuleDescriptor descr) {
    return ListSequence.fromList(((List<jetbrains.mps.project.structure.modules.Dependency>) descr.getDependencies())).where(new IWhereFilter<jetbrains.mps.project.structure.modules.Dependency>() {
      public boolean accept(jetbrains.mps.project.structure.modules.Dependency dep) {
        return !(dep.isReexport());
      }
    }).select(new ISelector<jetbrains.mps.project.structure.modules.Dependency, ModuleReference>() {
      public ModuleReference select(jetbrains.mps.project.structure.modules.Dependency dep) {
        return dep.getModuleRef();
      }
    });
  }

  public static Set<jetbrains.mps.ide.depanalyzer.DependencyUtil.Dependency> getCyclic(jetbrains.mps.ide.depanalyzer.DependencyUtil.Dependency node, Set<jetbrains.mps.ide.depanalyzer.DependencyUtil.Dependency> visited, List<jetbrains.mps.ide.depanalyzer.DependencyUtil.Dependency> path) {
    Set<jetbrains.mps.ide.depanalyzer.DependencyUtil.Dependency> res = SetSequence.fromSet(new HashSet<jetbrains.mps.ide.depanalyzer.DependencyUtil.Dependency>());
    if (ListSequence.fromList(path).contains(node)) {
      return SetSequence.fromSet(res).addSequence(ListSequence.fromList(path).tailListSequence(ListSequence.fromList(path).indexOf(node)));
    }
    if (!(SetSequence.fromSet(visited).contains(node))) {
      SetSequence.fromSet(visited).addElement(node);
      ListSequence.fromList(path).addElement(node);
      for (DependencyUtil.Link link : ListSequence.fromList(dependencies(node.role(), node.module(), true))) {
        SetSequence.fromSet(res).addSequence(SetSequence.fromSet(getCyclic(new jetbrains.mps.ide.depanalyzer.DependencyUtil.Dependency(link.module, link.role), visited, path)));
      }
      ListSequence.fromList(path).removeLastElement();
    }
    return res;
  }

  public static Set<Tuples._2<DependencyUtil.Role, IModule>> getLoops(DependencyUtil.Role role, IModule module, boolean trackRuntime) {
    Set<Tuples._2<DependencyUtil.Role, IModule>> result = SetSequence.fromSet(new HashSet<Tuples._2<DependencyUtil.Role, IModule>>());
    Set<Tuples._2<DependencyUtil.Role, IModule>> visited = SetSequence.fromSet(new HashSet<Tuples._2<DependencyUtil.Role, IModule>>());
    calcLoops(MultiTuple.<DependencyUtil.Role,IModule>from(role, module), trackRuntime, visited, ListSequence.fromList(new ArrayList<Tuples._2<DependencyUtil.Role, IModule>>()), result);
    return result;
  }

  private static void calcLoops(Tuples._2<DependencyUtil.Role, IModule> cur, boolean trackRuntime, Set<Tuples._2<DependencyUtil.Role, IModule>> visited, List<Tuples._2<DependencyUtil.Role, IModule>> path, Set<Tuples._2<DependencyUtil.Role, IModule>> result) {
    if (ListSequence.fromList(path).contains(cur)) {
      SetSequence.fromSet(result).addSequence(ListSequence.fromList(path).tailListSequence(ListSequence.fromList(path).indexOf(cur)));
      return;
    }
    if (SetSequence.fromSet(visited).contains(cur)) {
      return;
    }
    SetSequence.fromSet(visited).addElement(cur);
    ListSequence.fromList(path).addElement(cur);
    for (DependencyUtil.Link link : ListSequence.fromList(dependencies(cur._0(), cur._1(), trackRuntime))) {
      calcLoops(MultiTuple.<DependencyUtil.Role,IModule>from(link.role, link.module), trackRuntime, visited, path, result);
    }
    ListSequence.fromList(path).removeLastElement();
  }

  private static List<ModuleReference> check_he47wm_b0a0h3a0(LanguageDescriptor checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getExtendedLanguages();
    }
    return null;
  }

  private static List<ModuleReference> check_he47wm_b0b0h3a0(LanguageDescriptor checkedDotOperand) {
    if (null != checkedDotOperand) {
      return checkedDotOperand.getRuntimeModules();
    }
    return null;
  }

  private static <T> T as_he47wm_a0a0a0b0a0f0a3a0(Object o, Class<T> type) {
    return (type.isInstance(o) ?
      (T) o :
      null
    );
  }

  private static <T> T as_he47wm_a0a1a1a5a0d0a(Object o, Class<T> type) {
    return (type.isInstance(o) ?
      (T) o :
      null
    );
  }

  private static <T> T as_he47wm_a0a0a0a0b0g0a3a0(Object o, Class<T> type) {
    return (type.isInstance(o) ?
      (T) o :
      null
    );
  }

  private static <T> T as_he47wm_a0a0a1d0a(Object o, Class<T> type) {
    return (type.isInstance(o) ?
      (T) o :
      null
    );
  }

  private static <T> T as_he47wm_a0a0a2d0a(Object o, Class<T> type) {
    return (type.isInstance(o) ?
      (T) o :
      null
    );
  }

  private static <T> T as_he47wm_a0a1a0a1a3d0a(Object o, Class<T> type) {
    return (type.isInstance(o) ?
      (T) o :
      null
    );
  }

  private static <T> T as_he47wm_a0b0a0h3a0(Object o, Class<T> type) {
    return (type.isInstance(o) ?
      (T) o :
      null
    );
  }

  private static <T> T as_he47wm_a0b0b0h3a0(Object o, Class<T> type) {
    return (type.isInstance(o) ?
      (T) o :
      null
    );
  }

  public static   enum LinkType {
    Depends("depends on"),
    ReexportsDep("reexports dependency on"),
    UsesLanguage("uses language"),
    ExtendsLanguage("extends language"),
    ExportsRuntime("exports runtime"),
    ExportsRuntimeLib("has runtime library"),
    UsesDevkit("uses devkit"),
    ExportsLanguage("exports language"),
    ExportsSolution("exports solution"),
    ExtendsDevkit("extends devkit"),
    Generator("generator"),
    GeneratorLanguage("generator language");

    private String myText;

    LinkType(String text) {
      myText = text;
    }

    @Override
    public String toString() {
      return myText;
    }
  }

  public static   enum Role {
    None(),
    DTDependency_(),
    DTDependency(),
    RTDependency(),
    RTLibraries(),
    UsedLanguage(),
    UsedDevkit(),
    Generator(),
    GeneratorLanguage();

    Role() {
    }
  }

  public static class Dependency extends MultiTuple._2<IModule, DependencyUtil.Role> {
    public Dependency() {
      super();
    }

    public Dependency(IModule module, DependencyUtil.Role role) {
      super(module, role);
    }

    public IModule module(IModule value) {
      return super._0(value);
    }

    public DependencyUtil.Role role(DependencyUtil.Role value) {
      return super._1(value);
    }

    public IModule module() {
      return super._0();
    }

    public DependencyUtil.Role role() {
      return super._1();
    }

    @SuppressWarnings(value = "unchecked")
    public DependencyUtil.Dependency assignFrom(Tuples._2<IModule, DependencyUtil.Role> from) {
      return (DependencyUtil.Dependency) super.assign(from);
    }
  }

  public static class Link {
    public DependencyUtil.Role role;
    public IModule module;
    public DependencyUtil.LinkType linktype;

    public Link(IModule module, DependencyUtil.Role role, DependencyUtil.LinkType linktype) {
      this.module = module;
      this.role = role;
      this.linktype = linktype;
    }

    @Override
    public boolean equals(Object object) {
      if (object instanceof DependencyUtil.Link) {
        DependencyUtil.Link link = (DependencyUtil.Link) object;
        return link.module.equals(module) && link.linktype == linktype && link.role == role;
      }
      return false;
    }

    @Override
    public int hashCode() {
      return module.hashCode() + linktype.hashCode();
    }
  }
}
