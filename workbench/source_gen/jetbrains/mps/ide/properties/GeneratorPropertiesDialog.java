package jetbrains.mps.ide.properties;

/*Generated by MPS */

import jetbrains.mps.workbench.dialogs.project.BasePropertiesDialog;
import jetbrains.mps.smodel.Generator;
import com.intellij.openapi.project.Project;
import jetbrains.mps.project.ModuleContext;
import jetbrains.mps.project.structure.modules.mappingpriorities.MappingPriorityRule;
import jetbrains.mps.project.structure.modules.GeneratorDescriptor;
import jetbrains.mps.smodel.ModelAccess;

public class GeneratorPropertiesDialog extends BasePropertiesDialog {
  public Generator myGenerator;
  public GeneratorProperties myProperties;

  /*package*/ GeneratorPropertiesDialog(Project project, final Generator generator) {
    super("Generator Properties", new ModuleContext(generator, project));
    myGenerator = generator;
    this.collectGeneratorProperties();
  }

  public GeneratorProperties getProperties() {
    return myProperties;
  }

  protected String getErrorString() {
    for (MappingPriorityRule rule : myProperties.getPriorityRules()) {
      if (rule.getLeft().isIncomplete() || rule.getRight().isIncomplete()) {
        return "One or more priority rules are incomplete";
      }
    }
    GeneratorDescriptor tmpDescr = new GeneratorDescriptor();
    myProperties.saveTo(tmpDescr);
    return null;
  }

  private void collectGeneratorProperties() {
    myProperties = new GeneratorProperties();
    myProperties.loadFrom(myGenerator.getModuleDescriptor());
  }

  protected boolean doSaveChanges() {
    String errorString = this.getErrorString();
    if (errorString != null) {
      this.setErrorText(errorString);
      return false;
    }
    ModelAccess.instance().runWriteActionInCommand(new Runnable() {
      public void run() {
        myProperties.saveTo(myGenerator.getModuleDescriptor());
        myGenerator.setModuleDescriptor(myGenerator.getModuleDescriptor(), true);
        myGenerator.save();
      }
    }, getOperationContext().getProject());
    return true;
  }
}
