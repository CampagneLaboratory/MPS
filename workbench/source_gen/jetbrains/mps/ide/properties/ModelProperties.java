package jetbrains.mps.ide.properties;

/*Generated by MPS */

import jetbrains.mps.uiLanguage.runtime.BaseBean;
import java.util.List;
import jetbrains.mps.smodel.SModelReference;
import jetbrains.mps.project.structure.modules.ModuleReference;
import jetbrains.mps.workbench.dialogs.project.components.parts.lists.ListsFactory;
import jetbrains.mps.smodel.SModelDescriptor;
import jetbrains.mps.smodel.IOperationContext;
import jetbrains.mps.generator.ModelGenerationStatusManager;
import jetbrains.mps.smodel.ModelAccess;
import java.util.Set;
import java.util.HashSet;
import jetbrains.mps.project.DevKit;
import jetbrains.mps.project.GlobalScope;
import jetbrains.mps.smodel.SModel;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.smodel.MissingDependenciesFixer;

public class ModelProperties extends BaseBean {
  private List<SModelReference> myImportedModels;
  private List<ModuleReference> myUsedLanguages = ListsFactory.create(ListsFactory.MODULE_VALID_REF_COMPARATOR);
  private List<ModuleReference> myUsedDevKits = ListsFactory.create(ListsFactory.MODULE_VALID_REF_COMPARATOR);
  private List<ModuleReference> myLanguagesEngagedOnGeneration = ListsFactory.create(ListsFactory.MODULE_REF_COMPARATOR);
  private SModelDescriptor myModelDescriptor;
  private IOperationContext myContext;
  private boolean myDoNotGenerate;

  public ModelProperties(SModelDescriptor modelDescriptor, IOperationContext context) {
    this.myModelDescriptor = modelDescriptor;
    this.myImportedModels = ListsFactory.create(ListsFactory.createValidRefComparator(modelDescriptor.getModule().getScope()));
    this.myContext = context;
    this.myImportedModels.addAll(this.myModelDescriptor.getSModel().getImportedModelUIDs());
    this.myUsedLanguages.addAll(this.myModelDescriptor.getSModel().getExplicitlyImportedLanguages());
    this.myUsedDevKits.addAll(this.myModelDescriptor.getSModel().getDevKitRefs());
    this.myLanguagesEngagedOnGeneration.addAll(this.myModelDescriptor.getSModel().getEngagedOnGenerationLanguages());
    this.myDoNotGenerate = ModelGenerationStatusManager.isDoNotGenerate(this.myModelDescriptor);
  }

  public SModelDescriptor getModelDescriptor() {
    return this.myModelDescriptor;
  }

  public List<SModelReference> getImportedModels() {
    return this.myImportedModels;
  }

  public List<ModuleReference> getUsedLanguages() {
    return this.myUsedLanguages;
  }

  public List<ModuleReference> getUsedDevKits() {
    return this.myUsedDevKits;
  }

  public List<ModuleReference> getLanguagesEngagedOnGeneration() {
    return this.myLanguagesEngagedOnGeneration;
  }

  public boolean isDoNotGenerate() {
    return this.myDoNotGenerate;
  }

  public void setDoNotGenerate(boolean doNotGenerate) {
    this.myDoNotGenerate = doNotGenerate;
  }

  public void saveChanges() {
    ModelAccess.instance().runWriteActionInCommand(new Runnable() {
      public void run() {
        ModelProperties.this.addNewModels();
        ModelProperties.this.removeUnusedModels();
        ModelProperties.this.addNewLanguages();
        ModelProperties.this.removeUnusedLanguages();
        ModelProperties.this.addNewDevKits();
        ModelProperties.this.removeUnusedDevKits();
        ModelProperties.this.addNewEngagedOnGenerationLanguages();
        ModelProperties.this.removeUnusedEngagedOnGenerationLanguages();
        if (ModelGenerationStatusManager.isDoNotGenerate(ModelProperties.this.myModelDescriptor) != ModelProperties.this.myDoNotGenerate) {
          ModelGenerationStatusManager.setDoNotGenerate(ModelProperties.this.myModelDescriptor, ModelProperties.this.myDoNotGenerate);
        }
        ModelProperties.this.myModelDescriptor.save();
      }
    });
    this.addMissingDependenciesToModule();
  }

  private void addNewDevKits() {
    Set<ModuleReference> devKitsInModel = new HashSet<ModuleReference>(this.myModelDescriptor.getSModel().getDevKitRefs());
    Set<ModuleReference> devKitsInProperties = new HashSet<ModuleReference>(this.getUsedDevKits());
    devKitsInProperties.removeAll(devKitsInModel);
    for (ModuleReference dk : devKitsInProperties) {
      DevKit devKit = GlobalScope.getInstance().getDevKit(dk);
      assert devKit != null;
      SModel model = this.myModelDescriptor.getSModel();
      model.addNewlyImportedDevKit(dk);
    }
  }

  private void removeUnusedDevKits() {
    Set<ModuleReference> propsDevKits = new HashSet<ModuleReference>(this.getUsedDevKits());
    for (ModuleReference dk : this.myModelDescriptor.getSModel().getDevKitRefs()) {
      if (!(propsDevKits.contains(dk))) {
        this.myModelDescriptor.getSModel().deleteDevKit(dk);
      }
    }
  }

  protected String getErrorString() {
    return null;
  }

  private void addNewLanguages() {
    Set<ModuleReference> languagesInModel = new HashSet<ModuleReference>(this.myModelDescriptor.getSModel().getExplicitlyImportedLanguages());
    Set<ModuleReference> languagesInProps = new HashSet<ModuleReference>(this.getUsedLanguages());
    languagesInProps.removeAll(languagesInModel);
    for (ModuleReference namespace : languagesInProps) {
      Language language = GlobalScope.getInstance().getLanguage(namespace);
      if (language != null) {
        this.myModelDescriptor.getSModel().addLanguage(language);
      }
    }
  }

  private void removeUnusedLanguages() {
    Set<ModuleReference> languagesInModel = new HashSet<ModuleReference>(this.myModelDescriptor.getSModel().getExplicitlyImportedLanguages());
    Set<ModuleReference> languagesInProps = new HashSet<ModuleReference>(this.getUsedLanguages());
    languagesInModel.removeAll(languagesInProps);
    for (ModuleReference namespace : languagesInModel) {
      this.myModelDescriptor.getSModel().deleteLanguage(namespace);
    }
  }

  private void addNewEngagedOnGenerationLanguages() {
    Set<ModuleReference> languagesInModel = new HashSet<ModuleReference>(this.myModelDescriptor.getSModel().getEngagedOnGenerationLanguages());
    Set<ModuleReference> languagesInProps = new HashSet<ModuleReference>(this.getLanguagesEngagedOnGeneration());
    languagesInProps.removeAll(languagesInModel);
    for (ModuleReference namespace : languagesInProps) {
      this.myModelDescriptor.getSModel().addEngagedOnGenerationLanguage(namespace);
    }
  }

  private void removeUnusedEngagedOnGenerationLanguages() {
    Set<ModuleReference> languagesInModel = new HashSet<ModuleReference>(this.myModelDescriptor.getSModel().getEngagedOnGenerationLanguages());
    Set<ModuleReference> languagesInProps = new HashSet<ModuleReference>(this.getLanguagesEngagedOnGeneration());
    languagesInModel.removeAll(languagesInProps);
    for (ModuleReference ref : languagesInModel) {
      this.myModelDescriptor.getSModel().removeEngagedOnGenerationLanguage(ref);
    }
  }

  private void addNewModels() {
    Set<SModelReference> modelsInModel = new HashSet<SModelReference>(this.myModelDescriptor.getSModel().getImportedModelUIDs());
    Set<SModelReference> modelsInProps = new HashSet<SModelReference>(this.getImportedModels());
    modelsInProps.removeAll(modelsInModel);
    for (SModelReference modelReference : modelsInProps) {
      this.myModelDescriptor.getSModel().addImportedModel(modelReference);
    }
  }

  private void removeUnusedModels() {
    Set<SModelReference> modelsInModel = new HashSet<SModelReference>(this.myModelDescriptor.getSModel().getImportedModelUIDs());
    Set<SModelReference> modelsInProps = new HashSet<SModelReference>(this.getImportedModels());
    modelsInModel.removeAll(modelsInProps);
    for (SModelReference modelReference : modelsInModel) {
      this.myModelDescriptor.getSModel().deleteImportedModel(modelReference);
    }
  }

  private void addMissingDependenciesToModule() {
    new MissingDependenciesFixer(this.myContext, this.myModelDescriptor).fix();
  }
}
