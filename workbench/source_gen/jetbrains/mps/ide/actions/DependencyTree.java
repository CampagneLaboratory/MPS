package jetbrains.mps.ide.actions;

/*Generated by MPS */

import jetbrains.mps.ide.ui.MPSTree;
import jetbrains.mps.project.MPSProject;
import jetbrains.mps.ide.ui.MPSTreeNode;
import jetbrains.mps.ide.ui.TextMPSTreeNode;
import jetbrains.mps.project.IModule;
import jetbrains.mps.ide.projectPane.logicalview.nodes.ProjectModuleTreeNode;
import jetbrains.mps.smodel.SModelDescriptor;
import jetbrains.mps.ide.ui.smodel.SModelTreeNode;
import jetbrains.mps.project.ModuleContext;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.ide.ui.smodel.SNodeTreeNode;
import javax.swing.JPopupMenu;
import javax.swing.event.TreeSelectionListener;
import javax.swing.event.TreeSelectionEvent;
import javax.swing.tree.TreePath;
import jetbrains.mps.ide.projectPane.NamespaceTextNode;

public class DependencyTree extends MPSTree {
  private Scope myScope;
  private MPSProject myProject;
  private DependenciesComponent myParent;

  public DependencyTree(DependenciesComponent parent) {
    myParent = parent;
    addTreeSelectionListener(new DependencyTree.MyTreeSelectionListener());
  }

  protected MPSTreeNode rebuild() {
    TextMPSTreeNode root = new TextMPSTreeNode("root", null);
    for (IModule module : myScope.getModules()) {
      root.add(ProjectModuleTreeNode.createFor(myProject, module));
    }
    for (SModelDescriptor modelDescriptor : myScope.getModels()) {
      SModelTreeNode node = new SModelTreeNode(modelDescriptor, null, new ModuleContext(modelDescriptor.getModule(), myProject));
      root.add(node);
    }
    for (SNode node : myScope.getRoots()) {
      SNodeTreeNode treeNode = new SNodeTreeNode(node, null, new ModuleContext(node.getModel().getModelDescriptor().getModule(), myProject));
      root.add(treeNode);
    }
    setRootVisible(false);
    setShowsRootHandles(true);
    return root;
  }

  @Override
  protected JPopupMenu createPopupMenu(MPSTreeNode node) {
    return null;
  }

  public void setContent(Scope scope, MPSProject project) {
    myScope = scope;
    myProject = project;
    rebuildLater();
  }

  public class MyTreeSelectionListener implements TreeSelectionListener {
    public MyTreeSelectionListener() {
    }

    public void valueChanged(TreeSelectionEvent event) {
      TreePath[] paths = getSelectionPaths();
      if (paths == null || paths.length == 0) {
        return;
      }
      Scope scope = new Scope();
      for (TreePath path : paths) {
        MPSTreeNode node = (MPSTreeNode) path.getLastPathComponent();
        if (node instanceof SModelTreeNode) {
          scope.add(((SModelTreeNode) node).getSModelDescriptor());
        }
        if (node instanceof ProjectModuleTreeNode) {
          scope.add(((ProjectModuleTreeNode) node).getModule());
        }
        if (node instanceof SNodeTreeNode) {
          scope.add(((SNodeTreeNode) node).getSNode());
        }
        if (node instanceof NamespaceTextNode) {
          for (IModule module : ((NamespaceTextNode) node).getModulesUnder()) {
            scope.add(module);
          }
          for (SModelDescriptor model : ((NamespaceTextNode) node).getModelsUnder()) {
            scope.add(model);
          }
        }

      }
      myParent.updateTargetsView(scope);
    }
  }
}
