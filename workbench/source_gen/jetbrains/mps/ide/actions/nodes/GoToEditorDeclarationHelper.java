package jetbrains.mps.ide.actions.nodes;

/*Generated by MPS */

import jetbrains.mps.smodel.SNode;
import jetbrains.mps.smodel.SModelDescriptor;
import jetbrains.mps.smodel.IScope;
import jetbrains.mps.smodel.ModelAccess;
import com.intellij.openapi.util.Computable;
import javax.swing.JOptionPane;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.smodel.LanguageAspect;
import jetbrains.mps.smodel.SModel;
import jetbrains.mps.util.Condition;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import java.util.Iterator;
import jetbrains.mps.util.ConditionalIterator;
import jetbrains.mps.smodel.action.SNodeFactoryOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SModelOperations;

public class GoToEditorDeclarationHelper {
  public GoToEditorDeclarationHelper() {
  }

  public static SNode getOrCreateEditorForConcept(final SModelDescriptor languageEditor, final SNode concept, final SNode node, final IScope scope) {
    SNode editorDeclaration = ModelAccess.instance().runReadAction(new Computable<SNode>() {
      public SNode compute() {
        return findEditorDeclaration(languageEditor.getSModel(), concept);
      }
    });
    if (editorDeclaration != null) {
      return editorDeclaration;
    }
    String message = ModelAccess.instance().runReadAction(new Computable<String>() {
      public String compute() {
        return "Concept \"" + node.getConceptFqName() + "\" has no editor.\n" + "Create new editor?";
      }
    });
    int option = JOptionPane.showConfirmDialog(null, message, "Editor not found", JOptionPane.YES_NO_OPTION, JOptionPane.QUESTION_MESSAGE);
    if (option != JOptionPane.YES_OPTION) {
      return null;
    }
    return ModelAccess.instance().runWriteActionInCommand(new Computable<SNode>() {
      public SNode compute() {
        return GoToEditorDeclarationHelper.createEditorDeclaration(concept, languageEditor, scope);
      }
    }, null);
  }

  public static SModelDescriptor getOrCreateEditorAspect(final Language language, final SNode concept, final IScope scope) {
    final SModelDescriptor languageEditor = language.getEditorModelDescriptor();
    if (languageEditor != null) {
      return languageEditor;
    }
    String message = "Language \"" + language.getModuleFqName() + "\" has no editor model.\n" + "Create new editor model?";
    int option = JOptionPane.showConfirmDialog(null, message, "Editor not found", JOptionPane.YES_NO_OPTION, JOptionPane.QUESTION_MESSAGE);
    if (option != JOptionPane.YES_OPTION) {
      return null;
    }
    ModelAccess.instance().runWriteActionInCommand(new Runnable() {
      public void run() {
        LanguageAspect.EDITOR.createNew(language);
        GoToEditorDeclarationHelper.createEditorDeclaration(concept, language.getEditorModelDescriptor(), scope);
      }
    });
    return language.getEditorModelDescriptor();
  }

  public static SNode findEditorDeclaration(SModel editorModel, final SNode conceptDeclaration) {
    Condition<SNode> cond = new Condition<SNode>() {
      public boolean met(SNode node) {
        SNode n = SNodeOperations.as(node, "jetbrains.mps.lang.editor.structure.ConceptEditorDeclaration");
        return (n != null) && SLinkOperations.getTarget(n, "conceptDeclaration", false) == conceptDeclaration;
      }
    };
    Iterator<SNode> editors = new ConditionalIterator<SNode>(editorModel.rootsIterator(), cond);
    if (!(editors.hasNext())) {
      return null;
    }
    return SNodeOperations.cast(editors.next(), "jetbrains.mps.lang.editor.structure.ConceptEditorDeclaration");
  }

  public static SNode createEditorDeclaration(SNode conceptDeclaration, SModelDescriptor editorModelDescriptor, IScope scope) {
    SModel editorModel = editorModelDescriptor.getSModel();
    SNode result = SNodeFactoryOperations.createNewNode(editorModel, "jetbrains.mps.lang.editor.structure.ConceptEditorDeclaration", null);
    SLinkOperations.setTarget(result, "conceptDeclaration", conceptDeclaration, false);
    SModelOperations.addRootNode(editorModel, result);
    return result;
  }
}
