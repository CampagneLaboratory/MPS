package jetbrains.mps.ide.actions;

/*Generated by MPS */

import jetbrains.mps.baseLanguage.structure.ClassConcept;
import jetbrains.mps.baseLanguage.structure.InstanceMethodDeclaration;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.smodel.ModelAccess;
import java.util.List;
import java.util.ArrayList;
import jetbrains.mps.baseLanguage.typesystem.ResolveUtil;
import jetbrains.mps.baseLanguage.structure.BaseMethodDeclaration;
import jetbrains.mps.baseLanguage.structure.StatementList;
import jetbrains.mps.smodel.INodeAdapter;
import jetbrains.mps.baseLanguage.structure.Classifier;

public class AddClassMethodStrategy implements StratergyAddMethodDialog.ContainerStrategy {
  private ClassConcept myClassConcept;
  private InstanceMethodDeclaration myContextMethod;

  public AddClassMethodStrategy(final SNode contextNode) {
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        AddClassMethodStrategy.this.myClassConcept = contextNode.getAdapter().getParent(ClassConcept.class);
        AddClassMethodStrategy.this.myContextMethod = contextNode.getAdapter().getParent(InstanceMethodDeclaration.class);
      }
    });
  }

  public List<StratergyAddMethodDialog.ContainerStrategy.MethodAddition> doAddMethods(List<SNode> baseMethods) {
    boolean insertion = this.myContextMethod != null && this.myContextMethod.getParent() == this.myClassConcept;
    List<StratergyAddMethodDialog.ContainerStrategy.MethodAddition> methods = new ArrayList<StratergyAddMethodDialog.ContainerStrategy.MethodAddition>();
    for (SNode methodNode : baseMethods) {
      SNode classNode = this.myClassConcept.getNode();
      InstanceMethodDeclaration method = (InstanceMethodDeclaration) ResolveUtil.processMethodToImplement(classNode, methodNode).getAdapter();
      methods.add(new StratergyAddMethodDialog.ContainerStrategy.MethodAddition(((BaseMethodDeclaration) methodNode.getAdapter()), method));
      method.setIsAbstract(false);
      method.setBody(StatementList.newInstance(this.myClassConcept.getModel()));
      if (insertion) {
        this.myClassConcept.insertMethod(this.myContextMethod, method);
      } else {
        this.myClassConcept.addMethod(method);
      }
    }
    return (List<StratergyAddMethodDialog.ContainerStrategy.MethodAddition>) methods;
  }

  public boolean extendsContainer(INodeAdapter containerThatExtends, INodeAdapter extendedContainer) {
    return false;
  }

  public int compareContainers(INodeAdapter c1, INodeAdapter c2) {
    return 0;
  }

  public SNode getMainContainer() {
    return this.myClassConcept.getNode();
  }

  public SNode getContainer(SNode methodDecl) {
    return methodDecl.getAdapter().getParent(Classifier.class).getNode();
  }
}
