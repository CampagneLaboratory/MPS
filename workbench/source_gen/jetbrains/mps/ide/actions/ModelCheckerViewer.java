package jetbrains.mps.ide.actions;

/*Generated by MPS */

import javax.swing.JPanel;
import jetbrains.mps.project.MPSProject;
import jetbrains.mps.ide.findusages.view.UsagesView;
import java.awt.BorderLayout;
import jetbrains.mps.ide.findusages.view.treeholder.treeview.ViewOptions;
import jetbrains.mps.ide.findusages.findalgorithm.finders.IFinder;
import jetbrains.mps.ide.findusages.model.IResultProvider;
import jetbrains.mps.ide.findusages.view.FindUtils;
import jetbrains.mps.ide.findusages.model.SearchQuery;
import com.intellij.openapi.progress.ProgressManager;
import com.intellij.openapi.progress.Task;
import com.intellij.openapi.project.Project;
import org.jetbrains.annotations.NotNull;
import com.intellij.openapi.progress.ProgressIndicator;
import jetbrains.mps.smodel.SModelDescriptor;
import jetbrains.mps.ide.findusages.view.treeholder.treeview.INodeRepresentator;
import jetbrains.mps.ide.findusages.view.treeholder.tree.TextOptions;
import javax.swing.Icon;
import jetbrains.mps.ide.projectPane.Icons;
import org.apache.commons.lang.StringEscapeUtils;
import org.jdom.Element;
import jetbrains.mps.ide.findusages.CantSaveSomethingException;
import jetbrains.mps.ide.findusages.CantLoadSomethingException;
import jetbrains.mps.smodel.SNodeId;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import jetbrains.mps.smodel.ModelAccess;

public class ModelCheckerViewer extends JPanel {
  private MPSProject myProject;
  private UsagesView myUsagesView;

  public ModelCheckerViewer(MPSProject mpsProject, final ModelCheckerTool_Tool tool) {
    this.myProject = mpsProject;

    this.setLayout(new BorderLayout());
    ViewOptions viewOptions = new ViewOptions(true, false, false, false, false);
    viewOptions.myCategory = true;

    final ModelCheckerViewer theViewer = this;
    this.myUsagesView = new UsagesView(mpsProject, viewOptions) {
      public void close() {
        tool.closeTab(theViewer);
      }
    };
    this.myUsagesView.setCustomNodeRepresentator(new ModelCheckerViewer.MyNodeRepresentator());
    this.add(this.myUsagesView.getComponent());
  }

  private void checkSomething(final IFinder finder) {
    IResultProvider resultProvider = FindUtils.makeProvider(finder);
    SearchQuery searchQuery = new SearchQuery(ModelCheckerViewer.this.myProject.getScope());
    ModelCheckerViewer.this.myUsagesView.setRunOptions(resultProvider, searchQuery, new UsagesView.ButtonConfiguration(false, false, true));

    ProgressManager.getInstance().run(new Task.Modal(this.myProject.getComponent(Project.class), "Checking some model", true) {
      public void run(@NotNull ProgressIndicator indicator) {
        ModelCheckerViewer.this.myUsagesView.run(indicator);
      }
    });
  }

  public void checkModel(SModelDescriptor modelDescriptor) {
    this.checkSomething(new ModelIssueFinder(modelDescriptor));
  }

  public static class MyNodeRepresentator implements INodeRepresentator<ModelCheckerIssue> {
    private static final String CATEGORY_ERROR = "ERROR";
    private static final String CATEGORY_WARNING = "WARNING";
    private static final String CATEGORY_OK = "OK";

    public MyNodeRepresentator() {
    }

    public String getResultsText(TextOptions options) {
      int size = options.mySubresultsCount;
      String sizeRepr = size + " issue" + ((size == 1 ?
        "" :
        "s"
      ));
      return "<strong>" + sizeRepr + " found</strong>";
    }

    public Icon getResultsIcon() {
      return Icons.CLOSED_FOLDER;
    }

    public String getCategoryText(TextOptions options, String category, boolean isResultsSection) {
      String counter = "";
      if (options.myCounters && isResultsSection) {
        int size = options.mySubresultsCount;
        counter = " (" + size + " issue" + ((size == 0 ?
          "" :
          "s"
        )) + ")";
      }
      String categoryRepr = "";
      if (CATEGORY_ERROR.equals(category)) {
        categoryRepr = "Errors";
      } else if (CATEGORY_WARNING.equals(category)) {
        categoryRepr = "Warnings";
      } else if (CATEGORY_OK.equals(category)) {
        categoryRepr = "Infos";
      }
      return "<strong>" + categoryRepr + counter + "</strong>";
    }

    public Icon getCategoryIcon(String category) {
      if (CATEGORY_ERROR.equals(category)) {
        return jetbrains.mps.ide.messages.Icons.ERROR_ICON;
      } else if (CATEGORY_WARNING.equals(category)) {
        return jetbrains.mps.ide.messages.Icons.WARNING_ICON;
      } else if (CATEGORY_OK.equals(category)) {
        return jetbrains.mps.ide.messages.Icons.INFORMATION_ICON;
      }
      return jetbrains.mps.ide.messages.Icons.ERROR_ICON;
    }

    public String getPresentation(ModelCheckerIssue issue) {
      return StringEscapeUtils.escapeHtml(issue.getMessage());
    }

    public void write(Element element, MPSProject project) throws CantSaveSomethingException {
    }

    public void read(Element element, MPSProject project) throws CantLoadSomethingException {
    }

    private static SNodeId getNodeId(final SNode node) {
      final Wrappers._T<SNodeId> nodeId = new Wrappers._T<SNodeId>();
      ModelAccess.instance().runReadAction(new Runnable() {
        public void run() {
          nodeId.value = node.getSNodeId();
        }
      });
      return nodeId.value;
    }
  }
}
