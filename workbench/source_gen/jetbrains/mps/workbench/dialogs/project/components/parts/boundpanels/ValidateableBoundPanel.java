package jetbrains.mps.workbench.dialogs.project.components.parts.boundpanels;

/*Generated by MPS */

import javax.swing.JPanel;
import jetbrains.mps.workbench.dialogs.project.IBindedDialog;
import java.util.List;
import jetbrains.mps.util.Condition;
import javax.swing.DefaultListCellRenderer;
import javax.swing.TransferHandler;
import jetbrains.mps.workbench.dialogs.project.components.parts.validators.Validator;
import com.intellij.openapi.util.Computable;
import jetbrains.mps.workbench.dialogs.project.components.parts.actions.BaseValidatedAction;
import org.jetbrains.annotations.NotNull;
import java.util.Collections;
import java.awt.event.KeyListener;
import javax.swing.border.TitledBorder;
import java.awt.BorderLayout;
import javax.swing.JComponent;
import jetbrains.mps.workbench.dialogs.project.components.parts.CopySupport;
import javax.swing.JScrollPane;
import com.intellij.openapi.actionSystem.AnAction;
import java.util.ArrayList;
import com.intellij.openapi.actionSystem.DefaultActionGroup;
import jetbrains.mps.workbench.action.ActionUtils;
import com.intellij.openapi.actionSystem.ActionToolbar;
import com.intellij.openapi.actionSystem.ActionManager;
import com.intellij.openapi.actionSystem.ActionPlaces;
import java.awt.Color;
import java.awt.event.KeyAdapter;
import java.awt.event.KeyEvent;

public abstract class ValidateableBoundPanel<T> extends JPanel {
  protected IBindedDialog myOwner;
  protected String myCaption;
  protected List<T> myList;
  protected Condition<T> myCanRemoveCondition = Condition.TRUE_CONDITION;
  protected DefaultListCellRenderer myCellRenderer;
  protected TransferHandler myTransferHandler;
  private Validator myObjectValidator = null;
  private Computable<List<T>> myChooser;
  private BaseValidatedAction myAddAction;
  private BaseValidatedAction myRemoveAction;
  private BaseValidatedAction myEditAction;
  private boolean myActionsSet = false;
  private ValidateableBoundPanel.MyValidator myValidator = new ValidateableBoundPanel.MyValidator();
  private boolean myInitialized = false;

  public ValidateableBoundPanel(final IBindedDialog owner, String caption, @NotNull final List<T> list) {
    this.myOwner = owner;
    this.myCaption = caption;
    this.myList = list;
  }

  public void setChooseActions(BaseValidatedAction add, BaseValidatedAction rem, BaseValidatedAction edit) {
    assert !(this.myInitialized);
    this.myAddAction = add;
    this.myRemoveAction = rem;
    this.myEditAction = edit;
    this.myActionsSet = true;
  }

  public void setChooser(final Computable<T> chooser) {
    assert !(this.myInitialized);
    this.myChooser = new Computable<List<T>>() {
      public List<T> compute() {
        return Collections.singletonList(chooser.compute());
      }
    };
  }

  public void setMultipleChooser(Computable<List<T>> chooser) {
    assert !(this.myInitialized);
    this.myChooser = chooser;
  }

  public void setCellRenderer(DefaultListCellRenderer cellRenderer) {
    assert !(this.myInitialized);
    this.myCellRenderer = cellRenderer;
  }

  public void setTransferHandler(TransferHandler transferHandler) {
    assert !(this.myInitialized);
    this.myTransferHandler = transferHandler;
  }

  public void setObjectValidator(Validator objectValidator) {
    this.myObjectValidator = objectValidator;
  }

  public void setCanRemoveCondition(Condition<T> canRemoveCondition) {
    assert !(this.myInitialized);
    this.myCanRemoveCondition = (canRemoveCondition != null ?
      canRemoveCondition :
      Condition.TRUE_CONDITION
    );
  }

  protected KeyListener getListKeyAdapter() {
    return new ValidateableBoundPanel.MyKeyAdapter();
  }

  public void init() {
    this.myInitialized = true;
    this.setBorder(new TitledBorder(this.myCaption));
    this.setLayout(new BorderLayout());
    JComponent component = ValidateableBoundPanel.this.initUIComponentAndBinding();
    if (this.myTransferHandler != null) {
      component.setTransferHandler(this.myTransferHandler);
    }
    CopySupport.addCopyPopup(component);
    component.addKeyListener(ValidateableBoundPanel.this.getListKeyAdapter());
    JComponent actionsComponent = ValidateableBoundPanel.this.createActionsComponent();
    if (actionsComponent != null) {
      this.add(actionsComponent, BorderLayout.WEST);
    }
    JScrollPane comp = new JScrollPane(component);
    comp.doLayout();
    this.add(comp, BorderLayout.CENTER);
    this.myValidator.run();
  }

  private JComponent createActionsComponent() {
    if (!(this.myActionsSet)) {
      this.myAddAction = ValidateableBoundPanel.this.createAddAction(this.myChooser);
      this.myRemoveAction = ValidateableBoundPanel.this.createRemoveAction();
    }
    List<AnAction> act = new ArrayList<AnAction>();
    if (this.myAddAction != null) {
      this.myAddAction.setValidator(this.myValidator);
      act.add(this.myAddAction);
    }
    if (this.myRemoveAction != null) {
      this.myRemoveAction.setValidator(this.myValidator);
      act.add(this.myRemoveAction);
    }
    if (this.myEditAction != null) {
      this.myEditAction.setValidator(this.myValidator);
      act.add(this.myEditAction);
    }
    AnAction[] actions = act.toArray(new AnAction[act.size()]);
    if (actions.length == 0) {
      return null;
    }
    DefaultActionGroup group = ActionUtils.groupFromActions(actions);
    ActionToolbar toolbar = ActionManager.getInstance().createActionToolbar(ActionPlaces.UNKNOWN, group, false);
    return toolbar.getComponent();
  }

  protected abstract BaseValidatedAction createAddAction(Computable<List<T>> chooser);

  protected abstract BaseValidatedAction createRemoveAction();

  protected abstract JComponent initUIComponentAndBinding();

  private class MyValidator implements Runnable {
    private MyValidator() {
    }

    public void run() {
      if (ValidateableBoundPanel.this.myObjectValidator == null) {
        return;
      }
      if (!((ValidateableBoundPanel.this.getBorder() instanceof TitledBorder))) {
        return;
      }
      TitledBorder titledBorder = (TitledBorder) ValidateableBoundPanel.this.getBorder();
      boolean hasError = false;
      for (T value : ValidateableBoundPanel.this.myList) {
        if (ValidateableBoundPanel.this.myObjectValidator.isBrokenValue(value)) {
          hasError = true;
          break;
        }
      }
      titledBorder.setTitleColor((hasError ?
        Color.RED :
        Color.BLACK
      ));
      ValidateableBoundPanel.this.repaint();
    }
  }

  private class MyKeyAdapter extends KeyAdapter {
    private MyKeyAdapter() {
    }

    public void keyPressed(KeyEvent e) {
      if (e.getKeyCode() == KeyEvent.VK_INSERT) {
        if (ValidateableBoundPanel.this.myAddAction != null) {
          ActionUtils.updateAndPerformAction(ValidateableBoundPanel.this.myAddAction, ActionUtils.createEvent(e));
        }
        e.consume();
      }
      if (e.getKeyCode() == KeyEvent.VK_DELETE) {
        if (ValidateableBoundPanel.this.myRemoveAction != null) {
          ActionUtils.updateAndPerformAction(ValidateableBoundPanel.this.myRemoveAction, ActionUtils.createEvent(e));
        }
        e.consume();
      }
    }
  }
}
