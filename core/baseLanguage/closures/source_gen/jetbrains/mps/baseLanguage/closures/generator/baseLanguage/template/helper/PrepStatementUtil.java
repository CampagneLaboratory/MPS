package jetbrains.mps.baseLanguage.closures.generator.baseLanguage.template.helper;

/*Generated by MPS */

import jetbrains.mps.generator.template.ITemplateGenerator;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;

public class PrepStatementUtil {
  private PrepStatementUtil.Context ctx;
  private ITemplateGenerator generator;

  private PrepStatementUtil(ITemplateGenerator generator) {
    this.ctx = new PrepStatementUtil.Context();
    this.generator = generator;
  }

  private void prepTopStatementList(SNode slist) {
    int beginLabel = this.ctx.label;
    int endLabel = this.ctx.incrementLabel();
    Object data = new Integer[]{beginLabel,endLabel};
    Values.CLOSURE_DATA.set(slist, data);
    this.prepStatementList(slist);
  }

  private int prepStatementList(SNode slist) {
    boolean labelAutoIncremented = true;
    int label = this.ctx.incrementLabel();
    for (SNode stmt : SLinkOperations.getTargets(slist, "statement", true)) {
      if (!(labelAutoIncremented) && StatementListUtil.isControlStatement(stmt)) {
        label = this.ctx.incrementLabel();
      }
      labelAutoIncremented = StatementListUtil.isControlStatement(stmt);
      label = this.prepStatement(stmt, label);
    }
    return label;
  }

  private int prepStatement(SNode stmt, int label) {
    if (SNodeOperations.isInstanceOf(stmt, "jetbrains.mps.baseLanguage.structure.WhileStatement")) {
      return this.prepWhileStatement(SNodeOperations.cast(stmt, "jetbrains.mps.baseLanguage.structure.WhileStatement"), label);
    } else
    if (SNodeOperations.isInstanceOf(stmt, "jetbrains.mps.baseLanguage.structure.DoWhileStatement")) {
      return this.prepDoWhileStatement(SNodeOperations.cast(stmt, "jetbrains.mps.baseLanguage.structure.DoWhileStatement"), label);
    } else
    if (SNodeOperations.isInstanceOf(stmt, "jetbrains.mps.baseLanguage.structure.ForStatement")) {
      return this.prepForStatement(SNodeOperations.cast(stmt, "jetbrains.mps.baseLanguage.structure.ForStatement"), label);
    } else
    if (SNodeOperations.isInstanceOf(stmt, "jetbrains.mps.baseLanguage.structure.ForeachStatement")) {
      return this.prepForeachStatement(SNodeOperations.cast(stmt, "jetbrains.mps.baseLanguage.structure.ForeachStatement"), label);
    } else
    if (SNodeOperations.isInstanceOf(stmt, "jetbrains.mps.baseLanguage.structure.IfStatement")) {
      return this.prepIfStatement(SNodeOperations.cast(stmt, "jetbrains.mps.baseLanguage.structure.IfStatement"), label);
    } else
    if (SNodeOperations.isInstanceOf(stmt, "jetbrains.mps.baseLanguage.structure.SwitchStatement")) {
      return this.prepSwitchStatement(SNodeOperations.cast(stmt, "jetbrains.mps.baseLanguage.structure.SwitchStatement"), label);
    } else
    if (SNodeOperations.isInstanceOf(stmt, "jetbrains.mps.baseLanguage.structure.LocalVariableDeclarationStatement")) {
      return this.prepLocalvariableDeclarationStatement(SNodeOperations.cast(stmt, "jetbrains.mps.baseLanguage.structure.LocalVariableDeclarationStatement"), label);
    } else
    if (SNodeOperations.isInstanceOf(stmt, "jetbrains.mps.baseLanguage.closures.structure.YieldStatement")) {
      return this.prepYieldStatement(SNodeOperations.cast(stmt, "jetbrains.mps.baseLanguage.closures.structure.YieldStatement"), label);
    } else
    if (SNodeOperations.isInstanceOf(stmt, "jetbrains.mps.baseLanguage.structure.BreakStatement")) {
      this.prepBreakStatement(SNodeOperations.cast(stmt, "jetbrains.mps.baseLanguage.structure.BreakStatement"));
    } else
    if (SNodeOperations.isInstanceOf(stmt, "jetbrains.mps.baseLanguage.structure.ContinueStatement")) {
      this.prepContinueStatement(SNodeOperations.cast(stmt, "jetbrains.mps.baseLanguage.structure.ContinueStatement"));
    } else
    if (SNodeOperations.isInstanceOf(stmt, "jetbrains.mps.baseLanguage.structure.BlockStatement")) {
      return this.prepBlockStatement(SNodeOperations.cast(stmt, "jetbrains.mps.baseLanguage.structure.BlockStatement"), label);
    }
    return label;
  }

  private int prepWhileStatement(SNode wstmt, int label) {
    int beginLabel = label;
    int blockLabel = this.ctx.incrementLabel();
    SNode sn = SLinkOperations.getTarget(wstmt, "body", true);
    Object data1 = new Integer[]{blockLabel,beginLabel};
    Values.CLOSURE_DATA.set(sn, data1);
    int nextLabel = this.calcNextLabel(wstmt);
    Object data = new Integer[]{beginLabel,beginLabel,blockLabel,nextLabel};
    Values.CLOSURE_DATA.set(wstmt, data);
    this.prepStatementList(SLinkOperations.getTarget(wstmt, "body", true));
    return nextLabel;
  }

  private int prepDoWhileStatement(SNode dwstmt, int label) {
    int beginLabel = label;
    int condLabel = this.ctx.incrementLabel();
    SNode sn = SLinkOperations.getTarget(dwstmt, "body", true);
    Object data = new Integer[]{beginLabel,condLabel};
    Values.CLOSURE_DATA.set(sn, data);
    int nextLabel = this.calcNextLabel(dwstmt);
    Object data1 = new Integer[]{beginLabel,condLabel,nextLabel};
    Values.CLOSURE_DATA.set(dwstmt, data1);
    this.prepStatementList(SLinkOperations.getTarget(dwstmt, "body", true));
    return nextLabel;
  }

  private int prepForStatement(SNode fstmt, int label) {
    int beginLabel = label;
    this.prepLocalVariableDeclaration(SLinkOperations.getTarget(fstmt, "variable", true));
    int condLabel = this.ctx.incrementLabel();
    int blockLabel = this.ctx.incrementLabel();
    int postLabel = this.ctx.incrementLabel();
    SNode sn = SLinkOperations.getTarget(fstmt, "body", true);
    Object data = new Integer[]{blockLabel,postLabel};
    Values.CLOSURE_DATA.set(sn, data);
    int nextLabel = this.calcNextLabel(fstmt);
    Object data1 = new Integer[]{beginLabel,postLabel,blockLabel,condLabel,nextLabel};
    Values.CLOSURE_DATA.set(fstmt, data1);
    this.prepStatementList(SLinkOperations.getTarget(fstmt, "body", true));
    return nextLabel;
  }

  private int prepForeachStatement(SNode fstmt, int label) {
    int beginLabel = label;
    this.prepLocalVariableDeclaration(SLinkOperations.getTarget(fstmt, "variable", true));
    int condLabel = this.ctx.incrementLabel();
    int blockLabel = this.ctx.incrementLabel();
    SNode sn = SLinkOperations.getTarget(fstmt, "body", true);
    Object data1 = new Integer[]{blockLabel,condLabel};
    Values.CLOSURE_DATA.set(sn, data1);
    int nextLabel = this.calcNextLabel(fstmt);
    Object data = new Integer[]{beginLabel,condLabel,blockLabel,nextLabel};
    Values.CLOSURE_DATA.set(fstmt, data);
    this.prepStatementList(SLinkOperations.getTarget(fstmt, "body", true));
    return nextLabel;
  }

  private int prepIfStatement(SNode ifstmt, int label) {
    int beginLabel = label;
    int ifTrueLabel = this.ctx.incrementLabel();
    int ifFalseLabel = -1;
    int nextLabel = this.calcNextLabel(ifstmt);
    SNode sn = SLinkOperations.getTarget(ifstmt, "ifTrue", true);
    Object data = new Integer[]{ifTrueLabel,nextLabel};
    Values.CLOSURE_DATA.set(sn, data);
    this.prepStatementList(SLinkOperations.getTarget(ifstmt, "ifTrue", true));
    if (SLinkOperations.getCount(ifstmt, "elsifClauses") > 0) {
      for (SNode eicls : SLinkOperations.getTargets(ifstmt, "elsifClauses", true)) {
        int tmp = this.ctx.incrementLabel();
        SNode sn1 = SLinkOperations.getTarget(eicls, "statementList", true);
        Object data1 = new Integer[]{tmp,nextLabel};
        Values.CLOSURE_DATA.set(sn1, data1);
        this.prepStatementList(SLinkOperations.getTarget(eicls, "statementList", true));
        Object data2 = new Integer[]{tmp};
        Values.CLOSURE_DATA.set(eicls, data2);
      }
    }
    if ((SLinkOperations.getTarget(ifstmt, "ifFalseStatement", true) != null)) {
      if (StatementListUtil.isControlStatement(SLinkOperations.getTarget(ifstmt, "ifFalseStatement", true)) || SNodeOperations.isInstanceOf(SLinkOperations.getTarget(ifstmt, "ifFalseStatement", true), "jetbrains.mps.baseLanguage.structure.BlockStatement")) {
        ifFalseLabel = this.ctx.incrementLabel();
      }
    }
    Object data2 = new Integer[]{beginLabel,ifTrueLabel,ifFalseLabel,nextLabel};
    Values.CLOSURE_DATA.set(ifstmt, data2);
    if (SNodeOperations.isInstanceOf(SLinkOperations.getTarget(ifstmt, "ifFalseStatement", true), "jetbrains.mps.baseLanguage.structure.BlockStatement")) {
      SNode sn1 = SLinkOperations.getTarget(SNodeOperations.cast(SLinkOperations.getTarget(ifstmt, "ifFalseStatement", true), "jetbrains.mps.baseLanguage.structure.BlockStatement"), "statements", true);
      Object data1 = new Integer[]{ifFalseLabel,nextLabel};
      Values.CLOSURE_DATA.set(sn1, data1);
      this.prepStatementList(SLinkOperations.getTarget(SNodeOperations.cast(SLinkOperations.getTarget(ifstmt, "ifFalseStatement", true), "jetbrains.mps.baseLanguage.structure.BlockStatement"), "statements", true));
    } else
    if ((SLinkOperations.getTarget(ifstmt, "ifFalseStatement", true) != null)) {
      this.prepStatement(SLinkOperations.getTarget(ifstmt, "ifFalseStatement", true), ifFalseLabel);
    }
    return nextLabel;
  }

  private int prepSwitchStatement(SNode sstmt, int label) {
    int beginLabel = label;
    int nextLabel = this.calcNextLabel(sstmt);
    Object data1 = new Integer[]{beginLabel,nextLabel};
    Values.CLOSURE_DATA.set(sstmt, data1);
    int nextCaseLabel = this.ctx.incrementLabel();
    for (SNode scase : SLinkOperations.getTargets(sstmt, "case", true)) {
      int caseLabel = nextCaseLabel;
      nextCaseLabel = this.ctx.incrementLabel();
      if ((SLinkOperations.getTarget(scase, "body", true) != null)) {
        List<SNode> stmts = SLinkOperations.getTargets(SLinkOperations.getTarget(scase, "body", true), "statement", true);
        int endCaseLabel = nextCaseLabel;
        if (ListSequence.fromList(stmts).count() > 0 && SNodeOperations.isInstanceOf(ListSequence.fromList(stmts).getElement(ListSequence.fromList(stmts).count() - 1), "jetbrains.mps.baseLanguage.structure.BreakStatement")) {
          endCaseLabel = nextLabel;
        }
        SNode sn = SLinkOperations.getTarget(scase, "body", true);
        Object data = new Integer[]{caseLabel,endCaseLabel};
        Values.CLOSURE_DATA.set(sn, data);
        this.prepStatementList(SLinkOperations.getTarget(scase, "body", true));
      }
    }
    if ((SLinkOperations.getTarget(sstmt, "defaultBlock", true) != null)) {
      int defLabel = this.ctx.incrementLabel();
      SNode sn = SLinkOperations.getTarget(sstmt, "defaultBlock", true);
      Object data = new Integer[]{defLabel,nextLabel};
      Values.CLOSURE_DATA.set(sn, data);
      this.prepStatementList(SLinkOperations.getTarget(sstmt, "defaultBlock", true));
    }
    return nextLabel;
  }

  private int prepYieldStatement(SNode ystmt, int label) {
    int beginLabel = label;
    int nextLabel = this.calcNextLabel(ystmt);
    Object data = new Integer[]{beginLabel,nextLabel};
    Values.CLOSURE_DATA.set(ystmt, data);
    return nextLabel;
  }

  private void prepBreakStatement(SNode bstmt) {
    int brLabel = -1;
    String lbl = SPropertyOperations.getString(bstmt, "label");
    SNode node = bstmt;
    while (((node = SNodeOperations.getAncestorWhereConceptInList(node, new String[]{"jetbrains.mps.baseLanguage.structure.AbstractLoopStatement","jetbrains.mps.baseLanguage.structure.SwitchStatement"}, false, false)) != null)) {
      if (lbl == (SNodeOperations.isInstanceOf(node, "jetbrains.mps.baseLanguage.structure.AbstractLoopStatement") ?
        SPropertyOperations.getString(SNodeOperations.cast(node, "jetbrains.mps.baseLanguage.structure.AbstractLoopStatement"), "label") :
        SPropertyOperations.getString(SNodeOperations.cast(node, "jetbrains.mps.baseLanguage.structure.SwitchStatement"), "label")
      )) {
        Integer[] labels = (Integer[])Values.CLOSURE_DATA.get(node);
        brLabel = labels[labels.length - 1];
        break;
      }
    }
    Object data = new Integer[]{brLabel};
    Values.CLOSURE_DATA.set(bstmt, data);
  }

  private void prepContinueStatement(SNode cstmt) {
    int conLabel = -1;
    String lbl = SPropertyOperations.getString(cstmt, "label");
    SNode node = cstmt;
    while (((node = SNodeOperations.getAncestorWhereConceptInList(node, new String[]{"jetbrains.mps.baseLanguage.structure.AbstractLoopStatement"}, false, false)) != null)) {
      if (lbl == SPropertyOperations.getString(SNodeOperations.cast(node, "jetbrains.mps.baseLanguage.structure.AbstractLoopStatement"), "label") || (lbl != null && lbl.equals(SPropertyOperations.getString(SNodeOperations.cast(node, "jetbrains.mps.baseLanguage.structure.AbstractLoopStatement"), "label")))) {
        Integer[] labels = (Integer[])Values.CLOSURE_DATA.get(node);
        conLabel = labels[1];
        break;
      }
    }
    Object data = new Integer[]{conLabel};
    Values.CLOSURE_DATA.set(cstmt, data);
  }

  private int prepBlockStatement(SNode bs, int label) {
    int beginLabel = label;
    int nextLabel = this.calcNextLabel(bs);
    SNode sn = SLinkOperations.getTarget(bs, "statements", true);
    Object data1 = new Integer[]{beginLabel,nextLabel};
    Values.CLOSURE_DATA.set(sn, data1);
    int tmp = this.prepStatementList(SLinkOperations.getTarget(bs, "statements", true));
    Object data = new Integer[]{beginLabel,tmp};
    Values.CLOSURE_DATA.set(bs, data);
    return tmp;
  }

  private int prepLocalvariableDeclarationStatement(SNode lstmt, int label) {
    int nextLabel = this.ctx.incrementLabel();
    Values.CLOSURE_DATA.set(lstmt, label);
    this.prepLocalVariableDeclaration(SLinkOperations.getTarget(lstmt, "localVariableDeclaration", true));
    return nextLabel;
  }

  private void prepLocalVariableDeclaration(SNode lvd) {
    String name = "_" + this.ctx.label + "_" + SPropertyOperations.getString(lvd, "name");
    Values.CLOSURE_DATA.set(lvd, name);
  }

  private int calcNextLabel(SNode cstmt) {
    if (SNodeOperations.isInstanceOf(cstmt, "jetbrains.mps.baseLanguage.structure.IfStatement") && SNodeOperations.isInstanceOf(SNodeOperations.getParent(cstmt), "jetbrains.mps.baseLanguage.structure.IfStatement")) {
      SNode topIfStmt = SNodeOperations.cast(SNodeOperations.getParent(cstmt), "jetbrains.mps.baseLanguage.structure.IfStatement");
      while (SNodeOperations.isInstanceOf(SNodeOperations.getParent(topIfStmt), "jetbrains.mps.baseLanguage.structure.IfStatement")) {
        topIfStmt = SNodeOperations.cast(SNodeOperations.getParent(topIfStmt), "jetbrains.mps.baseLanguage.structure.IfStatement");
      }
      Integer[] parentLabels = (Integer[])Values.CLOSURE_DATA.get(topIfStmt);
      if (parentLabels != null) {
        return parentLabels[parentLabels.length - 1];
      }
    } else if ((SNodeOperations.getNextSibling(cstmt) == null) && SNodeOperations.isInstanceOf(SNodeOperations.getParent(cstmt), "jetbrains.mps.baseLanguage.structure.StatementList")) {
      SNode sn = SNodeOperations.getParent(cstmt);
      Integer[] parentLabels = (Integer[])Values.CLOSURE_DATA.get(sn);
      if (parentLabels != null) {
        return parentLabels[parentLabels.length - 1];
      }
    }
    return this.ctx.incrementLabel();
  }

  public static void prepStatementList(SNode slist, ITemplateGenerator generator) {
    PrepStatementUtil psu = new PrepStatementUtil(generator);
    psu.prepTopStatementList(slist);
  }

  private static class Context {
    public int label;

    public Context() {
      this.label = 0;
    }

    public int incrementLabel() {
      this.label = this.label + 1;
      return this.label;
    }
  }
}
