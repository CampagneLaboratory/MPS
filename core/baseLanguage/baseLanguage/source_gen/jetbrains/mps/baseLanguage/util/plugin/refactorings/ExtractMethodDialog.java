package jetbrains.mps.baseLanguage.util.plugin.refactorings;

/*Generated by MPS */

import jetbrains.mps.ide.dialogs.BaseDialog;
import javax.swing.JPanel;
import javax.swing.JTextArea;
import jetbrains.mps.nodeEditor.EditorContext;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.smodel.SModel;
import java.awt.Frame;
import java.awt.Dimension;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import java.awt.GridBagLayout;
import java.awt.GridBagConstraints;
import java.awt.Insets;
import javax.swing.JComponent;
import javax.swing.event.TableModelListener;
import javax.swing.event.TableModelEvent;
import javax.swing.JLabel;
import javax.swing.JTextField;
import com.intellij.ui.DocumentAdapter;
import javax.swing.event.DocumentEvent;
import javax.swing.JCheckBox;
import java.awt.event.ItemListener;
import java.awt.event.ItemEvent;
import javax.swing.border.Border;
import javax.swing.border.CompoundBorder;
import javax.swing.border.TitledBorder;
import javax.swing.border.EmptyBorder;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import javax.swing.JOptionPane;
import jetbrains.mps.smodel.SModelReference;
import jetbrains.mps.ide.dialogs.DialogDimensionsSettings;
import jetbrains.mps.smodel.SModelDescriptor;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import javax.swing.JButton;
import javax.swing.JRadioButton;
import javax.swing.ButtonGroup;
import java.awt.event.ActionListener;
import java.awt.event.ActionEvent;

public class ExtractMethodDialog extends BaseDialog {
  private JPanel myPanel;
  private boolean myCanRefactor;
  private JTextArea myPreviewArea = new JTextArea();
  private JTextArea myMessagesArea = new JTextArea();
  private VisibilityPanel myVisibilityPanel;
  private ExtractMethodDialog.ChooseContainerPanel myChooseContainerPanel;
  private ExtractMethodRefactoringParameters myParameters;
  private EditorContext myContext;
  private ExtractMethodRefactoring myRefactoring;
  private SNode myStaticTarget;
  private SModel myRefactoringModel;
  private boolean myExtractIntoCurrentContainer;

  public ExtractMethodDialog(Frame frame, EditorContext context, ExtractMethodRefactoringParameters params, ExtractMethodRefactoring refactoring) {
    super(frame, "Extract Method");
    this.setMinimumSize(new Dimension(600, 450));
    this.myContext = context;
    this.myParameters = params;
    this.myRefactoring = refactoring;
    this.myExtractIntoCurrentContainer = true;
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        ExtractMethodDialog.this.initPanel();
      }
    });
    this.update();
  }

  private void update() {
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        ExtractMethodDialog.this.myMessagesArea.setText(ExtractMethodDialog.this.getMessagesText());
        ExtractMethodDialog.this.myPreviewArea.setText(ExtractMethodDialog.this.myParameters.getMethodText());
      }
    });
    this.repaint();
  }

  private String getMessagesText() {
    StringBuffer buff = new StringBuffer();
    String methodName = this.myParameters.getName();
    if (methodName.length() == 0) {
      buff.append("Method name is empty.\n");
    } else {
      boolean nameIsGood = Character.isJavaIdentifierStart(methodName.charAt(0));
      for (int i = 1; i < methodName.length(); i++) {
        nameIsGood = nameIsGood && Character.isJavaIdentifierPart(methodName.charAt(0));
      }
      if (!(nameIsGood)) {
        buff.append("Method name is incorrect.");
      }
    }
    String errors = ExtractMethodFactory.getErrors(this.myParameters.getNodesToRefactor());
    if (errors != null) {
      buff.append(errors);
      this.myCanRefactor = false;
    } else {
      this.myCanRefactor = true;
    }
    SNode overrides = this.myParameters.getOverridingMethodClass();
    if (overrides != null) {
      if (overrides == SNodeOperations.getAncestor(this.myParameters.getContainerMethod(), "jetbrains.mps.baseLanguage.structure.Classifier", false, false)) {
        buff.append("Such method already exists.\n");
      } else {
        buff.append("Method overrides method from class ").append(SPropertyOperations.getString(overrides, "name")).append("\n");
      }
    }
    if (buff.length() == 0) {
      buff.append("\n");
    }
    return buff.toString();
  }

  private void initPanel() {
    this.myPanel = new JPanel(new GridBagLayout());
    GridBagConstraints c = new GridBagConstraints();
    c.fill = GridBagConstraints.BOTH;
    c.anchor = GridBagConstraints.NORTHWEST;
    c.insets = new Insets(3, 5, 3, 5);

    c.gridx = 0;
    c.gridy = 0;
    c.weightx = 1;
    c.weighty = 1;
    c.gridwidth = 1;
    this.myPanel.add(this.createMethodPanel(), c);

    c.gridx = 1;
    c.gridy = 0;
    c.weightx = 0;
    c.weighty = 1;
    c.gridwidth = 1;
    this.myChooseContainerPanel = new ExtractMethodDialog.ChooseContainerPanel();
    myChooseContainerPanel.setBorder(this.createBorder("Choose container"));
    this.myPanel.add(this.myChooseContainerPanel, c);


    c.gridx = 0;
    c.gridy = 1;
    c.weightx = 1;
    c.weighty = 1;
    c.gridwidth = 1;

    this.myPanel.add(this.createParametersPanel(), c);

    c.gridx = 1;
    c.gridy = 1;
    c.weightx = 0;
    c.weighty = 1;
    c.gridwidth = 1;
    this.myVisibilityPanel = new VisibilityPanel();
    this.myPanel.add(this.myVisibilityPanel, c);

    c.gridx = 0;
    c.gridy = 2;
    c.weightx = 1;
    c.weighty = 0;
    c.gridwidth = 2;
    this.myPanel.add(this.createPreviewPanel(), c);



    c.gridx = 0;
    c.gridy = 4;
    c.weightx = 1;
    c.weighty = 0;
    c.gridwidth = 2;

    this.myPanel.add(this.createMessagesComponent(), c);
  }

  private JComponent createPreviewPanel() {
    this.myPreviewArea.setEditable(false);
    this.myPreviewArea.setBackground(this.myPanel.getBackground());
    this.myPreviewArea.setBorder(this.createBorder("Signature Preview"));
    return this.myPreviewArea;
  }

  private JComponent createMessagesComponent() {
    this.myMessagesArea.setEditable(false);
    this.myMessagesArea.setBackground(this.myPanel.getBackground());
    this.myMessagesArea.setBorder(this.createBorder("Messages"));
    return this.myMessagesArea;
  }

  private JComponent createParametersPanel() {
    ParametersPanel parametersPanel = new ParametersPanel(this.myParameters);
    parametersPanel.setBorder(this.createBorder("Parameters"));
    ParametersTableModel tableModel = parametersPanel.getTableModel();
    tableModel.addTableModelListener(new TableModelListener() {
      public void tableChanged(TableModelEvent p0) {
        ExtractMethodDialog.this.update();
      }
    });


    return parametersPanel;
  }

  private JComponent createMethodPanel() {
    JPanel methodPanel = new JPanel(new GridBagLayout());
    methodPanel.setBorder(this.createBorder("Method"));
    GridBagConstraints c = new GridBagConstraints();
    c.gridx = 0;
    c.gridy = 0;
    c.weightx = 0;
    c.anchor = GridBagConstraints.FIRST_LINE_START;
    methodPanel.add(new JLabel("Name:"), c);
    c = new GridBagConstraints();
    c.fill = GridBagConstraints.HORIZONTAL;
    c.gridx = 0;
    c.gridy = 1;
    c.weightx = 1;
    c.weighty = 1;
    c.anchor = GridBagConstraints.FIRST_LINE_START;
    final JTextField nameField = new JTextField(20);
    methodPanel.add(nameField, c);
    nameField.getDocument().addDocumentListener(new DocumentAdapter() {
      protected void textChanged(DocumentEvent p0) {
        ExtractMethodDialog.this.myParameters.setName(nameField.getText());
        ExtractMethodDialog.this.update();
      }
    });

    c.fill = GridBagConstraints.NONE;
    c.gridx = 0;
    c.gridy = 2;
    c.weightx = 1;
    c.weighty = 1;
    c.anchor = GridBagConstraints.FIRST_LINE_START;
    final JCheckBox declareStatic = createDeclareStaticCheckBox();
    methodPanel.add(declareStatic, c);
    declareStatic.addItemListener(new ItemListener() {
      public void itemStateChanged(ItemEvent p0) {
        if (declareStatic.isSelected()) {
          ExtractMethodDialog.this.myParameters.setStatic(true);
        } else {
          ExtractMethodDialog.this.myParameters.setStatic(false);
        }
        ExtractMethodDialog.this.update();
      }
    });






    return methodPanel;
  }

  public JCheckBox createDeclareStaticCheckBox() {
    JCheckBox result = new JCheckBox("Declare static");
    int canBeStatic = myRefactoring.canBeStatic();
    if (canBeStatic == ExtractMethodRefactoring.CANNOT_BE_STATIC) {
      result.setSelected(false);
      result.setEnabled(false);
    } else if (canBeStatic == ExtractMethodRefactoring.CAN_BE_STATIC) {
      result.setSelected(false);
      result.setEnabled(true);
    } else if (canBeStatic == ExtractMethodRefactoring.SHOULD_BE_STATIC) {
      result.setSelected(true);
      result.setEnabled(false);
    }
    return result;
  }

  private Border createBorder(String title) {
    return new CompoundBorder(new TitledBorder(title), new EmptyBorder(5, 5, 5, 5));
  }

  public JComponent getMainComponent() {
    return this.myPanel;
  }

  @BaseDialog.Button(position = 0, name = "Refactor", mnemonic = 'R', defaultButton = true)
  public void onOk() {
    this.myParameters.setVisibilityLevel(this.myVisibilityPanel.getResult());
    final Wrappers._T<SNode> result = new Wrappers._T<SNode>(null);
    if (!(this.myCanRefactor)) {
      JOptionPane.showMessageDialog(this, "Can't refactor. See errors.", "Can't perform refactoring", JOptionPane.ERROR_MESSAGE);
    } else {
      if ((this.myStaticTarget != null) && !(this.myExtractIntoCurrentContainer)) {
        this.setStaticContainer();
      } else if (this.myParameters.getAnalyzer().shouldChooseOuterContainer()) {
        chooseStaticContainer();
      }
      ModelAccess.instance().runWriteActionInCommand(new Runnable() {
        public void run() {
          result.value = ExtractMethodDialog.this.myRefactoring.doRefactor();
          ExtractMethodDialog.this.myContext.select(result.value);
          if ((myRefactoringModel != null) && !(ExtractMethodDialog.this.myExtractIntoCurrentContainer)) {
            SModelReference ref = SNodeOperations.getModel(myStaticTarget).getSModelReference();
            myRefactoringModel.addModelImport(ref, false);
          }
        }
      });
    }
    this.dispose();
    if ((result.value != null)) {
      new ExtractMethodDialog.MyMethodDuplicatesProcessor(this.myContext, result.value).process(this.myRefactoring.getMatches());
    }
  }

  private void setStaticContainer() {
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        ExtractMethodDialog.this.myRefactoring.setStaticContainer(ExtractMethodDialog.this.myStaticTarget);
      }
    });
  }

  @BaseDialog.Button(position = 1, name = "Cancel", mnemonic = 'C', defaultButton = false)
  public void onCancel() {
    this.dispose();
  }

  public DialogDimensionsSettings.DialogDimensions getDefaultDimensionSettings() {
    return new DialogDimensionsSettings.DialogDimensions(100, 200, 500, 400);
  }

  protected void prepareDialog() {
    super.prepareDialog();
    this.pack();
  }

  public void chooseStaticContainer() {
    final Wrappers._T<SModelDescriptor> model = new Wrappers._T<SModelDescriptor>();
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        myRefactoringModel = SNodeOperations.getModel(ListSequence.fromList(ExtractMethodDialog.this.myParameters.getNodesToRefactor()).first());
        model.value = myRefactoringModel.getModelDescriptor();
      }
    });
    myStaticTarget = BLDialogs.showStaticContainerChooser(this.myContext.getOperationContext(), model.value);
    if (myStaticTarget == null) {
      myRefactoringModel = null;
      return;
    }
    setStaticContainer();

  }

  public class MyMethodDuplicatesProcessor extends MethodDuplicatesProcessor {
    private SNode myMethod;

    public MyMethodDuplicatesProcessor(EditorContext context, SNode method) {
      super(context);
      this.myMethod = method;
    }

    public void substitute(MethodMatch duplicate) {
      duplicate.getRefactoring().replaceMatch(duplicate, this.myMethod);
    }
  }

  private class ChooseContainerPanel extends JPanel {
    {
      myOuterContainerCheckBox = new JCheckBox("Extract into" + "\n" + "outer container");
      myCurrentContainerLabel = new JLabel("Extract into:");
      myChooseContainerButton = new JButton("Choose Container");
      myAnotherContainerRadioButton = new JRadioButton("another container");
      myCurrentContainerRadioButton = new JRadioButton("current container");
      myOuterContanerLabel = new JLabel("<no container is chosen>");
      myGroup = new ButtonGroup();
    }

    private JButton myChooseContainerButton;
    private JCheckBox myOuterContainerCheckBox;
    private JLabel myCurrentContainerLabel;
    private JRadioButton myCurrentContainerRadioButton;
    private JRadioButton myAnotherContainerRadioButton;
    private JLabel myOuterContanerLabel;
    private ButtonGroup myGroup;

    public ChooseContainerPanel() {
      super(new GridBagLayout());


      myOuterContainerCheckBox.setSelected(false);
      myOuterContainerCheckBox.addActionListener(new ActionListener() {
        public void actionPerformed(ActionEvent p0) {
          myChooseContainerButton.setEnabled(myOuterContainerCheckBox.isSelected());
          ExtractMethodDialog.this.myExtractIntoCurrentContainer = false;
        }
      });

      myChooseContainerButton.setEnabled(false);
      myChooseContainerButton.addActionListener(new ActionListener() {
        public void actionPerformed(ActionEvent p0) {
          chooseStaticContainer();
          ModelAccess.instance().runReadAction(new Runnable() {
            public void run() {
              if (ExtractMethodDialog.this.myStaticTarget != null) {
                if (SNodeOperations.isInstanceOf(ExtractMethodDialog.this.myStaticTarget, "jetbrains.mps.baseLanguage.structure.ClassConcept")) {
                  myChooseContainerButton.setText(SPropertyOperations.getString((SNodeOperations.cast(ExtractMethodDialog.this.myStaticTarget, "jetbrains.mps.baseLanguage.structure.ClassConcept")), "name"));
                  myChooseContainerButton.setIcon(IconContainer.ICON_a0a1a0a0a0b0a0a0a0h0a1);
                } else if (SNodeOperations.isInstanceOf(ExtractMethodDialog.this.myStaticTarget, "jetbrains.mps.lang.behavior.structure.ConceptBehavior")) {
                  myChooseContainerButton.setText(SPropertyOperations.getString((SNodeOperations.cast(ExtractMethodDialog.this.myStaticTarget, "jetbrains.mps.lang.behavior.structure.ConceptBehavior")), "name"));
                  myChooseContainerButton.setIcon(IconContainer.ICON_a0a1a0a0a0a1a0a0a0a7a0b);
                } else if (SNodeOperations.isInstanceOf(ExtractMethodDialog.this.myStaticTarget, "jetbrains.mps.lang.core.structure.INamedConcept")) {
                  myChooseContainerButton.setText(SPropertyOperations.getString((SNodeOperations.cast(ExtractMethodDialog.this.myStaticTarget, "jetbrains.mps.lang.core.structure.INamedConcept")), "name"));
                }

              }
            }
          });
        }
      });
      myCurrentContainerRadioButton.setSelected(true);
      myCurrentContainerRadioButton.addActionListener(new ActionListener() {
        public void actionPerformed(ActionEvent p0) {
          myChooseContainerButton.setEnabled(false);
          ExtractMethodDialog.this.myExtractIntoCurrentContainer = true;
        }
      });

      myAnotherContainerRadioButton.setSelected(false);
      myAnotherContainerRadioButton.addActionListener(new ActionListener() {
        public void actionPerformed(ActionEvent p0) {
          myChooseContainerButton.setEnabled(true);
          ExtractMethodDialog.this.myExtractIntoCurrentContainer = false;
        }
      });

      myGroup.add(myCurrentContainerRadioButton);
      myGroup.add(myAnotherContainerRadioButton);

      GridBagConstraints c = new GridBagConstraints();
      c.gridx = 0;
      c.gridy = 0;
      c.weightx = 2;
      c.anchor = GridBagConstraints.FIRST_LINE_START;
      add(myOuterContainerCheckBox, c);

      c.gridx = 0;
      c.gridy = 1;
      c.anchor = GridBagConstraints.FIRST_LINE_START;
      add(myChooseContainerButton, c);


      c.gridx = 1;
      c.gridy = 0;
      c.anchor = GridBagConstraints.FIRST_LINE_START;
      // <node> 


      c.gridx = 2;
      c.gridy = 0;
      c.anchor = GridBagConstraints.FIRST_LINE_START;
      // <node> 

      c.gridx = 3;
      c.gridy = 0;
      c.anchor = GridBagConstraints.FIRST_LINE_START;
      // <node> 


      c.gridx = 4;
      c.gridy = 0;
      c.weightx = 1;
      c.anchor = GridBagConstraints.FIRST_LINE_END;
      // <node> 
    }
  }
}
