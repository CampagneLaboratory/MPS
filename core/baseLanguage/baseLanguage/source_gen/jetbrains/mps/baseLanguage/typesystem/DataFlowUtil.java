package jetbrains.mps.baseLanguage.typesystem;

/*Generated by MPS */

import jetbrains.mps.lang.typesystem.dependencies.InferenceMethod;
import jetbrains.mps.typesystem.inference.TypeCheckingContext;
import jetbrains.mps.smodel.SNode;
import java.util.Set;
import jetbrains.mps.lang.dataFlow.DataFlow;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.intentions.BaseIntentionProvider;
import jetbrains.mps.baseLanguage.behavior.IVariableAssignment_Behavior;

public class DataFlowUtil {

  public DataFlowUtil() {
  }

  @InferenceMethod()
  public static void checkDataFlow(final TypeCheckingContext typeCheckingContext, SNode statementList) {
    checkUnreachable(typeCheckingContext, statementList);
    checkUninitializedReads(typeCheckingContext, statementList);
    checkUnusedAssignments(typeCheckingContext, statementList);
    checkUnusedVariables(typeCheckingContext, statementList);
  }

  @InferenceMethod()
  public static void checkReturns(final TypeCheckingContext typeCheckingContext, SNode statementList) {
    Set<SNode> expectedReturns = DataFlow.getExpectedReturns(statementList);
    for(SNode n : expectedReturns) {
      if (n != null) {
        SNode nodeToSelect;
        SNode sl = SNodeOperations.getAncestor(n, "jetbrains.mps.baseLanguage.structure.StatementList", false, false);
        if ((sl != null) && ListSequence.fromList(SLinkOperations.getTargets(sl, "statement", true)).isNotEmpty()) {
          SNodeOperations.getAncestor(nodeToSelect = n, "jetbrains.mps.baseLanguage.structure.Statement", true, false);
        } else
        {
          nodeToSelect = SNodeOperations.getAncestor(n, "jetbrains.mps.baseLanguage.structure.StatementList", false, false);
        }
        if (nodeToSelect != null) {
          {
            BaseIntentionProvider intentionProvider = null;
            typeCheckingContext.reportTypeError(nodeToSelect, "Return expected", "r:00000000-0000-4000-0000-011c895902c5(jetbrains.mps.baseLanguage.typesystem)", "1223640343628", intentionProvider);
          }
        } else
        {
          {
            BaseIntentionProvider intentionProvider = null;
            typeCheckingContext.reportTypeError(n, "Return expected", "r:00000000-0000-4000-0000-011c895902c5(jetbrains.mps.baseLanguage.typesystem)", "1223640343636", intentionProvider);
          }
        }
      }
    }
  }

  @InferenceMethod()
  private static void checkUnreachable(final TypeCheckingContext typeCheckingContext, SNode statementList) {
    Set<SNode> unreachable = DataFlow.getUnreachableNodes(statementList);
    for(SNode n : unreachable) {
      {
        BaseIntentionProvider intentionProvider = null;
        typeCheckingContext.reportTypeError(n, "Unreachable node", "r:00000000-0000-4000-0000-011c895902c5(jetbrains.mps.baseLanguage.typesystem)", "1223640538234", intentionProvider);
      }
    }
  }

  @InferenceMethod()
  private static void checkUninitializedReads(final TypeCheckingContext typeCheckingContext, SNode statementList) {
    Set<SNode> uninitializedReads = DataFlow.getUninitializedReads(statementList);
    for(SNode read : uninitializedReads) {
      if (SNodeOperations.isInstanceOf(read, "jetbrains.mps.baseLanguage.structure.LocalVariableReference")) {
        SNode ref = read;
        {
          BaseIntentionProvider intentionProvider = null;
          typeCheckingContext.reportTypeError(read, "Variable used before it is initialized", "r:00000000-0000-4000-0000-011c895902c5(jetbrains.mps.baseLanguage.typesystem)", "1223640624825", intentionProvider);
        }
      }
    }
  }

  @InferenceMethod()
  private static void checkUnusedAssignments(final TypeCheckingContext typeCheckingContext, SNode statementList) {
    Set<SNode> unusedAssignments = DataFlow.getUnusedAssignments(statementList);
    for(SNode write : unusedAssignments) {
      if (SNodeOperations.isInstanceOf(write, "jetbrains.mps.baseLanguage.structure.BaseAssignmentExpression")) {
        SNode assignment = write;
        if (SNodeOperations.isInstanceOf(SLinkOperations.getTarget(assignment, "lValue", true), "jetbrains.mps.baseLanguage.structure.LocalVariableReference") || SNodeOperations.isInstanceOf(SLinkOperations.getTarget(assignment, "lValue", true), "jetbrains.mps.baseLanguage.structure.ParameterReference")) {
          {
            BaseIntentionProvider intentionProvider = null;
            intentionProvider = new BaseIntentionProvider("r:00000000-0000-4000-0000-011c895902c1(jetbrains.mps.baseLanguage.constraints).RemoveUnusedAssignment_QuickFix");
            typeCheckingContext.reportWarning(assignment, "Unused assignment", "r:00000000-0000-4000-0000-011c895902c5(jetbrains.mps.baseLanguage.typesystem)", "1223642282236", intentionProvider);
          }
        }
      }
      if (SNodeOperations.isInstanceOf(write, "jetbrains.mps.baseLanguage.structure.IVariableAssignment")) {
        SNode variableAssignment = (SNode)write;
        if (IVariableAssignment_Behavior.call_isCanBeUnused_1223985713603(variableAssignment)) {
          {
            BaseIntentionProvider intentionProvider = null;
            typeCheckingContext.reportWarning(write, "Unused parameter", "r:00000000-0000-4000-0000-011c895902c5(jetbrains.mps.baseLanguage.typesystem)", "1223986255355", intentionProvider);
          }
        }
      }
    }
  }

  @InferenceMethod()
  public static void checkUnusedVariables(final TypeCheckingContext typeCheckingContext, SNode statementList) {
    Set<SNode> unusedVariables = DataFlow.getUnusedVariables(statementList);
    for(SNode var : unusedVariables) {
      if (!(SNodeOperations.isInstanceOf(SNodeOperations.getParent(var), "jetbrains.mps.baseLanguage.structure.CatchClause"))) {
        {
          BaseIntentionProvider intentionProvider = null;
          typeCheckingContext.reportWarning(var, "Unused variable", "r:00000000-0000-4000-0000-011c895902c5(jetbrains.mps.baseLanguage.typesystem)", "1223642399966", intentionProvider);
        }
      }
    }
  }

}
