package jetbrains.mps.baseLanguage.search;

/*Generated by MPS */

import jetbrains.mps.smodel.search.IReferenceInfoResolver;
import jetbrains.mps.baseLanguage.structure.ClassifierType;
import java.util.List;
import jetbrains.mps.baseLanguage.structure.Expression;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.smodel.SModelReference;
import jetbrains.mps.baseLanguage.structure.BaseMethodDeclaration;
import jetbrains.mps.baseLanguage.structure.Classifier;
import jetbrains.mps.baseLanguage.structure.Type;
import java.util.Map;
import jetbrains.mps.baseLanguage.structure.TypeVariableDeclaration;

/*package*/ class InstanceMethodReferenceInfoResolver implements IReferenceInfoResolver {
  private ClassifierType myInstanceType;
  private List<Expression> myActualArguments;
  private ClassifierAndSuperClassifiersScope mySearchScope;

  public InstanceMethodReferenceInfoResolver(ClassifierAndSuperClassifiersScope searchScope, ClassifierType instanceType, List<Expression> actualArguments) {
    this.myInstanceType = instanceType;
    this.myActualArguments = actualArguments;
    this.mySearchScope = searchScope;
  }

  public SNode resolve(String referenceInfo, SModelReference targetModelReference) {
    if (referenceInfo == null) {
      return null;
    }
    List<BaseMethodDeclaration> methods = this.mySearchScope.getMethodsByName(referenceInfo);
    if (methods.isEmpty()) {
      return null;
    }
    if (methods.size() == 1) {
      return methods.get(0).getNode();
    }
    methods = (List<BaseMethodDeclaration>) MethodResolveUtil.selectByParmCount(methods, this.myActualArguments);
    if (methods.size() == 1) {
      return methods.get(0).getNode();
    }
    Classifier classifier = this.myInstanceType.getClassifier();
    List<Type> typeParameters = this.myInstanceType.getParameters();
    Map<TypeVariableDeclaration, Type> typeByTypeVar = MethodResolveUtil.getTypesByTypeVars(classifier, typeParameters);
    return MethodResolveUtil.chooseByParameterType(methods, this.myActualArguments, typeByTypeVar).getNode();
  }
}
