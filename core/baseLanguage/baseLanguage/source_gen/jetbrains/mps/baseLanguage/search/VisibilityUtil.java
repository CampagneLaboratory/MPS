package jetbrains.mps.baseLanguage.search;

/*Generated by MPS */

import org.jetbrains.annotations.NotNull;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.baseLanguage.BaseLanguageUtil;
import jetbrains.mps.baseLanguage.structure.Classifier;
import jetbrains.mps.typesystem.inference.TypeChecker;
import org.jetbrains.annotations.Nullable;

public final class VisibilityUtil {
  private VisibilityUtil() {
  }

  public static boolean isVisible(@NotNull SNode context, @NotNull SNode name) {
    // only check visibility of the name, accessibility of qualifier and if the name is member is not checked here 
    if (SNodeOperations.isInstanceOf(name, "jetbrains.mps.baseLanguage.structure.Classifier")) {
      return isClassifierAccessible(context, SNodeOperations.cast(name, "jetbrains.mps.baseLanguage.structure.Classifier"));
    }
    if (SNodeOperations.isInstanceOf(SLinkOperations.getTarget(name, "visibility", true), "jetbrains.mps.baseLanguage.structure.PublicVisibility") || SNodeOperations.isInstanceOf(name, "jetbrains.mps.baseLanguage.structure.EnumConstantDeclaration")) {
      return true;
    }
    if (SNodeOperations.isInstanceOf(SLinkOperations.getTarget(name, "visibility", true), "jetbrains.mps.baseLanguage.structure.PrivateVisibility")) {
      return topClassifier(context) == topClassifier(name);
    }
    // package or protected access 
    if (packageName(context).equals(packageName(name))) {
      return true;
    }
    if (SNodeOperations.isInstanceOf(SLinkOperations.getTarget(name, "visibility", true), "jetbrains.mps.baseLanguage.structure.ProtectedVisibility")) {
      //  checkspecial cases of protected access 
      SNode classifier = SNodeOperations.getAncestor(name, "jetbrains.mps.baseLanguage.structure.Classifier", false, false);
      for (SNode cls : ListSequence.fromList(SNodeOperations.getAncestors(context, "jetbrains.mps.baseLanguage.structure.Classifier", true))) {
        if (BaseLanguageUtil.isAssignable(((Classifier) SNodeOperations.getAdapter(cls)), ((Classifier) SNodeOperations.getAdapter(classifier)))) {
          if (SNodeOperations.isInstanceOf(name, "jetbrains.mps.baseLanguage.structure.FieldDeclaration") && SNodeOperations.isInstanceOf(context, "jetbrains.mps.baseLanguage.structure.FieldReferenceOperation") || SNodeOperations.isInstanceOf(name, "jetbrains.mps.baseLanguage.structure.InstanceMethodDeclaration") && SNodeOperations.isInstanceOf(context, "jetbrains.mps.baseLanguage.structure.InstanceMethodCallOperation")) {
            // check ExpressionName or PrimaryExpression is subclass of cls, works only with right context 
            //  will not work in the case: otherClass.method(protectedMethod()) with enclosed node as context 
            SNode qualifier = SLinkOperations.getTarget(SNodeOperations.cast(TypeChecker.getInstance().getTypeOf(SLinkOperations.getTarget(SNodeOperations.cast(SNodeOperations.getParent(context), "jetbrains.mps.baseLanguage.structure.DotExpression"), "operand", true)), "jetbrains.mps.baseLanguage.structure.ClassifierType"), "classifier", false);
            if (BaseLanguageUtil.isAssignable(((Classifier) SNodeOperations.getAdapter(qualifier)), ((Classifier) SNodeOperations.getAdapter(cls)))) {
              return true;
            }
          } else if (SNodeOperations.isInstanceOf(name, "jetbrains.mps.baseLanguage.structure.ConstructorDeclaration")) {
            // check it is superclass constructor invocation or anonymous class instance creation 
            return SNodeOperations.isInstanceOf(context, "jetbrains.mps.baseLanguage.structure.SuperConstructorInvocation") || SNodeOperations.isInstanceOf(context, "jetbrains.mps.baseLanguage.structure.AnonymousClass") || SNodeOperations.isInstanceOf(context, "jetbrains.mps.baseLanguage.structure.AnonymousClassCreator");
          } else {
            return true;
          }
        }
      }
    }
    return false;
  }

  public static String packageName(@NotNull SNode node) {
    return SNodeOperations.getModel(node).getSModelFqName().getLongName();
  }

  public static SNode topClassifier(@NotNull SNode node) {
    return ListSequence.fromList(SNodeOperations.getAncestors(node, "jetbrains.mps.baseLanguage.structure.Classifier", true)).last();
  }

  @Nullable
  public static SNode getQualifier(@NotNull SNode refNode) {
    if (SNodeOperations.isInstanceOf(refNode, "jetbrains.mps.baseLanguage.structure.EnumConstantReference")) {
      return SLinkOperations.getTarget(SNodeOperations.cast(refNode, "jetbrains.mps.baseLanguage.structure.EnumConstantReference"), "enumClass", false);
    } else if (SNodeOperations.isInstanceOf(refNode, "jetbrains.mps.baseLanguage.structure.FieldReferenceOperation") || SNodeOperations.isInstanceOf(refNode, "jetbrains.mps.baseLanguage.structure.InstanceMethodCallOperation")) {
      return SLinkOperations.getTarget(SNodeOperations.cast(TypeChecker.getInstance().getTypeOf(SLinkOperations.getTarget(SNodeOperations.cast(SNodeOperations.getParent(refNode), "jetbrains.mps.baseLanguage.structure.DotExpression"), "operand", true)), "jetbrains.mps.baseLanguage.structure.ClassifierType"), "classifier", false);
    } else if (SNodeOperations.isInstanceOf(refNode, "jetbrains.mps.baseLanguage.structure.StaticFieldReference")) {
      return SLinkOperations.getTarget(SNodeOperations.cast(refNode, "jetbrains.mps.baseLanguage.structure.StaticFieldReference"), "classifier", false);
    } else if (SNodeOperations.isInstanceOf(refNode, "jetbrains.mps.baseLanguage.structure.StaticMethodCall")) {
      return SLinkOperations.getTarget(SNodeOperations.cast(refNode, "jetbrains.mps.baseLanguage.structure.StaticMethodCall"), "classConcept", false);
    } else {
      return null;
    }
  }

  public static boolean isClassifierAccessible(@NotNull SNode context, @Nullable SNode classifier) {
    //  check "static" accessibility here 
    if ((classifier == null)) {
      return true;
    }
    if (SNodeOperations.isInstanceOf(SLinkOperations.getTarget(classifier, "visibility", true), "jetbrains.mps.baseLanguage.structure.PrivateVisibility")) {
      return topClassifier(context) == topClassifier(classifier);
    }
    SNode parent = SNodeOperations.getAncestor(classifier, "jetbrains.mps.baseLanguage.structure.Classifier", false, false);
    if (!(isClassifierAccessible(context, parent))) {
      return false;
    }
    if (SNodeOperations.isInstanceOf(SLinkOperations.getTarget(classifier, "visibility", true), "jetbrains.mps.baseLanguage.structure.PublicVisibility") || packageName(context).equals(packageName(classifier))) {
      return true;
    }
    if (SNodeOperations.isInstanceOf(SLinkOperations.getTarget(classifier, "visibility", true), "jetbrains.mps.baseLanguage.structure.ProtectedVisibility")) {
      // parent cannot be null here 
      for (SNode cls : ListSequence.fromList(SNodeOperations.getAncestors(context, "jetbrains.mps.baseLanguage.structure.Classifier", true))) {
        if (BaseLanguageUtil.isAssignable(((Classifier) SNodeOperations.getAdapter(cls)), ((Classifier) SNodeOperations.getAdapter(parent))) && isClassifierAccessible(context, parent)) {
          return true;
        }
      }
    }
    return false;
  }

  public static boolean isAccessible(@NotNull SNode refNode, @NotNull SNode name) {
    // check if name is visible and valid member in the context 
    if (!(isVisible(refNode, name))) {
      return false;
    }
    SNode clsMember = SNodeOperations.getAncestor(name, "jetbrains.mps.baseLanguage.structure.Classifier", false, false);
    SNode qualifier = getQualifier(refNode);
    if ((qualifier == null)) {
      // member of "this" 
      for (SNode cls : ListSequence.fromList(SNodeOperations.getAncestors(refNode, "jetbrains.mps.baseLanguage.structure.Classifier", true))) {
        if (new ClassifierAndSuperClassifiersScope(((Classifier) SNodeOperations.getAdapter(cls))).getClassifierNodes().contains(clsMember)) {
          return true;
        }
      }
      return false;
    } else {
      return new ClassifierAndSuperClassifiersScope(((Classifier) SNodeOperations.getAdapter(qualifier))).getClassifierNodes().contains(clsMember);
    }
  }
}
