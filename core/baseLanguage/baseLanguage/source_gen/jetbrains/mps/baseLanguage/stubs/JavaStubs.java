package jetbrains.mps.baseLanguage.stubs;

/*Generated by MPS */

import jetbrains.mps.stubs.BaseStubModelRootManager;
import jetbrains.mps.logging.Logger;
import java.util.Set;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.stubs.StubLocation;
import jetbrains.mps.stubs.ModelInfo;
import jetbrains.mps.reloading.IClassPathItem;
import jetbrains.mps.stubs.javastub.ASMModelLoader;
import jetbrains.mps.smodel.SModelDescriptor;
import jetbrains.mps.smodel.SModelReference;
import jetbrains.mps.stubs.javastub.classpath.StubHelper;
import jetbrains.mps.smodel.SModelRepository;
import jetbrains.mps.smodel.DefaultSModelDescriptor;
import java.util.HashSet;
import jetbrains.mps.smodel.SModelStereotype;
import java.io.File;
import jetbrains.mps.reloading.AbstractClassPathItem;
import java.io.IOException;

public class JavaStubs extends BaseStubModelRootManager {
  private static Logger LOG = Logger.getLogger(JavaStubs.class);

  public JavaStubs() {
  }

  protected Set<Language> getLanguagesToImport() {
    return null;
  }

  protected void updateModel(final StubLocation location, final ModelInfo modelInfo) {
    final JavaStubs localThis = JavaStubs.this;
    IClassPathItem cpItem = JavaStubs.this.createClassPathItem(location);
    if (cpItem == null) {
      return;
    }
    new ASMModelLoader(cpItem, modelInfo.getModelDescriptor(), modelInfo.getModel()) {
      public SModelDescriptor getModelDescriptor(String packageName) {
        SModelReference modelReference = StubHelper.uidForPackageInStubs(packageName);
        SModelDescriptor result = SModelRepository.getInstance().getModelDescriptor(modelReference);
        if (result != null) {
          return result;
        }
        result = new DefaultSModelDescriptor(localThis, null, modelReference);
        SModelRepository.getInstance().registerModelDescriptor(result, modelInfo.getModelDescriptor().getModule());
        return result;
      }
    }.updateModel();
  }

  protected Set<SModelDescriptor> getModelDescriptors(final StubLocation location) {
    String pack = location.getPrefix();
    IClassPathItem cpItem = JavaStubs.this.createClassPathItem(location);
    if (cpItem == null) {
      return new HashSet<SModelDescriptor>();
    }

    Set<String> subpackages = cpItem.getSubpackages(pack);

    if (pack.equals("")) {
    }
    Set<SModelDescriptor> result = new HashSet<SModelDescriptor>();
    for (String subpackage : subpackages) {
      if (!(cpItem.getAvailableClasses(subpackage).isEmpty())) {
        SModelReference modelReference = StubHelper.uidForPackageInStubs(subpackage);
        if (SModelRepository.getInstance().getModelDescriptor(modelReference) != null) {
          final SModelDescriptor descriptor = SModelRepository.getInstance().getModelDescriptor(SModelReference.fromString(subpackage + "@" + SModelStereotype.JAVA_STUB));
          assert descriptor != null;
          SModelRepository.getInstance().addOwnerForDescriptor(descriptor, location.getModule());
          result.add(descriptor);
        } else {
          SModelDescriptor modelDescriptor = new DefaultSModelDescriptor(JavaStubs.this, null, modelReference);
          result.add(modelDescriptor);
        }
      }
      result.addAll(JavaStubs.this.getModelDescriptors(new StubLocation(location.getPath(), subpackage, location.getModule())));
    }
    return result;
  }

  private IClassPathItem createClassPathItem(StubLocation location) {
    IClassPathItem result = null;
    try {
      result = AbstractClassPathItem.createFromPath(location.getPath(), location.getModule());
    } catch (IOException e) {
      LOG.error("Error on loading stubs", e);
    }
    return result;
  }
}
