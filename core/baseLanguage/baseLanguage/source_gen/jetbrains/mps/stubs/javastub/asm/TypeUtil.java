package jetbrains.mps.stubs.javastub.asm;

/*Generated by MPS */

import org.objectweb.asm.Type;
import org.objectweb.asm.signature.SignatureReader;
import org.objectweb.asm.signature.SignatureVisitor;
import java.util.List;
import java.util.Collections;
import java.util.ArrayList;
import java.util.Stack;

/*package*/ class TypeUtil {
  /*package*/ TypeUtil() {
  }

  /*package*/ static ASMType fromDescriptor(String desc) {
    return TypeUtil.fromType(Type.getType(desc));
  }

  /*package*/ static ASMType fromType(Type type) {
    switch (type.getSort()) {
      case Type.VOID:
        return ASMPrimitiveType.VOID;
      case Type.BOOLEAN:
        return ASMPrimitiveType.BOOLEAN;
      case Type.CHAR:
        return ASMPrimitiveType.CHAR;
      case Type.BYTE:
        return ASMPrimitiveType.BYTE;
      case Type.SHORT:
        return ASMPrimitiveType.SHORT;
      case Type.INT:
        return ASMPrimitiveType.INT;
      case Type.FLOAT:
        return ASMPrimitiveType.FLOAT;
      case Type.LONG:
        return ASMPrimitiveType.LONG;
      case Type.DOUBLE:
        return ASMPrimitiveType.DOUBLE;
      case Type.OBJECT:
        return new ASMClassType(type.getClassName());
      case Type.ARRAY:
        {
          ASMType result = new ASMArrayType(TypeUtil.fromType(type.getElementType()));
          for (int i = 1; i < type.getDimensions(); i++) {
            result = new ASMArrayType(result);
          }
          return result;
        }
      default:
    }
    return null;
  }

  /*package*/ static ASMType getReturnType(String signature) {
    if (signature == null) {
      return null;
    }
    SignatureReader reader = new SignatureReader(signature);
    final TypeUtil.TypeBuilderVisitor builder = new TypeUtil.TypeBuilderVisitor();
    reader.accept(new SignatureVisitorAdapter() {
      public SignatureVisitor visitReturnType() {
        return builder;
      }
    });
    return builder.getResult();
  }

  /*package*/ static List<ASMType> getParameterTypes(String signature) {
    if (signature == null) {
      return Collections.emptyList();
    }
    SignatureReader reader = new SignatureReader(signature);
    final List<TypeUtil.TypeBuilderVisitor> visitors = new ArrayList<TypeUtil.TypeBuilderVisitor>();
    reader.accept(new SignatureVisitorAdapter() {
      public SignatureVisitor visitParameterType() {
        TypeUtil.TypeBuilderVisitor v = new TypeUtil.TypeBuilderVisitor();
        visitors.add(v);
        return v;
      }
    });
    List<ASMType> types = new ArrayList<ASMType>(visitors.size());
    for (TypeUtil.TypeBuilderVisitor v : visitors) {
      types.add(v.getResult());
    }
    return types;
  }

  public static List<ASMFormalTypeParameter> getFormalTypeParameters(String signature) {
    final List<ASMFormalTypeParameter> result = new ArrayList<ASMFormalTypeParameter>();
    if (signature == null) {
      return result;
    }
    SignatureReader reader = new SignatureReader(signature);
    reader.accept(new SignatureVisitorAdapter() {
      private String name = null;
      private TypeUtil.TypeBuilderVisitor classBoundVisitor = new TypeUtil.TypeBuilderVisitor();
      private List<TypeUtil.TypeBuilderVisitor> interfaceBoundVisitors = new ArrayList<TypeUtil.TypeBuilderVisitor>();

      public void visitFormalTypeParameter(String name) {
        if (this.name != null) {
          this.flush();
        }
        this.name = name;
      }

      public SignatureVisitor visitClassBound() {
        this.classBoundVisitor = new TypeUtil.TypeBuilderVisitor();
        return this.classBoundVisitor;
      }

      public SignatureVisitor visitInterfaceBound() {
        TypeUtil.TypeBuilderVisitor visitor = new TypeUtil.TypeBuilderVisitor();
        this.interfaceBoundVisitors.add(visitor);
        return visitor;
      }

      public SignatureVisitor visitReturnType() {
        if (this.name != null) {
          this.flush();
        }
        return super.visitReturnType();
      }

      public SignatureVisitor visitSuperclass() {
        if (this.name != null) {
          this.flush();
        }
        return super.visitSuperclass();
      }

      private void flush() {
        List<ASMType> interfaceBounds = new ArrayList<ASMType>(this.interfaceBoundVisitors.size());
        for (TypeUtil.TypeBuilderVisitor v : this.interfaceBoundVisitors) {
          interfaceBounds.add(v.getResult());
        }
        ASMType formalType = null;
        if (this.classBoundVisitor != null) {
          formalType = this.classBoundVisitor.getResult();
          if (formalType instanceof ASMClassType) {
            ASMClassType classFormalType = (ASMClassType) formalType;
            if (classFormalType.getName().equals(Object.class.getName())) {
              formalType = null;
            }
          }
        }
        result.add(new ASMFormalTypeParameter(this.name, formalType, interfaceBounds));
        this.name = null;
        this.classBoundVisitor = null;
        this.interfaceBoundVisitors.clear();
      }
    });
    return result;
  }

  public static List<ASMType> getExceptionTypes(String signature) {
    if (signature == null) {
      return Collections.emptyList();
    }
    SignatureReader reader = new SignatureReader(signature);
    final List<TypeUtil.TypeBuilderVisitor> visitors = new ArrayList<TypeUtil.TypeBuilderVisitor>();
    reader.accept(new SignatureVisitorAdapter() {
      public SignatureVisitor visitExceptionType() {
        TypeUtil.TypeBuilderVisitor v = new TypeUtil.TypeBuilderVisitor();
        visitors.add(v);
        return v;
      }
    });
    final List<ASMType> types = new ArrayList<ASMType>(visitors.size());
    for (TypeUtil.TypeBuilderVisitor v : visitors) {
      types.add(v.getResult());
    }
    return types;
  }

  public static ASMType getFieldType(String signature) {
    if (signature == null) {
      return null;
    }
    final TypeUtil.TypeBuilderVisitor builder = new TypeUtil.TypeBuilderVisitor();
    SignatureReader reader = new SignatureReader(signature);
    reader.acceptType(builder);
    return builder.getResult();
  }

  /*package*/ static class TypeBuilderVisitor extends SignatureVisitorAdapter {
    private ASMType myResult;
    private Stack<ASMType> myTypes = new Stack<ASMType>();
    private char myWildcard;
    private TypeUtil.TypeBuilderVisitor myArrayVisitor = null;

    public TypeBuilderVisitor() {
    }

    protected void setResult(ASMType type) {
      this.myResult = type;
    }

    protected void addPart(ASMType type) {
      if (this.myTypes.isEmpty()) {
        this.myTypes.add(type);
        return;
      }
      if (this.myTypes.peek() instanceof ASMClassType) {
        ASMClassType ct = (ASMClassType) this.myTypes.pop();
        ASMParameterizedType replacement = new ASMParameterizedType(ct, new ArrayList<ASMType>());
        if (!(this.myTypes.isEmpty())) {
          ASMParameterizedType parent = (ASMParameterizedType) this.myTypes.peek();
          parent.removeArgument(ct);
          parent.addArgument(replacement);
        }
        this.myTypes.push(replacement);
      }
      if (this.myTypes.peek() instanceof ASMParameterizedType) {
        ((ASMParameterizedType) this.myTypes.peek()).addArgument(this.wrap(type));
      }
      if (type instanceof ASMClassType) {
        this.myTypes.push(type);
      }
    }

    private void finish() {
      if (this.myTypes.size() == 1) {
        this.setResult(this.myTypes.peek());
      }
      if (!(this.myTypes.isEmpty())) {
        this.myTypes.pop();
      }
    }

    private ASMType wrap(ASMType type) {
      if (this.myWildcard == '+') {
        this.myWildcard = '=';
        return new ASMExtendsType(type);
      }
      if (this.myWildcard == '-') {
        this.myWildcard = '=';
        return new ASMSuperType(type);
      }
      return type;
    }

    public void visitTypeArgument() {
      this.addPart(new ASMUnboundedType());
    }

    public SignatureVisitor visitTypeArgument(char wildcard) {
      this.myWildcard = wildcard;
      return this;
    }

    public void visitBaseType(char descriptor) {
      this.addPart(TypeUtil.fromType(Type.getType("" + descriptor)));
    }

    public void visitTypeVariable(String name) {
      this.addPart(new ASMTypeVariable(name));
    }

    public SignatureVisitor visitArrayType() {
      return this.myArrayVisitor = new TypeUtil.TypeBuilderVisitor();
    }

    public void visitClassType(String name) {
      this.addPart(new ASMClassType(name.replace('/', '.')));
    }

    public void visitEnd() {
      if (this.myArrayVisitor != null) {
        this.addPart(new ASMArrayType(this.myArrayVisitor.getResult()));
        this.myArrayVisitor = null;
      } else {
        this.finish();
      }
    }

    /*package*/ ASMType getResult() {
      if (this.myArrayVisitor != null) {
        this.addPart(new ASMArrayType(this.myArrayVisitor.getResult()));
        this.myArrayVisitor = null;
      }
      if (this.myResult == null) {
        this.finish();
      }
      return this.myResult;
    }
  }
}
