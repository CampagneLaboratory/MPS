package jetbrains.mps.baseLanguage.unitTest.plugin;

/*Generated by MPS */

import jetbrains.mps.baseLanguage.util.plugin.run.ConfigRunParameters;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.smodel.ModelAccess;
import com.intellij.execution.process.ProcessHandler;
import com.intellij.execution.ExecutionException;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;

public class UnitTestExecutionController {
  private final TestRunState myState;
  private final TestEventsDispatcher myDispatcher;
  private final ConfigRunParameters myConfigurationRunParameters;
  private final List<ITestNodeWrapper> myWhatToTest = ListSequence.fromList(new ArrayList<ITestNodeWrapper>());
  private Process myCurrentProcess;

  public UnitTestExecutionController(final List<ITestNodeWrapper> whatToTest, ConfigRunParameters configurationRunParameters) {
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        ListSequence.fromList(UnitTestExecutionController.this.myWhatToTest).addSequence(ListSequence.fromList(whatToTest));
      }
    });
    this.myState = new TestRunState(myWhatToTest);
    this.myDispatcher = new TestEventsDispatcher(this.myState);
    this.myConfigurationRunParameters = configurationRunParameters;
  }

  public TestRunState getState() {
    return this.myState;
  }

  public ProcessHandler execute() throws ExecutionException {
    if (ListSequence.fromList(myWhatToTest).isEmpty()) {
      throw new ExecutionException("Nothing to test.");
    }

    UnitTestRunner testRunner = null;
    try {
      testRunner = new UnitTestRunner(this.myWhatToTest, this.myConfigurationRunParameters);
    } catch (NullPointerException npe) {
      npe.printStackTrace();
    }
    this.myCurrentProcess = testRunner.run();
    if (this.myCurrentProcess == null) {
      this.myState.terminate();
      return null;
    }
    return new UnitTestProcessHandler(this.myDispatcher, this.myCurrentProcess, testRunner.getCommandString());
  }

  public _FunctionTypes._void_P0_E0 getCloseListener() {
    final Process process = this.myCurrentProcess;
    return new _FunctionTypes._void_P0_E0() {
      public void invoke() {
        if (process != null) {
          process.destroy();
        }
      }
    };
  }
}
