package jetbrains.mps.baseLanguage.unitTest.plugin;

/*Generated by MPS */

import javax.swing.JPanel;
import com.intellij.openapi.progress.util.ColorProgressBar;
import javax.swing.JLabel;
import java.awt.GridLayout;
import java.awt.GridBagLayout;
import java.awt.GridBagConstraints;
import java.awt.Insets;
import com.intellij.execution.process.ProcessOutputTypes;
import javax.swing.SwingUtilities;
import com.intellij.execution.process.ProcessHandler;
import com.intellij.execution.process.ProcessAdapter;
import com.intellij.execution.process.ProcessEvent;
import com.intellij.openapi.application.ApplicationManager;

public class ProgressLine extends JPanel implements TestView {
  private final ColorProgressBar progressBar = new ColorProgressBar();
  private final JLabel stateLabel = new JLabel("Starting...");
  private boolean testsBuilt = false;
  private TestRunState state;

  public ProgressLine(TestRunState testState) {
    super(new GridLayout(1, 2));
    this.state = testState;
    this.add(this.stateLabel);
    final JPanel progress = new JPanel(new GridBagLayout());
    progress.add(this.progressBar, new GridBagConstraints(0, 0, 0, 0, 1, 1, GridBagConstraints.CENTER, GridBagConstraints.HORIZONTAL, new Insets(0, 0, 0, 0), 0, 0));
    this.progressBar.setColor(ColorProgressBar.GREEN);
    this.add(progress);
    this.testsBuilt = true;
    this.init();
  }

  public void update() {
    if (this.state.getAvailableText() != null || ProcessOutputTypes.SYSTEM.equals(this.state.getKey())) {
      return;
    }
    final int defectedTests = this.state.getDefectTests();
    final int totalTests = this.state.getTotalTests();
    final int complitedTests = this.state.getCompletedTests();
    final String testName = this.state.getCurrentMethod();
    SwingUtilities.invokeLater(new Runnable() {
      public void run() {
        ProgressLine.this.updateProgressBar(defectedTests, totalTests, complitedTests);
        ProgressLine.this.updateLabel(defectedTests, totalTests, complitedTests, testName);
      }
    });
  }

  public void init() {
  }

  private void updateProgressBar(int defected, int total, int complited) {
    if (defected > 0) {
      this.progressBar.setColor(ColorProgressBar.RED);
    } else if (this.state.isTerminated()) {
      this.progressBar.setColor(ColorProgressBar.YELLOW);
    }
    if (total != 0) {
      this.progressBar.setFraction((double) complited / (double) total);
    }
  }

  private void updateLabel(int defected, int total, int complited, String testName) {
    StringBuilder sb = new StringBuilder();
    if (this.state.isTerminated()) {
      sb.append(" Terminated: " + complited + " of " + total + " ");
      testName = "";
    } else if (total == complited || testName == null) {
      sb.append(" Done: " + complited + " of " + total + " ");
      testName = "";
    }
    if (defected > 0) {
      sb.append(" Failed: " + defected);
    } else if (sb.length() == 0) {
      sb.append(" Running: " + complited + " of " + total);
    }
    this.stateLabel.setText(sb + "  " + testName);
  }

  public void start(final ProcessHandler processHandler) {
    processHandler.addProcessListener(new ProcessAdapter() {
      @Override
      public void processTerminated(ProcessEvent p0) {
        ApplicationManager.getApplication().invokeLater(new Runnable() {
          public void run() {
            if (!(ProgressLine.this.testsBuilt) && ProgressLine.this.progressBar.getFraction() == 0.0) {
              ProgressLine.this.progressBar.setColor(ColorProgressBar.RED);
              ProgressLine.this.progressBar.setFraction(1.0);
              ProgressLine.this.stateLabel.setText("Failed to start");
            } else if (ProgressLine.this.state.getTotalTests() != ProgressLine.this.state.getCompletedTests()) {
            }
          }
        });
      }
    });
  }
}
