package jetbrains.mps.baseLanguage.unitTest.plugin;

/*Generated by MPS */

import com.intellij.execution.process.DefaultJavaProcessHandler;
import java.nio.charset.Charset;
import com.intellij.execution.process.ProcessAdapter;
import com.intellij.execution.process.ProcessTerminatedListener;
import com.intellij.execution.process.ProcessEvent;
import com.intellij.openapi.util.Key;
import com.intellij.execution.process.ProcessOutputTypes;
import org.apache.commons.lang.StringUtils;
import jetbrains.mps.baseLanguage.unitTest.runtime.TestEvent;

public class UnitTestProcessHandler extends DefaultJavaProcessHandler {
  private final TestEventsDispatcher myDispatcher;

  public UnitTestProcessHandler(TestEventsDispatcher dispartcher, Process process, String params) {
    super(process, params, Charset.defaultCharset());
    this.myDispatcher = dispartcher;

    this.addProcessListener(new ProcessAdapter() {
      private StringBuffer buffer = new StringBuffer();

      private String getLine(String text, StringBuffer buffer) {
        buffer.append(text);
        if (buffer.toString().contains("\n")) {
          int pos = buffer.toString().lastIndexOf("\n");
          String lineToAppend = buffer.toString().substring(0, pos);
          buffer.replace(0, pos, "");
          return lineToAppend;
        } else {
          return null;
        }
      }

      private boolean isTerminatedEvent() {
        for (StackTraceElement element : Thread.currentThread().getStackTrace()) {
          if (element.getClassName().equals(ProcessTerminatedListener.class.getName())) {
            return true;
          }
        }
        return false;
      }

      public void onTextAvailable(ProcessEvent event, Key k) {
        if (this.isTerminatedEvent()) {
          UnitTestProcessHandler.this.myDispatcher.onProcessTerminated(event.getText());
        }
        boolean error = ProcessOutputTypes.STDERR.equals(k);
        boolean system = ProcessOutputTypes.SYSTEM.equals(k);
        String text = (error || system ?
          event.getText() :
          this.getLine(event.getText(), this.buffer)
        );
        if (text == null) {
          return;
        }
        String textTrimmed = StringUtils.trim(text);
        TestEvent testEvent = TestEvent.parse(textTrimmed);
        if (testEvent != null) {
          UnitTestProcessHandler.this.myDispatcher.onTestEvent(testEvent);
        } else {
          UnitTestProcessHandler.this.myDispatcher.onSimpleTextAvailable(text, k);
        }
      }
    });
    ProcessTerminatedListener.attach(this);
  }
}
