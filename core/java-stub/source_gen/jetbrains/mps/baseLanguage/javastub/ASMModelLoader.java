package jetbrains.mps.baseLanguage.javastub;

/*Generated by MPS */

import org.apache.log4j.Logger;
import org.apache.log4j.LogManager;
import org.jetbrains.mps.openapi.module.SModule;
import java.util.Collection;
import jetbrains.mps.smodel.SModel;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.vfs.FileSystem;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.internal.collections.runtime.ITranslator2;
import org.jetbrains.mps.openapi.model.SNode;

public class ASMModelLoader {
  private static final Logger LOG = LogManager.getLogger(ASMModelLoader.class);
  private final SModule myModule;
  private Collection<String> myPaths;
  private boolean mySkipPrivate;
  private boolean myOnlyPublic;
  public ASMModelLoader(SModule module, Collection<String> paths) {
    myModule = module;
    myPaths = paths;
  }
  public ASMModelLoader onlyPublicClasses(boolean onlyPublicClasses) {
    myOnlyPublic = onlyPublicClasses;
    return this;
  }
  public ASMModelLoader skipPrivateMembers(boolean skipPrivateMembers) {
    mySkipPrivate = skipPrivateMembers;
    return this;
  }
  public void update(SModel model) {
    try {
      ClassifierLoader loader = new ClassifierLoader(new SReferenceCreator(myModule, model), myOnlyPublic, mySkipPrivate);

      Iterable<IFile> classFiles = CollectionSequence.fromCollection(myPaths).select(new ISelector<String, IFile>() {
        public IFile select(String it) {
          return FileSystem.getInstance().getFileByPath(it);
        }
      }).where(new IWhereFilter<IFile>() {
        public boolean accept(IFile it) {
          return it != null;
        }
      }).translate(new ITranslator2<IFile, IFile>() {
        public Iterable<IFile> translate(IFile it) {
          return it.getChildren();
        }
      }).where(new IWhereFilter<IFile>() {
        public boolean accept(IFile it) {
          return !(it.isDirectory()) && it.getName().endsWith(".class") && !(ClassifierLoader.getClassName(it).contains("$"));
        }
      });

      for (IFile classfile : classFiles) {
        if (model.getNode(ASMNodeId.createId(ClassifierLoader.getClassName(classfile))) != null) {
          continue;
        }
        SNode classifier = loader.getClassifier(classfile);
        if (classifier != null) {
          model.addRootNode(classifier);
        }
      }
    } catch (Exception e) {
      LOG.error("Exception", e);
    }
  }
}
