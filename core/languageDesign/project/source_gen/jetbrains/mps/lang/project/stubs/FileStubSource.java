package jetbrains.mps.lang.project.stubs;

/*Generated by MPS */

import jetbrains.mps.util.annotation.ImmutableObject;
import jetbrains.mps.smodel.descriptor.source.FileBasedModelDataSource;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.smodel.SModelReference;
import jetbrains.mps.smodel.persistence.def.DescriptorLoadResult;
import jetbrains.mps.project.IModule;
import jetbrains.mps.smodel.SModelFqName;
import jetbrains.mps.smodel.BaseSModelDescriptor;
import jetbrains.mps.smodel.SModelDescriptor;
import jetbrains.mps.smodel.ModelLoadingState;
import jetbrains.mps.smodel.SModel;
import jetbrains.mps.smodel.nodeidmap.ForeignNodeIdMap;
import jetbrains.mps.project.structure.modules.ModuleDescriptor;
import jetbrains.mps.library.ModulesMiner;
import jetbrains.mps.project.structure.stub.ProjectStructureBuilder;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.project.structure.model.ModelRoot;
import jetbrains.mps.internal.collections.runtime.ITranslator2;
import jetbrains.mps.project.structure.modules.ModuleReference;
import jetbrains.mps.smodel.MPSModuleRepository;
import jetbrains.mps.project.ModuleId;
import jetbrains.mps.project.SModelRoot;
import jetbrains.mps.internal.collections.runtime.ISelector;
import java.util.Collections;

@ImmutableObject
public class FileStubSource extends FileBasedModelDataSource {
  private IFile myFile;
  private SModelReference ref;

  public FileStubSource(IFile file, SModelReference ref) {
    myFile = file;
    this.ref = ref;
  }

  public IFile getFile() {
    return myFile;
  }

  public boolean containFile(IFile file) {
    return eq_9hjfki_a0a0b(myFile, file);
  }

  public long getTimestamp() {
    return 0;
  }

  public DescriptorLoadResult loadDescriptor(IModule module, SModelFqName name) {
    DescriptorLoadResult result = new DescriptorLoadResult();
    result.setUID(ref.getSModelId().toString());
    return result;
  }

  public BaseSModelDescriptor.ModelLoadResult loadSModel(IModule module, SModelDescriptor descriptor, ModelLoadingState state) {
    SModel model = new SModel(descriptor.getSModelReference(), new ForeignNodeIdMap());
    model.setLoading(true);

    try {
      final ModuleDescriptor moduleDesc = ModulesMiner.getInstance().loadModuleDescriptor(myFile);
      new ProjectStructureBuilder(moduleDesc, myFile, model) {
        public Iterable<SModelReference> loadReferences(SNode m, final ModuleDescriptor d) {
          return Sequence.fromIterable(((Iterable<ModelRoot>) d.getModelRoots())).translate(new ITranslator2<ModelRoot, SModelReference>() {
            public Iterable<SModelReference> translate(ModelRoot it) {
              return loadModels(it, d);
            }
          });
        }
      }.convert();

      ModuleReference lang = MPSModuleRepository.getInstance().getModuleById(ModuleId.fromString("86ef8290-12bb-4ca7-947f-093788f263a9")).getModuleReference();
      model.addLanguage(lang);
      module.addUsedLanguage(lang);
    } finally {
      model.setLoading(false);
    }
    return new BaseSModelDescriptor.ModelLoadResult(model, ModelLoadingState.FULLY_LOADED);

  }

  public boolean saveModel(SModelDescriptor descriptor) {
    throw new UnsupportedOperationException();
  }

  private Iterable<SModelReference> loadModels(ModelRoot root, ModuleDescriptor md) {
    try {
      SModelRoot sroot = new SModelRoot(root);
      IModule module = MPSModuleRepository.getInstance().getModule(md.getModuleReference());
      Iterable<SModelDescriptor> mds = sroot.getManager().load(root, module);
      return Sequence.fromIterable(mds).select(new ISelector<SModelDescriptor, SModelReference>() {
        public SModelReference select(SModelDescriptor it) {
          return it.getSModelReference();
        }
      });
    } catch (Exception e) {
      return Collections.emptySet();
    }
  }

  private static boolean eq_9hjfki_a0a0b(Object a, Object b) {
    return (a != null ?
      a.equals(b) :
      a == b
    );
  }
}
