package jetbrains.mps.lang.dataFlow;

/*Generated by MPS */

import com.intellij.openapi.components.ApplicationComponent;
import jetbrains.mps.logging.Logger;
import jetbrains.mps.reloading.ClassLoaderManager;
import jetbrains.mps.smodel.MPSModuleRepository;
import java.util.Map;
import java.util.HashMap;
import jetbrains.mps.reloading.ReloadAdapter;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.lang.dataFlow.framework.Program;
import jetbrains.mps.smodel.INodeAdapter;
import jetbrains.mps.smodel.BaseAdapter;
import jetbrains.mps.smodel.SNode;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.smodel.SModelDescriptor;
import jetbrains.mps.smodel.LanguageAspect;
import com.intellij.openapi.application.ApplicationManager;

public class DataFlowManager implements ApplicationComponent {
  private static Logger LOG = Logger.getLogger(DataFlowManager.class);

  private ClassLoaderManager myClassLoaderManager;
  private MPSModuleRepository myModuleRepository;
  private Map<String, DataFlowBuilder> myBuilders = new HashMap<String, DataFlowBuilder>();

  public DataFlowManager(ClassLoaderManager manager, MPSModuleRepository repo) {
    this.myClassLoaderManager = manager;
    this.myModuleRepository = repo;
  }

  public void initComponent() {
    this.myClassLoaderManager.addReloadHandler(new ReloadAdapter() {
      public void invalidateCaches() {
        DataFlowManager.this.refresh();
      }
    });
  }

  @NotNull
  public String getComponentName() {
    return "Data Flow Manager";
  }

  public void disposeComponent() {
  }

  public void register(String conceptFqName, DataFlowBuilder builder) {
    this.myBuilders.put(conceptFqName, builder);
  }

  public Program buildProgramFor(INodeAdapter adapter) {
    return this.buildProgramFor(BaseAdapter.fromAdapter(adapter));
  }

  public Program buildProgramFor(SNode node) {
    return new MPSProgramBuilder(this).buildProgram(node);
  }

  /*package*/ DataFlowBuilder getBuilderFor(String conceptName) {
    return this.myBuilders.get(conceptName);
  }

  private void refresh() {
    this.myBuilders.clear();
    for (Language l : this.myModuleRepository.getAllLanguages()) {
      SModelDescriptor dfaModel = LanguageAspect.DATA_FLOW.get(l);
      if (dfaModel != null && !(dfaModel.isEmpty())) {
        String dfaBuildersClassName = dfaModel.getLongName() + ".DFABuilders";
        Class<? extends DataFlowBuilders> buildersClass = l.getClass(dfaBuildersClassName);
        if (buildersClass != null) {
          DataFlowBuilders builders = null;
          try {
            builders = buildersClass.newInstance();
            builders.install(this);
          } catch (InstantiationException e) {
            LOG.error(e);
          } catch (IllegalAccessException e) {
            LOG.error(e);
          }
        }
      }
    }
  }

  public static DataFlowManager getInstance() {
    return ApplicationManager.getApplication().getComponent(DataFlowManager.class);
  }
}
