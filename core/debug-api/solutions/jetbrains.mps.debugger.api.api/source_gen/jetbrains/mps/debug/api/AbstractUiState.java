package jetbrains.mps.debug.api;

/*Generated by MPS */

import org.jetbrains.annotations.Nullable;
import jetbrains.mps.debug.api.programState.IThread;
import org.jetbrains.annotations.NotNull;
import java.util.List;
import jetbrains.mps.debug.api.programState.IStackFrame;
import java.util.Collections;
import java.util.Map;
import jetbrains.mps.debug.api.programState.IWatchable;
import jetbrains.mps.debug.api.programState.IValue;

public abstract class AbstractUiState {
  protected static final int NO_FRAME = -1;

  protected final AbstractDebugSession myAbstractDebugSession;

  protected AbstractUiState(AbstractDebugSession session) {
    myAbstractDebugSession = session;
  }

  @Nullable
  public abstract IThread getThread();

  @NotNull
  public abstract List<IThread> getThreads();

  @Nullable
  public abstract IStackFrame getStackFrame();

  public abstract boolean isPausedOnBreakpoint();

  protected abstract IThread findThread();

  protected abstract AbstractUiState selectThreadInternal(@Nullable IThread thread);

  @Deprecated
  protected AbstractUiState selectFrameInternal(@Nullable IStackFrame frame) {
    //  is going to be removed, implement selectFrameInternal(int) 
    return this;
  }

  protected AbstractUiState selectFrameInternal(int frame) {
    //  this implementation is going to be removed 
    //  the method is going to be abstract 
    //  it is here for not breaking existing user code 
    if (frame == NO_FRAME) {
      return selectFrameInternal(null);
    } else {
      return selectFrameInternal(getThread().getFrames().get(frame));
    }
  }

  @Nullable
  @Deprecated
  protected IStackFrame findStackFrame() {
    // impl 
    int index = findStackFrameIndex();
    if (index == NO_FRAME) {
      return null;
    }
    return getThread().getFrames().get(index);
  }

  protected int findStackFrameIndex() {
    // impl 
    IThread thread = getThread();
    if (thread == null) {
      return NO_FRAME;
    }
    if (thread.getFramesCount() > 0) {
      return myAbstractDebugSession.getDebuggableFramesSelector().findDeepestDebuggableFrameIndex(thread.getFrames());
    }
    return NO_FRAME;
  }

  public void selectThread(@Nullable IThread thread) {
    AbstractUiState newState = selectThreadInternal(thread);
    if (newState != this) {
      myAbstractDebugSession.trySetState(this, newState);
    }
  }

  public void selectFrame(int frame) {
    AbstractUiState newState = selectFrameInternal(frame);
    if (newState != this) {
      myAbstractDebugSession.trySetState(this, newState);
    }
  }

  @NotNull
  public List<IStackFrame> getStackFrames() {
    IThread thread = getThread();
    if (thread != null) {
      return thread.getFrames();
    }
    return Collections.emptyList();
  }

  public int getStackFramesCount() {
    IThread thread = getThread();
    if (thread != null) {
      return thread.getFramesCount();
    }
    return 0;
  }

  @Nullable
  public IStackFrame getStackFrame(int index) {
    assert index >= 0;
    List<IStackFrame> frames = getStackFrames();
    if (index >= frames.size()) {
      return null;
    }
    return frames.get(index);
  }

  @NotNull
  public Map<IWatchable, IValue> getWatchableValues() {
    //  todo is this method really used? 
    IStackFrame stackFrame = getStackFrame();
    if (stackFrame != null) {
      return stackFrame.getWatchableValues();
    }
    return Collections.emptyMap();
  }

  @NotNull
  public List<IWatchable> getWatchables() {
    IStackFrame stackFrame = getStackFrame();
    if (stackFrame != null) {
      return stackFrame.getVisibleWatchables();
    }
    return Collections.emptyList();
  }

  @Nullable
  public IValue getVariableValue(IWatchable variable) {
    IStackFrame stackFrame = getStackFrame();
    if (stackFrame != null) {
      return stackFrame.getValue(variable);
    }
    return null;
  }

  @Nullable
  public String getSourceFileName() {
    IStackFrame stackFrame = getStackFrame();
    if (stackFrame == null) {
      return null;
    }
    return stackFrame.getLocation().getFileName();
  }

  public int getPosition() {
    IStackFrame stackFrame = getStackFrame();
    if (stackFrame == null) {
      return 0;
    }
    return stackFrame.getLocation().getLineNumber();
  }
}
