package jetbrains.mps.internal.make.runtime.util;

/*Generated by MPS */

import java.util.Map;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.MapSequence;
import java.util.HashMap;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.IVisitor;
import jetbrains.mps.internal.collections.runtime.IRightCombinator;
import java.util.ArrayList;

public class DeltaReconciler {
  private Map<Object, List<IDelta>> delta = MapSequence.fromMap(new HashMap<Object, List<IDelta>>());

  public DeltaReconciler() {
  }

  public DeltaReconciler(Iterable<IDelta> toReconcile) {
    addAll(toReconcile);
  }

  public void addDelta(IDelta d) {
    ListSequence.fromList(deltaList(d.key())).addElement(d);
  }

  public final void addAll(Iterable<IDelta> toReconcile) {
    Sequence.fromIterable(toReconcile).visitAll(new IVisitor<IDelta>() {
      public void visit(IDelta d) {
        ListSequence.fromList(deltaList(d.key())).addElement(d);
      }
    });
  }

  public void reconcileAll() {
    for (List<IDelta> deltaList : MapSequence.fromMap(delta).values()) {
      ListSequence.fromList(deltaList).reduceRight(new IRightCombinator<IDelta, IDelta>() {
        public IDelta combine(IDelta a, IDelta b) {
          return b.merge(a);
        }
      }).reconcile();
    }
  }

  private List<IDelta> deltaList(Object key) {
    List<IDelta> ld = MapSequence.fromMap(delta).get(key);
    if (ld == null) {
      ld = ListSequence.fromList(new ArrayList<IDelta>());
      MapSequence.fromMap(delta).put(key, ld);
    }
    return ld;
  }
}
