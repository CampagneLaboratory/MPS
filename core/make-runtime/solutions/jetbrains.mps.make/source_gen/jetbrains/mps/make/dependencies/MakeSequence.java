package jetbrains.mps.make.dependencies;

/*Generated by MPS */

import jetbrains.mps.make.resources.IResource;
import jetbrains.mps.make.script.IScript;
import java.util.Iterator;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.smodel.ModelAccess;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.make.MakeSession;
import jetbrains.mps.internal.collections.runtime.IVisitor;
import jetbrains.mps.make.script.ScriptBuilder;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;

public class MakeSequence {
  private Iterable<Cluster> myClusters;

  public MakeSequence() {
  }

  protected MakeSequence(Iterable<? extends Iterable<IResource>> inputRes, Iterable<IScript> scripts) {
    // protected to prevent accidental use. This cons here is for compatibility reasons 
    // and will be removed as soon as it's only use in CoreMakeTask(deprecated cons) gone. 
    Iterator<IScript> it1 = Sequence.fromIterable(scripts).iterator();
    Iterator<? extends Iterable<IResource>> it2 = Sequence.fromIterable(inputRes).iterator();
    List<Cluster> cc = ListSequence.fromList(new ArrayList<Cluster>());
    // list of used languages is for script building. since we've got script already, there's no use for languages 
    List<String> noUse = ListSequence.fromList(new ArrayList<String>());
    while (it1.hasNext() && it2.hasNext()) {
      Iterable<IResource> seq = it2.next();
      Cluster c = new Cluster(seq, noUse);
      c.setScript(it1.next());
      ListSequence.fromList(cc).addElement(c);
    }
    myClusters = cc;
  }

  public void prepareClusters(final Iterable<? extends IResource> inputRes) {
    ModelAccess.instance().runReadAction(new Runnable() {
      public void run() {
        ModulesClusterizer mcr = new ModulesClusterizer();
        myClusters = mcr.clusterize(inputRes);
      }
    });
  }

  public void prepareScipts(@Nullable final IScript defaultScript, @Nullable final MakeSession makeSession) {
    Sequence.fromIterable(myClusters).visitAll(new IVisitor<Cluster>() {
      public void visit(Cluster cluster) {
        if (defaultScript != null) {
          cluster.setScript(defaultScript);
        } else {
          ScriptBuilder scb = cluster.createScriptBuilder();
          cluster.setScript((makeSession == null ? scb.toScript() : makeSession.toScript(scb)));
        }
      }
    });
  }



  @Deprecated
  public Iterable<Cluster> getClusters() {
    // this method is for transition period only, and will be removed afterwards 
    return myClusters;
  }

  public int steps() {
    return Sequence.fromIterable(myClusters).count();
  }

  public void iterate(_FunctionTypes._return_P2_E0<? extends Boolean, ? super IScript, ? super Iterable<IResource>> iterator) {
    // iterator accepts script and resources to be processed by the script, and returns false to stop 
    for (Cluster c : myClusters) {
      if (!(iterator.invoke(c.getScript(), c.getResources()))) {
        break;
      }
    }
  }
}
