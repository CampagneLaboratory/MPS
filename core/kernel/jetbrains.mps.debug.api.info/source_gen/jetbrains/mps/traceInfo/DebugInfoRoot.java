package jetbrains.mps.traceInfo;

/*Generated by MPS */

import org.jetbrains.annotations.Nls;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.TreeSet;
import java.util.HashSet;
import org.jetbrains.annotations.Nullable;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.NonNls;
import jetbrains.mps.smodel.SModelReference;
import jetbrains.mps.smodel.SNodePointer;
import org.jetbrains.mps.openapi.model.SNodeId;
import org.jdom.Element;
import java.util.Comparator;
import org.jdom.DataConversionException;
import java.util.List;

public class DebugInfoRoot {
  private static final String NODE_INFO = "nodeInfo";
  private static final String SCOPE_INFO = "scopeInfo";
  private static final String UNIT_INFO = "unitInfo";
  private final String myRootId;
  @Nls
  private final String myModelId;
  private final Set<TraceablePositionInfo> myPositions = SetSequence.fromSet(new TreeSet<TraceablePositionInfo>());
  private final Set<ScopePositionInfo> myScopePositions = SetSequence.fromSet(new TreeSet<ScopePositionInfo>());
  private final Set<UnitPositionInfo> myUnitPositions = SetSequence.fromSet(new TreeSet<UnitPositionInfo>());
  private final Set<String> myFileNames = SetSequence.fromSet(new HashSet<String>());

  public DebugInfoRoot(String rootId, String modelId) {
    myRootId = rootId;
    myModelId = modelId;
  }

  /*package*/ void addPosition(TraceablePositionInfo position) {
    SetSequence.fromSet(myFileNames).addElement(position.getFileName());
    SetSequence.fromSet(myPositions).addElement(position);
  }

  /*package*/ void addScopePosition(ScopePositionInfo position) {
    SetSequence.fromSet(myFileNames).addElement(position.getFileName());
    SetSequence.fromSet(myScopePositions).addElement(position);
  }

  /*package*/ void addUnitPosition(UnitPositionInfo unitPosition) {
    SetSequence.fromSet(myFileNames).addElement(unitPosition.getFileName());
    SetSequence.fromSet(myUnitPositions).addElement(unitPosition);
  }

  /*package*/ String getRootId() {
    return myRootId;
  }

  /*package*/ String getModelId() {
    return myModelId;
  }

  public Set<TraceablePositionInfo> getPositions() {
    return myPositions;
  }

  public Set<ScopePositionInfo> getScopePositions() {
    return myScopePositions;
  }

  public Set<UnitPositionInfo> getUnitPositions() {
    return myUnitPositions;
  }

  public Set<String> getFileNames() {
    return myFileNames;
  }

  @Nullable
  public SNode findNode(@NotNull PositionInfo info) {
    String nodeId = info.getNodeId();
    if ((nodeId == null || nodeId.length() == 0)) {
      return null;
    }
    return findNode(nodeId);
  }

  public SNode findNode(@NonNls String nodeId) {
    SModelReference modelRef = SModelReference.fromString(myModelId);
    return new SNodePointer(modelRef, jetbrains.mps.smodel.SNodeId.fromString(nodeId)).getNode();
  }

  /*package*/ void toXml(Element container) {
    for (PositionInfo position : SetSequence.fromSet(myPositions).toListSequence().sort(new Comparator<TraceablePositionInfo>() {
      public int compare(TraceablePositionInfo a, TraceablePositionInfo b) {
        return a.compareTo(b);
      }
    }, true)) {
      Element e = new Element(DebugInfoRoot.NODE_INFO);
      position.saveTo(e);
      container.addContent(e);
    }
    for (ScopePositionInfo position : SetSequence.fromSet(myScopePositions).toListSequence().sort(new Comparator<ScopePositionInfo>() {
      public int compare(ScopePositionInfo a, ScopePositionInfo b) {
        return a.compareTo(b);
      }
    }, true)) {
      Element e = new Element(DebugInfoRoot.SCOPE_INFO);
      position.saveTo(e);
      container.addContent(e);
    }
    for (UnitPositionInfo position : SetSequence.fromSet(myUnitPositions).toListSequence().sort(new Comparator<UnitPositionInfo>() {
      public int compare(UnitPositionInfo a, UnitPositionInfo b) {
        return a.compareTo(b);
      }
    }, true)) {
      Element e = new Element(DebugInfoRoot.UNIT_INFO);
      position.saveTo(e);
      container.addContent(e);
    }
  }

  /*package*/ static DebugInfoRoot fromXml(Element element, String id, String modelId) throws DataConversionException {
    Element root = element;
    DebugInfoRoot result = new DebugInfoRoot(id, modelId);
    for (Element e : ((List<Element>) root.getChildren(DebugInfoRoot.NODE_INFO))) {
      result.addPosition(new TraceablePositionInfo(e));
    }
    for (Element e : ((List<Element>) root.getChildren(DebugInfoRoot.SCOPE_INFO))) {
      result.addScopePosition(new ScopePositionInfo(e));
    }
    for (Element e : ((List<Element>) root.getChildren(DebugInfoRoot.UNIT_INFO))) {
      result.addUnitPosition(new UnitPositionInfo(e));
    }
    return result;
  }
}
