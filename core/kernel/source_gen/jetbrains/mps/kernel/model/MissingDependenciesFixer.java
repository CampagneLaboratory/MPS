package jetbrains.mps.kernel.model;

/*Generated by MPS */

import org.apache.log4j.Logger;
import org.apache.log4j.LogManager;
import org.jetbrains.mps.openapi.model.SModel;
import jetbrains.mps.smodel.ModelAccess;
import jetbrains.mps.project.AbstractModule;
import org.jetbrains.mps.openapi.module.SRepository;
import java.util.Set;
import org.jetbrains.mps.openapi.module.SModule;
import jetbrains.mps.classloading.ClassLoaderManager;
import java.util.Arrays;
import jetbrains.mps.progress.EmptyProgressMonitor;
import org.jetbrains.mps.openapi.module.SearchScope;
import java.util.List;
import org.jetbrains.mps.openapi.model.SModelReference;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import java.util.ArrayList;
import jetbrains.mps.smodel.SModelOperations;
import jetbrains.mps.smodel.SModelRepository;
import org.jetbrains.mps.openapi.module.SModuleReference;
import jetbrains.mps.util.CollectionUtil;
import jetbrains.mps.smodel.SModelInternal;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.smodel.ScopeOperations;
import jetbrains.mps.project.GlobalScope;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;
import jetbrains.mps.project.DevKit;

public class MissingDependenciesFixer {
  private static Logger LOG = LogManager.getLogger(MissingDependenciesFixer.class);

  private SModel myModel;

  public MissingDependenciesFixer(SModel modelDescriptor) {
    myModel = modelDescriptor;
  }



  @Deprecated
  public void fix() {
    fixDependencies(myModel);
  }



  @Deprecated
  public void fix(final boolean reload) {
    fixDependencies(myModel);
  }



  public static void fixDependencies(final SModel model, final boolean fixImplicit) {
    // TODO use repository.getModelAccess().executeCommand() 
    ModelAccess.instance().runWriteActionInCommand(new Runnable() {
      public void run() {
        AbstractModule module = (AbstractModule) model.getModule();
        if (module == null) {
          LOG.error("Module is null: " + model.getReference().toString());
          return;
        }
        SRepository repository = module.getRepository();
        if (repository == null) {
          LOG.error("Repository is null: " + model.getReference().toString());
          return;
        }

        Set<SModule> unloadedModules = ClassLoaderManager.getInstance().unloadClasses(Arrays.asList(module), new EmptyProgressMonitor());

        SearchScope moduleScope = module.getScope();
        List<SModelReference> models = ListSequence.fromList(new ArrayList<SModelReference>());
        if (fixImplicit) {
          for (jetbrains.mps.smodel.SModel.ImportElement impElem : SModelOperations.getAllImportElements(model)) {
            ListSequence.fromList(models).addElement(impElem.getModelReference());
          }
        } else {
          ListSequence.fromList(models).addSequence(ListSequence.fromList(SModelOperations.getImportedModelUIDs(model)));
        }
        for (SModelReference modelImport : models) {
          if (moduleScope.resolve(modelImport) != null) {
            continue;
          }
          SModel sm = modelImport.resolve(repository);
          if (sm == null) {
            sm = (modelImport.getModelName() != null ? SModelRepository.getInstance().getModelDescriptor(modelImport.getModelName()) : null);
            if (sm == null) {
              continue;
            }
          }
          SModule anotherModule = sm.getModule();
          if (anotherModule == null || anotherModule == module) {
            continue;
          }
          module.addDependency(anotherModule.getModuleReference(), false);
        }
        for (SModuleReference namespace : CollectionUtil.union(((SModelInternal) model).importedLanguages(), ((SModelInternal) model).engagedOnGenerationLanguages())) {
          if (moduleScope.resolve(namespace) instanceof Language) {
            continue;
          }
          Language lang = ScopeOperations.resolveModule(GlobalScope.getInstance(), namespace, Language.class);
          if (lang == null) {
            continue;
          }
          SModuleReference ref = PersistenceFacade.getInstance().createModuleReference(namespace.toString());
          module.addUsedLanguage(ref);
        }
        for (SModuleReference devKitNamespace : ((SModelInternal) model).importedDevkits()) {
          if (moduleScope.resolve(devKitNamespace) instanceof DevKit) {
            continue;
          }
          DevKit devKit = ScopeOperations.resolveModule(GlobalScope.getInstance(), devKitNamespace, DevKit.class);
          if (devKit == null) {
            continue;
          }
          SModuleReference ref = PersistenceFacade.getInstance().createModuleReference(devKitNamespace.toString());
          module.addUsedDevkit(ref);
        }

        ClassLoaderManager.getInstance().loadClasses(unloadedModules, new EmptyProgressMonitor());
      }
    });
  }

  public static void fixDependencies(SModel model) {
    fixDependencies(model, false);
  }
}
