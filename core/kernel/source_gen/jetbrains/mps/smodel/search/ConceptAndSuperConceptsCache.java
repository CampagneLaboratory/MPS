package jetbrains.mps.smodel.search;

/*Generated by MPS */

import jetbrains.mps.cache.AbstractCache;
import jetbrains.mps.cache.KeyProducer;
import jetbrains.mps.cache.CachesManager;
import jetbrains.mps.lang.structure.structure.AbstractConceptDeclaration;
import jetbrains.mps.cache.DataSet;
import java.util.Set;
import jetbrains.mps.smodel.SModelDescriptor;
import java.util.HashSet;
import jetbrains.mps.smodel.SModelUtil_new;
import jetbrains.mps.util.NameUtil;
import jetbrains.mps.project.GlobalScope;
import java.util.List;
import jetbrains.mps.lang.structure.structure.PropertyDeclaration;
import jetbrains.mps.lang.structure.structure.LinkDeclaration;
import jetbrains.mps.lang.structure.structure.ConceptProperty;
import jetbrains.mps.smodel.SNode;
import java.util.LinkedHashSet;
import jetbrains.mps.lang.structure.structure.InterfaceConceptDeclaration;
import jetbrains.mps.lang.structure.structure.InterfaceConceptReference;
import jetbrains.mps.lang.structure.structure.ConceptDeclaration;
import java.util.ArrayList;
import jetbrains.mps.smodel.event.SModelChildEvent;
import jetbrains.mps.smodel.event.SModelPropertyEvent;
import java.util.Map;
import java.util.HashMap;
import jetbrains.mps.lang.structure.structure.ConceptPropertyDeclaration;
import jetbrains.mps.smodel.event.SModelReferenceEvent;

/*package*/ class ConceptAndSuperConceptsCache extends AbstractCache {
  private static final KeyProducer keyProducer = new KeyProducer();
  private static final CachesManager.CacheCreator<AbstractConceptDeclaration> CREATOR = new CachesManager.CacheCreator<AbstractConceptDeclaration>() {
    public AbstractCache create(Object key, AbstractConceptDeclaration element) {
      return new ConceptAndSuperConceptsCache(key, element);
    }
  };
  private static final AbstractCache.DataSetCreator<ConceptAndSuperConceptsCache> CONCEPTS_CACHE_CREATOR = new AbstractCache.DataSetCreator<ConceptAndSuperConceptsCache>() {
    public DataSet create(ConceptAndSuperConceptsCache ownerCache) {
      return new ConceptAndSuperConceptsCache.ConceptsDataSet(ownerCache);
    }
  };
  private static final AbstractCache.DataSetCreator<ConceptAndSuperConceptsCache> PROPDECL_CACHE_CREATOR = new AbstractCache.DataSetCreator<ConceptAndSuperConceptsCache>() {
    @Override
    public DataSet create(ConceptAndSuperConceptsCache ownerCache) {
      return new ConceptAndSuperConceptsCache.PropertyDeclarationsDataSet(ownerCache);
    }
  };
  private static final AbstractCache.DataSetCreator<ConceptAndSuperConceptsCache> LINKDECL_CACHE_CREATOR = new AbstractCache.DataSetCreator<ConceptAndSuperConceptsCache>() {
    @Override
    public DataSet create(ConceptAndSuperConceptsCache ownerCache) {
      return new ConceptAndSuperConceptsCache.LinkDeclarationsDataSet(ownerCache);
    }
  };
  private static final AbstractCache.DataSetCreator<ConceptAndSuperConceptsCache> CONCEPTPROPS_CACHE_CREATOR = new AbstractCache.DataSetCreator<ConceptAndSuperConceptsCache>() {
    @Override
    public DataSet create(ConceptAndSuperConceptsCache ownerCache) {
      return new ConceptAndSuperConceptsCache.ConceptPropertiesDataSet(ownerCache);
    }
  };

  private AbstractConceptDeclaration myTopConcept;

  protected ConceptAndSuperConceptsCache(Object key, AbstractConceptDeclaration topConcept) {
    super(key);
    myTopConcept = topConcept;
  }

  @Override
  public Set<SModelDescriptor> getDependsOnModels(Object element) {
    Set<SModelDescriptor> dependsOnModel = new HashSet<SModelDescriptor>();
    for (AbstractConceptDeclaration concept : getConcepts()) {
      SModelDescriptor descriptor = concept.getModel().getModelDescriptor();
      assert descriptor != null : getAssertionMessage(element, concept);
      dependsOnModel.add(descriptor);
    }
    return dependsOnModel;
  }

  private String getAssertionMessage(Object element, AbstractConceptDeclaration concept) {
    AbstractConceptDeclaration conceptFromModelUtil = SModelUtil_new.findConceptDeclaration(NameUtil.nodeFQName(concept), GlobalScope.getInstance());
    return "Model descriptor is null for concept: " + concept + "(" + System.identityHashCode(concept) + ")  same concept from SModelUtil_new: " + conceptFromModelUtil + "(" + System.identityHashCode(conceptFromModelUtil) + "), element: " + element + "(" + System.identityHashCode(element) + "), myTopConcept: " + myTopConcept + "(" + System.identityHashCode(element) + ")";
  }

  public List<AbstractConceptDeclaration> getConcepts() {
    ConceptAndSuperConceptsCache.ConceptsDataSet dataSet = (ConceptAndSuperConceptsCache.ConceptsDataSet) getDataSet(ConceptAndSuperConceptsCache.ConceptsDataSet.ID, CONCEPTS_CACHE_CREATOR);
    return dataSet.getConcepts();
  }

  public PropertyDeclaration getPropertyDeclarationByName(String name) {
    ConceptAndSuperConceptsCache.PropertyDeclarationsDataSet dataSet = (ConceptAndSuperConceptsCache.PropertyDeclarationsDataSet) getDataSet(ConceptAndSuperConceptsCache.PropertyDeclarationsDataSet.ID, PROPDECL_CACHE_CREATOR);
    return dataSet.getPropertyDeclarationByName(name);
  }

  public List<PropertyDeclaration> getPropertyDeclarations() {
    ConceptAndSuperConceptsCache.PropertyDeclarationsDataSet dataSet = (ConceptAndSuperConceptsCache.PropertyDeclarationsDataSet) getDataSet(ConceptAndSuperConceptsCache.PropertyDeclarationsDataSet.ID, PROPDECL_CACHE_CREATOR);
    return dataSet.getPropertyDeclarations();
  }

  public LinkDeclaration getLinkDeclarationByRole(String role) {
    ConceptAndSuperConceptsCache.LinkDeclarationsDataSet dataSet = (ConceptAndSuperConceptsCache.LinkDeclarationsDataSet) getDataSet(ConceptAndSuperConceptsCache.LinkDeclarationsDataSet.ID, LINKDECL_CACHE_CREATOR);
    return dataSet.getLinkDeclarationByRole(role);
  }

  public LinkDeclaration getMostSpecificLinkDeclarationByRole(String role) {
    ConceptAndSuperConceptsCache.LinkDeclarationsDataSet dataSet = (ConceptAndSuperConceptsCache.LinkDeclarationsDataSet) getDataSet(ConceptAndSuperConceptsCache.LinkDeclarationsDataSet.ID, LINKDECL_CACHE_CREATOR);
    return dataSet.getMostSpecificLinkDeclarationByRole(role);
  }

  public List<LinkDeclaration> getLinkDeclarationsExcludingOverridden() {
    ConceptAndSuperConceptsCache.LinkDeclarationsDataSet dataSet = (ConceptAndSuperConceptsCache.LinkDeclarationsDataSet) getDataSet(ConceptAndSuperConceptsCache.LinkDeclarationsDataSet.ID, LINKDECL_CACHE_CREATOR);
    return dataSet.getLinkDeclarationsExcludingOverridden();
  }

  public ConceptProperty getConceptPropertyByName(String name) {
    ConceptAndSuperConceptsCache.ConceptPropertiesDataSet dataSet = (ConceptAndSuperConceptsCache.ConceptPropertiesDataSet) getDataSet(ConceptAndSuperConceptsCache.ConceptPropertiesDataSet.ID, CONCEPTPROPS_CACHE_CREATOR);
    return dataSet.getConceptPropertyByName(name);
  }

  public static ConceptAndSuperConceptsCache getInstance(AbstractConceptDeclaration topConcept) {
    SNode node = topConcept.getNode();
    Object key = keyProducer.createKey(node);
    return (ConceptAndSuperConceptsCache) CachesManager.getInstance().getCache(key, topConcept, CREATOR);
  }

  private static void collectImplementedAndExtended(AbstractConceptDeclaration top, Set<AbstractConceptDeclaration> result) {
    Set<AbstractConceptDeclaration> frontier = new LinkedHashSet<AbstractConceptDeclaration>();
    Set<AbstractConceptDeclaration> newFrontier = new LinkedHashSet<AbstractConceptDeclaration>();
    frontier.add(top);
    result.add(top);
    while (!(frontier.isEmpty())) {
      for (AbstractConceptDeclaration cd : frontier) {
        if (cd instanceof InterfaceConceptDeclaration) {
          InterfaceConceptDeclaration icd = (InterfaceConceptDeclaration) cd;
          for (InterfaceConceptReference i : icd.getExtendses()) {
            InterfaceConceptDeclaration intfc = i.getIntfc();
            if (intfc != null && !(result.contains(intfc))) {
              newFrontier.add(intfc);
              result.add(intfc);
            }
          }
        }
        if (cd instanceof ConceptDeclaration) {
          ConceptDeclaration c = (ConceptDeclaration) cd;
          ConceptDeclaration anExtends = c.getExtends();
          if (anExtends != null && !(result.contains(anExtends))) {
            newFrontier.add(anExtends);
            result.add(anExtends);
          }
          for (InterfaceConceptReference i : c.getImplementses()) {
            InterfaceConceptDeclaration intfc = i.getIntfc();
            if (intfc != null) {
              newFrontier.add(intfc);
              result.add(intfc);
            }
          }
        }
      }
      frontier = newFrontier;
      newFrontier = new LinkedHashSet<AbstractConceptDeclaration>();
    }
  }

  private static class ConceptsDataSet extends DataSet {
    public static final String ID = "CONCEPTS_DATASET";

    private AbstractConceptDeclaration myTopConcept;
    private List<AbstractConceptDeclaration> myConcepts;
    private Set<SNode> myDependsOnNodes;

    public ConceptsDataSet(ConceptAndSuperConceptsCache ownerCache) {
      super(ID, ownerCache, DataSet.DefaultNodeChangedProcessing.DROP_OWNER_CACHE);
      myTopConcept = ownerCache.myTopConcept;
    }

    public List<AbstractConceptDeclaration> getConcepts() {
      return myConcepts;
    }

    public Set<SNode> getDependsOnNodes() {
      return myDependsOnNodes;
    }

    protected void init() {
      Set<AbstractConceptDeclaration> result = new LinkedHashSet<AbstractConceptDeclaration>();
      ConceptAndSuperConceptsCache.collectImplementedAndExtended(myTopConcept, result);
      result.add(SModelUtil_new.getBaseConcept());
      myConcepts = new ArrayList<AbstractConceptDeclaration>(result);
      myDependsOnNodes = new HashSet<SNode>();
      for (AbstractConceptDeclaration concept : myConcepts) {
        myDependsOnNodes.add(concept.getNode());
        if (concept instanceof InterfaceConceptDeclaration) {
          for (InterfaceConceptReference i : ((InterfaceConceptDeclaration) concept).getExtendses()) {
            myDependsOnNodes.add(i.getNode());
          }
        }
        if (concept instanceof ConceptDeclaration) {
          for (InterfaceConceptReference i : ((ConceptDeclaration) concept).getImplementses()) {
            myDependsOnNodes.add(i.getNode());
          }
        }
      }
    }

    public void childAdded(SModelChildEvent event) {
      if (event.getParent().getAdapter() instanceof AbstractConceptDeclaration) {
        String role = event.getChildRole();
        if (ConceptDeclaration.IMPLEMENTS.equals(role) || InterfaceConceptDeclaration.EXTENDS.equals(role)) {
          super.childAdded(event);
        }
      }
    }

    public void childRemoved(SModelChildEvent event) {
      if (event.getParent().getAdapter() instanceof AbstractConceptDeclaration) {
        String role = event.getChildRole();
        if (ConceptDeclaration.IMPLEMENTS.equals(role) || InterfaceConceptDeclaration.EXTENDS.equals(role)) {
          super.childRemoved(event);
        }
      }
    }

    public void propertyChanged(SModelPropertyEvent event) {
    }
  }

  private static class PropertyDeclarationsDataSet extends DataSet {
    public static final String ID = "PROPERTY_DECLARATIONS_DATASET";

    private Map<String, PropertyDeclaration> myPropertyByName;
    private List<PropertyDeclaration> myProperties;
    private Set<SNode> myDependsOnNodes;

    public PropertyDeclarationsDataSet(AbstractCache ownerCache) {
      super(ID, ownerCache, DataSet.DefaultNodeChangedProcessing.DROP_DATA_SET);
    }

    public Set<SNode> getDependsOnNodes() {
      return myDependsOnNodes;
    }

    public PropertyDeclaration getPropertyDeclarationByName(String name) {
      return myPropertyByName.get(name);
    }

    public List<PropertyDeclaration> getPropertyDeclarations() {
      return new ArrayList<PropertyDeclaration>(myProperties);
    }

    protected void init() {
      List<PropertyDeclaration> allProperties = new ArrayList<PropertyDeclaration>();
      myProperties = new ArrayList<PropertyDeclaration>();
      myPropertyByName = new HashMap<String, PropertyDeclaration>();
      List<AbstractConceptDeclaration> concepts = ((ConceptAndSuperConceptsCache) getOwnerCache()).getConcepts();
      for (int i = concepts.size() - 1; i >= 0; i--) {
        List<PropertyDeclaration> props = concepts.get(i).getPropertyDeclarations();
        for (PropertyDeclaration prop : props) {
          allProperties.add(prop);
          String name = prop.getName();
          if (name == null) {
            continue;
          }
          if (myPropertyByName.containsKey(name)) {
            continue;
          }
          myProperties.add(prop);
          myPropertyByName.put(name, prop);
        }
      }
      myDependsOnNodes = new HashSet<SNode>();
      for (AbstractConceptDeclaration concept : concepts) {
        myDependsOnNodes.add(concept.getNode());
      }
      for (PropertyDeclaration prop : allProperties) {
        myDependsOnNodes.add(prop.getNode());
      }
    }

    public void childAdded(SModelChildEvent event) {
      if (event.getParent().getAdapter() instanceof AbstractConceptDeclaration) {
        String role = event.getChildRole();
        if (AbstractConceptDeclaration.PROPERTY_DECLARATION.equals(role)) {
          super.childAdded(event);
        }
      }
    }

    public void childRemoved(SModelChildEvent event) {
      if (event.getParent().getAdapter() instanceof AbstractConceptDeclaration) {
        String role = event.getChildRole();
        if (AbstractConceptDeclaration.PROPERTY_DECLARATION.equals(role)) {
          super.childRemoved(event);
        }
      }
    }

    public void propertyChanged(SModelPropertyEvent event) {
      if (event.getNode().getAdapter() instanceof PropertyDeclaration) {
        super.propertyChanged(event);
      }
    }
  }

  private static class LinkDeclarationsDataSet extends DataSet {
    public static final String ID = "LINK_DECLARATIONS_DATASET";

    private Map<String, LinkDeclaration> myLinkByRole;
    private Map<LinkDeclaration, LinkDeclaration> myMostSpecificLinkBySpecializedLink;
    private List<LinkDeclaration> myMostSpecificLinks;
    private Set<SNode> myDependsOnNodes;

    public LinkDeclarationsDataSet(AbstractCache ownerCache) {
      super(ID, ownerCache, DataSet.DefaultNodeChangedProcessing.DROP_DATA_SET);
    }

    public Set<SNode> getDependsOnNodes() {
      return myDependsOnNodes;
    }

    public LinkDeclaration getLinkDeclarationByRole(String role) {
      return myLinkByRole.get(role);
    }

    public LinkDeclaration getMostSpecificLinkDeclarationByRole(String role) {
      LinkDeclaration linkDeclaration = myLinkByRole.get(role);
      if (linkDeclaration != null) {
        LinkDeclaration mostSpecificLinkDeclaration = myMostSpecificLinkBySpecializedLink.get(linkDeclaration);
        if (mostSpecificLinkDeclaration != null) {
          return mostSpecificLinkDeclaration;
        }
        return linkDeclaration;
      }
      return null;
    }

    public List<LinkDeclaration> getLinkDeclarationsExcludingOverridden() {
      return new ArrayList<LinkDeclaration>(myMostSpecificLinks);
    }

    protected void init() {
      List<LinkDeclaration> allLinks = new ArrayList<LinkDeclaration>();
      myLinkByRole = new HashMap<String, LinkDeclaration>();
      List<AbstractConceptDeclaration> concepts = ((ConceptAndSuperConceptsCache) getOwnerCache()).getConcepts();
      for (AbstractConceptDeclaration concept : concepts) {
        List<LinkDeclaration> list = concept.getLinkDeclarations();
        allLinks.addAll(list);
        for (LinkDeclaration link : list) {
          String role1 = link.getRole();
          if (role1 == null) {
            continue;
          }
          if (myLinkByRole.containsKey(role1)) {
            continue;
          }
          myLinkByRole.put(role1, link);
        }
      }
      Map<LinkDeclaration, LinkDeclaration> specializedLinks = new HashMap<LinkDeclaration, LinkDeclaration>();
      for (LinkDeclaration link : allLinks) {
        LinkDeclaration specializedLink = link.getSpecializedLink();
        if (specializedLink != null) {
          specializedLinks.put(specializedLink, link);
        }
      }
      myMostSpecificLinkBySpecializedLink = new HashMap<LinkDeclaration, LinkDeclaration>();
      myMostSpecificLinks = new ArrayList<LinkDeclaration>(5);
      for (LinkDeclaration link : allLinks) {
        LinkDeclaration moreSpecificLink = specializedLinks.get(link);
        if (moreSpecificLink == null) {
          myMostSpecificLinks.add(link);
        } else {
          while (moreSpecificLink != null) {
            myMostSpecificLinkBySpecializedLink.put(link, moreSpecificLink);
            moreSpecificLink = specializedLinks.get(moreSpecificLink);
          }
        }
      }
      myDependsOnNodes = new HashSet<SNode>();
      for (AbstractConceptDeclaration concept : concepts) {
        myDependsOnNodes.add(concept.getNode());
      }
      for (LinkDeclaration link : allLinks) {
        myDependsOnNodes.add(link.getNode());
      }
    }

    public void childAdded(SModelChildEvent event) {
      if (event.getParent().getAdapter() instanceof AbstractConceptDeclaration) {
        String role = event.getChildRole();
        if (AbstractConceptDeclaration.LINK_DECLARATION.equals(role)) {
          super.childAdded(event);
        }
      }
    }

    public void childRemoved(SModelChildEvent event) {
      if (event.getParent().getAdapter() instanceof AbstractConceptDeclaration) {
        String role = event.getChildRole();
        if (AbstractConceptDeclaration.LINK_DECLARATION.equals(role)) {
          super.childRemoved(event);
        }
      }
    }

    public void propertyChanged(SModelPropertyEvent event) {
      if (LinkDeclaration.ROLE.equals(event.getPropertyName()) && event.getNode().getAdapter() instanceof LinkDeclaration) {
        String oldRole = event.getOldPropertyValue();
        if (oldRole != null) {
          myLinkByRole.remove(oldRole);
        }
        String newRole = event.getNewPropertyValue();
        if (!((newRole == null || myLinkByRole.containsKey(newRole)))) {
          myLinkByRole.put(newRole, (LinkDeclaration) event.getNode().getAdapter());
        }
      }
    }
  }

  private static class ConceptPropertiesDataSet extends DataSet {
    public static final String ID = "CONCEPT_PROPERTIES_DATASET";

    private Map<String, ConceptProperty> myPropertyByName;
    private Set<SNode> myDependsOnNodes;

    public ConceptPropertiesDataSet(AbstractCache ownerCache) {
      super(ID, ownerCache, DataSet.DefaultNodeChangedProcessing.DROP_DATA_SET);
    }

    public Set<SNode> getDependsOnNodes() {
      return myDependsOnNodes;
    }

    public ConceptProperty getConceptPropertyByName(String name) {
      return myPropertyByName.get(name);
    }

    protected void init() {
      List<ConceptProperty> allConceptProperties = new ArrayList<ConceptProperty>();
      Set<ConceptPropertyDeclaration> allConceptPropertyDeclarations = new HashSet<ConceptPropertyDeclaration>();
      myPropertyByName = new HashMap<String, ConceptProperty>();
      List<AbstractConceptDeclaration> concepts = ((ConceptAndSuperConceptsCache) getOwnerCache()).getConcepts();
      for (AbstractConceptDeclaration concept : concepts) {
        List<ConceptProperty> conceptProperties = concept.getConceptProperties();
        for (ConceptProperty conceptProperty : conceptProperties) {
          allConceptProperties.add(conceptProperty);
          ConceptPropertyDeclaration conceptPropertyDeclaration = conceptProperty.getConceptPropertyDeclaration();
          if (conceptPropertyDeclaration == null) {
            continue;
          }
          allConceptPropertyDeclarations.add(conceptPropertyDeclaration);
          String propertyName = conceptPropertyDeclaration.getName();
          if (propertyName == null || propertyName.length() == 0) {
            continue;
          }
          if (conceptPropertyDeclaration.getInheritable() || concept == concepts.get(0)) {
            if (!(myPropertyByName.containsKey(propertyName))) {
              myPropertyByName.put(propertyName, conceptProperty);
            }
          }
        }
      }
      myDependsOnNodes = new HashSet<SNode>();
      for (AbstractConceptDeclaration concept : concepts) {
        myDependsOnNodes.add(concept.getNode());
      }
      for (ConceptProperty prop : allConceptProperties) {
        myDependsOnNodes.add(prop.getNode());
      }
      for (ConceptPropertyDeclaration propDecl : allConceptPropertyDeclarations) {
        myDependsOnNodes.add(propDecl.getNode());
      }
    }

    public void childAdded(SModelChildEvent event) {
      if (event.getParent().getAdapter() instanceof AbstractConceptDeclaration) {
        String role = event.getChildRole();
        if (AbstractConceptDeclaration.CONCEPT_PROPERTY.equals(role)) {
          super.childAdded(event);
        }
      }
    }

    public void childRemoved(SModelChildEvent event) {
      if (event.getParent().getAdapter() instanceof AbstractConceptDeclaration) {
        String role = event.getChildRole();
        if (AbstractConceptDeclaration.CONCEPT_PROPERTY.equals(role)) {
          super.childRemoved(event);
        }
      }
    }

    public void propertyChanged(SModelPropertyEvent event) {
      if (event.getNode().getAdapter() instanceof ConceptPropertyDeclaration) {
        super.propertyChanged(event);
      }
    }

    public void referenceAdded(SModelReferenceEvent event) {
      if (event.getReference().getSourceNode().getAdapter() instanceof ConceptProperty) {
        super.referenceRemoved(event);
      }
    }

    public void referenceRemoved(SModelReferenceEvent event) {
      if (event.getReference().getSourceNode().getAdapter() instanceof ConceptProperty) {
        super.referenceRemoved(event);
      }
    }
  }
}
