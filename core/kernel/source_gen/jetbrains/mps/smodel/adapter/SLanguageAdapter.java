package jetbrains.mps.smodel.adapter;

/*Generated by MPS */

import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.project.ModuleId;
import jetbrains.mps.project.structure.modules.ModuleReference;
import jetbrains.mps.smodel.IdUtil;
import jetbrains.mps.smodel.Language;
import jetbrains.mps.smodel.LanguageAspect;
import jetbrains.mps.smodel.MPSModuleRepository;
import jetbrains.mps.smodel.ModuleRepositoryFacade;
import jetbrains.mps.smodel.language.LanguageRegistry;
import jetbrains.mps.smodel.language.LanguageRuntime;
import jetbrains.mps.util.NameUtil;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.mps.openapi.language.SAbstractConcept;
import org.jetbrains.mps.openapi.language.SConcept;
import org.jetbrains.mps.openapi.language.SConceptRepository;
import org.jetbrains.mps.openapi.language.SEnumeration;
import org.jetbrains.mps.openapi.language.SLanguage;
import org.jetbrains.mps.openapi.language.SLanguageId;
import org.jetbrains.mps.openapi.model.SNode;
import org.jetbrains.mps.openapi.module.SModuleReference;
import org.jetbrains.mps.openapi.persistence.PersistenceFacade;

import java.util.ArrayList;
import java.util.Collections;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

public class SLanguageAdapter implements SLanguage {
  private String myLanguageFqName;
  private SLanguageId myLanguage;

  public SLanguageAdapter(@NotNull SLanguageId language) {
    this.myLanguage = language;
  }

  @Deprecated
  public SLanguageAdapter(@NotNull String language) {
    this.myLanguageFqName = language;
    Language module = ModuleRepositoryFacade.getInstance().getModule(language, Language.class);
    if (module!=null){
      myLanguage = IdUtil.getLanguageId(module);
    }
  }

  @Override
  public String getQualifiedName() {
    return myLanguageFqName != null ? myLanguageFqName : MPSModuleRepository.getInstance().getDebugRegistry().getLanguageName(myLanguage);
  }

  @Override
  public Iterable<SAbstractConcept> getConcepts() {
    LanguageRuntime runtime = LanguageRegistry.getInstance().getLanguage(myLanguage);
    if (runtime == null) {
      return Collections.emptySet();
    }

    // TODO rewrite using LanguageRuntime 
    Iterable<SNode> roots = (Iterable<SNode>) LanguageAspect.STRUCTURE.get(getSourceModule()).getRootNodes();
    List<SAbstractConcept> c = ListSequence.fromList(new ArrayList<SAbstractConcept>());
    ListSequence.fromList(c).addSequence(Sequence.fromIterable(roots).where(new IWhereFilter<SNode>() {
      public boolean accept(SNode it) {
        return SNodeOperations.isInstanceOf(it, "jetbrains.mps.lang.structure.structure.ConceptDeclaration");
      }
    }).select(new ISelector<SNode, SConcept>() {
      public SConcept select(SNode it) {
        return ((SConcept) SConceptRepository.getInstance().getConcept(NameUtil.nodeFQName(it)));
      }
    }));
    ListSequence.fromList(c).addSequence(Sequence.fromIterable(roots).where(new IWhereFilter<SNode>() {
      public boolean accept(SNode it) {
        return SNodeOperations.isInstanceOf(it, "jetbrains.mps.lang.structure.structure.InterfaceConceptDeclaration");
      }
    }).select(new ISelector<SNode, SInterfaceConceptAdapter>() {
      public SInterfaceConceptAdapter select(SNode it) {
        if (myLanguage != null) {
          return new SInterfaceConceptAdapter(IdUtil.getConceptId(it));
        } else {
          return new SInterfaceConceptAdapter(NameUtil.nodeFQName(it));
        }
      }
    }));
    return c;
  }

  public Iterable<SEnumeration> getEnumerations() {
    // TODO rewrite using LanguageRuntime 
    Iterable<SNode> roots = (Iterable<SNode>) LanguageAspect.STRUCTURE.get(getSourceModule()).getRootNodes();
    List<SEnumeration> c = ListSequence.fromList(new ArrayList<SEnumeration>());
    ListSequence.fromList(c).addSequence(Sequence.fromIterable(roots).where(new IWhereFilter<SNode>() {
      public boolean accept(SNode it) {
        return SNodeOperations.isInstanceOf(it, "jetbrains.mps.lang.structure.structure.EnumerationDataTypeDeclaration");
      }
    }).select(new ISelector<SNode, SEnumeration>() {
      public SEnumeration select(SNode it) {
        return SConceptRepository.getInstance().getEnumeration(NameUtil.nodeFQName(it));
      }
    }));
    return c;

  }

  @Override
  public Iterable<SModuleReference> getLanguageRuntimes() {
    Set<SModuleReference> runtimes = new HashSet<SModuleReference>();
    Language sourceModule = getSourceModule();
    assert sourceModule != null;
    for (Language language : SetSequence.fromSet(sourceModule.getAllExtendedLanguages())) {
      runtimes.addAll(language.getRuntimeModulesReferences());
    }
    return runtimes;
  }

  @Override
  public Language getSourceModule() {
    if (myLanguage != null) {
      return (Language) ModuleRepositoryFacade.getInstance().getModule(new ModuleReference("", ModuleId.regular(myLanguage.getId())));
    } else {
      return (Language) ModuleRepositoryFacade.getInstance().getModule(PersistenceFacade.getInstance().createModuleReference(myLanguageFqName));
    }
  }

  @Override
  public int hashCode() {
    if (myLanguage == null) {
      return myLanguageFqName.hashCode();
    } else {
      return myLanguage.hashCode();
    }
  }

  @Override
  public boolean equals(Object object) {
    if (!(object instanceof SLanguageAdapter)) return false;

    if (myLanguage == null) {
      return myLanguageFqName.equals(((SLanguageAdapter) object).myLanguageFqName);
    } else {
      return myLanguage.equals(((SLanguageAdapter) object).myLanguage);
    }
  }
}
