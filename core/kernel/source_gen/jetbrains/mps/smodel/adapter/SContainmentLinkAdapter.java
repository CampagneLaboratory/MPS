package jetbrains.mps.smodel.adapter;

/*Generated by MPS */

import jetbrains.mps.kernel.model.SModelUtil;
import jetbrains.mps.smodel.SNodeId.Regular;
import jetbrains.mps.smodel.search.ConceptAndSuperConceptsScope;
import org.jetbrains.mps.openapi.language.SAbstractLinkId;
import org.jetbrains.mps.openapi.language.SConceptId;
import org.jetbrains.mps.openapi.language.SContainmentLink;
import jetbrains.mps.smodel.runtime.ConceptDescriptor;
import jetbrains.mps.smodel.language.ConceptRegistry;
import org.jetbrains.mps.openapi.language.SContainmentLinkId;
import org.jetbrains.mps.openapi.model.SModel;
import org.jetbrains.mps.openapi.model.SNode;

public class SContainmentLinkAdapter extends SAbstractLinkAdapter implements SContainmentLink {
  protected SContainmentLinkId myRoleId;

  @Deprecated
  public SContainmentLinkAdapter(String conceptName, String role) {
    super(conceptName, role);
  }


  public SContainmentLinkAdapter(SContainmentLinkId roleId) {
    super(null, null);
    myRoleId = roleId;
  }


  @Override
  public SAbstractLinkId getRoleId() {
    fillBothIds();
    return myRoleId;
  }

  @Override
  public boolean isReference() {
    return false;
  }


  @Override
  public boolean isMultiple() {
    fillBothIds();
    ConceptDescriptor d = ConceptRegistry.getInstance().getConceptDescriptor(conceptName);
    return d.isMultipleChild(role);
  }


  public boolean isUnordered() {
    fillBothIds();
    ConceptDescriptor d = ConceptRegistry.getInstance().getConceptDescriptor(conceptName);
    return d.isUnorderedChild(role);
  }

  @Override
  public SNode getLinkNode() {
    fillBothIds();
    SConceptAdapter adapter = new SConceptAdapter(getRoleId().getConceptId());
    SModel model = adapter.getConceptDeclarationNode().getModel();
    return model.getNode(new Regular(myRoleId.getContainmentLinkId()));
  }

  public void fillBothIds() {
    if (myRoleId != null && role != null) return;
    if (myRoleId == null) {
      SNode concept = SModelUtil.findConceptDeclaration(conceptName);
      SConceptId cid = IdHelper.getConceptId((jetbrains.mps.smodel.SNode) concept);
      final ConceptAndSuperConceptsScope scope = new ConceptAndSuperConceptsScope(concept);
      SNode linkNode = scope.getLinkDeclarationByRole(role);
      myRoleId = new SContainmentLinkId(cid, IdHelper.getNodeId((jetbrains.mps.smodel.SNode) linkNode));
    } else {
      //there might be an interface declaring this link, but this code still works well
      SConceptAdapter adapter = new SConceptAdapter(myRoleId.getConceptId());
      conceptName = adapter.getQualifiedName();
      SModel model = adapter.getConceptDeclarationNode().getModel();
      role = model.getNode(new Regular(myRoleId.getContainmentLinkId())).getProperty("role");
    }
  }

  @Override
  public boolean equals(Object o) {
    if (this == o) return true;
    if (o == null || getClass() != o.getClass()) return false;

    SContainmentLinkAdapter that = (SContainmentLinkAdapter) o;

    if (myRoleId != null) {
      return myRoleId.equals(that.myRoleId);
    } else {
      String my = "" + conceptName + "#" + role;
      String theirs = "" + that.conceptName + "#" + that.role;
      return my.equals(theirs);
    }
  }

  @Override
  public int hashCode() {
    if (myRoleId != null) {
      return myRoleId.hashCode();
    } else {
      return ("" + conceptName + "#" + role).hashCode();
    }
  }
}
