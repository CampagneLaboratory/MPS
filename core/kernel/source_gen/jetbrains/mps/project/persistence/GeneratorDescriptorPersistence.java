package jetbrains.mps.project.persistence;

/*Generated by MPS */

import jetbrains.mps.project.structure.modules.GeneratorDescriptor;
import org.jdom.Element;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.util.MacroHelper;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.util.xml.XmlUtil;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.project.structure.modules.ModuleReference;
import jetbrains.mps.project.structure.modules.mappingpriorities.MappingPriorityRule;
import jetbrains.mps.project.structure.modules.mappingpriorities.RuleType;
import jetbrains.mps.project.structure.modules.mappingpriorities.MappingConfig_AbstractRef;
import org.jetbrains.mps.openapi.module.SModuleReference;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.project.structure.modules.mappingpriorities.MappingConfig_RefAllLocal;
import jetbrains.mps.project.structure.modules.mappingpriorities.MappingConfig_RefAllGlobal;
import jetbrains.mps.project.structure.modules.mappingpriorities.MappingConfig_SimpleRef;
import jetbrains.mps.project.structure.modules.mappingpriorities.MappingConfig_ExternalRef;
import jetbrains.mps.project.structure.modules.mappingpriorities.MappingConfig_RefSet;
import jetbrains.mps.logging.Logger;

public class GeneratorDescriptorPersistence {
  private GeneratorDescriptorPersistence() {
  }

  public static GeneratorDescriptor loadGeneratorDescriptor(final Element generatorElement, IFile file, final String contentRoot, final MacroHelper macroHelper) {
    GeneratorDescriptor descriptor = new _FunctionTypes._return_P0_E0<GeneratorDescriptor>() {
      public GeneratorDescriptor invoke() {
        final GeneratorDescriptor result_wk2vdq_a0a0a0b = new GeneratorDescriptor();
        String genUID = generatorElement.getAttributeValue("generatorUID");
        final String result_wk2vdq_a1a0a0a0b = genUID;
        result_wk2vdq_a0a0a0b.setGeneratorUID(result_wk2vdq_a1a0a0a0b);
        final boolean result_wk2vdq_a2a0a0a0b = XmlUtil.booleanWithDefault(generatorElement, "generate-templates", false);
        result_wk2vdq_a0a0a0b.setGenerateTemplates(result_wk2vdq_a2a0a0a0b);

        String uuid = generatorElement.getAttributeValue("uuid");
        if (uuid != null) {
          final String result_wk2vdq_a0a5a0a0a0b = uuid;
          result_wk2vdq_a0a0a0b.setUUID(result_wk2vdq_a0a5a0a0a0b);
        }

        String generatorName = generatorElement.getAttributeValue("name");
        if (generatorName != null) {
          final String result_wk2vdq_a0a8a0a0a0b = generatorName;
          result_wk2vdq_a0a0a0b.setNamespace(result_wk2vdq_a0a8a0a0a0b);
        }

        Element models = XmlUtil.first(generatorElement, "models");
        if (models != null) {
          result_wk2vdq_a0a0a0b.getModelRootDescriptors().addAll(ModuleDescriptorPersistence.loadModelRoots(XmlUtil.children(models, "modelRoot"), contentRoot, macroHelper));
        } else {
          // old - for backwards compatibility 
          result_wk2vdq_a0a0a0b.getModelRootDescriptors().addAll(ModuleDescriptorPersistence.loadModelRoots(XmlUtil.children(generatorElement, "modelRoot"), contentRoot, macroHelper));
        }

        Element facets = XmlUtil.first(generatorElement, "facets");
        if (facets != null) {
          result_wk2vdq_a0a0a0b.getModuleFacetDescriptors().addAll(ModuleDescriptorPersistence.loadFacets(XmlUtil.children(facets, "facet"), macroHelper));
        }

        ModuleDescriptorPersistence.loadDependencies(result_wk2vdq_a0a0a0b, generatorElement);

        // "depends on" generators 
        for (Element refGenerator : Sequence.fromIterable(XmlUtil.children(XmlUtil.first(generatorElement, "external-templates"), "generator"))) {
          result_wk2vdq_a0a0a0b.getDepGenerators().add(ModuleReference.fromString(refGenerator.getAttributeValue("generatorUID")));
        }

        for (Element ruleElement : Sequence.fromIterable(XmlUtil.children(XmlUtil.first(generatorElement, "mapping-priorities"), "mapping-priority-rule"))) {
          final MappingPriorityRule result_wk2vdq_a0a12a0a0a0b = new MappingPriorityRule();
          // TODO: remove when the error disappear. 
          try {
            final RuleType result_wk2vdq_a0a1a0a12a0a0a0b = RuleType.parse(ruleElement.getAttributeValue("kind"));
            result_wk2vdq_a0a12a0a0a0b.setType(result_wk2vdq_a0a1a0a12a0a0a0b);
          } catch (IllegalArgumentException e) {
            LOG.error(e.getMessage() + " Rule type for generator " + genUID + " is set to EQUALS. You can change this in Generator Properties dialog.", e);
            final RuleType result_wk2vdq_a1a0b0a0v0a0a0a1 = RuleType.STRICTLY_TOGETHER;
            result_wk2vdq_a0a12a0a0a0b.setType(result_wk2vdq_a1a0b0a0v0a0a0a1);
          }

          Element greaterPM = XmlUtil.first(ruleElement, "greater-priority-mapping");
          if (greaterPM != null) {
            final MappingConfig_AbstractRef result_wk2vdq_a0a4a0a12a0a0a0b = loadGeneratorMappingConfigRef(greaterPM, genUID, false);
            result_wk2vdq_a0a12a0a0a0b.setLeft(result_wk2vdq_a0a4a0a12a0a0a0b);
          }
          Element lesserPM = XmlUtil.first(ruleElement, "lesser-priority-mapping");
          if (lesserPM != null) {
            final MappingConfig_AbstractRef result_wk2vdq_a0a6a0a12a0a0a0b = loadGeneratorMappingConfigRef(lesserPM, genUID, false);
            result_wk2vdq_a0a12a0a0a0b.setRight(result_wk2vdq_a0a6a0a12a0a0a0b);
          }
          result_wk2vdq_a0a0a0b.getPriorityRules().add(result_wk2vdq_a0a12a0a0a0b);
        }
        return result_wk2vdq_a0a0a0b;
      }
    }.invoke();
    ModuleDescriptorPersistence.setTimestamp(descriptor, file);
    return descriptor;
  }

  public static void saveGeneratorDescriptor(Element languageGeneratorsElement, GeneratorDescriptor descriptor, MacroHelper macroHelper) {
    Element generator = new Element("generator");
    if (descriptor.getNamespace() != null) {
      generator.setAttribute("name", descriptor.getNamespace());
    }
    if (descriptor.getGeneratorUID() != null) {
      generator.setAttribute("generatorUID", descriptor.getGeneratorUID());
    }
    if (descriptor.getUUID() != null) {
      generator.setAttribute("uuid", descriptor.getUUID());
    }
    if (descriptor.isGenerateTemplates()) {
      generator.setAttribute("generate-templates", Boolean.toString(descriptor.isGenerateTemplates()));
    }

    Element models = new Element("models");
    ModuleDescriptorPersistence.saveModelRoots(models, descriptor.getModelRootDescriptors(), macroHelper);
    generator.addContent(models);

    if (!(descriptor.getModuleFacetDescriptors().isEmpty())) {
      Element facets = new Element("facets");
      ModuleDescriptorPersistence.saveFacets(facets, descriptor.getModuleFacetDescriptors(), macroHelper);
      generator.addContent(facets);
    }

    // "depends on" generators 
    Element extTemplates = new Element("external-templates");
    for (SModuleReference generatorReference : SetSequence.fromSet(descriptor.getDepGenerators())) {
      XmlUtil.tagWithAttribute(extTemplates, "generator", "generatorUID", generatorReference.toString());
    }
    generator.addContent(extTemplates);

    ModuleDescriptorPersistence.saveDependencies(generator, descriptor);

    // mapping priority rules 
    Element mapPrio = new Element("mapping-priorities");
    for (MappingPriorityRule rule : ListSequence.fromList(descriptor.getPriorityRules())) {
      Element ruleElement = new Element("mapping-priority-rule");
      ruleElement.setAttribute("kind", rule.getType().getName());

      Element gpm = new Element("greater-priority-mapping");
      saveGeneratorMappingConfigRef(rule.getLeft(), gpm);
      ruleElement.addContent(gpm);

      Element lpm = new Element("lesser-priority-mapping");
      saveGeneratorMappingConfigRef(rule.getRight(), lpm);
      ruleElement.addContent(lpm);

      mapPrio.addContent(ruleElement);
    }
    generator.addContent(mapPrio);

    languageGeneratorsElement.addContent(generator);
  }

  private static void saveGeneratorMappingConfigRef(MappingConfig_AbstractRef mappingRef, Element parentElement) {
    if (mappingRef instanceof MappingConfig_RefAllLocal) {
      parentElement.addContent(new Element("all-local-mappings"));

    } else if (mappingRef instanceof MappingConfig_RefAllGlobal) {
      parentElement.addContent(new Element("all-mappings"));

    } else if (mappingRef instanceof MappingConfig_SimpleRef) {
      XmlUtil.tagWithAttributes(parentElement, "mapping-node", "modelUID", ((MappingConfig_SimpleRef) mappingRef).getModelUID(), "nodeID", ((MappingConfig_SimpleRef) mappingRef).getNodeID());
    } else if (mappingRef instanceof MappingConfig_ExternalRef) {
      XmlUtil.tagWithAttribute(parentElement, "generator", "generatorUID", ((MappingConfig_ExternalRef) mappingRef).getGenerator().toString());
      Element extMapping = new Element("external-mapping");
      saveGeneratorMappingConfigRef(((MappingConfig_ExternalRef) mappingRef).getMappingConfig(), extMapping);
      parentElement.addContent(extMapping);
    } else if (mappingRef instanceof MappingConfig_RefSet) {
      Element mappingSet = new Element("mapping-set");
      for (MappingConfig_AbstractRef mappingRefInner : ListSequence.fromList(((MappingConfig_RefSet) mappingRef).getMappingConfigs())) {
        Element mappingSetElement = new Element("mapping-set-element");
        saveGeneratorMappingConfigRef(mappingRefInner, mappingSetElement);
        mappingSet.addContent(mappingSetElement);
      }
      parentElement.addContent(mappingSet);
    }
  }

  public static MappingConfig_AbstractRef loadGeneratorMappingConfigRef(final Element parentElement, final String genUID, boolean childOfGen) {
    if (Sequence.fromIterable(XmlUtil.children(parentElement, "all-mappings")).isNotEmpty()) {
      return new MappingConfig_RefAllGlobal();
    } else if (Sequence.fromIterable(XmlUtil.children(parentElement, "all-local-mappings")).isNotEmpty()) {
      final MappingConfig_RefAllLocal local = new MappingConfig_RefAllLocal();
      if (childOfGen) {
        return local;
      }

      return new _FunctionTypes._return_P0_E0<MappingConfig_ExternalRef>() {
        public MappingConfig_ExternalRef invoke() {
          final MappingConfig_ExternalRef result_wk2vdq_a0a3a0a0e = new MappingConfig_ExternalRef();
          final SModuleReference result_wk2vdq_a0a0a3a0a0e = ModuleReference.fromString(genUID);
          result_wk2vdq_a0a3a0a0e.setGenerator(result_wk2vdq_a0a0a3a0a0e);
          final MappingConfig_AbstractRef result_wk2vdq_a1a0a3a0a0e = local;
          result_wk2vdq_a0a3a0a0e.setMappingConfig(result_wk2vdq_a1a0a3a0a0e);
          return result_wk2vdq_a0a3a0a0e;
        }
      }.invoke();
    } else if (XmlUtil.first(parentElement, "mapping-set") != null) {
      final MappingConfig_RefSet mappingSet = new MappingConfig_RefSet();
      for (Element mappingSetElement : Sequence.fromIterable(XmlUtil.children(XmlUtil.first(parentElement, "mapping-set"), "mapping-set-element"))) {
        mappingSet.getMappingConfigs().add(loadGeneratorMappingConfigRef(mappingSetElement, genUID, true));
      }

      if (childOfGen) {
        return mappingSet;
      }

      return new _FunctionTypes._return_P0_E0<MappingConfig_ExternalRef>() {
        public MappingConfig_ExternalRef invoke() {
          final MappingConfig_ExternalRef result_wk2vdq_a0a5a1a0e = new MappingConfig_ExternalRef();
          final SModuleReference result_wk2vdq_a0a0a5a1a0e = ModuleReference.fromString(genUID);
          result_wk2vdq_a0a5a1a0e.setGenerator(result_wk2vdq_a0a0a5a1a0e);
          final MappingConfig_AbstractRef result_wk2vdq_a1a0a5a1a0e = mappingSet;
          result_wk2vdq_a0a5a1a0e.setMappingConfig(result_wk2vdq_a1a0a5a1a0e);
          return result_wk2vdq_a0a5a1a0e;
        }
      }.invoke();
    } else if (XmlUtil.first(parentElement, "generator") != null) {
      // external reference 
      final Element generator = XmlUtil.first(parentElement, "generator");
      return new _FunctionTypes._return_P0_E0<MappingConfig_ExternalRef>() {
        public MappingConfig_ExternalRef invoke() {
          final MappingConfig_ExternalRef result_wk2vdq_a0a2a2a0e = new MappingConfig_ExternalRef();
          final SModuleReference result_wk2vdq_a0a0a2a2a0e = ModuleReference.fromString(generator.getAttributeValue("generatorUID"));
          result_wk2vdq_a0a2a2a0e.setGenerator(result_wk2vdq_a0a0a2a2a0e);
          final MappingConfig_AbstractRef result_wk2vdq_a1a0a2a2a0e = loadGeneratorMappingConfigRef(XmlUtil.first(parentElement, "external-mapping"), generator.getAttributeValue("generatorUID"), true);
          result_wk2vdq_a0a2a2a0e.setMappingConfig(result_wk2vdq_a1a0a2a2a0e);
          return result_wk2vdq_a0a2a2a0e;
        }
      }.invoke();
    } else if (XmlUtil.first(parentElement, "mapping-node") != null) {
      // simple reference 
      Element mappingNode = XmlUtil.first(parentElement, "mapping-node");
      final MappingConfig_SimpleRef mapping_SimpleRef = new MappingConfig_SimpleRef();
      MappingConfig_SimpleRef result_wk2vdq_a3a3a0e = mapping_SimpleRef;
      final String result_wk2vdq_a0a3a3a0e = mappingNode.getAttributeValue("modelUID");
      result_wk2vdq_a3a3a0e.setModelUID(result_wk2vdq_a0a3a3a0e);
      final String result_wk2vdq_a1a3a3a0e = mappingNode.getAttributeValue("nodeID");
      result_wk2vdq_a3a3a0e.setNodeID(result_wk2vdq_a1a3a3a0e);

      if (childOfGen) {
        return mapping_SimpleRef;
      }

      return new _FunctionTypes._return_P0_E0<MappingConfig_ExternalRef>() {
        public MappingConfig_ExternalRef invoke() {
          final MappingConfig_ExternalRef result_wk2vdq_a0a7a3a0e = new MappingConfig_ExternalRef();
          final SModuleReference result_wk2vdq_a0a0a7a3a0e = ModuleReference.fromString(genUID);
          result_wk2vdq_a0a7a3a0e.setGenerator(result_wk2vdq_a0a0a7a3a0e);
          final MappingConfig_AbstractRef result_wk2vdq_a1a0a7a3a0e = mapping_SimpleRef;
          result_wk2vdq_a0a7a3a0e.setMappingConfig(result_wk2vdq_a1a0a7a3a0e);
          return result_wk2vdq_a0a7a3a0e;
        }
      }.invoke();
    }

    // empty? 
    return new MappingConfig_AbstractRef();
  }

  private static Logger LOG = Logger.getLogger(GeneratorDescriptorPersistence.class);
}
