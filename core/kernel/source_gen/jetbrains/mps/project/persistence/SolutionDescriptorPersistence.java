package jetbrains.mps.project.persistence;

/*Generated by MPS */

import jetbrains.mps.logging.Logger;
import jetbrains.mps.project.structure.modules.SolutionDescriptor;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.util.MacroHelper;
import org.jdom.Document;
import jetbrains.mps.util.JDOMUtil;
import org.jdom.Element;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.project.structure.modules.SolutionKind;
import jetbrains.mps.util.xml.XmlUtil;
import java.util.List;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.internal.collections.runtime.CollectionSequence;
import java.io.OutputStream;

public class SolutionDescriptorPersistence {
  private static final String SOURCE_PATH = "sourcePath";
  private static final String SOURCE_PATH_SOURCE = "source";
  private static final String COMPILE_IN_MPS = "compileInMPS";
  private static Logger LOG = Logger.getLogger(SolutionDescriptorPersistence.class);

  private SolutionDescriptorPersistence() {
  }

  public static SolutionDescriptor loadSolutionDescriptor(IFile file, final MacroHelper macroHelper) {
    SolutionDescriptor descriptor;
    try {
      Document document = JDOMUtil.loadDocument(file);
      final Element rootElement = document.getRootElement();

      assert rootElement != null;

      descriptor = new _FunctionTypes._return_P0_E0<SolutionDescriptor>() {
        public SolutionDescriptor invoke() {
          final SolutionDescriptor result_8ckma3_a0a0f0b0a = new SolutionDescriptor();
          final String result_8ckma3_a0a0a0f0b0a = rootElement.getAttributeValue("name");
          result_8ckma3_a0a0f0b0a.setNamespace(result_8ckma3_a0a0a0f0b0a);

          if (rootElement.getAttributeValue("uuid") != null) {
            final String result_8ckma3_a0a2a0a0f0b0a = rootElement.getAttributeValue("uuid");
            result_8ckma3_a0a0f0b0a.setUUID(result_8ckma3_a0a2a0a0f0b0a);
          }

          String pluginKind = rootElement.getAttributeValue("pluginKind");
          if (pluginKind != null && pluginKind.length() > 0) {
            final SolutionKind result_8ckma3_a0a5a0a0f0b0a = SolutionKind.valueOf(pluginKind);
            result_8ckma3_a0a0f0b0a.setKind(result_8ckma3_a0a5a0a0f0b0a);
          }

          final boolean result_8ckma3_a7a0a0f0b0a = XmlUtil.booleanWithDefault(rootElement, COMPILE_IN_MPS, false);
          result_8ckma3_a0a0f0b0a.setCompileInMPS(result_8ckma3_a7a0a0f0b0a);

          String genOutput = rootElement.getAttributeValue("generatorOutputPath");
          if ((genOutput != null && genOutput.length() > 0)) {
            final String result_8ckma3_a0a01a0a0f0b0a = macroHelper.expandPath(genOutput);
            result_8ckma3_a0a0f0b0a.setOutputPath(result_8ckma3_a0a01a0a0f0b0a);
          }

          result_8ckma3_a0a0f0b0a.getModelRootDescriptors().addAll(ModuleDescriptorPersistence.loadModelRoots(XmlUtil.children(XmlUtil.first(rootElement, "models"), "modelRoot"), macroHelper));

          Element stubModelEntries = XmlUtil.first(rootElement, "stubModelEntries");
          if (stubModelEntries != null) {
            List<String> roots = ModuleDescriptorPersistence.loadStubModelEntries(stubModelEntries, macroHelper);
            result_8ckma3_a0a0f0b0a.getAdditionalJavaStubPaths().addAll(roots);
          }

          ModuleDescriptorPersistence.loadDependencies(result_8ckma3_a0a0f0b0a, rootElement);
          for (Element entryElement : Sequence.fromIterable(XmlUtil.children(XmlUtil.first(rootElement, "classPath"), "entry")).concat(Sequence.fromIterable(XmlUtil.children(XmlUtil.first(rootElement, "runtimeClassPath"), "entry")))) {
            // runtime classpath left for compatibility 
            result_8ckma3_a0a0f0b0a.getAdditionalJavaStubPaths().add(macroHelper.expandPath(entryElement.getAttributeValue("path")));
          }

          for (Element entryElement : Sequence.fromIterable(XmlUtil.children(XmlUtil.first(rootElement, SOURCE_PATH), SOURCE_PATH_SOURCE))) {
            result_8ckma3_a0a0f0b0a.getSourcePaths().add(macroHelper.expandPath(entryElement.getAttributeValue("path")));
          }
          return result_8ckma3_a0a0f0b0a;
        }
      }.invoke();
    } catch (Exception e) {
      throw new ModuleReadException(e);
    }
    ModuleDescriptorPersistence.setTimestamp(descriptor, file);
    return descriptor;
  }

  public static void saveSolutionDescriptor(IFile file, SolutionDescriptor descriptor, MacroHelper macroHelper) {
    if (file.isReadOnly()) {
      LOG.error("Can't save " + file.getPath());
      return;
    }

    Element result = new Element("solution");
    if (descriptor.getNamespace() != null) {
      result.setAttribute("name", descriptor.getNamespace());
    }
    if (descriptor.getUUID() != null) {
      result.setAttribute("uuid", descriptor.getUUID());
    }
    if (descriptor.getKind() != SolutionKind.NONE) {
      result.setAttribute("pluginKind", descriptor.getKind().name());
    }
    result.setAttribute(COMPILE_IN_MPS, Boolean.toString(descriptor.getCompileInMPS()));
    if (descriptor.getOutputPath() != null) {
      result.setAttribute("generatorOutputPath", macroHelper.shrinkPath(descriptor.getOutputPath()));
    }

    Element models = new Element("models");
    ModuleDescriptorPersistence.saveModelRoots(models, descriptor.getModelRootDescriptors(), macroHelper);
    result.addContent(models);

    if (!(descriptor.getAdditionalJavaStubPaths().isEmpty())) {
      Element stubModelEntries = new Element("stubModelEntries");
      ModuleDescriptorPersistence.saveStubModelEntries(stubModelEntries, descriptor.getAdditionalJavaStubPaths(), macroHelper);
      result.addContent(stubModelEntries);
    }

    Element sourcePath = new Element(SOURCE_PATH);
    for (String p : CollectionSequence.fromCollection(descriptor.getSourcePaths())) {
      XmlUtil.tagWithAttribute(sourcePath, SOURCE_PATH_SOURCE, "path", macroHelper.shrinkPath(p));
    }
    result.addContent(sourcePath);

    ModuleDescriptorPersistence.saveDependencies(result, descriptor);

    try {
      OutputStream os = file.openOutputStream();
      JDOMUtil.writeDocument(new Document(result), os);
    } catch (Exception e) {
      LOG.error("", e);
    }

    ModuleDescriptorPersistence.setTimestamp(descriptor, file);
  }
}
