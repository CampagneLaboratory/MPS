package jetbrains.mps.project.persistence;

/*Generated by MPS */

import jetbrains.mps.project.structure.modules.ModuleDescriptor;
import org.jdom.Element;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.xmlQuery.runtime.AttributeUtils;
import jetbrains.mps.internal.collections.runtime.ISelector;
import jetbrains.mps.project.structure.modules.ModuleReference;
import jetbrains.mps.project.structure.modules.LanguageDescriptor;
import java.util.List;
import jetbrains.mps.project.structure.modules.Dependency;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.project.structure.model.ModelRoot;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.util.Macros;
import jetbrains.mps.project.structure.model.ModelRootManager;
import org.jdom.Document;
import jetbrains.mps.util.JDOMUtil;

public class ModuleDescriptorPersistence {
  private ModuleDescriptorPersistence() {
  }

  public static void loadDependencies(ModuleDescriptor descriptor, Element root) {
    descriptor.getDependencies().addAll(loadDependenciesList(ListSequence.fromList(AttributeUtils.elementChildren(root, "dependencies")).first()));

    descriptor.getUsedLanguages().addAll(ListSequence.fromList(AttributeUtils.elementChildren(ListSequence.fromList(AttributeUtils.elementChildren(root, "usedLanguages")).first(), "usedLanguage")).select(new ISelector<Element, ModuleReference>() {
      public ModuleReference select(Element ul) {
        return ModuleReference.fromString(ul.getText());
      }
    }).toListSequence());

    descriptor.getUsedDevkits().addAll(ListSequence.fromList(AttributeUtils.elementChildren(ListSequence.fromList(AttributeUtils.elementChildren(root, "usedDevKits")).first(), "usedDevKit")).select(new ISelector<Element, ModuleReference>() {
      public ModuleReference select(Element udk) {
        return ModuleReference.fromString(udk.getText());
      }
    }).toListSequence());

    if (descriptor instanceof LanguageDescriptor) {
      LanguageDescriptor ld = (LanguageDescriptor) descriptor;
      ld.getRuntimeModules().addAll(loadDependenciesList(ListSequence.fromList(AttributeUtils.elementChildren(root, "runtime")).first()));
    }
  }

  public static void saveDependencies(Element result, ModuleDescriptor descriptor) {
    Element result_dxyzb6_a0a1 = result;
    if (!(descriptor.getDependencies().isEmpty())) {
      final Element result_dxyzb6_a0a0a0a1 = new Element("dependencies");
      saveDependencyList(result_dxyzb6_a0a0a0a1, descriptor.getDependencies());
      result_dxyzb6_a0a1.addContent(result_dxyzb6_a0a0a0a1);
    }

    if (!(descriptor.getUsedLanguages().isEmpty())) {
      final Element result_dxyzb6_a0a2a0a1 = new Element("usedLanguages");
      for (ModuleReference langRef : ListSequence.fromList(descriptor.getUsedLanguages())) {
        final Element result_dxyzb6_a0a0a0a2a0a1 = new Element("usedLanguage");
        final String result_dxyzb6_a0a0a0a0a2a0a1 = langRef.toString();
        result_dxyzb6_a0a0a0a2a0a1.setText(result_dxyzb6_a0a0a0a0a2a0a1);
        result_dxyzb6_a0a2a0a1.addContent(result_dxyzb6_a0a0a0a2a0a1);
      }
      result_dxyzb6_a0a1.addContent(result_dxyzb6_a0a2a0a1);
    }

    if (!(descriptor.getUsedDevkits().isEmpty())) {
      final Element result_dxyzb6_a0a4a0a1 = new Element("usedDevKits");
      for (ModuleReference dkRef : ListSequence.fromList(descriptor.getUsedDevkits())) {
        final Element result_dxyzb6_a0a0a0a4a0a1 = new Element("usedDevKit");
        final String result_dxyzb6_a0a0a0a0a4a0a1 = dkRef.toString();
        result_dxyzb6_a0a0a0a4a0a1.setText(result_dxyzb6_a0a0a0a0a4a0a1);
        result_dxyzb6_a0a4a0a1.addContent(result_dxyzb6_a0a0a0a4a0a1);
      }
      result_dxyzb6_a0a1.addContent(result_dxyzb6_a0a4a0a1);
    }

    if (descriptor instanceof LanguageDescriptor) {
      LanguageDescriptor ld = (LanguageDescriptor) descriptor;
      if (!(ld.getRuntimeModules().isEmpty())) {
        final Element result_dxyzb6_a0a1a6a0a1 = new Element("runtime");
        saveDependencyList(result_dxyzb6_a0a1a6a0a1, ld.getRuntimeModules());
        result_dxyzb6_a0a1.addContent(result_dxyzb6_a0a1a6a0a1);
      }
    }
  }

  public static List<Dependency> loadDependenciesList(Element depElement) {
    return ListSequence.fromList(AttributeUtils.elementChildren(depElement, "dependency")).select(new ISelector<Element, Dependency>() {
      public Dependency select(final Element d) {
        return new _FunctionTypes._return_P0_E0<Dependency>() {
          public Dependency invoke() {
            final Dependency result_dxyzb6_a0a0a0a0a0a2 = new Dependency();
            final ModuleReference result_dxyzb6_a0a0a0a0a0a0a2 = ModuleReference.fromString(d.getText());
            result_dxyzb6_a0a0a0a0a0a2.setModuleRef(result_dxyzb6_a0a0a0a0a0a0a2);
            final boolean result_dxyzb6_a1a0a0a0a0a0a2 = AttributeUtils.booleanWithDefault(d.getAttributeValue("reexport"), true);
            result_dxyzb6_a0a0a0a0a0a2.setReexport(result_dxyzb6_a1a0a0a0a0a0a2);
            return result_dxyzb6_a0a0a0a0a0a2;
          }
        }.invoke();
      }
    }).toListSequence();
  }

  private static void saveDependencyList(Element depElement, List<Dependency> dependencies) {
    Element result_dxyzb6_a0a3 = depElement;
    for (Dependency md : ListSequence.fromList(dependencies)) {
      final Element result_dxyzb6_a0a0a0a3 = new Element("dependency");
      final String result_dxyzb6_a0a0a0a0a3 = md.getModuleRef().toString();
      result_dxyzb6_a0a0a0a3.setText(result_dxyzb6_a0a0a0a0a3);
      final boolean result_dxyzb6_a1a0a0a0a3 = md.isReexport();
      result_dxyzb6_a0a0a0a3.setAttribute("reexport", "" + result_dxyzb6_a1a0a0a0a3);
      result_dxyzb6_a0a3.addContent(result_dxyzb6_a0a0a0a3);
    }
  }

  public static List<ModelRoot> loadModelRoots(List<Element> modelRootElements, final IFile file, final Macros macros) {
    return ListSequence.fromList(modelRootElements).select(new ISelector<Element, ModelRoot>() {
      public ModelRoot select(Element mre) {
        return loadModelRoot(mre, file, macros);
      }
    }).toListSequence();
  }

  private static ModelRoot loadModelRoot(final Element modelRootElement, final IFile file, final Macros macros) {
    return new _FunctionTypes._return_P0_E0<ModelRoot>() {
      public ModelRoot invoke() {
        final ModelRoot result_dxyzb6_a0a0a5 = new ModelRoot();
        final String result_dxyzb6_a0a0a0a5 = AttributeUtils.stringWithDefault(modelRootElement.getAttributeValue("namespacePrefix"), "");
        result_dxyzb6_a0a0a5.setPrefix(result_dxyzb6_a0a0a0a5);
        String pathName = modelRootElement.getAttributeValue("path");
        if (pathName == null) {
          // left for compatibility 
          pathName = AttributeUtils.stringWithDefault(modelRootElement.getAttributeValue("rootPath"), "");
        }
        final String result_dxyzb6_a3a0a0a5 = macros.expandPath(pathName, file);
        result_dxyzb6_a0a0a5.setPath(result_dxyzb6_a3a0a0a5);
        if (ListSequence.fromList(AttributeUtils.elementChildren(modelRootElement, "manager")).isNotEmpty()) {
          final ModelRootManager result_dxyzb6_a0a4a0a0a5 = new ModelRootManager();
          Element manager = ListSequence.fromList(AttributeUtils.elementChildren(modelRootElement, "manager")).first();
          final String result_dxyzb6_a1a0a4a0a0a5 = AttributeUtils.stringWithDefault(manager.getAttributeValue("moduleId"), "");
          result_dxyzb6_a0a4a0a0a5.setModuleId(result_dxyzb6_a1a0a4a0a0a5);
          final String result_dxyzb6_a2a0a4a0a0a5 = AttributeUtils.stringWithDefault(manager.getAttributeValue("className"), "");
          result_dxyzb6_a0a4a0a0a5.setClassName(result_dxyzb6_a2a0a4a0a0a5);
          result_dxyzb6_a0a0a5.setManager(result_dxyzb6_a0a4a0a0a5);
        }
        return result_dxyzb6_a0a0a5;
      }
    }.invoke();
  }

  public static List<ModelRoot> loadStubModelEntries(List<Element> stubModelEntryElements, final IFile file, final Macros macros) {
    return ListSequence.fromList(AttributeUtils.elementChildren(ListSequence.fromList(stubModelEntryElements).first(), "stubModelEntry")).select(new ISelector<Element, ModelRoot>() {
      public ModelRoot select(Element mre) {
        return loadModelEntry(mre, file, macros);
      }
    }).toListSequence();
  }

  private static ModelRoot loadModelEntry(final Element modelRootElement, final IFile file, final Macros macros) {
    return new _FunctionTypes._return_P0_E0<ModelRoot>() {
      public ModelRoot invoke() {
        final ModelRoot result_dxyzb6_a0a0a7 = new ModelRoot();
        final String result_dxyzb6_a0a0a0a7 = macros.expandPath(modelRootElement.getAttributeValue("path"), file);
        result_dxyzb6_a0a0a7.setPath(result_dxyzb6_a0a0a0a7);
        final ModelRootManager result_dxyzb6_a1a0a0a7 = new ModelRootManager();
        final String result_dxyzb6_a0a1a0a0a7 = AttributeUtils.stringWithDefault(ListSequence.fromList(AttributeUtils.elementChildren(modelRootElement, "manager")).first().getAttributeValue("moduleId"), "");
        result_dxyzb6_a1a0a0a7.setModuleId(result_dxyzb6_a0a1a0a0a7);
        final String result_dxyzb6_a1a1a0a0a7 = AttributeUtils.stringWithDefault(ListSequence.fromList(AttributeUtils.elementChildren(modelRootElement, "manager")).first().getAttributeValue("className"), "");
        result_dxyzb6_a1a0a0a7.setClassName(result_dxyzb6_a1a1a0a0a7);
        result_dxyzb6_a0a0a7.setManager(result_dxyzb6_a1a0a0a7);
        return result_dxyzb6_a0a0a7;
      }
    }.invoke();
  }

  public static void saveModelRoots(Element modelsElement, List<ModelRoot> modelRoots, IFile file, Macros macros) {
    Element result_dxyzb6_a0a8 = modelsElement;
    for (ModelRoot root : ListSequence.fromList(modelRoots)) {
      final Element result_dxyzb6_a0a0a0a8 = new Element("modelRoot");
      final String result_dxyzb6_a0a0a0a0a8 = macros.shrinkPath((root.getPath() == null ?
        "" :
        root.getPath()
      ), file);
      result_dxyzb6_a0a0a0a8.setAttribute("path", "" + result_dxyzb6_a0a0a0a0a8);
      final String result_dxyzb6_a1a0a0a0a8 = (root.getPrefix() == null ?
        "" :
        root.getPrefix()
      );
      result_dxyzb6_a0a0a0a8.setAttribute("namespacePrefix", "" + result_dxyzb6_a1a0a0a0a8);
      if (root.getManager() != null) {
        final Element result_dxyzb6_a0a2a0a0a0a8 = new Element("manager");
        final String result_dxyzb6_a0a0a2a0a0a0a8 = root.getManager().getModuleId();
        result_dxyzb6_a0a2a0a0a0a8.setAttribute("moduleId", "" + result_dxyzb6_a0a0a2a0a0a0a8);
        final String result_dxyzb6_a1a0a2a0a0a0a8 = root.getManager().getClassName();
        result_dxyzb6_a0a2a0a0a0a8.setAttribute("className", "" + result_dxyzb6_a1a0a2a0a0a0a8);
        result_dxyzb6_a0a0a0a8.addContent(result_dxyzb6_a0a2a0a0a0a8);
      }
      result_dxyzb6_a0a8.addContent(result_dxyzb6_a0a0a0a8);
    }
  }

  public static void saveStubModelEntries(Element modelsElement, List<ModelRoot> modelRoots, IFile file, Macros macros) {
    Element result_dxyzb6_a0a9 = modelsElement;
    for (ModelRoot root : ListSequence.fromList(modelRoots)) {
      final Element result_dxyzb6_a0a0a0a9 = new Element("stubModelEntry");
      final String result_dxyzb6_a0a0a0a0a9 = macros.shrinkPath((root.getPath() == null ?
        "" :
        root.getPath()
      ), file);
      result_dxyzb6_a0a0a0a9.setAttribute("path", "" + result_dxyzb6_a0a0a0a0a9);
      final Element result_dxyzb6_a1a0a0a0a9 = new Element("manager");
      final String result_dxyzb6_a0a1a0a0a0a9 = root.getManager().getModuleId();
      result_dxyzb6_a1a0a0a0a9.setAttribute("moduleId", "" + result_dxyzb6_a0a1a0a0a0a9);
      final String result_dxyzb6_a1a1a0a0a0a9 = root.getManager().getClassName();
      result_dxyzb6_a1a0a0a0a9.setAttribute("className", "" + result_dxyzb6_a1a1a0a0a0a9);
      result_dxyzb6_a0a0a0a9.addContent(result_dxyzb6_a1a0a0a0a9);
      result_dxyzb6_a0a9.addContent(result_dxyzb6_a0a0a0a9);
    }
  }

  public static String getLanguageNamespace(IFile file) {
    // This method has no usages, probably it can be removed 
    try {
      Document document = JDOMUtil.loadDocument(file);
      return ((Element) document.getRootElement()).getAttributeValue("namespace");
    } catch (Exception e) {
      throw new RuntimeException(e);
    }
  }

  public static void setTimestamp(ModuleDescriptor descriptor, IFile file) {
    descriptor.setTimestamp(Long.toString(file.lastModified()));
  }
}
