package jetbrains.mps.project.persistence;

/*Generated by MPS */

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import jetbrains.mps.project.structure.modules.LanguageDescriptor;
import jetbrains.mps.vfs.IFile;
import jetbrains.mps.util.Macros;
import org.jdom.Document;
import jetbrains.mps.util.JDOMUtil;
import org.jdom.Element;
import jetbrains.mps.baseLanguage.closures.runtime._FunctionTypes;
import jetbrains.mps.xmlQuery.runtime.AttributeUtils;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.project.structure.modules.ModuleReference;
import jetbrains.mps.smodel.SModelReference;
import jetbrains.mps.project.structure.modules.ClassPathEntry;
import java.io.File;
import jetbrains.mps.vfs.FileSystem;
import jetbrains.mps.project.structure.modules.GeneratorDescriptor;
import java.io.OutputStream;

public class LanguageDescriptorPersistence {
  protected static Log log = LogFactory.getLog(LanguageDescriptorPersistence.class);

  public static LanguageDescriptor loadLanguageDescriptor(final IFile file) {
    final Macros macros = Macros.languageDescriptor();
    LanguageDescriptor descriptor;

    try {
      Document document = JDOMUtil.loadDocument(file);
      final Element languageElement = ((Element)document.getRootElement());

      descriptor = new _FunctionTypes._return_P0_E0<LanguageDescriptor>() {
        public LanguageDescriptor invoke() {
          LanguageDescriptor result_5080_0 = new LanguageDescriptor();
          String result_5080_1 = languageElement.getAttributeValue("namespace");
          result_5080_0.setNamespace(result_5080_1);
          if (languageElement.getAttributeValue("uuid") != null) {
            String result_5080_2 = languageElement.getAttributeValue("uuid");
            result_5080_0.setUUID(result_5080_2);
          }
          boolean result_5080_3 = AttributeUtils.booleanWithDefault(languageElement.getAttributeValue("java-stubs-enabled"), false);
          result_5080_0.setEnableJavaStubs(result_5080_3);

          if (languageElement.getAttributeValue("generatorOutputPath") != null) {
            String result_5080_4 = macros.expandPath(languageElement.getAttributeValue("generatorOutputPath"), file);
            result_5080_0.setGenPath(result_5080_4);
          }

          if (ListSequence.fromList(AttributeUtils.elementChildren(languageElement, "models")).isNotEmpty()) {
            result_5080_0.getModelRoots().addAll(ModuleDescriptorPersistence.loadModelRoots(AttributeUtils.elementChildren(ListSequence.fromList(AttributeUtils.elementChildren(languageElement, "models")).first(), "modelRoot"), file, macros));
          } else {
            // old - for backwards compatibility 
            result_5080_0.getModelRoots().addAll(ModuleDescriptorPersistence.loadModelRoots(AttributeUtils.elementChildren(languageElement, "modelRoot"), file, macros));
          }

          ModuleDescriptorPersistence.loadDependencies(result_5080_0, languageElement);

          for (Element extendedLanguage : ListSequence.fromList(AttributeUtils.elementChildren(ListSequence.fromList(AttributeUtils.elementChildren(languageElement, "extendedLanguages")).first(), "extendedLanguage"))) {
            result_5080_0.getExtendedLanguages().add(ModuleReference.fromString(extendedLanguage.getText()));
          }

          Element autoImports = ListSequence.fromList(AttributeUtils.elementChildren(languageElement, "accessoryModels")).first();
          if (autoImports == null) {
            // deprecated name 
            autoImports = ListSequence.fromList(AttributeUtils.elementChildren(languageElement, "library")).first();
          }
          for (Element modelElement : ListSequence.fromList(AttributeUtils.elementChildren(autoImports, "model"))) {
            result_5080_0.getAccessoryModels().add(SModelReference.fromString(modelElement.getAttributeValue("modelUID")));
          }

          for (Element generatorElement : ListSequence.fromList(AttributeUtils.elementChildren(ListSequence.fromList(AttributeUtils.elementChildren(languageElement, "generators")).first(), "generator"))) {
            result_5080_0.getGenerators().add(GeneratorDescriptorPersistence.loadGeneratorDescriptor(generatorElement, file, macros));
          }

          for (Element entryElement : ListSequence.fromList(AttributeUtils.elementChildren(ListSequence.fromList(AttributeUtils.elementChildren(languageElement, "classPath")).first(), "entry")).concat(ListSequence.fromList(AttributeUtils.elementChildren(ListSequence.fromList(AttributeUtils.elementChildren(languageElement, "runtimeClassPath")).first(), "entry")))) {
            // runtimeClassPath was left for compatibility 
            ClassPathEntry result_5080_5 = new ClassPathEntry();
            String result_5080_6 = macros.expandPath(entryElement.getAttributeValue("path"), file);
            result_5080_5.setPath(result_5080_6);
            boolean result_5080_7 = AttributeUtils.booleanWithDefault(entryElement.getAttributeValue("include"), false);
            result_5080_5.setIncludedInVCS(result_5080_7);
            result_5080_0.getClassPaths().add(result_5080_5);
          }

          for (Element entryElement : ListSequence.fromList(AttributeUtils.elementChildren(ListSequence.fromList(AttributeUtils.elementChildren(languageElement, "languageRuntimeClassPath")).first(), "entry"))) {
            ClassPathEntry result_5080_8 = new ClassPathEntry();
            String result_5080_9 = macros.expandPath(entryElement.getAttributeValue("path"), file);
            result_5080_8.setPath(result_5080_9);
            boolean result_5080_10 = AttributeUtils.booleanWithDefault(entryElement.getAttributeValue("include"), false);
            result_5080_8.setIncludedInVCS(result_5080_10);
            result_5080_0.getRuntimeClassPaths().add(result_5080_8);
          }

          for (Element entryElement : ListSequence.fromList(AttributeUtils.elementChildren(ListSequence.fromList(AttributeUtils.elementChildren(languageElement, "sourcePath")).first(), "source"))) {
            result_5080_0.getSourcePaths().add(macros.expandPath(entryElement.getAttributeValue("path"), file));
          }

          boolean result_5080_11 = AttributeUtils.booleanWithDefault(languageElement.getAttributeValue("compileInMPS"), false);
          result_5080_0.setCompileInMPS(result_5080_11);
          return result_5080_0;
        }
      }.invoke();
    } catch (Exception e) {
      throw new ModuleReadException(e);
    }

    ModuleDescriptorPersistence.setTimestamp(descriptor, file, false);
    return descriptor;
  }

  public static void saveLanguageDescriptor(File file, LanguageDescriptor descriptor) {
    saveLanguageDescriptor(FileSystem.getFile(file), descriptor);
  }

  public static void saveLanguageDescriptor(final IFile file, final LanguageDescriptor descriptor) {
    if (file.isReadOnly()) {
      if (log.isErrorEnabled()) {
        log.error("Cant't save " + file.getPath());
      }
      return;
    }

    final Macros macros = Macros.languageDescriptor();
    Element languageElement = new _FunctionTypes._return_P0_E0<Element>() {
      public Element invoke() {
        Element result_5080_12 = new Element("language");
        String result_5080_13 = descriptor.getNamespace();
        result_5080_12.setAttribute("namespace", "" + result_5080_13);
        if (descriptor.getUUID() != null) {
          String result_5080_14 = descriptor.getUUID();
          result_5080_12.setAttribute("uuid", "" + result_5080_14);
        }
        if (descriptor.getGenPath() != null) {
          String result_5080_15 = macros.shrinkPath(descriptor.getGenPath(), file);
          result_5080_12.setAttribute("generatorOutputPath", "" + result_5080_15);
        }
        boolean result_5080_16 = descriptor.getEnableJavaStubs();
        result_5080_12.setAttribute("java-stubs-enabled", "" + result_5080_16);

        Element result_5080_17 = new Element("models");
        ModuleDescriptorPersistence.saveModelRoots(result_5080_17, descriptor.getModelRoots(), file, macros);
        result_5080_12.addContent(result_5080_17);

        Element result_5080_18 = new Element("accessoryModels");
        for (SModelReference model : ListSequence.fromList(descriptor.getAccessoryModels())) {
          Element result_5080_19 = new Element("model");
          String result_5080_20 = model.toString();
          result_5080_19.setAttribute("modelUID", "" + result_5080_20);
          result_5080_18.addContent(result_5080_19);
        }
        result_5080_12.addContent(result_5080_18);

        Element result_5080_21 = new Element("generators");
        for (GeneratorDescriptor generatorDescriptor : ListSequence.fromList(descriptor.getGenerators())) {
          GeneratorDescriptorPersistence.saveGeneratorDescriptor(result_5080_21, generatorDescriptor, file, macros);
        }
        result_5080_12.addContent(result_5080_21);

        Element result_5080_22 = new Element("classPath");
        for (ClassPathEntry entry : ListSequence.fromList(descriptor.getClassPaths())) {
          Element result_5080_23 = new Element("entry");
          String result_5080_24 = macros.shrinkPath(entry.getPath(), file);
          result_5080_23.setAttribute("path", "" + result_5080_24);
          boolean result_5080_25 = entry.isIncludedInVCS();
          result_5080_23.setAttribute("include", "" + result_5080_25);
          result_5080_22.addContent(result_5080_23);
        }
        result_5080_12.addContent(result_5080_22);

        Element result_5080_26 = new Element("languageRuntimeClassPath");
        for (ClassPathEntry entry : ListSequence.fromList(descriptor.getRuntimeClassPaths())) {
          Element result_5080_27 = new Element("entry");
          String result_5080_28 = macros.shrinkPath(entry.getPath(), file);
          result_5080_27.setAttribute("path", "" + result_5080_28);
          result_5080_26.addContent(result_5080_27);
        }
        result_5080_12.addContent(result_5080_26);

        Element result_5080_29 = new Element("sourcePath");
        for (String p : ListSequence.fromList(descriptor.getSourcePaths())) {
          Element result_5080_30 = new Element("source");
          String result_5080_31 = macros.shrinkPath(p, file);
          result_5080_30.setAttribute("path", "" + result_5080_31);
          result_5080_29.addContent(result_5080_30);
        }
        result_5080_12.addContent(result_5080_29);

        boolean result_5080_32 = descriptor.getCompileInMPS();
        result_5080_12.setAttribute("compileInMPS", "" + result_5080_32);

        ModuleDescriptorPersistence.saveDependencies(result_5080_12, descriptor);

        Element result_5080_33 = new Element("extendedLanguages");
        for (ModuleReference ref : ListSequence.fromList(descriptor.getExtendedLanguages())) {
          Element result_5080_34 = new Element("extendedLanguage");
          String result_5080_35 = ref.toString();
          result_5080_34.setText(result_5080_35);
          result_5080_33.addContent(result_5080_34);
        }
        result_5080_12.addContent(result_5080_33);
        return result_5080_12;
      }
    }.invoke();

    try {
      OutputStream os = file.openOutputStream();
      JDOMUtil.writeDocument(new Document(languageElement), os);
      os.close();
    } catch (Exception e) {
      if (log.isErrorEnabled()) {
        log.error("", e);
      }
    }
    ModuleDescriptorPersistence.setTimestamp(descriptor, file, true);
  }
}
