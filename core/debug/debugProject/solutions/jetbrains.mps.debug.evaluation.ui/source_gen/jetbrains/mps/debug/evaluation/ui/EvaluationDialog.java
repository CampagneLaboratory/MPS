package jetbrains.mps.debug.evaluation.ui;

/*Generated by MPS */

import jetbrains.mps.ide.dialogs.BaseDialog;
import jetbrains.mps.debug.evaluation.EvaluationProvider;
import javax.swing.JPanel;
import jetbrains.mps.debug.runtime.SessionStopDisposer;
import jetbrains.mps.smodel.IOperationContext;
import org.jetbrains.annotations.NotNull;
import jetbrains.mps.debug.evaluation.model.AbstractEvaluationModel;
import java.awt.Dimension;
import jetbrains.mps.debug.runtime.DebugSession;
import java.awt.BorderLayout;
import com.intellij.openapi.application.ApplicationManager;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import javax.swing.JComponent;

public class EvaluationDialog extends BaseDialog {
  private final EvaluationProvider myProvider;
  private final EvaluationPanel myEvaluationPanel;
  private final JPanel myMainPanel;
  private final SessionStopDisposer mySessionStopDisposer;

  public EvaluationDialog(final IOperationContext context, @NotNull EvaluationProvider provider, AbstractEvaluationModel evalModel) {
    super(context.getMainFrame(), "Evaluate");
    setSize(new Dimension(500, 500));
    setModal(false);

    myProvider = provider;
    final DebugSession debugSession = provider.getDebugSession();
    myEvaluationPanel = new EvaluationPanel(context.getProject(), debugSession, evalModel, false);
    myEvaluationPanel.setErrorTextListener(new EvaluationPanel.IErrorTextListener() {
      public void updateErrorText(String text) {
        setErrorText(text);
      }
    });
    myMainPanel = new JPanel(new BorderLayout());
    myMainPanel.add(myEvaluationPanel, BorderLayout.CENTER);

    mySessionStopDisposer = new SessionStopDisposer(debugSession) {
      public void doDispose() {
        ApplicationManager.getApplication().invokeLater(new Runnable() {
          public void run() {
            dispose();
          }
        });
      }
    };
    addWindowListener(new WindowAdapter() {
      @Override
      public void windowClosed(WindowEvent event) {
        dispose();
      }
    });
  }

  public JComponent getMainComponent() {
    return myMainPanel;
  }

  @BaseDialog.Button(position = 1, name = "Watch", mnemonic = 'W', defaultButton = false)
  public void buttonWatch() {
    myProvider.watch(myEvaluationPanel.getEvaluationModel());
    dispose();
  }

  @BaseDialog.Button(position = 0, name = "Evaluate", mnemonic = 'E', defaultButton = true)
  public void buttonEvaluate() {
    myEvaluationPanel.evaluate();
  }

  @BaseDialog.Button(position = 2, name = "Close", mnemonic = 'C', defaultButton = false)
  public void buttonCancel() {
    dispose();
  }

  @Override
  public void dispose() {
    ApplicationManager.getApplication().assertIsDispatchThread();
    super.dispose();
    myEvaluationPanel.dispose();
  }
}
